
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../examples/rate-limiting/">
      
      
        <link rel="next" href="../cli/">
      
      
      <link rel="icon" href="../../assets/docetl-favicon-color.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>docetl Core - docetl docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CSource+Code+Pro:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"Source Code Pro"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="#FDB515">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#docetl.DSLRunner" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="docetl docs" class="md-header__button md-logo" aria-label="docetl docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M0 112c0-41.5 31.6-75.6 72-79.6V32h280c53 0 96 43 96 96v176H272c-39.8 0-72 32.2-72 72v60c0 24.3-19.7 44-44 44s-44-19.7-44-44V208H48c-26.5 0-48-21.5-48-48zm236.8 368c7.1-13.1 11.2-28.1 11.2-44v-60c0-13.3 10.7-24 24-24h248c13.3 0 24 10.7 24 24v24c0 44.2-35.8 80-80 80zM80 80c-17.7 0-32 14.3-32 32v48h64v-48c0-17.7-14.3-32-32-32"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            docetl docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              docetl Core
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="#FDB515"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="#FDB515"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="#FDB515"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/ucbepic/docetl" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    ucbepic/docetl
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  
    
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../concepts/operators/" class="md-tabs__link">
          
  
  
    
  
  User Guide

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../optimization/overview/" class="md-tabs__link">
          
  
  
    
  
  Optimization

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../examples/presidential-debate-themes/" class="md-tabs__link">
          
  
  
    
  
  Tutorials & Examples

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../examples/custom-parsing/" class="md-tabs__link">
          
  
  
    
  
  Developer Reference

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../playground/" class="md-tabs__link">
          
  
  
    
  
  Tools & Resources

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="docetl docs" class="md-nav__button md-logo" aria-label="docetl docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M0 112c0-41.5 31.6-75.6 72-79.6V32h280c53 0 96 43 96 96v176H272c-39.8 0-72 32.2-72 72v60c0 24.3-19.7 44-44 44s-44-19.7-44-44V208H48c-26.5 0-48-21.5-48-48zm236.8 368c7.1-13.1 11.2-28.1 11.2-44v-60c0-13.3 10.7-24 24-24h248c13.3 0 24 10.7 24 24v24c0 44.2-35.8 80-80 80zM80 80c-17.7 0-32 14.3-32 32v48h64v-48c0-17.7-14.3-32-32-32"/></svg>

    </a>
    docetl docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ucbepic/docetl" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    ucbepic/docetl
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../.." class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../concepts/operators/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    User Guide
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../optimization/overview/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Optimization
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../examples/presidential-debate-themes/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Tutorials & Examples
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Developer Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Developer Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Technical Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            Technical Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/custom-parsing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Custom Data Parsing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/rate-limiting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rate Limiting Implementation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" checked>
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    docetl Core
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    docetl Core
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#docetl.DSLRunner" class="md-nav__link">
    <span class="md-ellipsis">
      DSLRunner
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DSLRunner">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.clear_intermediate" class="md-nav__link">
    <span class="md-ellipsis">
      clear_intermediate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.load_run_save" class="md-nav__link">
    <span class="md-ellipsis">
      load_run_save
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.print_query_plan" class="md-nav__link">
    <span class="md-ellipsis">
      print_query_plan
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.save" class="md-nav__link">
    <span class="md-ellipsis">
      save
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.syntax_check" class="md-nav__link">
    <span class="md-ellipsis">
      syntax_check
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docetl.Optimizer" class="md-nav__link">
    <span class="md-ellipsis">
      Optimizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Optimizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.checkpoint_optimized_ops" class="md-nav__link">
    <span class="md-ellipsis">
      checkpoint_optimized_ops
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.clean_optimized_config" class="md-nav__link">
    <span class="md-ellipsis">
      clean_optimized_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.optimize" class="md-nav__link">
    <span class="md-ellipsis">
      optimize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.print_optimizer_config" class="md-nav__link">
    <span class="md-ellipsis">
      print_optimizer_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.resolve_anchors" class="md-nav__link">
    <span class="md-ellipsis">
      resolve_anchors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.save_optimized_config" class="md-nav__link">
    <span class="md-ellipsis">
      save_optimized_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.should_optimize" class="md-nav__link">
    <span class="md-ellipsis">
      should_optimize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CLI Interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../operations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Operations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../optimizers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Optimizers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../python/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Python API
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../playground/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Tools & Resources
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#docetl.DSLRunner" class="md-nav__link">
    <span class="md-ellipsis">
      DSLRunner
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DSLRunner">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.clear_intermediate" class="md-nav__link">
    <span class="md-ellipsis">
      clear_intermediate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.load_run_save" class="md-nav__link">
    <span class="md-ellipsis">
      load_run_save
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.print_query_plan" class="md-nav__link">
    <span class="md-ellipsis">
      print_query_plan
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.save" class="md-nav__link">
    <span class="md-ellipsis">
      save
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.syntax_check" class="md-nav__link">
    <span class="md-ellipsis">
      syntax_check
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docetl.Optimizer" class="md-nav__link">
    <span class="md-ellipsis">
      Optimizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Optimizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.checkpoint_optimized_ops" class="md-nav__link">
    <span class="md-ellipsis">
      checkpoint_optimized_ops
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.clean_optimized_config" class="md-nav__link">
    <span class="md-ellipsis">
      clean_optimized_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.optimize" class="md-nav__link">
    <span class="md-ellipsis">
      optimize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.print_optimizer_config" class="md-nav__link">
    <span class="md-ellipsis">
      print_optimizer_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.resolve_anchors" class="md-nav__link">
    <span class="md-ellipsis">
      resolve_anchors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.save_optimized_config" class="md-nav__link">
    <span class="md-ellipsis">
      save_optimized_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.should_optimize" class="md-nav__link">
    <span class="md-ellipsis">
      should_optimize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>docetl Core</h1>

<div class="doc doc-object doc-class">



<h3 id="docetl.DSLRunner" class="doc doc-heading">
            <code>docetl.DSLRunner</code>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="docetl.config_wrapper.ConfigWrapper">ConfigWrapper</span></code></p>


        <p>DSLRunner orchestrates pipeline execution by building and traversing a DAG of OpContainers.
The runner uses a two-phase approach:</p>
<ol>
<li>Build Phase:</li>
<li>Parses YAML config into a DAG of OpContainers</li>
<li>Each operation becomes a node connected to its dependencies</li>
<li>Special handling for equijoins which have two parent nodes</li>
<li>
<p>Validates operation syntax and schema compatibility</p>
</li>
<li>
<p>Execution Phase:</p>
</li>
<li>Starts from the final operation and pulls data through the DAG</li>
<li>Handles caching/checkpointing of intermediate results</li>
<li>Tracks costs and execution metrics</li>
<li>Manages dataset loading and result persistence</li>
</ol>
<p>The separation between build and execution phases allows for:
- Pipeline validation before any execution
- Cost estimation and optimization
- Partial pipeline execution for testing</p>







              <details class="quote">
                <summary>Source code in <code>docetl/runner.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DSLRunner</span><span class="p">(</span><span class="n">ConfigWrapper</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DSLRunner orchestrates pipeline execution by building and traversing a DAG of OpContainers.</span>
<span class="sd">    The runner uses a two-phase approach:</span>

<span class="sd">    1. Build Phase:</span>
<span class="sd">       - Parses YAML config into a DAG of OpContainers</span>
<span class="sd">       - Each operation becomes a node connected to its dependencies</span>
<span class="sd">       - Special handling for equijoins which have two parent nodes</span>
<span class="sd">       - Validates operation syntax and schema compatibility</span>

<span class="sd">    2. Execution Phase:</span>
<span class="sd">       - Starts from the final operation and pulls data through the DAG</span>
<span class="sd">       - Handles caching/checkpointing of intermediate results</span>
<span class="sd">       - Tracks costs and execution metrics</span>
<span class="sd">       - Manages dataset loading and result persistence</span>

<span class="sd">    The separation between build and execution phases allows for:</span>
<span class="sd">    - Pipeline validation before any execution</span>
<span class="sd">    - Cost estimation and optimization</span>
<span class="sd">    - Partial pipeline execution for testing</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classproperty</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">schema</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="c1"># Accessing the schema loads all operations, so only do this</span>
        <span class="c1"># when we actually need it...</span>
        <span class="c1"># Yes, this means DSLRunner.schema isn&#39;t really accessible to</span>
        <span class="c1"># static type checkers. But it /is/ available for dynamic</span>
        <span class="c1"># checking, and for generating json schema.</span>

        <span class="n">OpType</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">|</span> <span class="n">b</span><span class="p">,</span> <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">schema</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">get_operations</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="p">)</span>
        <span class="c1"># More pythonic implementation of the above, but only works in python 3.11:</span>
        <span class="c1"># OpType = Union[*[op.schema for op in get_operations().values()]]</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">Pipeline</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
            <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
            <span class="n">parsing_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">schemas</span><span class="o">.</span><span class="n">ParsingTool</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
            <span class="n">datasets</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">schemas</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]</span>
            <span class="n">retrievers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
            <span class="n">operations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">OpType</span><span class="p">]</span>
            <span class="n">pipeline</span><span class="p">:</span> <span class="n">schemas</span><span class="o">.</span><span class="n">PipelineSpec</span>

        <span class="k">return</span> <span class="n">Pipeline</span>

    <span class="nd">@classproperty</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">json_schema</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">max_threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the DSLRunner with a YAML configuration file.</span>

<span class="sd">        Args:</span>
<span class="sd">            max_threads (int, optional): Maximum number of threads to use. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">base_name</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;base_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">yaml_file_suffix</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;yaml_file_suffix&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">max_threads</span><span class="o">=</span><span class="n">max_threads</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_parsing_tools</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_retrievers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_operation_graph</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_operation_hashes</span><span class="p">()</span>

        <span class="c1"># Run initial validation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from_df_accessors</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;from_df_accessors&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_df_accessors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">syntax_check</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize basic runner state and datasets&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pipeline&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intermediate_dir&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_parsing_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up parsing tools from configuration&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parsing_tool_map</span> <span class="o">=</span> <span class="n">create_parsing_tool_map</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parsing_tools&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_retrievers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instantiate retrievers from configuration (lazy index creation).&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">docetl.retrievers.lancedb</span><span class="w"> </span><span class="kn">import</span> <span class="n">LanceDBRetriever</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">retrievers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">retrievers_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;retrievers&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">rconf</span> <span class="ow">in</span> <span class="n">retrievers_cfg</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rconf</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid retriever &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; configuration&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rconf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;lancedb&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unsupported retriever type &#39;</span><span class="si">{</span><span class="n">rconf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; for &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;. Only &#39;lancedb&#39; is supported.&quot;</span>
                <span class="p">)</span>
            <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="s2">&quot;index_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;index_types&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rconf</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Retriever &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; missing required key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                    <span class="p">)</span>
            <span class="c1"># Defaults</span>
            <span class="n">rconf</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;top_k&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>
            <span class="n">rconf</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;build_index&quot;</span><span class="p">,</span> <span class="s2">&quot;if_missing&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">retrievers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">LanceDBRetriever</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">rconf</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_operation_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build the DAG of operations from configuration&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op_container_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_scan_operation</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_equijoin_operation</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_add_step_operations</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_step_boundary</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate step configuration&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2"> does not have a name&quot;</span>
        <span class="k">assert</span> <span class="s2">&quot;operations&quot;</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2"> does not have `operations`&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_scan_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a scan operation for input datasets&quot;&quot;&quot;</span>
        <span class="n">scan_op_container</span> <span class="o">=</span> <span class="n">OpContainer</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/scan_</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;scan&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dataset_name&quot;</span><span class="p">:</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">],</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;scan_</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op_container_map</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/scan_</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">scan_op_container</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">:</span>
            <span class="n">scan_op_container</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span> <span class="o">=</span> <span class="n">scan_op_container</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_equijoin_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add an equijoin operation with its scan operations&quot;&quot;&quot;</span>
        <span class="n">equijoin_operation_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">left_dataset_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;left&quot;</span><span class="p">]</span>
        <span class="n">right_dataset_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;right&quot;</span><span class="p">]</span>

        <span class="n">left_scan_op_container</span> <span class="o">=</span> <span class="n">OpContainer</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/scan_</span><span class="si">{</span><span class="n">left_dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;scan&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dataset_name&quot;</span><span class="p">:</span> <span class="n">left_dataset_name</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;scan_</span><span class="si">{</span><span class="n">left_dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">:</span>
            <span class="n">left_scan_op_container</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">)</span>
        <span class="n">right_scan_op_container</span> <span class="o">=</span> <span class="n">OpContainer</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/scan_</span><span class="si">{</span><span class="n">right_dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;scan&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dataset_name&quot;</span><span class="p">:</span> <span class="n">right_dataset_name</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;scan_</span><span class="si">{</span><span class="n">right_dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">:</span>
            <span class="n">right_scan_op_container</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">)</span>
        <span class="n">equijoin_op_container</span> <span class="o">=</span> <span class="n">OpContainer</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">equijoin_operation_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">find_operation</span><span class="p">(</span><span class="n">equijoin_operation_name</span><span class="p">),</span>
            <span class="n">left_name</span><span class="o">=</span><span class="n">left_dataset_name</span><span class="p">,</span>
            <span class="n">right_name</span><span class="o">=</span><span class="n">right_dataset_name</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">equijoin_op_container</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">left_scan_op_container</span><span class="p">)</span>
        <span class="n">equijoin_op_container</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">right_scan_op_container</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span> <span class="o">=</span> <span class="n">equijoin_op_container</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op_container_map</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">equijoin_operation_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">equijoin_op_container</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op_container_map</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/scan_</span><span class="si">{</span><span class="n">left_dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">left_scan_op_container</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op_container_map</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/scan_</span><span class="si">{</span><span class="n">right_dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">right_scan_op_container</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_step_operations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add operations for a step&quot;&quot;&quot;</span>
        <span class="n">op_start_idx</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">operation_name</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">][</span><span class="n">op_start_idx</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operation_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Operation </span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2"> in step </span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> should be a string. &quot;</span>
                    <span class="s2">&quot;If you intend for it to be an equijoin, don&#39;t specify an input in the step.&quot;</span>
                <span class="p">)</span>

            <span class="n">op_container</span> <span class="o">=</span> <span class="n">OpContainer</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">find_operation</span><span class="p">(</span><span class="n">operation_name</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">op_container</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span> <span class="o">=</span> <span class="n">op_container</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">op_container_map</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_container</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_step_boundary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a step boundary node&quot;&quot;&quot;</span>
        <span class="n">step_boundary</span> <span class="o">=</span> <span class="n">StepBoundary</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/boundary&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;step_boundary&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/boundary&quot;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="n">step_boundary</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op_container_map</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/boundary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_boundary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span> <span class="o">=</span> <span class="n">step_boundary</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_operation_hashes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute hashes for operations to enable caching&quot;&quot;&quot;</span>
        <span class="n">op_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">op</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">op</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_op_hashes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]):</span>
                <span class="n">op_name</span> <span class="o">=</span> <span class="n">op</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">all_ops_until_and_including_current</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">[</span><span class="n">op_map</span><span class="p">[</span><span class="n">prev_op</span><span class="p">]</span> <span class="k">for</span> <span class="n">prev_op</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">][:</span><span class="n">idx</span><span class="p">]]</span>
                    <span class="o">+</span> <span class="p">[</span><span class="n">op_map</span><span class="p">[</span><span class="n">op_name</span><span class="p">]]</span>
                    <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system_prompt&quot;</span><span class="p">,</span> <span class="p">{})]</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">all_ops_until_and_including_current</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;model&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">op</span><span class="p">:</span>
                        <span class="n">op</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span>

                <span class="n">all_ops_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">all_ops_until_and_including_current</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">step_op_hashes</span><span class="p">[</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]][</span><span class="n">op_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span>
                    <span class="n">all_ops_str</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
                <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_output_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pipeline&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="n">output_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">output_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Output path &#39;</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&#39; is not a JSON or CSV file. Please provide a path ending with &#39;.json&#39; or &#39;.csv&#39;.&quot;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">require</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No output path specified in the configuration. Please provide an output path ending with &#39;.json&#39; or &#39;.csv&#39; in the configuration to use the save() method.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">output_path</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">syntax_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a syntax check on all operations defined in the configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[yellow]Checking operations...[/yellow]&quot;</span><span class="p">)</span>

        <span class="c1"># Just validate that it&#39;s a json file if specified</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_output_path</span><span class="p">()</span>
        <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Walk the last op container to check syntax</span>
            <span class="n">op_containers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">:</span>
                <span class="n">op_containers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">]</span>

            <span class="k">while</span> <span class="n">op_containers</span><span class="p">:</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">op_containers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">syntax_result</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">syntax_check</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">syntax_result</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="c1"># Add all children to the queue</span>
                <span class="n">op_containers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Syntax check failed for operation &#39;</span><span class="si">{</span><span class="n">current</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[green] All operations passed syntax check[/green]&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">print_query_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_boundaries</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print a visual representation of the entire query plan using indentation and arrows.</span>
<span class="sd">        Operations are color-coded by step to show the pipeline structure while maintaining</span>
<span class="sd">        dependencies between steps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold]Pipeline Steps:[/bold]&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="n">Panel</span><span class="p">(</span><span class="s2">&quot;No operations in pipeline&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Query Plan&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_print_op</span><span class="p">(</span>
            <span class="n">op</span><span class="p">:</span> <span class="n">OpContainer</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">step_colors</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="c1"># Handle boundary operations based on show_boundaries flag</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">StepBoundary</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">show_boundaries</span><span class="p">:</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">indent_str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="n">indent</span>
                    <span class="n">step_name</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">step_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">step_name</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">][bold]</span><span class="si">{</span><span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[/bold][/</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">]&quot;</span>
                    <span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">Type: step_boundary&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">[yellow][/yellow]&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_print_op</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step_colors</span><span class="p">))</span>
                    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">_print_op</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">indent</span><span class="p">,</span> <span class="n">step_colors</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>

            <span class="c1"># Build the string for the current operation with indentation</span>
            <span class="n">indent_str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="n">indent</span>
            <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Color code the operation name based on its step</span>
            <span class="n">step_name</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">step_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">step_name</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">][bold]</span><span class="si">{</span><span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[/bold][/</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">Type: </span><span class="si">{</span><span class="n">op</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Add schema if available</span>
            <span class="k">if</span> <span class="s2">&quot;output&quot;</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="s2">&quot;schema&quot;</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">Output Schema:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">field_type</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">escaped_type</span> <span class="o">=</span> <span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">field_type</span><span class="p">))</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">: [bright_white]</span><span class="si">{</span><span class="n">escaped_type</span><span class="si">}</span><span class="s2">[/bright_white]&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Add children</span>
            <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">is_equijoin</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">[yellow] LEFT[/yellow]&quot;</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_print_op</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step_colors</span><span class="p">))</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">[yellow] RIGHT[/yellow]&quot;</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_print_op</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step_colors</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">[yellow][/yellow]&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_print_op</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step_colors</span><span class="p">))</span>

            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="c1"># Get all step boundaries and extract unique step names</span>
        <span class="n">step_boundaries</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">op</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_container_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">StepBoundary</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">step_boundaries</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Create a color map for steps - using distinct colors</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cyan&quot;</span><span class="p">,</span> <span class="s2">&quot;magenta&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">]</span>
        <span class="n">step_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">step_boundaries</span><span class="p">]</span>
        <span class="n">step_colors</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">step_names</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># Print the legend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold]Pipeline Steps:[/bold]&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">step_name</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">step_colors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">][/</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Print the full query plan starting from the last step boundary</span>
        <span class="n">query_plan</span> <span class="o">=</span> <span class="n">_print_op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">,</span> <span class="n">step_colors</span><span class="o">=</span><span class="n">step_colors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Panel</span><span class="p">(</span><span class="n">query_plan</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Query Plan&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">operation_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">operation_config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">op_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">operation_config</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Operation &#39;</span><span class="si">{</span><span class="n">op_name</span><span class="si">}</span><span class="s2">&#39; not found in configuration.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_run_save</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the entire pipeline defined in the configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_path</span><span class="p">(</span><span class="n">require</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Print the query plan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_query_plan</span><span class="p">()</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[bold]Pipeline Execution[/bold]&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

        <span class="c1"># Print execution summary</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Cost: [green]$</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">total_cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">[/green]</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Time: </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cache: [dim]</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="si">}</span><span class="s2">[/dim]</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span>
                <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Output: [dim]</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">[/dim]&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Panel</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Execution Summary&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_cost</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load all datasets defined in the configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[bold]Loading Datasets[/bold]&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dataset_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;datasets&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">dataset_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
                <span class="n">datasets</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="s2">&quot;file&quot;</span><span class="p">,</span>
                    <span class="n">dataset_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span>
                    <span class="n">source</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">,</span>
                    <span class="n">parsing</span><span class="o">=</span><span class="n">dataset_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parsing&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="n">user_defined_parsing_tool_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parsing_tool_map</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[green][/green] Loaded dataset &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; from </span><span class="si">{</span><span class="n">dataset_config</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">dataset_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
                <span class="n">datasets</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="s2">&quot;memory&quot;</span><span class="p">,</span>
                    <span class="n">dataset_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span>
                    <span class="n">source</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">,</span>
                    <span class="n">parsing</span><span class="o">=</span><span class="n">dataset_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parsing&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="n">user_defined_parsing_tool_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parsing_tool_map</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[green][/green] Loaded dataset &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; from in-memory data&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported dataset type: </span><span class="si">{</span><span class="n">dataset_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">dataset</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the final output of the pipeline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_output_path</span><span class="p">(</span><span class="n">require</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">output_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">output_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
            <span class="c1"># Create the directory if it doesn&#39;t exist</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># CSV</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="n">limited_data</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span>
                    <span class="p">]</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">limited_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[green][/green] Saved to [dim]</span><span class="si">{</span><span class="n">output_config</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">[/dim]</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported output type: </span><span class="si">{</span><span class="n">output_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. Supported types: file&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_from_checkpoint_if_exists</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">step_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">operation_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bypass_cache&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">intermediate_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="p">,</span> <span class="s2">&quot;.docetl_intermediate_config.json&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">intermediate_config_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Make sure the step and op name is in the checkpoint config path</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">step_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_op_hashes</span>
            <span class="ow">or</span> <span class="n">operation_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_op_hashes</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># See if the checkpoint config is the same as the current step op hash</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intermediate_config_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">intermediate_config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">intermediate_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">step_name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">operation_name</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_op_hashes</span><span class="p">[</span><span class="n">step_name</span><span class="p">][</span><span class="n">operation_name</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="p">,</span> <span class="n">step_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">.json&quot;</span>
        <span class="p">)</span>
        <span class="c1"># check if checkpoint exists</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="p">,</span> <span class="s2">&quot;local&quot;</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[green][/green] [italic]Loaded checkpoint for operation &#39;</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">&#39; in step &#39;</span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">&#39; from </span><span class="si">{</span><span class="n">checkpoint_path</span><span class="si">}</span><span class="s2">[/italic]&quot;</span>
                <span class="p">)</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clear_intermediate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear the intermediate directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Remove the intermediate directory</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Intermediate directory not set. Cannot clear intermediate.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_save_checkpoint</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">step_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">operation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save a checkpoint of the current data after an operation.</span>

<span class="sd">        This method creates a JSON file containing the current state of the data</span>
<span class="sd">        after an operation has been executed. The checkpoint is saved in a directory</span>
<span class="sd">        structure that reflects the step and operation names.</span>

<span class="sd">        Args:</span>
<span class="sd">            step_name (str): The name of the current step in the pipeline.</span>
<span class="sd">            operation_name (str): The name of the operation that was just executed.</span>
<span class="sd">            data (list[dict]): The current state of the data to be checkpointed.</span>

<span class="sd">        Note:</span>
<span class="sd">            The checkpoint is saved only if a checkpoint directory has been specified</span>
<span class="sd">            when initializing the DSLRunner.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="p">,</span> <span class="n">step_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">.json&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="c1"># Update the intermediate config file with the hash for this step/operation</span>
        <span class="c1"># so that future runs can validate and reuse this checkpoint.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="p">:</span>
            <span class="n">intermediate_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="p">,</span> <span class="s2">&quot;.docetl_intermediate_config.json&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Initialize or load existing intermediate configuration</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">intermediate_config_path</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intermediate_config_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cfg_file</span><span class="p">:</span>
                        <span class="n">intermediate_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                            <span class="n">cfg_file</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                    <span class="c1"># If the file is corrupted, start fresh to avoid crashes</span>
                    <span class="n">intermediate_config</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">intermediate_config</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Ensure nested dict structure exists</span>
            <span class="n">step_dict</span> <span class="o">=</span> <span class="n">intermediate_config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">step_name</span><span class="p">,</span> <span class="p">{})</span>

            <span class="c1"># Write (or overwrite) the hash for the current operation</span>
            <span class="n">step_dict</span><span class="p">[</span><span class="n">operation_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_op_hashes</span><span class="p">[</span><span class="n">step_name</span><span class="p">][</span><span class="n">operation_name</span><span class="p">]</span>

            <span class="c1"># Persist the updated configuration</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intermediate_config_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cfg_file</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">intermediate_config</span><span class="p">,</span> <span class="n">cfg_file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[green] [italic]Intermediate saved for operation &#39;</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">&#39; in step &#39;</span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">&#39; at </span><span class="si">{</span><span class="n">checkpoint_path</span><span class="si">}</span><span class="s2">[/italic][/green]&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">should_optimize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">step_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">op_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="c1"># Augment the kwargs with the runner&#39;s config if not already provided</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;litellm_kwargs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;litellm_kwargs&quot;</span><span class="p">,</span> <span class="p">{}</span>
        <span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;rewrite_agent_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;rewrite_agent_model&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-5.1&quot;</span>
        <span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;judge_agent_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;judge_agent_model&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4o-mini&quot;</span>
        <span class="p">)</span>

        <span class="n">builder</span> <span class="o">=</span> <span class="n">Optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">builder</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">should_optimize</span><span class="p">(</span><span class="n">step_name</span><span class="p">,</span> <span class="n">op_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">return_pipeline</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span> <span class="o">|</span> <span class="s2">&quot;DSLRunner&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No operations in pipeline. Cannot optimize.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="c1"># Augment the kwargs with the runner&#39;s config if not already provided</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;litellm_kwargs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;litellm_kwargs&quot;</span><span class="p">,</span> <span class="p">{}</span>
        <span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;rewrite_agent_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;rewrite_agent_model&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-5.1&quot;</span>
        <span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;judge_agent_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;judge_agent_model&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4o-mini&quot;</span>
        <span class="p">)</span>

        <span class="n">save_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Pop the save_path from kwargs</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;save_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">builder</span> <span class="o">=</span> <span class="n">Optimizer</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">builder</span>
        <span class="n">llm_api_cost</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
        <span class="n">operations_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_cost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_cost</span> <span class="o">+=</span> <span class="n">llm_api_cost</span>

        <span class="c1"># Log the cost of optimization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[green italic] Total cost: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">total_cost</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">[/green italic]&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[green italic]   Operation execution cost: $</span><span class="si">{</span><span class="n">operations_cost</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">[/green italic]&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[green italic]   Optimization cost: $</span><span class="si">{</span><span class="n">llm_api_cost</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">[/green italic]&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="c1"># If output path is provided, save the optimized config to that path</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_path&quot;</span><span class="p">):</span>
                <span class="n">save_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;save_path&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">save_path</span><span class="p">):</span>
                    <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">save_path</span><span class="p">)</span>
                <span class="n">builder</span><span class="o">.</span><span class="n">save_optimized_config</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config_path</span> <span class="o">=</span> <span class="n">save_path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">builder</span><span class="o">.</span><span class="n">save_optimized_config</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_opt.yaml&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_opt.yaml&quot;</span>

        <span class="k">if</span> <span class="n">return_pipeline</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">DSLRunner</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">clean_optimized_config</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">total_cost</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="n">clean_optimized_config</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_cost</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_operation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">return_instance</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">is_build</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">BaseOperation</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a single operation based on its configuration.</span>

<span class="sd">        This method creates an instance of the appropriate operation class and executes it.</span>
<span class="sd">        It also updates the total operation cost.</span>

<span class="sd">        Args:</span>
<span class="sd">            op_config (dict[str, Any]): The configuration of the operation to run.</span>
<span class="sd">            input_data (list[dict[str, Any]]): The input data for the operation.</span>
<span class="sd">            return_instance (bool, optional): If True, return the operation instance along with the output data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[dict[str, Any]] | tuple[list[dict[str, Any]], BaseOperation, float]:</span>
<span class="sd">            If return_instance is False, returns the output data.</span>
<span class="sd">            If return_instance is True, returns a tuple of the output data, the operation instance, and the cost.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">operation_class</span> <span class="o">=</span> <span class="n">get_operation</span><span class="p">(</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>

        <span class="n">oc_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;runner&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">op_config</span><span class="p">,</span>
            <span class="s2">&quot;default_model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;default_model&quot;</span><span class="p">],</span>
            <span class="s2">&quot;max_threads&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
            <span class="s2">&quot;console&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">operation_instance</span> <span class="o">=</span> <span class="n">operation_class</span><span class="p">(</span><span class="o">**</span><span class="n">oc_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;equijoin&quot;</span><span class="p">:</span>
            <span class="n">output_data</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">operation_instance</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">input_data</span><span class="p">[</span><span class="s2">&quot;left_data&quot;</span><span class="p">],</span> <span class="n">input_data</span><span class="p">[</span><span class="s2">&quot;right_data&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;filter&quot;</span><span class="p">:</span>
            <span class="n">output_data</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">operation_instance</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">is_build</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_data</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">operation_instance</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">total_cost</span> <span class="o">+=</span> <span class="n">cost</span>

        <span class="k">if</span> <span class="n">return_instance</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output_data</span><span class="p">,</span> <span class="n">operation_instance</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_flush_partial_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">operation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">batch_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save partial (batch-level) results from an operation to a directory named</span>
<span class="sd">        &#39;&lt;operation_name&gt;_batches&#39; inside the intermediate directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            operation_name (str): The name of the operation, e.g. &#39;extract_medications&#39;.</span>
<span class="sd">            batch_index (int): Zero-based index of the batch.</span>
<span class="sd">            data (list[dict]): Batch results to write to disk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">op_batches_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">_batches&quot;</span>
        <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">op_batches_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># File name: &#39;batch_0.json&#39;, &#39;batch_1.json&#39;, etc.</span>
        <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">op_batches_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;batch_</span><span class="si">{</span><span class="n">batch_index</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[green][/green] [italic]Partial checkpoint saved for &#39;</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;batch </span><span class="si">{</span><span class="n">batch_index</span><span class="si">}</span><span class="s2"> at &#39;</span><span class="si">{</span><span class="n">checkpoint_path</span><span class="si">}</span><span class="s2">&#39;[/italic]&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="docetl.DSLRunner.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">max_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the DSLRunner with a YAML configuration file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>max_threads</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of threads to use. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>docetl/runner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">max_threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the DSLRunner with a YAML configuration file.</span>

<span class="sd">    Args:</span>
<span class="sd">        max_threads (int, optional): Maximum number of threads to use. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">base_name</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;base_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="n">yaml_file_suffix</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;yaml_file_suffix&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="n">max_threads</span><span class="o">=</span><span class="n">max_threads</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_state</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_setup_parsing_tools</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_setup_retrievers</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_build_operation_graph</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_compute_operation_hashes</span><span class="p">()</span>

    <span class="c1"># Run initial validation</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_from_df_accessors</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;from_df_accessors&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_df_accessors</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">syntax_check</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.DSLRunner.clear_intermediate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clear_intermediate</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Clear the intermediate directory.</p>


            <details class="quote">
              <summary>Source code in <code>docetl/runner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clear_intermediate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clear the intermediate directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Remove the intermediate directory</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Intermediate directory not set. Cannot clear intermediate.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.DSLRunner.load" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Load all datasets defined in the configuration.</p>


            <details class="quote">
              <summary>Source code in <code>docetl/runner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load all datasets defined in the configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[bold]Loading Datasets[/bold]&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dataset_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;datasets&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">dataset_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
            <span class="n">datasets</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">,</span>
                <span class="n">dataset_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span>
                <span class="n">source</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">,</span>
                <span class="n">parsing</span><span class="o">=</span><span class="n">dataset_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parsing&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="n">user_defined_parsing_tool_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parsing_tool_map</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[green][/green] Loaded dataset &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; from </span><span class="si">{</span><span class="n">dataset_config</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">dataset_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
            <span class="n">datasets</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="s2">&quot;memory&quot;</span><span class="p">,</span>
                <span class="n">dataset_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span>
                <span class="n">source</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">,</span>
                <span class="n">parsing</span><span class="o">=</span><span class="n">dataset_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parsing&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="n">user_defined_parsing_tool_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parsing_tool_map</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[green][/green] Loaded dataset &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; from in-memory data&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported dataset type: </span><span class="si">{</span><span class="n">dataset_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">dataset</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.DSLRunner.load_run_save" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_run_save</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Execute the entire pipeline defined in the configuration.</p>


            <details class="quote">
              <summary>Source code in <code>docetl/runner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_run_save</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute the entire pipeline defined in the configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_path</span><span class="p">(</span><span class="n">require</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Print the query plan</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">print_query_plan</span><span class="p">()</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[bold]Pipeline Execution[/bold]&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="c1"># Print execution summary</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Cost: [green]$</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">total_cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">[/green]</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Time: </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="o">+</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Cache: [dim]</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="si">}</span><span class="s2">[/dim]</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span>
            <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Output: [dim]</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">[/dim]&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Panel</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Execution Summary&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_cost</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.DSLRunner.print_query_plan" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">print_query_plan</span><span class="p">(</span><span class="n">show_boundaries</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Print a visual representation of the entire query plan using indentation and arrows.
Operations are color-coded by step to show the pipeline structure while maintaining
dependencies between steps.</p>


            <details class="quote">
              <summary>Source code in <code>docetl/runner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">print_query_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_boundaries</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print a visual representation of the entire query plan using indentation and arrows.</span>
<span class="sd">    Operations are color-coded by step to show the pipeline structure while maintaining</span>
<span class="sd">    dependencies between steps.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold]Pipeline Steps:[/bold]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="n">Panel</span><span class="p">(</span><span class="s2">&quot;No operations in pipeline&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Query Plan&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_print_op</span><span class="p">(</span>
        <span class="n">op</span><span class="p">:</span> <span class="n">OpContainer</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">step_colors</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Handle boundary operations based on show_boundaries flag</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">StepBoundary</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">show_boundaries</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">indent_str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="n">indent</span>
                <span class="n">step_name</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">step_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">step_name</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">][bold]</span><span class="si">{</span><span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[/bold][/</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">Type: step_boundary&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">[yellow][/yellow]&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_print_op</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step_colors</span><span class="p">))</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_print_op</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">indent</span><span class="p">,</span> <span class="n">step_colors</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Build the string for the current operation with indentation</span>
        <span class="n">indent_str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="n">indent</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Color code the operation name based on its step</span>
        <span class="n">step_name</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">step_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">step_name</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">][bold]</span><span class="si">{</span><span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[/bold][/</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">Type: </span><span class="si">{</span><span class="n">op</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Add schema if available</span>
        <span class="k">if</span> <span class="s2">&quot;output&quot;</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="s2">&quot;schema&quot;</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">Output Schema:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">field_type</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">escaped_type</span> <span class="o">=</span> <span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">field_type</span><span class="p">))</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">: [bright_white]</span><span class="si">{</span><span class="n">escaped_type</span><span class="si">}</span><span class="s2">[/bright_white]&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Add children</span>
        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">is_equijoin</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">[yellow] LEFT[/yellow]&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_print_op</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step_colors</span><span class="p">))</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">[yellow] RIGHT[/yellow]&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_print_op</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step_colors</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">[yellow][/yellow]&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_print_op</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step_colors</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="c1"># Get all step boundaries and extract unique step names</span>
    <span class="n">step_boundaries</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">op</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_container_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">StepBoundary</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">step_boundaries</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Create a color map for steps - using distinct colors</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cyan&quot;</span><span class="p">,</span> <span class="s2">&quot;magenta&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">]</span>
    <span class="n">step_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">step_boundaries</span><span class="p">]</span>
    <span class="n">step_colors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">step_names</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># Print the legend</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold]Pipeline Steps:[/bold]&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">step_name</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">step_colors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">][/</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Print the full query plan starting from the last step boundary</span>
    <span class="n">query_plan</span> <span class="o">=</span> <span class="n">_print_op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">,</span> <span class="n">step_colors</span><span class="o">=</span><span class="n">step_colors</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Panel</span><span class="p">(</span><span class="n">query_plan</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Query Plan&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.DSLRunner.save" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Save the final output of the pipeline.</p>


            <details class="quote">
              <summary>Source code in <code>docetl/runner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the final output of the pipeline.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">get_output_path</span><span class="p">(</span><span class="n">require</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">output_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">output_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
        <span class="c1"># Create the directory if it doesn&#39;t exist</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># CSV</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">limited_data</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span>
                <span class="p">]</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">limited_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[green][/green] Saved to [dim]</span><span class="si">{</span><span class="n">output_config</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">[/dim]</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unsupported output type: </span><span class="si">{</span><span class="n">output_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. Supported types: file&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.DSLRunner.syntax_check" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">syntax_check</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Perform a syntax check on all operations defined in the configuration.</p>


            <details class="quote">
              <summary>Source code in <code>docetl/runner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">syntax_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform a syntax check on all operations defined in the configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[yellow]Checking operations...[/yellow]&quot;</span><span class="p">)</span>

    <span class="c1"># Just validate that it&#39;s a json file if specified</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">get_output_path</span><span class="p">()</span>
    <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Walk the last op container to check syntax</span>
        <span class="n">op_containers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">:</span>
            <span class="n">op_containers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">]</span>

        <span class="k">while</span> <span class="n">op_containers</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">op_containers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">syntax_result</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">syntax_check</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">syntax_result</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="c1"># Add all children to the queue</span>
            <span class="n">op_containers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Syntax check failed for operation &#39;</span><span class="si">{</span><span class="n">current</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[green] All operations passed syntax check[/green]&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="docetl.Optimizer" class="doc doc-heading">
            <code>docetl.Optimizer</code>


</h3>


    <div class="doc doc-contents first">


        <p>Orchestrates the optimization of a DocETL pipeline by analyzing and potentially rewriting
operations marked for optimization. Works with the runner's pull-based execution model
to maintain lazy evaluation while improving pipeline efficiency.</p>







              <details class="quote">
                <summary>Source code in <code>docetl/optimizer.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Optimizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Orchestrates the optimization of a DocETL pipeline by analyzing and potentially rewriting</span>
<span class="sd">    operations marked for optimization. Works with the runner&#39;s pull-based execution model</span>
<span class="sd">    to maintain lazy evaluation while improving pipeline efficiency.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">runner</span><span class="p">:</span> <span class="s2">&quot;DSLRunner&quot;</span><span class="p">,</span>
        <span class="n">rewrite_agent_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gpt-5.1&quot;</span><span class="p">,</span>
        <span class="n">judge_agent_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span>
        <span class="n">litellm_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">resume</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the optimizer with a runner instance and configuration.</span>
<span class="sd">        Sets up optimization parameters, caching, and cost tracking.</span>

<span class="sd">        Args:</span>
<span class="sd">            yaml_file (str): Path to the YAML configuration file.</span>
<span class="sd">            model (str): The name of the language model to use. Defaults to &quot;gpt-5.1&quot;.</span>
<span class="sd">            resume (bool): Whether to resume optimization from a previous run. Defaults to False.</span>
<span class="sd">            timeout (int): Timeout in seconds for operations. Defaults to 60.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            config (Dict): Stores the loaded configuration from the YAML file.</span>
<span class="sd">            console (Console): Rich console for formatted output.</span>
<span class="sd">            max_threads (int): Maximum number of threads for parallel processing.</span>
<span class="sd">            base_name (str): Base name used for file paths.</span>
<span class="sd">            yaml_file_suffix (str): Suffix for YAML configuration files.</span>
<span class="sd">            runner (DSLRunner): The DSL runner instance.</span>
<span class="sd">            status: Status tracking for the runner.</span>
<span class="sd">            optimized_config (Dict): A copy of the original config to be optimized.</span>
<span class="sd">            llm_client (LLMClient): Client for interacting with the language model.</span>
<span class="sd">            timeout (int): Timeout for operations in seconds.</span>
<span class="sd">            resume (bool): Whether to resume from previous optimization.</span>
<span class="sd">            captured_output (CapturedOutput): Captures output during optimization.</span>
<span class="sd">            sample_cache (Dict): Maps operation names to tuples of (output_data, sample_size).</span>
<span class="sd">            optimized_ops_path (str): Path to store optimized operations.</span>
<span class="sd">            sample_size_map (Dict): Maps operation types to sample sizes.</span>

<span class="sd">        The method also calls print_optimizer_config() to display the initial configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">console</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">max_threads</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">base_name</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">base_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yaml_file_suffix</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">yaml_file_suffix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span> <span class="o">=</span> <span class="n">runner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># Get the rate limits from the optimizer config</span>
        <span class="n">rate_limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rate_limits&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span> <span class="o">=</span> <span class="n">LLMClient</span><span class="p">(</span>
            <span class="n">runner</span><span class="p">,</span>
            <span class="n">rewrite_agent_model</span><span class="p">,</span>
            <span class="n">judge_agent_model</span><span class="p">,</span>
            <span class="n">rate_limits</span><span class="p">,</span>
            <span class="o">**</span><span class="n">litellm_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">resume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">captured_output</span> <span class="o">=</span> <span class="n">CapturedOutput</span><span class="p">()</span>

        <span class="c1"># Add sample cache for build operations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Maps operation names to (output_data, sample_size)</span>

        <span class="n">home_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DOCETL_HOME_DIR&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">))</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;.docetl/cache/</span><span class="si">{</span><span class="n">runner</span><span class="o">.</span><span class="n">yaml_file_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Hash the config to create a unique identifier</span>
        <span class="n">config_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimized_ops_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cache_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">config_hash</span><span class="si">}</span><span class="s2">.yaml&quot;</span>

        <span class="c1"># Update sample size map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_size_map</span> <span class="o">=</span> <span class="n">SAMPLE_SIZE_MAP</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sample_sizes&quot;</span><span class="p">,</span> <span class="p">{}):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_size_map</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">][</span><span class="s2">&quot;sample_sizes&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">_from_df_accessors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_optimizer_config</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">print_optimizer_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print the current configuration of the optimizer.</span>

<span class="sd">        This method uses the Rich console to display a formatted output of the optimizer&#39;s</span>
<span class="sd">        configuration. It includes details such as the YAML file path, sample sizes for</span>
<span class="sd">        different operation types, maximum number of threads, the language model being used,</span>
<span class="sd">        and the timeout setting.</span>

<span class="sd">        The output is color-coded and formatted for easy readability, with a header and</span>
<span class="sd">        separator lines to clearly delineate the configuration information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="n">Panel</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="s2">&quot;[bold cyan]Optimizer Configuration[/bold cyan]</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;[yellow]Sample Size:[/yellow] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_size_map</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;[yellow]Max Threads:[/yellow] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;[yellow]Rewrite Agent Model:[/yellow] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">rewrite_agent_model</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;[yellow]Judge Agent Model:[/yellow] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">judge_agent_model</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;[yellow]Rate Limits:[/yellow] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optimizer_config&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rate_limits&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{})</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Optimizer Configuration&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_insert_empty_resolve_operations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines whether to insert resolve operations in the pipeline.</span>

<span class="sd">        For each reduce operation in the tree, checks if it has any map operation as a descendant</span>
<span class="sd">        without a resolve operation in between. If found, inserts an empty resolve operation</span>
<span class="sd">        right after the reduce operation.</span>

<span class="sd">        The method modifies the operation container tree in-place.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">find_map_without_resolve</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">visited</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Helper to find first map descendant without a resolve operation in between.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">visited</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;map&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">child</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;resolve&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">map_desc</span> <span class="o">=</span> <span class="n">find_map_without_resolve</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">visited</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">map_desc</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">map_desc</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Walk down the operation container tree</span>
        <span class="n">containers_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">containers_to_check</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">containers_to_check</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Skip if this is a boundary or has no children</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">StepBoundary</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">current</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">containers_to_check</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Get the step name from the container&#39;s name</span>
            <span class="n">step_name</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Check if current container is a reduce operation</span>
            <span class="k">if</span> <span class="n">current</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;reduce&quot;</span> <span class="ow">and</span> <span class="n">current</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;synthesize_resolve&quot;</span><span class="p">,</span> <span class="kc">True</span>
            <span class="p">):</span>
                <span class="n">reduce_key</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">,</span> <span class="s2">&quot;_all&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reduce_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">reduce_key</span> <span class="o">=</span> <span class="p">[</span><span class="n">reduce_key</span><span class="p">]</span>

                <span class="k">if</span> <span class="s2">&quot;_all&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reduce_key</span><span class="p">:</span>
                    <span class="c1"># Find map descendant without resolve</span>
                    <span class="n">map_desc</span> <span class="o">=</span> <span class="n">find_map_without_resolve</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">map_desc</span><span class="p">:</span>
                        <span class="c1"># Synthesize an empty resolver</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="s2">&quot;[yellow]Synthesizing empty resolver operation:[/yellow]&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;   [cyan]Reduce operation:[/cyan] [bold]</span><span class="si">{</span><span class="n">current</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[/bold]&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;   [cyan]Step:[/cyan] [bold]</span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">[/bold]&quot;</span>
                        <span class="p">)</span>

                        <span class="c1"># Create new resolve operation config</span>
                        <span class="n">new_resolve_name</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;synthesized_resolve_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;operations&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">new_resolve_config</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">new_resolve_name</span><span class="p">,</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;resolve&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;empty&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="s2">&quot;optimize&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="s2">&quot;embedding_model&quot;</span><span class="p">:</span> <span class="s2">&quot;text-embedding-3-small&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;resolution_model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;default_model&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4o-mini&quot;</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;comparison_model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;default_model&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4o-mini&quot;</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;_intermediates&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s2">&quot;map_prompt&quot;</span><span class="p">:</span> <span class="n">map_desc</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prompt&quot;</span><span class="p">),</span>
                                <span class="s2">&quot;reduce_key&quot;</span><span class="p">:</span> <span class="n">reduce_key</span><span class="p">,</span>
                            <span class="p">},</span>
                        <span class="p">}</span>

                        <span class="c1"># Add to operations list</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_resolve_config</span><span class="p">)</span>

                        <span class="c1"># Create new resolve container</span>
                        <span class="n">new_resolve_container</span> <span class="o">=</span> <span class="n">OpContainer</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">new_resolve_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
                            <span class="n">new_resolve_config</span><span class="p">,</span>
                        <span class="p">)</span>

                        <span class="c1"># Insert the new container between reduce and its children</span>
                        <span class="n">new_resolve_container</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">children</span>
                        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">new_resolve_container</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                            <span class="n">child</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">new_resolve_container</span>
                        <span class="n">current</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_resolve_container</span><span class="p">]</span>
                        <span class="n">new_resolve_container</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">current</span>

                        <span class="c1"># Add to container map</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">op_container_map</span><span class="p">[</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">new_resolve_name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">new_resolve_container</span>

                        <span class="c1"># Add children to the queue</span>
                        <span class="n">containers_to_check</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_resolve_container</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_map_prompts_to_reduce_operations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add relevant map prompts to reduce operations based on their reduce keys.</span>

<span class="sd">        This method walks the operation container tree to find map operations and their</span>
<span class="sd">        output schemas, then associates those with reduce operations that use those keys.</span>
<span class="sd">        When a reduce operation is found, it looks through its descendants to find the</span>
<span class="sd">        relevant map operations and adds their prompts.</span>

<span class="sd">        The method modifies the operation container tree in-place.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">find_map_prompts_for_keys</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">visited</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Helper to find map prompts for given keys in the container&#39;s descendants.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">visited</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="n">prompts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;map&quot;</span><span class="p">:</span>
                <span class="n">output_schema</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">output_schema</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">):</span>
                    <span class="n">prompts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prompt&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">prompts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">find_map_prompts_for_keys</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">visited</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">prompts</span>

        <span class="c1"># Walk down the operation container tree</span>
        <span class="n">containers_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">containers_to_check</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">containers_to_check</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Skip if this is a boundary or has no children</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">StepBoundary</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">current</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">containers_to_check</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># If this is a reduce operation, find relevant map prompts</span>
            <span class="k">if</span> <span class="n">current</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;reduce&quot;</span><span class="p">:</span>
                <span class="n">reduce_keys</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reduce_keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">reduce_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">reduce_keys</span><span class="p">]</span>

                <span class="c1"># Find map prompts in descendants</span>
                <span class="n">relevant_prompts</span> <span class="o">=</span> <span class="n">find_map_prompts_for_keys</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">reduce_keys</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">relevant_prompts</span><span class="p">:</span>
                    <span class="n">current</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_intermediates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;_intermediates&quot;</span><span class="p">,</span> <span class="p">{}</span>
                    <span class="p">)</span>
                    <span class="n">current</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_intermediates&quot;</span><span class="p">][</span><span class="s2">&quot;last_map_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">relevant_prompts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">)</span>

            <span class="c1"># Add children to the queue</span>
            <span class="n">containers_to_check</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">should_optimize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">step_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">op_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyzes whether an operation should be optimized by running it on a sample of input data</span>
<span class="sd">        and evaluating potential optimizations. Returns the optimization suggestion and relevant data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[bold cyan]Beginning Pipeline Assessment[/bold cyan]&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_insert_empty_resolve_operations</span><span class="p">()</span>

        <span class="n">node_of_interest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">op_container_map</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">op_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

        <span class="c1"># Run the node_of_interest&#39;s children</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node_of_interest</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">input_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">child</span><span class="o">.</span><span class="n">next</span><span class="p">(</span>
                    <span class="n">is_build</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">sample_size_needed</span><span class="o">=</span><span class="n">SAMPLE_SIZE_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]),</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># Set the step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">captured_output</span><span class="o">.</span><span class="n">set_step</span><span class="p">(</span><span class="n">step_name</span><span class="p">)</span>

        <span class="c1"># Determine whether we should optimize the node_of_interest</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">node_of_interest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;map&quot;</span>
            <span class="ow">or</span> <span class="n">node_of_interest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;filter&quot;</span>
        <span class="p">):</span>
            <span class="c1"># Create instance of map optimizer</span>
            <span class="n">map_optimizer</span> <span class="o">=</span> <span class="n">MapOptimizer</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">_run_operation</span><span class="p">,</span>
                <span class="n">is_filter</span><span class="o">=</span><span class="n">node_of_interest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;filter&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">should_optimize_output</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">output_data</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">map_optimizer</span><span class="o">.</span><span class="n">should_optimize</span><span class="p">(</span><span class="n">node_of_interest</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">node_of_interest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;reduce&quot;</span><span class="p">:</span>
            <span class="n">reduce_optimizer</span> <span class="o">=</span> <span class="n">ReduceOptimizer</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">_run_operation</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">should_optimize_output</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">output_data</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">reduce_optimizer</span><span class="o">.</span><span class="n">should_optimize</span><span class="p">(</span><span class="n">node_of_interest</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">node_of_interest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;resolve&quot;</span><span class="p">:</span>
            <span class="n">resolve_optimizer</span> <span class="o">=</span> <span class="n">JoinOptimizer</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
                <span class="n">node_of_interest</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                <span class="n">target_recall</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolve&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_recall&quot;</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">should_optimize_output</span> <span class="o">=</span> <span class="n">resolve_optimizer</span><span class="o">.</span><span class="n">should_optimize</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># if should_optimize_output is empty, then we should move to the reduce operation</span>
            <span class="k">if</span> <span class="n">should_optimize_output</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">0.0</span>

        <span class="c1"># Return the string and operation cost</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">should_optimize_output</span><span class="p">,</span>
            <span class="n">input_data</span><span class="p">,</span>
            <span class="n">output_data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">total_cost</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">total_cost</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimizes the entire pipeline by walking the operation DAG and applying</span>
<span class="sd">        operation-specific optimizers where marked. Returns the total optimization cost.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[bold cyan]Beginning Pipeline Rewrites[/bold cyan]&quot;</span><span class="p">)</span>

        <span class="c1"># If self.resume is True and there&#39;s a checkpoint, load it</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimized_ops_path</span><span class="p">):</span>
                <span class="c1"># Load the yaml and change the runner with it</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimized_ops_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">partial_optimized_config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="s2">&quot;[yellow]Loading partially optimized pipeline from checkpoint...[/yellow]&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">_build_operation_graph</span><span class="p">(</span><span class="n">partial_optimized_config</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s2">&quot;[yellow]No checkpoint found, starting optimization from scratch...[/yellow]&quot;</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insert_empty_resolve_operations</span><span class="p">()</span>

        <span class="c1"># Start with the last operation container and visit each child</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">last_op_container</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>

        <span class="n">flush_cache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">)</span>

        <span class="c1"># Print the query plan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[bold cyan]Optimized Query Plan[/bold cyan]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">print_query_plan</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">total_cost</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_optimize_equijoin</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">left_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">right_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">left_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">right_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">run_operation</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
            <span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
        <span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimizes an equijoin operation by analyzing join conditions and potentially inserting</span>
<span class="sd">        map operations to improve join efficiency. Returns the optimized configuration and updated data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">new_left_name</span> <span class="o">=</span> <span class="n">left_name</span>
        <span class="n">new_right_name</span> <span class="o">=</span> <span class="n">right_name</span>
        <span class="n">new_steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
            <span class="n">join_optimizer</span> <span class="o">=</span> <span class="n">JoinOptimizer</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
                <span class="n">op_config</span><span class="p">,</span>
                <span class="n">target_recall</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;equijoin&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_recall&quot;</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
                <span class="n">estimated_selectivity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;equijoin&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;estimated_selectivity&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">optimized_config</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">agent_results</span> <span class="o">=</span> <span class="n">join_optimizer</span><span class="o">.</span><span class="n">optimize_equijoin</span><span class="p">(</span>
                <span class="n">left_data</span><span class="p">,</span> <span class="n">right_data</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">total_cost</span> <span class="o">+=</span> <span class="n">cost</span>
            <span class="c1"># Update the operation config with the optimized values</span>
            <span class="n">op_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">optimized_config</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimize_map&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">break</span>  <span class="c1"># Exit the loop if no more map optimizations are necessary</span>

            <span class="c1"># Update the status to indicate we&#39;re optimizing a map operation</span>
            <span class="n">output_key</span> <span class="o">=</span> <span class="n">agent_results</span><span class="p">[</span><span class="s2">&quot;output_key&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Optimizing map operation for </span><span class="si">{</span><span class="n">output_key</span><span class="si">}</span><span class="s2"> extraction to help with the equijoin&quot;</span>
                <span class="p">)</span>
            <span class="n">map_prompt</span> <span class="o">=</span> <span class="n">agent_results</span><span class="p">[</span><span class="s2">&quot;map_prompt&quot;</span><span class="p">]</span>
            <span class="n">dataset_to_transform</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">left_data</span>
                <span class="k">if</span> <span class="n">agent_results</span><span class="p">[</span><span class="s2">&quot;dataset_to_transform&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span>
                <span class="k">else</span> <span class="n">right_data</span>
            <span class="p">)</span>

            <span class="c1"># Create a new step for the map operation</span>
            <span class="n">map_operation</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;synthesized_</span><span class="si">{</span><span class="n">output_key</span><span class="si">}</span><span class="s2">_extraction&quot;</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;map&quot;</span><span class="p">,</span>
                <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">map_prompt</span><span class="p">,</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_model&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">),</span>
                <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">output_key</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}},</span>
                <span class="s2">&quot;optimize&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># Optimize the map operation</span>
            <span class="k">if</span> <span class="n">map_operation</span><span class="p">[</span><span class="s2">&quot;optimize&quot;</span><span class="p">]:</span>
                <span class="n">dataset_to_transform_sample</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">dataset_to_transform</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;map&quot;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;random_sample&quot;</span><span class="p">,</span> <span class="kc">False</span>
                    <span class="p">)</span>
                    <span class="k">else</span> <span class="n">dataset_to_transform</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;map&quot;</span><span class="p">)]</span>
                <span class="p">)</span>
                <span class="n">optimized_map_operations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_map</span><span class="p">(</span>
                    <span class="n">map_operation</span><span class="p">,</span> <span class="n">dataset_to_transform_sample</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">optimized_map_operations</span> <span class="o">=</span> <span class="p">[</span><span class="n">map_operation</span><span class="p">]</span>

            <span class="n">new_step</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;synthesized_</span><span class="si">{</span><span class="n">output_key</span><span class="si">}</span><span class="s2">_extraction&quot;</span><span class="p">,</span>
                <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">left_name</span>
                    <span class="k">if</span> <span class="n">agent_results</span><span class="p">[</span><span class="s2">&quot;dataset_to_transform&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span>
                    <span class="k">else</span> <span class="n">right_name</span>
                <span class="p">),</span>
                <span class="s2">&quot;operations&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">mo</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">mo</span> <span class="ow">in</span> <span class="n">optimized_map_operations</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">agent_results</span><span class="p">[</span><span class="s2">&quot;dataset_to_transform&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span><span class="p">:</span>
                <span class="n">new_left_name</span> <span class="o">=</span> <span class="n">new_step</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_right_name</span> <span class="o">=</span> <span class="n">new_step</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

            <span class="n">new_steps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">new_step</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">new_step</span><span class="p">,</span> <span class="n">optimized_map_operations</span><span class="p">))</span>

            <span class="c1"># Now run the optimized map operation on the entire dataset_to_transform</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">optimized_map_operations</span><span class="p">:</span>
                <span class="n">dataset_to_transform</span> <span class="o">=</span> <span class="n">run_operation</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">dataset_to_transform</span><span class="p">)</span>

            <span class="c1"># Update the appropriate dataset for the next iteration</span>
            <span class="k">if</span> <span class="n">agent_results</span><span class="p">[</span><span class="s2">&quot;dataset_to_transform&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span><span class="p">:</span>
                <span class="n">left_data</span> <span class="o">=</span> <span class="n">dataset_to_transform</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">right_data</span> <span class="o">=</span> <span class="n">dataset_to_transform</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Optimizing equijoin operation with </span><span class="si">{</span><span class="n">output_key</span><span class="si">}</span><span class="s2"> extraction&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">op_config</span><span class="p">,</span> <span class="n">new_steps</span><span class="p">,</span> <span class="n">new_left_name</span><span class="p">,</span> <span class="n">new_right_name</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">checkpoint_optimized_ops</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the clean config and saves it to the self.optimized_ops_path</span>
<span class="sd">        This is used to resume optimization from a previous run</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clean_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_optimized_config</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimized_ops_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="n">clean_config</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>

    <span class="c1"># Recursively resolve all anchors and aliases</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolve_anchors</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively resolve all anchors and aliases in a nested data structure.</span>

<span class="sd">        This static method traverses through dictionaries and lists, resolving any YAML anchors and aliases.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The data structure to resolve. Can be a dictionary, list, or any other type.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The resolved data structure with all anchors and aliases replaced by their actual values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">Optimizer</span><span class="o">.</span><span class="n">resolve_anchors</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">Optimizer</span><span class="o">.</span><span class="n">resolve_anchors</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clean_optimized_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a clean YAML configuration from the optimized operation containers,</span>
<span class="sd">        removing internal fields and organizing operations into proper pipeline steps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>

        <span class="c1"># Create a clean copy of the config</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">dataset_name</span><span class="p">,</span> <span class="n">dataset_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;datasets&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">dataset_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
                <span class="n">dataset_config_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dataset_config</span><span class="p">)</span>
                <span class="n">dataset_config_copy</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;in-memory data&quot;</span>
                <span class="n">datasets</span><span class="p">[</span><span class="n">dataset_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset_config_copy</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">datasets</span><span class="p">[</span><span class="n">dataset_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset_config</span>

        <span class="n">clean_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;datasets&quot;</span><span class="p">:</span> <span class="n">datasets</span><span class="p">,</span>
            <span class="s2">&quot;operations&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;pipeline&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;pipeline&quot;</span><span class="p">,</span> <span class="p">{}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>  <span class="c1"># Copy entire pipeline config</span>
        <span class="p">}</span>

        <span class="c1"># Reset steps to regenerate</span>
        <span class="n">clean_config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Keep track of operations we&#39;ve seen to avoid duplicates</span>
        <span class="n">seen_operations</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">clean_operation</span><span class="p">(</span><span class="n">op_container</span><span class="p">:</span> <span class="n">OpContainer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Remove internal fields from operation config&quot;&quot;&quot;</span>
            <span class="n">op_config</span> <span class="o">=</span> <span class="n">op_container</span><span class="o">.</span><span class="n">config</span>
            <span class="n">clean_op</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">op_config</span><span class="p">)</span>

            <span class="n">clean_op</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_intermediates&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># If op has already been optimized, remove the recursively_optimize and optimize fields</span>
            <span class="k">if</span> <span class="n">op_container</span><span class="o">.</span><span class="n">is_optimized</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;recursively_optimize&quot;</span><span class="p">,</span> <span class="s2">&quot;optimize&quot;</span><span class="p">]:</span>
                    <span class="n">clean_op</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">clean_op</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">process_container</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">current_step</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Process an operation container and its dependencies&quot;&quot;&quot;</span>
            <span class="c1"># Skip step boundaries</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">StepBoundary</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">process_container</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">current_step</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

            <span class="c1"># Get step name from container name</span>
            <span class="n">step_name</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># If this is a new step, create it</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">current_step</span> <span class="ow">or</span> <span class="n">current_step</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">step_name</span><span class="p">:</span>
                <span class="n">current_step</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">step_name</span><span class="p">,</span> <span class="s2">&quot;operations&quot;</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="n">clean_config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">current_step</span><span class="p">)</span>

            <span class="c1"># Skip scan operations but process their dependencies</span>
            <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;scan&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">process_container</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">current_step</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">current_step</span>

            <span class="c1"># Handle equijoin operations</span>
            <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">is_equijoin</span><span class="p">:</span>
                <span class="c1"># Add operation to list if not seen</span>
                <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_operations</span><span class="p">:</span>
                    <span class="n">op_config</span> <span class="o">=</span> <span class="n">clean_operation</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>
                    <span class="n">clean_config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op_config</span><span class="p">)</span>
                    <span class="n">seen_operations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="c1"># Add to step operations with left and right inputs</span>
                <span class="n">current_step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="n">container</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="p">{</span>
                            <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="n">container</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;left_name&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="n">container</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;right_name&quot;</span><span class="p">],</span>
                        <span class="p">}</span>
                    <span class="p">},</span>
                <span class="p">)</span>

                <span class="c1"># Process both children</span>
                <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">process_container</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">current_step</span><span class="p">)</span>
                    <span class="n">process_container</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">current_step</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Add operation to list if not seen</span>
                <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_operations</span><span class="p">:</span>
                    <span class="n">op_config</span> <span class="o">=</span> <span class="n">clean_operation</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>
                    <span class="n">clean_config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op_config</span><span class="p">)</span>
                    <span class="n">seen_operations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="c1"># Add to step operations</span>
                <span class="n">current_step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">container</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

                <span class="c1"># Process children</span>
                <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                        <span class="n">process_container</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">current_step</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">container</span><span class="p">,</span> <span class="n">current_step</span>

        <span class="c1"># Start processing from the last container</span>
        <span class="n">process_container</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">)</span>

        <span class="c1"># Add inputs to steps based on their first operation</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">clean_config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]:</span>
            <span class="n">first_op</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first_op</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="c1"># This is an equijoin</span>
                <span class="k">continue</span>  <span class="c1"># Equijoin steps don&#39;t need an input field</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Find the first non-scan operation&#39;s input by looking at its dependencies</span>
                <span class="n">op_container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">op_container_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">first_op</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">op_container</span> <span class="ow">and</span> <span class="n">op_container</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">child</span> <span class="o">=</span> <span class="n">op_container</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">while</span> <span class="p">(</span>
                        <span class="n">child</span>
                        <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;step_boundary&quot;</span>
                        <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">children</span>
                    <span class="p">):</span>
                        <span class="n">child</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">child</span> <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;scan&quot;</span><span class="p">:</span>
                        <span class="n">step</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dataset_name&quot;</span><span class="p">]</span>

        <span class="c1"># Preserve all other config key-value pairs from original config</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;datasets&quot;</span><span class="p">,</span> <span class="s2">&quot;operations&quot;</span><span class="p">,</span> <span class="s2">&quot;pipeline&quot;</span><span class="p">]:</span>
                <span class="n">clean_config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">clean_config</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_optimized_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optimized_config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the optimized configuration to a YAML file after resolving all references</span>
<span class="sd">        and cleaning up internal optimization artifacts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resolved_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_optimized_config</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">optimized_config_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="n">resolved_config</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[green italic] Optimized config saved to </span><span class="si">{</span><span class="n">optimized_config_path</span><span class="si">}</span><span class="s2">[/green italic]&quot;</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="docetl.Optimizer.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">rewrite_agent_model</span><span class="o">=</span><span class="s1">&#39;gpt-5.1&#39;</span><span class="p">,</span> <span class="n">judge_agent_model</span><span class="o">=</span><span class="s1">&#39;gpt-4o-mini&#39;</span><span class="p">,</span> <span class="n">litellm_kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">resume</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the optimizer with a runner instance and configuration.
Sets up optimization parameters, caching, and cost tracking.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>yaml_file</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the YAML configuration file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the language model to use. Defaults to "gpt-5.1".</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resume</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to resume optimization from a previous run. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timeout</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timeout in seconds for operations. Defaults to 60.</p>
              </div>
            </td>
            <td>
                  <code>60</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.config">config</span></code></td>
            <td>
                  <code><span title="Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stores the loaded configuration from the YAML file.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.console">console</span></code></td>
            <td>
                  <code><span title="Console">Console</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Rich console for formatted output.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.max_threads">max_threads</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of threads for parallel processing.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.base_name">base_name</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base name used for file paths.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.yaml_file_suffix">yaml_file_suffix</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Suffix for YAML configuration files.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.runner">runner</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="docetl.DSLRunner (docetl.runner.DSLRunner)" href="#docetl.DSLRunner">DSLRunner</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The DSL runner instance.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.status">status</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="docetl.DSLRunner (docetl.runner.DSLRunner)" href="#docetl.DSLRunner">DSLRunner</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Status tracking for the runner.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.optimized_config">optimized_config</span></code></td>
            <td>
                  <code><span title="Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A copy of the original config to be optimized.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.llm_client">llm_client</span></code></td>
            <td>
                  <code><span title="docetl.optimizers.utils.LLMClient">LLMClient</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Client for interacting with the language model.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.timeout">timeout</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timeout for operations in seconds.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.resume">resume</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to resume from previous optimization.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.captured_output">captured_output</span></code></td>
            <td>
                  <code><span title="docetl.utils.CapturedOutput">CapturedOutput</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Captures output during optimization.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.sample_cache">sample_cache</span></code></td>
            <td>
                  <code><span title="Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maps operation names to tuples of (output_data, sample_size).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.optimized_ops_path">optimized_ops_path</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to store optimized operations.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.sample_size_map">sample_size_map</span></code></td>
            <td>
                  <code><span title="Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maps operation types to sample sizes.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>The method also calls print_optimizer_config() to display the initial configuration.</p>


            <details class="quote">
              <summary>Source code in <code>docetl/optimizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">runner</span><span class="p">:</span> <span class="s2">&quot;DSLRunner&quot;</span><span class="p">,</span>
    <span class="n">rewrite_agent_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gpt-5.1&quot;</span><span class="p">,</span>
    <span class="n">judge_agent_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span>
    <span class="n">litellm_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">resume</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the optimizer with a runner instance and configuration.</span>
<span class="sd">    Sets up optimization parameters, caching, and cost tracking.</span>

<span class="sd">    Args:</span>
<span class="sd">        yaml_file (str): Path to the YAML configuration file.</span>
<span class="sd">        model (str): The name of the language model to use. Defaults to &quot;gpt-5.1&quot;.</span>
<span class="sd">        resume (bool): Whether to resume optimization from a previous run. Defaults to False.</span>
<span class="sd">        timeout (int): Timeout in seconds for operations. Defaults to 60.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        config (Dict): Stores the loaded configuration from the YAML file.</span>
<span class="sd">        console (Console): Rich console for formatted output.</span>
<span class="sd">        max_threads (int): Maximum number of threads for parallel processing.</span>
<span class="sd">        base_name (str): Base name used for file paths.</span>
<span class="sd">        yaml_file_suffix (str): Suffix for YAML configuration files.</span>
<span class="sd">        runner (DSLRunner): The DSL runner instance.</span>
<span class="sd">        status: Status tracking for the runner.</span>
<span class="sd">        optimized_config (Dict): A copy of the original config to be optimized.</span>
<span class="sd">        llm_client (LLMClient): Client for interacting with the language model.</span>
<span class="sd">        timeout (int): Timeout for operations in seconds.</span>
<span class="sd">        resume (bool): Whether to resume from previous optimization.</span>
<span class="sd">        captured_output (CapturedOutput): Captures output during optimization.</span>
<span class="sd">        sample_cache (Dict): Maps operation names to tuples of (output_data, sample_size).</span>
<span class="sd">        optimized_ops_path (str): Path to store optimized operations.</span>
<span class="sd">        sample_size_map (Dict): Maps operation types to sample sizes.</span>

<span class="sd">    The method also calls print_optimizer_config() to display the initial configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">console</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">max_threads</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">base_name</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">base_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">yaml_file_suffix</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">yaml_file_suffix</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">runner</span> <span class="o">=</span> <span class="n">runner</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># Get the rate limits from the optimizer config</span>
    <span class="n">rate_limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rate_limits&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span> <span class="o">=</span> <span class="n">LLMClient</span><span class="p">(</span>
        <span class="n">runner</span><span class="p">,</span>
        <span class="n">rewrite_agent_model</span><span class="p">,</span>
        <span class="n">judge_agent_model</span><span class="p">,</span>
        <span class="n">rate_limits</span><span class="p">,</span>
        <span class="o">**</span><span class="n">litellm_kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">resume</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">captured_output</span> <span class="o">=</span> <span class="n">CapturedOutput</span><span class="p">()</span>

    <span class="c1"># Add sample cache for build operations</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sample_cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Maps operation names to (output_data, sample_size)</span>

    <span class="n">home_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DOCETL_HOME_DIR&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">))</span>
    <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;.docetl/cache/</span><span class="si">{</span><span class="n">runner</span><span class="o">.</span><span class="n">yaml_file_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Hash the config to create a unique identifier</span>
    <span class="n">config_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">optimized_ops_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cache_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">config_hash</span><span class="si">}</span><span class="s2">.yaml&quot;</span>

    <span class="c1"># Update sample size map</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sample_size_map</span> <span class="o">=</span> <span class="n">SAMPLE_SIZE_MAP</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sample_sizes&quot;</span><span class="p">,</span> <span class="p">{}):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_size_map</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">][</span><span class="s2">&quot;sample_sizes&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">_from_df_accessors</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_optimizer_config</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.Optimizer.checkpoint_optimized_ops" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">checkpoint_optimized_ops</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Generates the clean config and saves it to the self.optimized_ops_path
This is used to resume optimization from a previous run</p>


            <details class="quote">
              <summary>Source code in <code>docetl/optimizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">checkpoint_optimized_ops</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the clean config and saves it to the self.optimized_ops_path</span>
<span class="sd">    This is used to resume optimization from a previous run</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clean_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_optimized_config</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimized_ops_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="n">clean_config</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.Optimizer.clean_optimized_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clean_optimized_config</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Creates a clean YAML configuration from the optimized operation containers,
removing internal fields and organizing operations into proper pipeline steps.</p>


            <details class="quote">
              <summary>Source code in <code>docetl/optimizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clean_optimized_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a clean YAML configuration from the optimized operation containers,</span>
<span class="sd">    removing internal fields and organizing operations into proper pipeline steps.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>

    <span class="c1"># Create a clean copy of the config</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">dataset_name</span><span class="p">,</span> <span class="n">dataset_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;datasets&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">dataset_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
            <span class="n">dataset_config_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dataset_config</span><span class="p">)</span>
            <span class="n">dataset_config_copy</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;in-memory data&quot;</span>
            <span class="n">datasets</span><span class="p">[</span><span class="n">dataset_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset_config_copy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">datasets</span><span class="p">[</span><span class="n">dataset_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset_config</span>

    <span class="n">clean_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;datasets&quot;</span><span class="p">:</span> <span class="n">datasets</span><span class="p">,</span>
        <span class="s2">&quot;operations&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;pipeline&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;pipeline&quot;</span><span class="p">,</span> <span class="p">{}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>  <span class="c1"># Copy entire pipeline config</span>
    <span class="p">}</span>

    <span class="c1"># Reset steps to regenerate</span>
    <span class="n">clean_config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Keep track of operations we&#39;ve seen to avoid duplicates</span>
    <span class="n">seen_operations</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clean_operation</span><span class="p">(</span><span class="n">op_container</span><span class="p">:</span> <span class="n">OpContainer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove internal fields from operation config&quot;&quot;&quot;</span>
        <span class="n">op_config</span> <span class="o">=</span> <span class="n">op_container</span><span class="o">.</span><span class="n">config</span>
        <span class="n">clean_op</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">op_config</span><span class="p">)</span>

        <span class="n">clean_op</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_intermediates&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># If op has already been optimized, remove the recursively_optimize and optimize fields</span>
        <span class="k">if</span> <span class="n">op_container</span><span class="o">.</span><span class="n">is_optimized</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;recursively_optimize&quot;</span><span class="p">,</span> <span class="s2">&quot;optimize&quot;</span><span class="p">]:</span>
                <span class="n">clean_op</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">clean_op</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_container</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">current_step</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process an operation container and its dependencies&quot;&quot;&quot;</span>
        <span class="c1"># Skip step boundaries</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">StepBoundary</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">process_container</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">current_step</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Get step name from container name</span>
        <span class="n">step_name</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># If this is a new step, create it</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">current_step</span> <span class="ow">or</span> <span class="n">current_step</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">step_name</span><span class="p">:</span>
            <span class="n">current_step</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">step_name</span><span class="p">,</span> <span class="s2">&quot;operations&quot;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="n">clean_config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">current_step</span><span class="p">)</span>

        <span class="c1"># Skip scan operations but process their dependencies</span>
        <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;scan&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">process_container</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">current_step</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">current_step</span>

        <span class="c1"># Handle equijoin operations</span>
        <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">is_equijoin</span><span class="p">:</span>
            <span class="c1"># Add operation to list if not seen</span>
            <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_operations</span><span class="p">:</span>
                <span class="n">op_config</span> <span class="o">=</span> <span class="n">clean_operation</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>
                <span class="n">clean_config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op_config</span><span class="p">)</span>
                <span class="n">seen_operations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># Add to step operations with left and right inputs</span>
            <span class="n">current_step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="n">container</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="p">{</span>
                        <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="n">container</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;left_name&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="n">container</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;right_name&quot;</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">)</span>

            <span class="c1"># Process both children</span>
            <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">process_container</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">current_step</span><span class="p">)</span>
                <span class="n">process_container</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">current_step</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Add operation to list if not seen</span>
            <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_operations</span><span class="p">:</span>
                <span class="n">op_config</span> <span class="o">=</span> <span class="n">clean_operation</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>
                <span class="n">clean_config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op_config</span><span class="p">)</span>
                <span class="n">seen_operations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># Add to step operations</span>
            <span class="n">current_step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">container</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

            <span class="c1"># Process children</span>
            <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">process_container</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">current_step</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">container</span><span class="p">,</span> <span class="n">current_step</span>

    <span class="c1"># Start processing from the last container</span>
    <span class="n">process_container</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">last_op_container</span><span class="p">)</span>

    <span class="c1"># Add inputs to steps based on their first operation</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">clean_config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]:</span>
        <span class="n">first_op</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first_op</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="c1"># This is an equijoin</span>
            <span class="k">continue</span>  <span class="c1"># Equijoin steps don&#39;t need an input field</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Find the first non-scan operation&#39;s input by looking at its dependencies</span>
            <span class="n">op_container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">op_container_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">first_op</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">op_container</span> <span class="ow">and</span> <span class="n">op_container</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">child</span> <span class="o">=</span> <span class="n">op_container</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">while</span> <span class="p">(</span>
                    <span class="n">child</span>
                    <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;step_boundary&quot;</span>
                    <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">children</span>
                <span class="p">):</span>
                    <span class="n">child</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">child</span> <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;scan&quot;</span><span class="p">:</span>
                    <span class="n">step</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dataset_name&quot;</span><span class="p">]</span>

    <span class="c1"># Preserve all other config key-value pairs from original config</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;datasets&quot;</span><span class="p">,</span> <span class="s2">&quot;operations&quot;</span><span class="p">,</span> <span class="s2">&quot;pipeline&quot;</span><span class="p">]:</span>
            <span class="n">clean_config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">clean_config</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.Optimizer.optimize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Optimizes the entire pipeline by walking the operation DAG and applying
operation-specific optimizers where marked. Returns the total optimization cost.</p>


            <details class="quote">
              <summary>Source code in <code>docetl/optimizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimizes the entire pipeline by walking the operation DAG and applying</span>
<span class="sd">    operation-specific optimizers where marked. Returns the total optimization cost.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[bold cyan]Beginning Pipeline Rewrites[/bold cyan]&quot;</span><span class="p">)</span>

    <span class="c1"># If self.resume is True and there&#39;s a checkpoint, load it</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimized_ops_path</span><span class="p">):</span>
            <span class="c1"># Load the yaml and change the runner with it</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimized_ops_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">partial_optimized_config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s2">&quot;[yellow]Loading partially optimized pipeline from checkpoint...[/yellow]&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">_build_operation_graph</span><span class="p">(</span><span class="n">partial_optimized_config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="s2">&quot;[yellow]No checkpoint found, starting optimization from scratch...[/yellow]&quot;</span>
            <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insert_empty_resolve_operations</span><span class="p">()</span>

    <span class="c1"># Start with the last operation container and visit each child</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">last_op_container</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>

    <span class="n">flush_cache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">)</span>

    <span class="c1"># Print the query plan</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[bold cyan]Optimized Query Plan[/bold cyan]&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">print_query_plan</span><span class="p">()</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">total_cost</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.Optimizer.print_optimizer_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">print_optimizer_config</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Print the current configuration of the optimizer.</p>
<p>This method uses the Rich console to display a formatted output of the optimizer's
configuration. It includes details such as the YAML file path, sample sizes for
different operation types, maximum number of threads, the language model being used,
and the timeout setting.</p>
<p>The output is color-coded and formatted for easy readability, with a header and
separator lines to clearly delineate the configuration information.</p>


            <details class="quote">
              <summary>Source code in <code>docetl/optimizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">print_optimizer_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print the current configuration of the optimizer.</span>

<span class="sd">    This method uses the Rich console to display a formatted output of the optimizer&#39;s</span>
<span class="sd">    configuration. It includes details such as the YAML file path, sample sizes for</span>
<span class="sd">    different operation types, maximum number of threads, the language model being used,</span>
<span class="sd">    and the timeout setting.</span>

<span class="sd">    The output is color-coded and formatted for easy readability, with a header and</span>
<span class="sd">    separator lines to clearly delineate the configuration information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="n">Panel</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="s2">&quot;[bold cyan]Optimizer Configuration[/bold cyan]</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;[yellow]Sample Size:[/yellow] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_size_map</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;[yellow]Max Threads:[/yellow] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;[yellow]Rewrite Agent Model:[/yellow] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">rewrite_agent_model</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;[yellow]Judge Agent Model:[/yellow] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">judge_agent_model</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;[yellow]Rate Limits:[/yellow] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optimizer_config&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rate_limits&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{})</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Optimizer Configuration&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.Optimizer.resolve_anchors" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">resolve_anchors</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Recursively resolve all anchors and aliases in a nested data structure.</p>
<p>This static method traverses through dictionaries and lists, resolving any YAML anchors and aliases.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The data structure to resolve. Can be a dictionary, list, or any other type.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The resolved data structure with all anchors and aliases replaced by their actual values.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>docetl/optimizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">resolve_anchors</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recursively resolve all anchors and aliases in a nested data structure.</span>

<span class="sd">    This static method traverses through dictionaries and lists, resolving any YAML anchors and aliases.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: The data structure to resolve. Can be a dictionary, list, or any other type.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The resolved data structure with all anchors and aliases replaced by their actual values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">Optimizer</span><span class="o">.</span><span class="n">resolve_anchors</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Optimizer</span><span class="o">.</span><span class="n">resolve_anchors</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.Optimizer.save_optimized_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_optimized_config</span><span class="p">(</span><span class="n">optimized_config_path</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Saves the optimized configuration to a YAML file after resolving all references
and cleaning up internal optimization artifacts.</p>


            <details class="quote">
              <summary>Source code in <code>docetl/optimizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_optimized_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optimized_config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves the optimized configuration to a YAML file after resolving all references</span>
<span class="sd">    and cleaning up internal optimization artifacts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resolved_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_optimized_config</span><span class="p">()</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">optimized_config_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="n">resolved_config</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[green italic] Optimized config saved to </span><span class="si">{</span><span class="n">optimized_config_path</span><span class="si">}</span><span class="s2">[/green italic]&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.Optimizer.should_optimize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">should_optimize</span><span class="p">(</span><span class="n">step_name</span><span class="p">,</span> <span class="n">op_name</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Analyzes whether an operation should be optimized by running it on a sample of input data
and evaluating potential optimizations. Returns the optimization suggestion and relevant data.</p>


            <details class="quote">
              <summary>Source code in <code>docetl/optimizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">should_optimize</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">step_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">op_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyzes whether an operation should be optimized by running it on a sample of input data</span>
<span class="sd">    and evaluating potential optimizations. Returns the optimization suggestion and relevant data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[bold cyan]Beginning Pipeline Assessment[/bold cyan]&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_insert_empty_resolve_operations</span><span class="p">()</span>

    <span class="n">node_of_interest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">op_container_map</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">op_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

    <span class="c1"># Run the node_of_interest&#39;s children</span>
    <span class="n">input_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node_of_interest</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
        <span class="n">input_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">child</span><span class="o">.</span><span class="n">next</span><span class="p">(</span>
                <span class="n">is_build</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">sample_size_needed</span><span class="o">=</span><span class="n">SAMPLE_SIZE_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]),</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="c1"># Set the step</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">captured_output</span><span class="o">.</span><span class="n">set_step</span><span class="p">(</span><span class="n">step_name</span><span class="p">)</span>

    <span class="c1"># Determine whether we should optimize the node_of_interest</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">node_of_interest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;map&quot;</span>
        <span class="ow">or</span> <span class="n">node_of_interest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;filter&quot;</span>
    <span class="p">):</span>
        <span class="c1"># Create instance of map optimizer</span>
        <span class="n">map_optimizer</span> <span class="o">=</span> <span class="n">MapOptimizer</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">_run_operation</span><span class="p">,</span>
            <span class="n">is_filter</span><span class="o">=</span><span class="n">node_of_interest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;filter&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">should_optimize_output</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">output_data</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">map_optimizer</span><span class="o">.</span><span class="n">should_optimize</span><span class="p">(</span><span class="n">node_of_interest</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">node_of_interest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;reduce&quot;</span><span class="p">:</span>
        <span class="n">reduce_optimizer</span> <span class="o">=</span> <span class="n">ReduceOptimizer</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">_run_operation</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">should_optimize_output</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">output_data</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">reduce_optimizer</span><span class="o">.</span><span class="n">should_optimize</span><span class="p">(</span><span class="n">node_of_interest</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">node_of_interest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;resolve&quot;</span><span class="p">:</span>
        <span class="n">resolve_optimizer</span> <span class="o">=</span> <span class="n">JoinOptimizer</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
            <span class="n">node_of_interest</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="n">target_recall</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolve&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_recall&quot;</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">should_optimize_output</span> <span class="o">=</span> <span class="n">resolve_optimizer</span><span class="o">.</span><span class="n">should_optimize</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># if should_optimize_output is empty, then we should move to the reduce operation</span>
        <span class="k">if</span> <span class="n">should_optimize_output</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">0.0</span>

    <span class="c1"># Return the string and operation cost</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">should_optimize_output</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">,</span>
        <span class="n">output_data</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">total_cost</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">total_cost</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../examples/rate-limiting/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Rate Limiting Implementation">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Rate Limiting Implementation
              </div>
            </div>
          </a>
        
        
          
          <a href="../cli/" class="md-footer__link md-footer__link--next" aria-label="Next: CLI Interface">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                CLI Interface
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.instant.prefetch", "navigation.tracking", "navigation.expand", "navigation.path", "navigation.prune", "navigation.indexes", "navigation.top", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "toc.follow", "navigation.footer", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>