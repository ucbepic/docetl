
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../cli/">
      
      
        <link rel="next" href="../optimizers/">
      
      
      <link rel="icon" href="../../assets/docetl-favicon-color.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Operations - docetl docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CSource+Code+Pro:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"Source Code Pro"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="#FDB515">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#llm-powered-operators" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="docetl docs" class="md-header__button md-logo" aria-label="docetl docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M0 112c0-41.5 31.6-75.6 72-79.6V32h280c53 0 96 43 96 96v176H272c-39.8 0-72 32.2-72 72v60c0 24.3-19.7 44-44 44s-44-19.7-44-44V208H48c-26.5 0-48-21.5-48-48zm236.8 368c7.1-13.1 11.2-28.1 11.2-44v-60c0-13.3 10.7-24 24-24h248c13.3 0 24 10.7 24 24v24c0 44.2-35.8 80-80 80zM80 80c-17.7 0-32 14.3-32 32v48h64v-48c0-17.7-14.3-32-32-32"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            docetl docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Operations
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="#FDB515"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="#FDB515"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="#FDB515"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/ucbepic/docetl" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    ucbepic/docetl
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  
    
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../concepts/operators/" class="md-tabs__link">
          
  
  
    
  
  User Guide

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../optimization/overview/" class="md-tabs__link">
          
  
  
    
  
  Optimization

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../examples/presidential-debate-themes/" class="md-tabs__link">
          
  
  
    
  
  Tutorials & Examples

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../examples/custom-parsing/" class="md-tabs__link">
          
  
  
    
  
  Developer Reference

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../playground/" class="md-tabs__link">
          
  
  
    
  
  Tools & Resources

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="docetl docs" class="md-nav__button md-logo" aria-label="docetl docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M0 112c0-41.5 31.6-75.6 72-79.6V32h280c53 0 96 43 96 96v176H272c-39.8 0-72 32.2-72 72v60c0 24.3-19.7 44-44 44s-44-19.7-44-44V208H48c-26.5 0-48-21.5-48-48zm236.8 368c7.1-13.1 11.2-28.1 11.2-44v-60c0-13.3 10.7-24 24-24h248c13.3 0 24 10.7 24 24v24c0 44.2-35.8 80-80 80zM80 80c-17.7 0-32 14.3-32 32v48h64v-48c0-17.7-14.3-32-32-32"/></svg>

    </a>
    docetl docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ucbepic/docetl" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    ucbepic/docetl
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../.." class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../concepts/operators/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    User Guide
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../optimization/overview/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Optimization
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../examples/presidential-debate-themes/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Tutorials & Examples
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Developer Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Developer Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Technical Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            Technical Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/custom-parsing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Custom Data Parsing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/rate-limiting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rate Limiting Implementation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" checked>
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../docetl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    docetl Core
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CLI Interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Operations
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Operations
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#docetl.operations.map.MapOperation" class="md-nav__link">
    <span class="md-ellipsis">
      MapOperation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MapOperation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.operations.map.MapOperation.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docetl.operations.resolve.ResolveOperation" class="md-nav__link">
    <span class="md-ellipsis">
      ResolveOperation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ResolveOperation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.operations.resolve.ResolveOperation.compare_pair" class="md-nav__link">
    <span class="md-ellipsis">
      compare_pair
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.operations.resolve.ResolveOperation.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docetl.operations.reduce.ReduceOperation" class="md-nav__link">
    <span class="md-ellipsis">
      ReduceOperation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ReduceOperation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.operations.reduce.ReduceOperation.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.operations.reduce.ReduceOperation.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.operations.reduce.ReduceOperation.get_fold_time" class="md-nav__link">
    <span class="md-ellipsis">
      get_fold_time
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.operations.reduce.ReduceOperation.get_merge_time" class="md-nav__link">
    <span class="md-ellipsis">
      get_merge_time
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docetl.operations.map.ParallelMapOperation" class="md-nav__link">
    <span class="md-ellipsis">
      ParallelMapOperation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ParallelMapOperation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.operations.map.ParallelMapOperation.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docetl.operations.filter.FilterOperation" class="md-nav__link">
    <span class="md-ellipsis">
      FilterOperation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FilterOperation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.operations.filter.FilterOperation.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docetl.operations.equijoin.EquijoinOperation" class="md-nav__link">
    <span class="md-ellipsis">
      EquijoinOperation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EquijoinOperation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.operations.equijoin.EquijoinOperation.compare_pair" class="md-nav__link">
    <span class="md-ellipsis">
      compare_pair
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.operations.equijoin.EquijoinOperation.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docetl.operations.cluster.ClusterOperation" class="md-nav__link">
    <span class="md-ellipsis">
      ClusterOperation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ClusterOperation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.operations.cluster.ClusterOperation.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.operations.cluster.ClusterOperation.syntax_check" class="md-nav__link">
    <span class="md-ellipsis">
      syntax_check
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../optimizers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Optimizers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../python/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Python API
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../playground/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Tools & Resources
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#docetl.operations.map.MapOperation" class="md-nav__link">
    <span class="md-ellipsis">
      MapOperation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MapOperation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.operations.map.MapOperation.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docetl.operations.resolve.ResolveOperation" class="md-nav__link">
    <span class="md-ellipsis">
      ResolveOperation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ResolveOperation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.operations.resolve.ResolveOperation.compare_pair" class="md-nav__link">
    <span class="md-ellipsis">
      compare_pair
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.operations.resolve.ResolveOperation.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docetl.operations.reduce.ReduceOperation" class="md-nav__link">
    <span class="md-ellipsis">
      ReduceOperation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ReduceOperation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.operations.reduce.ReduceOperation.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.operations.reduce.ReduceOperation.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.operations.reduce.ReduceOperation.get_fold_time" class="md-nav__link">
    <span class="md-ellipsis">
      get_fold_time
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.operations.reduce.ReduceOperation.get_merge_time" class="md-nav__link">
    <span class="md-ellipsis">
      get_merge_time
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docetl.operations.map.ParallelMapOperation" class="md-nav__link">
    <span class="md-ellipsis">
      ParallelMapOperation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ParallelMapOperation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.operations.map.ParallelMapOperation.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docetl.operations.filter.FilterOperation" class="md-nav__link">
    <span class="md-ellipsis">
      FilterOperation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FilterOperation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.operations.filter.FilterOperation.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docetl.operations.equijoin.EquijoinOperation" class="md-nav__link">
    <span class="md-ellipsis">
      EquijoinOperation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EquijoinOperation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.operations.equijoin.EquijoinOperation.compare_pair" class="md-nav__link">
    <span class="md-ellipsis">
      compare_pair
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.operations.equijoin.EquijoinOperation.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docetl.operations.cluster.ClusterOperation" class="md-nav__link">
    <span class="md-ellipsis">
      ClusterOperation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ClusterOperation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.operations.cluster.ClusterOperation.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.operations.cluster.ClusterOperation.syntax_check" class="md-nav__link">
    <span class="md-ellipsis">
      syntax_check
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="llm-powered-operators">LLM-Powered Operators</h1>


<div class="doc doc-object doc-class">



<h3 id="docetl.operations.map.MapOperation" class="doc doc-heading">
            <code>docetl.operations.map.MapOperation</code>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="docetl.operations.base.BaseOperation">BaseOperation</span></code></p>








              <details class="quote">
                <summary>Source code in <code>docetl/operations/map.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MapOperation</span><span class="p">(</span><span class="n">BaseOperation</span><span class="p">):</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">schema</span><span class="p">(</span><span class="n">BaseOperation</span><span class="o">.</span><span class="n">schema</span><span class="p">):</span>
        <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;map&quot;</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">optimize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">recursively_optimize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span>  <span class="c1"># FIXME: Why isn&#39;t this using the Tool data class so validation works automatically?</span>
        <span class="p">)</span>
        <span class="n">validation_rules</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;validate&quot;</span><span class="p">)</span>
        <span class="n">num_retries_on_validate_failure</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">drop_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">enable_observability</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">clustering_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">batch_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">litellm_completion_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pdf_url_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">flush_partial_result</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Calibration parameters</span>
        <span class="n">calibrate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">num_calibration_docs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;batch_prompt&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_batch_prompt</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Check if it has Jinja syntax</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                    <span class="c1"># This will be handled during initialization with user confirmation</span>
                    <span class="c1"># We&#39;ll mark it for later processing</span>
                    <span class="k">return</span> <span class="n">v</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="c1"># Test render with a minimal inputs list to validate template</span>
                    <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[{}])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Invalid Jinja2 template in &#39;batch_prompt&#39; or missing required &#39;inputs&#39; variable: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;prompt&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_prompt</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Check if it has Jinja syntax</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                    <span class="c1"># This will be handled during initialization with user confirmation</span>
                    <span class="c1"># We&#39;ll mark it for later processing</span>
                    <span class="k">return</span> <span class="n">v</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">Template</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Invalid Jinja2 template in &#39;prompt&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_tools</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tool_obj</span> <span class="o">=</span> <span class="n">Tool</span><span class="p">(</span><span class="o">**</span><span class="n">tool</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Tool must be a dictionary&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">tool_obj</span><span class="o">.</span><span class="n">code</span> <span class="ow">and</span> <span class="n">tool_obj</span><span class="o">.</span><span class="n">function</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;Tool is missing required &#39;code&#39; or &#39;function&#39; key&quot;</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_obj</span><span class="o">.</span><span class="n">function</span><span class="p">,</span> <span class="n">ToolFunction</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;function&#39; in tool must be a dictionary&quot;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;parameters&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tool_obj</span><span class="o">.</span><span class="n">function</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Tool is missing required &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; in &#39;function&#39;&quot;</span>
                            <span class="p">)</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_prompt_and_output_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># If drop_keys is not specified, both prompt and output must be present</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;If &#39;drop_keys&#39; is not specified, both &#39;prompt&#39; and &#39;output&#39; must be present in the configuration&quot;</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema&quot;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing &#39;schema&#39; in &#39;output&#39; configuration&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;max_batch_size&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_batch_size&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_method</span> <span class="o">=</span> <span class="s2">&quot;random&quot;</span>
        <span class="c1"># Check for non-Jinja prompts and prompt user for confirmation</span>
        <span class="k">if</span> <span class="s2">&quot;prompt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">prompt_user_for_non_jinja_confirmation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="s2">&quot;prompt&quot;</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Operation &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; cancelled by user. Please add Jinja2 template syntax to your prompt.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Mark that we need to append document statement</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_append_document_to_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s2">&quot;batch_prompt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_prompt&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">prompt_user_for_non_jinja_confirmation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_prompt&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="s2">&quot;batch_prompt&quot;</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Operation &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; cancelled by user. Please add Jinja2 template syntax to your batch_prompt.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Mark that we need to append document statement</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_append_document_to_batch_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_limit_applies_to_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_calibration_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate calibration context by running the operation on a sample of documents</span>
<span class="sd">        and using an LLM to suggest prompt improvements for consistency.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Additional context to add to the original prompt</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">random</span>

        <span class="c1"># Set seed for reproducibility</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

        <span class="c1"># Sample documents for calibration</span>
        <span class="n">num_calibration_docs</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_calibration_docs&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">num_calibration_docs</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">):</span>
            <span class="n">calibration_sample</span> <span class="o">=</span> <span class="n">input_data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">calibration_sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">num_calibration_docs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[bold blue]Running calibration on </span><span class="si">{</span><span class="n">num_calibration_docs</span><span class="si">}</span><span class="s2"> documents...[/bold blue]&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Temporarily disable calibration to avoid infinite recursion</span>
        <span class="n">original_calibrate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;calibrate&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;calibrate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Run the map operation on the calibration sample</span>
            <span class="n">calibration_results</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">calibration_sample</span><span class="p">)</span>

            <span class="c1"># Prepare the calibration analysis prompt</span>
            <span class="n">calibration_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">The following prompt was applied to sample documents to generate these input-output pairs:</span>

<span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="s2">Sample inputs and their outputs:</span>
<span class="s2">&quot;&quot;&quot;</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">input_doc</span><span class="p">,</span> <span class="n">output_doc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">calibration_sample</span><span class="p">,</span> <span class="n">calibration_results</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">calibration_prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Example </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> ---</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">calibration_prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Input: </span><span class="si">{</span><span class="n">input_doc</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">calibration_prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Output: </span><span class="si">{</span><span class="n">output_doc</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="n">calibration_prompt</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Based on these examples, provide reference anchors that will be appended to the prompt to help maintain consistency when processing all documents.</span>

<span class="s2">DO NOT provide generic advice. Instead, use specific examples from above as calibration points.</span>
<span class="s2">Note that the outputs might be incorrect, because the user&#39;s prompt was not calibrated or rich in the first place.</span>
<span class="s2">You can ignore the outputs if they are incorrect, and focus on the diversity of the inputs.</span>

<span class="s2">Format as concrete reference points:</span>
<span class="s2">- &quot;For reference, consider &#39;[specific input text]&#39;  [output] as a baseline for [category/level]&quot;</span>
<span class="s2">- &quot;Documents similar to &#39;[specific input text]&#39; should be classified as [output]&quot;</span>

<span class="s2">Reference anchors:&quot;&quot;&quot;</span>

            <span class="c1"># Call LLM to get calibration suggestions</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">calibration_prompt</span><span class="p">}]</span>
            <span class="c1"># Use a copy of the user-provided completion kwargs so we don&#39;t mutate the original</span>
            <span class="c1"># and avoid hard-coding temperature to a value that may not be supported by certain models.</span>
            <span class="n">completion_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;litellm_completion_kwargs&quot;</span><span class="p">,</span> <span class="p">{}))</span>
            <span class="c1"># If the user did not explicitly specify a temperature, let the model default handle it</span>
            <span class="c1"># to prevent incompatibility errors with providers that don&#39;t support 0.0.</span>
            <span class="c1"># If a temperature is already provided, respect the user&#39;s choice.</span>

            <span class="n">llm_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">call_llm</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">),</span>
                <span class="s2">&quot;calibration&quot;</span><span class="p">,</span>
                <span class="n">messages</span><span class="p">,</span>
                <span class="p">{</span><span class="s2">&quot;calibration_context&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
                <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">bypass_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bypass_cache&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bypass_cache</span><span class="p">),</span>
                <span class="n">litellm_completion_kwargs</span><span class="o">=</span><span class="n">completion_kwargs</span><span class="p">,</span>
                <span class="n">op_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Parse the response</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">llm_result</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">):</span>
                <span class="n">calibration_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
                    <span class="n">llm_result</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
                    <span class="n">schema</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;calibration_context&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                    <span class="n">manually_fix_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manually_fix_errors</span><span class="p">,</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;calibration_context&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">calibration_context</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">return</span> <span class="n">calibration_context</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Restore original calibration setting</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;calibrate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_calibrate</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the map operation on the provided input data.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_data (list[dict]): The input data to process.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[list[dict], float]: A tuple containing the processed results and the total cost of the operation.</span>

<span class="sd">        This method performs the following steps:</span>
<span class="sd">        1. If calibration is enabled, runs calibration to improve prompt consistency</span>
<span class="sd">        2. If a prompt is specified, it processes each input item using the specified prompt and LLM model</span>
<span class="sd">        3. Applies gleaning if configured</span>
<span class="sd">        4. Validates the output</span>
<span class="sd">        5. If drop_keys is specified, it drops the specified keys from each document</span>
<span class="sd">        6. Aggregates results and calculates total cost</span>

<span class="sd">        The method uses parallel processing to improve performance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">limit_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limit&quot;</span><span class="p">)</span>

        <span class="c1"># Check if there&#39;s no prompt and only drop_keys</span>
        <span class="k">if</span> <span class="s2">&quot;prompt&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="s2">&quot;drop_keys&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="n">data_to_process</span> <span class="o">=</span> <span class="n">input_data</span>
            <span class="k">if</span> <span class="n">limit_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_applies_to_inputs</span><span class="p">():</span>
                <span class="n">data_to_process</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[:</span><span class="n">limit_value</span><span class="p">]</span>
            <span class="c1"># If only drop_keys is specified, simply drop the keys and return</span>
            <span class="n">dropped_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data_to_process</span><span class="p">:</span>
                <span class="n">new_item</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;drop_keys&quot;</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="n">dropped_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">limit_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dropped_results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">limit_value</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">return</span> <span class="n">dropped_results</span><span class="p">,</span> <span class="mf">0.0</span>  <span class="c1"># Return the modified data with no cost</span>

        <span class="k">if</span> <span class="n">limit_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_applies_to_inputs</span><span class="p">():</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[:</span><span class="n">limit_value</span><span class="p">]</span>

        <span class="c1"># Generate calibration context if enabled</span>
        <span class="n">calibration_context</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;calibrate&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;prompt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="n">calibration_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_calibration_context</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">calibration_context</span><span class="p">:</span>
                <span class="c1"># Store original prompt for potential restoration</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_original_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span>
                <span class="c1"># Augment the prompt with calibration context</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;prompt&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">calibration_context</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[bold green]New map (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) prompt augmented with context on how to improve consistency:[/bold green] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;prompt&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[bold yellow]Extra context on how to improve consistency failed to generate for map (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">); continuing with prompt as is.[/bold yellow]&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_process_map_item</span><span class="p">(</span>
            <span class="n">item</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">initial_result</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>

            <span class="c1"># Build retrieval context (if configured)</span>
            <span class="n">retrieval_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_build_retrieval_context</span><span class="p">({</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">})</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">,</span> <span class="s2">&quot;retrieval_context&quot;</span><span class="p">:</span> <span class="n">retrieval_context</span><span class="p">}</span>
            <span class="n">rendered</span> <span class="o">=</span> <span class="n">strict_render</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">],</span> <span class="n">ctx</span><span class="p">)</span>
            <span class="c1"># If template didn&#39;t use retrieval_context, prepend a standard header</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Here is some extra context:</span><span class="se">\n</span><span class="si">{</span><span class="n">retrieval_context</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">rendered</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">retrieval_context</span>
                <span class="ow">and</span> <span class="s2">&quot;retrieval_context&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span>
                <span class="k">else</span> <span class="n">rendered</span>
            <span class="p">)</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pdf_url_key&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># Append the pdf to the prompt</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pdf_url</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pdf_url_key&quot;</span><span class="p">]]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;PDF URL key &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pdf_url_key&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; not found in input data&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Download content</span>
                <span class="k">if</span> <span class="n">pdf_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
                    <span class="n">file_data</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf_url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdf_url</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">file_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">encoded_file</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                <span class="n">base64_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data:application/pdf;base64,</span><span class="si">{</span><span class="n">encoded_file</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;image_url&quot;</span><span class="p">,</span> <span class="s2">&quot;image_url&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">base64_url</span><span class="p">}},</span>
                    <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
                <span class="p">]</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">validation_fn</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">ModelResponse</span><span class="p">):</span>
                <span class="n">structured_mode</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span>
                    <span class="o">==</span> <span class="n">OutputMode</span><span class="o">.</span><span class="n">STRUCTURED_OUTPUT</span><span class="o">.</span><span class="n">value</span>
                <span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
                        <span class="n">response</span><span class="p">,</span>
                        <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
                        <span class="n">tools</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                        <span class="n">manually_fix_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manually_fix_errors</span><span class="p">,</span>
                        <span class="n">use_structured_output</span><span class="o">=</span><span class="n">structured_mode</span><span class="p">,</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">ModelResponse</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">response</span>
                <span class="p">)</span>
                <span class="c1"># Type-check output values against schema declarations</span>
                <span class="n">is_types_valid</span><span class="p">,</span> <span class="n">_errors</span> <span class="o">=</span> <span class="n">validate_output_types</span><span class="p">(</span>
                    <span class="n">output</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_types_valid</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="kc">False</span>

                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">]:</span>
                        <span class="n">output</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">validate_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">is_cancelled</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">(</span><span class="s2">&quot;Operation was cancelled&quot;</span><span class="p">)</span>
            <span class="n">llm_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">call_llm</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">),</span>
                <span class="s2">&quot;map&quot;</span><span class="p">,</span>
                <span class="n">messages</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
                <span class="n">tools</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">scratchpad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
                <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">validation_config</span><span class="o">=</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;num_retries&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_retries_on_validate_failure</span><span class="p">,</span>
                        <span class="s2">&quot;val_rule&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                        <span class="s2">&quot;validation_fn&quot;</span><span class="p">:</span> <span class="n">validation_fn</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">),</span>
                <span class="n">gleaning_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gleaning&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="n">bypass_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bypass_cache&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bypass_cache</span><span class="p">),</span>
                <span class="n">initial_result</span><span class="o">=</span><span class="n">initial_result</span><span class="p">,</span>
                <span class="n">litellm_completion_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;litellm_completion_kwargs&quot;</span><span class="p">,</span> <span class="p">{}</span>
                <span class="p">),</span>
                <span class="n">op_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">llm_result</span><span class="o">.</span><span class="n">validated</span><span class="p">:</span>
                <span class="c1"># Parse the response</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">llm_result</span><span class="o">.</span><span class="n">response</span><span class="p">,</span> <span class="n">ModelResponse</span><span class="p">):</span>
                    <span class="n">structured_mode</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span>
                        <span class="o">==</span> <span class="n">OutputMode</span><span class="o">.</span><span class="n">STRUCTURED_OUTPUT</span><span class="o">.</span><span class="n">value</span>
                    <span class="p">)</span>
                    <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
                        <span class="n">llm_result</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
                        <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
                        <span class="n">tools</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                        <span class="n">manually_fix_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manually_fix_errors</span><span class="p">,</span>
                        <span class="n">use_structured_output</span><span class="o">=</span><span class="n">structured_mode</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">llm_result</span><span class="o">.</span><span class="n">response</span><span class="p">]</span>

                <span class="c1"># Augment the output with the original item</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="p">[{</span><span class="o">**</span><span class="n">item</span><span class="p">,</span> <span class="o">**</span><span class="n">output</span><span class="p">}</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_observability&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                        <span class="n">output</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_observability_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">prompt</span>
                        <span class="p">}</span>
                <span class="c1"># Add retrieved context if save_retriever_output is enabled</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_retriever_output&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                        <span class="n">output</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_retrieved_context&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">retrieval_context</span> <span class="k">if</span> <span class="n">retrieval_context</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                        <span class="p">)</span>
                <span class="k">return</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">llm_result</span><span class="o">.</span><span class="n">total_cost</span>

            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">llm_result</span><span class="o">.</span><span class="n">total_cost</span>

        <span class="c1"># If there&#39;s a batch prompt, let&#39;s use that</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_process_map_batch</span><span class="p">(</span><span class="n">items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
            <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;batch_prompt&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># Raise error if pdf_url_key is set</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pdf_url_key&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Batch prompts do not support PDF URLs&quot;</span><span class="p">)</span>

                <span class="n">batch_prompt</span> <span class="o">=</span> <span class="n">strict_render</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_prompt&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>
                <span class="p">)</span>

                <span class="c1"># Issue the batch call</span>
                <span class="n">llm_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">call_llm_batch</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">),</span>
                    <span class="s2">&quot;batch map&quot;</span><span class="p">,</span>
                    <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">batch_prompt</span><span class="p">}],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
                    <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span>
                    <span class="p">),</span>
                    <span class="n">bypass_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bypass_cache&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bypass_cache</span><span class="p">),</span>
                    <span class="n">litellm_completion_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;litellm_completion_kwargs&quot;</span><span class="p">,</span> <span class="p">{}</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">llm_result</span><span class="o">.</span><span class="n">total_cost</span>

                <span class="c1"># Parse the LLM response</span>
                <span class="n">structured_mode</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span>
                    <span class="o">==</span> <span class="n">OutputMode</span><span class="o">.</span><span class="n">STRUCTURED_OUTPUT</span><span class="o">.</span><span class="n">value</span>
                <span class="p">)</span>
                <span class="n">parsed_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
                    <span class="n">llm_result</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
                    <span class="n">use_structured_output</span><span class="o">=</span><span class="n">structured_mode</span><span class="p">,</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;results&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">items_and_outputs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">parsed_output</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">parsed_output</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">items_and_outputs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">item</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>

            <span class="c1"># Run _process_map_item for each item</span>
            <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items_and_outputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_batch_size</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                    <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                            <span class="n">_process_map_item</span><span class="p">,</span>
                            <span class="n">items_and_outputs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">items_and_outputs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items_and_outputs</span><span class="p">))</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">futures</span><span class="p">)):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">,</span> <span class="n">item_cost</span> <span class="o">=</span> <span class="n">futures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">all_results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                            <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">item_cost</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;skip_on_error&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;[bold red]Error in map operation </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, skipping item:[/bold red] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                                <span class="k">continue</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">,</span> <span class="n">item_cost</span> <span class="o">=</span> <span class="n">_process_map_item</span><span class="p">(</span>
                        <span class="n">items_and_outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">items_and_outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">all_results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                    <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">item_cost</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;skip_on_error&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;[bold red]Error in map operation </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, skipping item:[/bold red] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">e</span>

            <span class="k">return</span> <span class="n">all_results</span><span class="p">,</span> <span class="n">total_cost</span>

        <span class="n">limit_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_batch_size</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">total_batches</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span>
        <span class="k">if</span> <span class="n">total_batches</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="mf">0.0</span>

        <span class="n">worker_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_batch_size</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span> <span class="ow">or</span> <span class="mi">1</span>
        <span class="n">window_size</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">total_batches</span>
            <span class="k">if</span> <span class="n">limit_value</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">limit_value</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">limit_reached</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">op_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">limit_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_applies_to_inputs</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[yellow]Note: Operation will terminate early once </span><span class="si">{</span><span class="n">limit_value</span><span class="si">}</span><span class="s2"> items pass the filter condition.[/yellow]&quot;</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">worker_limit</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">RichLoopBar</span><span class="p">(</span>
                <span class="n">total</span><span class="o">=</span><span class="n">total_batches</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">op_name</span><span class="si">}</span><span class="s2"> (map) on all documents&quot;</span><span class="p">,</span>
                <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="n">chunk_start</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">chunk_start</span> <span class="o">&lt;</span> <span class="n">total_batches</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">limit_reached</span><span class="p">:</span>
                    <span class="n">chunk_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">total_batches</span><span class="p">,</span> <span class="n">chunk_start</span> <span class="o">+</span> <span class="n">window_size</span><span class="p">)</span>
                    <span class="n">chunk_ordinals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">chunk_start</span><span class="p">,</span> <span class="n">chunk_end</span><span class="p">))</span>
                    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">ordinal</span> <span class="ow">in</span> <span class="n">chunk_ordinals</span><span class="p">:</span>
                        <span class="n">start_idx</span> <span class="o">=</span> <span class="n">ordinal</span> <span class="o">*</span> <span class="n">batch_size</span>
                        <span class="n">batch</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="n">start_idx</span> <span class="p">:</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>
                        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_process_map_batch</span><span class="p">,</span> <span class="n">batch</span><span class="p">))</span>

                    <span class="k">for</span> <span class="n">relative_idx</span><span class="p">,</span> <span class="n">future</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">limit_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">limit_counter</span> <span class="o">&gt;=</span> <span class="n">limit_value</span><span class="p">:</span>
                            <span class="n">limit_reached</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>

                        <span class="n">result_list</span><span class="p">,</span> <span class="n">item_cost</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                        <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">item_cost</span>

                        <span class="k">if</span> <span class="n">result_list</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s2">&quot;drop_keys&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                                <span class="n">result_list</span> <span class="o">=</span> <span class="p">[</span>
                                    <span class="p">{</span>
                                        <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;drop_keys&quot;</span><span class="p">]</span>
                                    <span class="p">}</span>
                                    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_list</span>
                                <span class="p">]</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flush_partial_results&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">_flush_partial_results</span><span class="p">(</span>
                                    <span class="n">op_name</span><span class="p">,</span> <span class="n">chunk_ordinals</span><span class="p">[</span><span class="n">relative_idx</span><span class="p">],</span> <span class="n">result_list</span>
                                <span class="p">)</span>

                            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_list</span><span class="p">:</span>
                                <span class="n">processed_result</span><span class="p">,</span> <span class="n">counts_towards_limit</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                                <span class="p">)</span>
                                <span class="k">if</span> <span class="n">processed_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">processed_result</span><span class="p">)</span>

                                <span class="k">if</span> <span class="n">limit_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">counts_towards_limit</span><span class="p">:</span>
                                    <span class="n">limit_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">if</span> <span class="n">limit_counter</span> <span class="o">&gt;=</span> <span class="n">limit_value</span><span class="p">:</span>
                                        <span class="n">limit_reached</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="k">break</span>

                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

                    <span class="n">chunk_start</span> <span class="o">=</span> <span class="n">chunk_end</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">total_cost</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="docetl.operations.map.MapOperation.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Executes the map operation on the provided input data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_data</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input data to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="list">list</span>[<span title="dict">dict</span>], <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[list[dict], float]: A tuple containing the processed results and the total cost of the operation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>This method performs the following steps:
1. If calibration is enabled, runs calibration to improve prompt consistency
2. If a prompt is specified, it processes each input item using the specified prompt and LLM model
3. Applies gleaning if configured
4. Validates the output
5. If drop_keys is specified, it drops the specified keys from each document
6. Aggregates results and calculates total cost</p>
<p>The method uses parallel processing to improve performance.</p>


            <details class="quote">
              <summary>Source code in <code>docetl/operations/map.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes the map operation on the provided input data.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_data (list[dict]): The input data to process.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[list[dict], float]: A tuple containing the processed results and the total cost of the operation.</span>

<span class="sd">    This method performs the following steps:</span>
<span class="sd">    1. If calibration is enabled, runs calibration to improve prompt consistency</span>
<span class="sd">    2. If a prompt is specified, it processes each input item using the specified prompt and LLM model</span>
<span class="sd">    3. Applies gleaning if configured</span>
<span class="sd">    4. Validates the output</span>
<span class="sd">    5. If drop_keys is specified, it drops the specified keys from each document</span>
<span class="sd">    6. Aggregates results and calculates total cost</span>

<span class="sd">    The method uses parallel processing to improve performance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">limit_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limit&quot;</span><span class="p">)</span>

    <span class="c1"># Check if there&#39;s no prompt and only drop_keys</span>
    <span class="k">if</span> <span class="s2">&quot;prompt&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="s2">&quot;drop_keys&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
        <span class="n">data_to_process</span> <span class="o">=</span> <span class="n">input_data</span>
        <span class="k">if</span> <span class="n">limit_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_applies_to_inputs</span><span class="p">():</span>
            <span class="n">data_to_process</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[:</span><span class="n">limit_value</span><span class="p">]</span>
        <span class="c1"># If only drop_keys is specified, simply drop the keys and return</span>
        <span class="n">dropped_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data_to_process</span><span class="p">:</span>
            <span class="n">new_item</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;drop_keys&quot;</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="n">dropped_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">limit_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dropped_results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">limit_value</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">dropped_results</span><span class="p">,</span> <span class="mf">0.0</span>  <span class="c1"># Return the modified data with no cost</span>

    <span class="k">if</span> <span class="n">limit_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_applies_to_inputs</span><span class="p">():</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[:</span><span class="n">limit_value</span><span class="p">]</span>

    <span class="c1"># Generate calibration context if enabled</span>
    <span class="n">calibration_context</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;calibrate&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;prompt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
        <span class="n">calibration_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_calibration_context</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">calibration_context</span><span class="p">:</span>
            <span class="c1"># Store original prompt for potential restoration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span>
            <span class="c1"># Augment the prompt with calibration context</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;prompt&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">calibration_context</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[bold green]New map (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) prompt augmented with context on how to improve consistency:[/bold green] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;prompt&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[bold yellow]Extra context on how to improve consistency failed to generate for map (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">); continuing with prompt as is.[/bold yellow]&quot;</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_map_item</span><span class="p">(</span>
        <span class="n">item</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">initial_result</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>

        <span class="c1"># Build retrieval context (if configured)</span>
        <span class="n">retrieval_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_build_retrieval_context</span><span class="p">({</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">})</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">,</span> <span class="s2">&quot;retrieval_context&quot;</span><span class="p">:</span> <span class="n">retrieval_context</span><span class="p">}</span>
        <span class="n">rendered</span> <span class="o">=</span> <span class="n">strict_render</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">],</span> <span class="n">ctx</span><span class="p">)</span>
        <span class="c1"># If template didn&#39;t use retrieval_context, prepend a standard header</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Here is some extra context:</span><span class="se">\n</span><span class="si">{</span><span class="n">retrieval_context</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">rendered</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">retrieval_context</span>
            <span class="ow">and</span> <span class="s2">&quot;retrieval_context&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span>
            <span class="k">else</span> <span class="n">rendered</span>
        <span class="p">)</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pdf_url_key&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># Append the pdf to the prompt</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pdf_url</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pdf_url_key&quot;</span><span class="p">]]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;PDF URL key &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pdf_url_key&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; not found in input data&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Download content</span>
            <span class="k">if</span> <span class="n">pdf_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
                <span class="n">file_data</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf_url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdf_url</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">file_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">encoded_file</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">base64_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data:application/pdf;base64,</span><span class="si">{</span><span class="n">encoded_file</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;image_url&quot;</span><span class="p">,</span> <span class="s2">&quot;image_url&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">base64_url</span><span class="p">}},</span>
                <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
            <span class="p">]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">validation_fn</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">ModelResponse</span><span class="p">):</span>
            <span class="n">structured_mode</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span>
                <span class="o">==</span> <span class="n">OutputMode</span><span class="o">.</span><span class="n">STRUCTURED_OUTPUT</span><span class="o">.</span><span class="n">value</span>
            <span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
                    <span class="n">response</span><span class="p">,</span>
                    <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
                    <span class="n">tools</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="n">manually_fix_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manually_fix_errors</span><span class="p">,</span>
                    <span class="n">use_structured_output</span><span class="o">=</span><span class="n">structured_mode</span><span class="p">,</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">ModelResponse</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">response</span>
            <span class="p">)</span>
            <span class="c1"># Type-check output values against schema declarations</span>
            <span class="n">is_types_valid</span><span class="p">,</span> <span class="n">_errors</span> <span class="o">=</span> <span class="n">validate_output_types</span><span class="p">(</span>
                <span class="n">output</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_types_valid</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="kc">False</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">]:</span>
                    <span class="n">output</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">validate_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">is_cancelled</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">(</span><span class="s2">&quot;Operation was cancelled&quot;</span><span class="p">)</span>
        <span class="n">llm_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">call_llm</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">),</span>
            <span class="s2">&quot;map&quot;</span><span class="p">,</span>
            <span class="n">messages</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
            <span class="n">tools</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">scratchpad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
            <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">validation_config</span><span class="o">=</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;num_retries&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_retries_on_validate_failure</span><span class="p">,</span>
                    <span class="s2">&quot;val_rule&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="s2">&quot;validation_fn&quot;</span><span class="p">:</span> <span class="n">validation_fn</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">),</span>
            <span class="n">gleaning_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gleaning&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">bypass_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bypass_cache&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bypass_cache</span><span class="p">),</span>
            <span class="n">initial_result</span><span class="o">=</span><span class="n">initial_result</span><span class="p">,</span>
            <span class="n">litellm_completion_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;litellm_completion_kwargs&quot;</span><span class="p">,</span> <span class="p">{}</span>
            <span class="p">),</span>
            <span class="n">op_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">llm_result</span><span class="o">.</span><span class="n">validated</span><span class="p">:</span>
            <span class="c1"># Parse the response</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">llm_result</span><span class="o">.</span><span class="n">response</span><span class="p">,</span> <span class="n">ModelResponse</span><span class="p">):</span>
                <span class="n">structured_mode</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span>
                    <span class="o">==</span> <span class="n">OutputMode</span><span class="o">.</span><span class="n">STRUCTURED_OUTPUT</span><span class="o">.</span><span class="n">value</span>
                <span class="p">)</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
                    <span class="n">llm_result</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
                    <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
                    <span class="n">tools</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="n">manually_fix_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manually_fix_errors</span><span class="p">,</span>
                    <span class="n">use_structured_output</span><span class="o">=</span><span class="n">structured_mode</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">llm_result</span><span class="o">.</span><span class="n">response</span><span class="p">]</span>

            <span class="c1"># Augment the output with the original item</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[{</span><span class="o">**</span><span class="n">item</span><span class="p">,</span> <span class="o">**</span><span class="n">output</span><span class="p">}</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_observability&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                    <span class="n">output</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_observability_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">prompt</span>
                    <span class="p">}</span>
            <span class="c1"># Add retrieved context if save_retriever_output is enabled</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_retriever_output&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                    <span class="n">output</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_retrieved_context&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">retrieval_context</span> <span class="k">if</span> <span class="n">retrieval_context</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                    <span class="p">)</span>
            <span class="k">return</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">llm_result</span><span class="o">.</span><span class="n">total_cost</span>

        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">llm_result</span><span class="o">.</span><span class="n">total_cost</span>

    <span class="c1"># If there&#39;s a batch prompt, let&#39;s use that</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_process_map_batch</span><span class="p">(</span><span class="n">items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;batch_prompt&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># Raise error if pdf_url_key is set</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pdf_url_key&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Batch prompts do not support PDF URLs&quot;</span><span class="p">)</span>

            <span class="n">batch_prompt</span> <span class="o">=</span> <span class="n">strict_render</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_prompt&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>
            <span class="p">)</span>

            <span class="c1"># Issue the batch call</span>
            <span class="n">llm_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">call_llm_batch</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">),</span>
                <span class="s2">&quot;batch map&quot;</span><span class="p">,</span>
                <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">batch_prompt</span><span class="p">}],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
                <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
                <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span>
                <span class="p">),</span>
                <span class="n">bypass_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bypass_cache&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bypass_cache</span><span class="p">),</span>
                <span class="n">litellm_completion_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;litellm_completion_kwargs&quot;</span><span class="p">,</span> <span class="p">{}</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">llm_result</span><span class="o">.</span><span class="n">total_cost</span>

            <span class="c1"># Parse the LLM response</span>
            <span class="n">structured_mode</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span>
                <span class="o">==</span> <span class="n">OutputMode</span><span class="o">.</span><span class="n">STRUCTURED_OUTPUT</span><span class="o">.</span><span class="n">value</span>
            <span class="p">)</span>
            <span class="n">parsed_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
                <span class="n">llm_result</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
                <span class="n">use_structured_output</span><span class="o">=</span><span class="n">structured_mode</span><span class="p">,</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;results&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">items_and_outputs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">parsed_output</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">parsed_output</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">items_and_outputs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">item</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>

        <span class="c1"># Run _process_map_item for each item</span>
        <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items_and_outputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_batch_size</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                        <span class="n">_process_map_item</span><span class="p">,</span>
                        <span class="n">items_and_outputs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">items_and_outputs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items_and_outputs</span><span class="p">))</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">futures</span><span class="p">)):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">,</span> <span class="n">item_cost</span> <span class="o">=</span> <span class="n">futures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">all_results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                        <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">item_cost</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;skip_on_error&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;[bold red]Error in map operation </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, skipping item:[/bold red] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">results</span><span class="p">,</span> <span class="n">item_cost</span> <span class="o">=</span> <span class="n">_process_map_item</span><span class="p">(</span>
                    <span class="n">items_and_outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">items_and_outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">all_results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">item_cost</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;skip_on_error&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[bold red]Error in map operation </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, skipping item:[/bold red] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>

        <span class="k">return</span> <span class="n">all_results</span><span class="p">,</span> <span class="n">total_cost</span>

    <span class="n">limit_counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_batch_size</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">total_batches</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span>
    <span class="k">if</span> <span class="n">total_batches</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="mf">0.0</span>

    <span class="n">worker_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_batch_size</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span> <span class="ow">or</span> <span class="mi">1</span>
    <span class="n">window_size</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">total_batches</span>
        <span class="k">if</span> <span class="n">limit_value</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">limit_value</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total_cost</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">limit_reached</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">op_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">limit_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_applies_to_inputs</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[yellow]Note: Operation will terminate early once </span><span class="si">{</span><span class="n">limit_value</span><span class="si">}</span><span class="s2"> items pass the filter condition.[/yellow]&quot;</span>
        <span class="p">)</span>

    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">worker_limit</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">RichLoopBar</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="n">total_batches</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">op_name</span><span class="si">}</span><span class="s2"> (map) on all documents&quot;</span><span class="p">,</span>
            <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">chunk_start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">chunk_start</span> <span class="o">&lt;</span> <span class="n">total_batches</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">limit_reached</span><span class="p">:</span>
                <span class="n">chunk_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">total_batches</span><span class="p">,</span> <span class="n">chunk_start</span> <span class="o">+</span> <span class="n">window_size</span><span class="p">)</span>
                <span class="n">chunk_ordinals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">chunk_start</span><span class="p">,</span> <span class="n">chunk_end</span><span class="p">))</span>
                <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ordinal</span> <span class="ow">in</span> <span class="n">chunk_ordinals</span><span class="p">:</span>
                    <span class="n">start_idx</span> <span class="o">=</span> <span class="n">ordinal</span> <span class="o">*</span> <span class="n">batch_size</span>
                    <span class="n">batch</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="n">start_idx</span> <span class="p">:</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>
                    <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_process_map_batch</span><span class="p">,</span> <span class="n">batch</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">relative_idx</span><span class="p">,</span> <span class="n">future</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">limit_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">limit_counter</span> <span class="o">&gt;=</span> <span class="n">limit_value</span><span class="p">:</span>
                        <span class="n">limit_reached</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>

                    <span class="n">result_list</span><span class="p">,</span> <span class="n">item_cost</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                    <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">item_cost</span>

                    <span class="k">if</span> <span class="n">result_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;drop_keys&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                            <span class="n">result_list</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="p">{</span>
                                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                    <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;drop_keys&quot;</span><span class="p">]</span>
                                <span class="p">}</span>
                                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_list</span>
                            <span class="p">]</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flush_partial_results&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">_flush_partial_results</span><span class="p">(</span>
                                <span class="n">op_name</span><span class="p">,</span> <span class="n">chunk_ordinals</span><span class="p">[</span><span class="n">relative_idx</span><span class="p">],</span> <span class="n">result_list</span>
                            <span class="p">)</span>

                        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_list</span><span class="p">:</span>
                            <span class="n">processed_result</span><span class="p">,</span> <span class="n">counts_towards_limit</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">processed_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">processed_result</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">limit_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">counts_towards_limit</span><span class="p">:</span>
                                <span class="n">limit_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">if</span> <span class="n">limit_counter</span> <span class="o">&gt;=</span> <span class="n">limit_value</span><span class="p">:</span>
                                    <span class="n">limit_reached</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">break</span>

                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

                <span class="n">chunk_start</span> <span class="o">=</span> <span class="n">chunk_end</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">total_cost</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="docetl.operations.resolve.ResolveOperation" class="doc doc-heading">
            <code>docetl.operations.resolve.ResolveOperation</code>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="docetl.operations.base.BaseOperation">BaseOperation</span></code></p>








              <details class="quote">
                <summary>Source code in <code>docetl/operations/resolve.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ResolveOperation</span><span class="p">(</span><span class="n">BaseOperation</span><span class="p">):</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">schema</span><span class="p">(</span><span class="n">BaseOperation</span><span class="o">.</span><span class="n">schema</span><span class="p">):</span>
        <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;resolve&quot;</span>
        <span class="n">comparison_prompt</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">resolution_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">embedding_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">resolution_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">comparison_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">blocking_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">blocking_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">blocking_target_recall</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">blocking_conditions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">input</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">embedding_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">compare_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">limit_comparisons</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">optimize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">litellm_completion_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
        <span class="n">enable_observability</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_comparison_prompt</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Check if it has Jinja syntax</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                    <span class="c1"># This will be handled during initialization with user confirmation</span>
                    <span class="k">return</span> <span class="n">v</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">comparison_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">comparison_vars</span> <span class="o">=</span> <span class="n">comparison_template</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span>
                        <span class="n">jinja2</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">Name</span>
                    <span class="p">)</span>
                    <span class="n">comparison_var_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">comparison_vars</span><span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="s2">&quot;input1&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">comparison_var_names</span>
                        <span class="ow">or</span> <span class="s2">&quot;input2&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">comparison_var_names</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;&#39;comparison_prompt&#39; must contain both &#39;input1&#39; and &#39;input2&#39; variables. </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Invalid Jinja2 template in &#39;comparison_prompt&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;resolution_prompt&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_resolution_prompt</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Check if it has Jinja syntax</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                    <span class="c1"># This will be handled during initialization with user confirmation</span>
                    <span class="k">return</span> <span class="n">v</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">reduction_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">reduction_vars</span> <span class="o">=</span> <span class="n">reduction_template</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span>
                        <span class="n">jinja2</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">Name</span>
                    <span class="p">)</span>
                    <span class="n">reduction_var_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">reduction_vars</span><span class="p">}</span>
                    <span class="k">if</span> <span class="s2">&quot;inputs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reduction_var_names</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;&#39;resolution_prompt&#39; must contain &#39;inputs&#39; variable&quot;</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Invalid Jinja2 template in &#39;resolution_prompt&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_input_schema</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;schema&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing &#39;schema&#39; in &#39;input&#39; configuration&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="s2">&quot;&#39;schema&#39; in &#39;input&#39; configuration must be a dictionary&quot;</span>
                    <span class="p">)</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_output_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">ValidationInfo</span><span class="p">):</span>
            <span class="c1"># Skip validation if we&#39;re using from dataframe accessors</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">info</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;_from_df_accessors&quot;</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Missing required key &#39;output&#39; in ResolveOperation configuration&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;schema&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing &#39;schema&#39; in &#39;output&#39; configuration&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;schema&#39; in &#39;output&#39; configuration must be a dictionary&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;schema&#39; in &#39;output&#39; configuration cannot be empty&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Check for non-Jinja prompts and prompt user for confirmation</span>
        <span class="k">if</span> <span class="s2">&quot;comparison_prompt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">prompt_user_for_non_jinja_confirmation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                <span class="s2">&quot;comparison_prompt&quot;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Operation &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; cancelled by user. Please add Jinja2 template syntax to your comparison_prompt.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Mark that we need to append document statement</span>
            <span class="c1"># Note: comparison_prompt uses input1 and input2, so we&#39;ll handle it specially in strict_render</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_append_document_to_comparison_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s2">&quot;resolution_prompt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;resolution_prompt&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">prompt_user_for_non_jinja_confirmation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;resolution_prompt&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                <span class="s2">&quot;resolution_prompt&quot;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Operation &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; cancelled by user. Please add Jinja2 template syntax to your resolution_prompt.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Mark that we need to append document statement (resolution uses inputs)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_append_document_to_resolution_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_is_reduce_operation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compare_pair</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">comparison_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">item1</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">item2</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">blocking_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">timeout_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
        <span class="n">max_retries_per_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compares two items using an LLM model to determine if they match.</span>

<span class="sd">        Args:</span>
<span class="sd">            comparison_prompt (str): The prompt template for comparison.</span>
<span class="sd">            model (str): The LLM model to use for comparison.</span>
<span class="sd">            item1 (dict): The first item to compare.</span>
<span class="sd">            item2 (dict): The second item to compare.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[bool, float, str]: A tuple containing a boolean indicating whether the items match, the cost of the comparison, and the prompt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">blocking_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
                <span class="n">key</span> <span class="ow">in</span> <span class="n">item1</span>
                <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item2</span>
                <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">item1</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">item2</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">blocking_keys</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>

        <span class="n">prompt</span> <span class="o">=</span> <span class="n">strict_render</span><span class="p">(</span><span class="n">comparison_prompt</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;input1&quot;</span><span class="p">:</span> <span class="n">item1</span><span class="p">,</span> <span class="s2">&quot;input2&quot;</span><span class="p">:</span> <span class="n">item2</span><span class="p">})</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">call_llm</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="s2">&quot;compare&quot;</span><span class="p">,</span>
            <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
            <span class="p">{</span><span class="s2">&quot;is_match&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">},</span>
            <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout_seconds</span><span class="p">,</span>
            <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="n">max_retries_per_timeout</span><span class="p">,</span>
            <span class="n">bypass_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bypass_cache&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bypass_cache</span><span class="p">),</span>
            <span class="n">litellm_completion_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;litellm_completion_kwargs&quot;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">op_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
            <span class="n">response</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;is_match&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">},</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;is_match&quot;</span><span class="p">],</span> <span class="n">response</span><span class="o">.</span><span class="n">total_cost</span><span class="p">,</span> <span class="n">prompt</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">syntax_check</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_from_df_accessors&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">_from_df_accessors</span><span class="p">}</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">syntax_check</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validation_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
            <span class="n">response</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">validate_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the resolve operation on the provided dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_data (list[dict]): The dataset to resolve.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[list[dict], float]: A tuple containing the resolved results and the total cost of the operation.</span>

<span class="sd">        This method performs the following steps:</span>
<span class="sd">        1. Initial blocking based on specified conditions and/or embedding similarity</span>
<span class="sd">        2. Pairwise comparison of potentially matching entries using LLM</span>
<span class="sd">        3. Clustering of matched entries</span>
<span class="sd">        4. Resolution of each cluster into a single entry (if applicable)</span>
<span class="sd">        5. Result aggregation and validation</span>

<span class="sd">        The method also calculates and logs statistics such as comparisons saved by blocking and self-join selectivity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="mi">0</span>

        <span class="c1"># Initialize observability data for all items at the start</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_observability&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">observability_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_observability_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">observability_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                    <span class="n">item</span><span class="p">[</span><span class="n">observability_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;comparison_prompts&quot;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="s2">&quot;resolution_prompt&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="p">}</span>

        <span class="n">blocking_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_keys&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">blocking_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_threshold&quot;</span><span class="p">)</span>
        <span class="n">blocking_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_conditions&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">limit_comparisons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limit_comparisons&quot;</span><span class="p">)</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="c1"># Track pre-computed embeddings from auto-optimization</span>
        <span class="n">precomputed_embeddings</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Auto-compute blocking threshold if no blocking configuration is provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blocking_threshold</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">blocking_conditions</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">limit_comparisons</span><span class="p">:</span>
            <span class="c1"># Get target recall from operation config (default 0.95)</span>
            <span class="n">target_recall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_target_recall&quot;</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[yellow]No blocking configuration. Auto-computing threshold (target recall: </span><span class="si">{</span><span class="n">target_recall</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2">)...[/yellow]&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Determine blocking keys if not set</span>
            <span class="n">auto_blocking_keys</span> <span class="o">=</span> <span class="n">blocking_keys</span> <span class="k">if</span> <span class="n">blocking_keys</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">auto_blocking_keys</span><span class="p">:</span>
                <span class="n">prompt_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">prompt_vars</span> <span class="o">=</span> <span class="n">extract_jinja_variables</span><span class="p">(</span><span class="n">prompt_template</span><span class="p">)</span>
                <span class="n">prompt_vars</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">var</span>
                    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">prompt_vars</span>
                    <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;input1&quot;</span><span class="p">,</span> <span class="s2">&quot;input2&quot;</span><span class="p">]</span>
                <span class="p">]</span>
                <span class="n">auto_blocking_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">set</span><span class="p">([</span><span class="n">var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">prompt_vars</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">auto_blocking_keys</span><span class="p">:</span>
                <span class="n">auto_blocking_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">blocking_keys</span> <span class="o">=</span> <span class="n">auto_blocking_keys</span>

            <span class="c1"># Create comparison function for threshold optimization</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">compare_fn_for_optimization</span><span class="p">(</span><span class="n">item1</span><span class="p">,</span> <span class="n">item2</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compare_pair</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comparison_model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">),</span>
                    <span class="n">item1</span><span class="p">,</span>
                    <span class="n">item2</span><span class="p">,</span>
                    <span class="n">blocking_keys</span><span class="o">=</span><span class="p">[],</span>  <span class="c1"># Don&#39;t use key-based shortcut during optimization</span>
                    <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
                    <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span>
                    <span class="p">),</span>
                <span class="p">)</span>

            <span class="c1"># Run threshold optimization</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">RuntimeBlockingOptimizer</span><span class="p">(</span>
                <span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                <span class="n">default_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">,</span>
                <span class="n">max_threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
                <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
                <span class="n">target_recall</span><span class="o">=</span><span class="n">target_recall</span><span class="p">,</span>
                <span class="n">sample_size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">blocking_threshold</span><span class="p">,</span> <span class="n">precomputed_embeddings</span><span class="p">,</span> <span class="n">optimization_cost</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">optimize_resolve</span><span class="p">(</span>
                    <span class="n">input_data</span><span class="p">,</span>
                    <span class="n">compare_fn_for_optimization</span><span class="p">,</span>
                    <span class="n">blocking_keys</span><span class="o">=</span><span class="n">blocking_keys</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">optimization_cost</span>

        <span class="n">input_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blocking_keys</span><span class="p">:</span>
            <span class="c1"># Set them to all keys in the input data</span>
            <span class="n">blocking_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">is_match</span><span class="p">(</span><span class="n">item1</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">item2</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">any</span><span class="p">(</span>
                <span class="nb">eval</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;input1&quot;</span><span class="p">:</span> <span class="n">item1</span><span class="p">,</span> <span class="s2">&quot;input2&quot;</span><span class="p">:</span> <span class="n">item2</span><span class="p">})</span>
                <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">blocking_conditions</span>
            <span class="p">)</span>

        <span class="c1"># Calculate embeddings if blocking_threshold is set</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">blocking_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use precomputed embeddings if available from auto-optimization</span>
            <span class="k">if</span> <span class="n">precomputed_embeddings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">embeddings</span> <span class="o">=</span> <span class="n">precomputed_embeddings</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[cyan]Creating embeddings for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> items...[/cyan]&quot;</span>
                <span class="p">)</span>
                <span class="n">embedding_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;embedding_model&quot;</span><span class="p">,</span> <span class="s2">&quot;text-embedding-3-small&quot;</span>
                <span class="p">)</span>
                <span class="n">model_input_context_length</span> <span class="o">=</span> <span class="n">model_cost</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">embedding_model</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;max_input_tokens&quot;</span><span class="p">,</span> <span class="mi">8192</span>
                <span class="p">)</span>
                <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;embedding_batch_size&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
                <span class="n">embeddings</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">embedding_cost</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">num_batches</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span>

                <span class="k">for</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_batches</span><span class="p">):</span>
                    <span class="n">start_idx</span> <span class="o">=</span> <span class="n">batch_idx</span> <span class="o">*</span> <span class="n">batch_size</span>
                    <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_idx</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))</span>
                    <span class="n">batch</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">num_batches</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;[dim]Creating embeddings: batch </span><span class="si">{</span><span class="n">batch_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_batches</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">end_idx</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> items)[/dim]&quot;</span>
                        <span class="p">)</span>

                    <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">blocking_keys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span>
                        <span class="p">)[:</span> <span class="n">model_input_context_length</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch</span>
                    <span class="p">]</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">gen_embedding</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">=</span><span class="n">embedding_model</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">texts</span>
                    <span class="p">)</span>
                    <span class="n">embeddings</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;embedding&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]])</span>
                    <span class="n">embedding_cost</span> <span class="o">+=</span> <span class="n">completion_cost</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

                <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">embedding_cost</span>

        <span class="c1"># Build a mapping of blocking key values to indices</span>
        <span class="c1"># This is used later for cluster merging (when two items match, merge all items sharing their key values)</span>
        <span class="n">value_to_indices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_data</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">blocking_keys</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value_to_indices</span><span class="p">:</span>
                <span class="n">value_to_indices</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">value_to_indices</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># Total number of pairs to potentially compare</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="n">total_pairs</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="c1"># Apply code-based blocking conditions (check all pairs)</span>
        <span class="n">code_blocked_pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">blocking_conditions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">is_match</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">input_data</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                        <span class="n">code_blocked_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>

        <span class="c1"># Apply cosine similarity blocking if threshold is specified</span>
        <span class="n">embedding_blocked_pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">blocking_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">embeddings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics.pairwise</span><span class="w"> </span><span class="kn">import</span> <span class="n">cosine_similarity</span>

            <span class="n">similarity_matrix</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span>
            <span class="n">code_blocked_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">code_blocked_pairs</span><span class="p">)</span>

            <span class="c1"># Use numpy to efficiently find all pairs above threshold</span>
            <span class="n">i_indices</span><span class="p">,</span> <span class="n">j_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">similarities</span> <span class="o">=</span> <span class="n">similarity_matrix</span><span class="p">[</span><span class="n">i_indices</span><span class="p">,</span> <span class="n">j_indices</span><span class="p">]</span>
            <span class="n">above_threshold_mask</span> <span class="o">=</span> <span class="n">similarities</span> <span class="o">&gt;=</span> <span class="n">blocking_threshold</span>

            <span class="c1"># Get pairs above threshold</span>
            <span class="n">above_threshold_i</span> <span class="o">=</span> <span class="n">i_indices</span><span class="p">[</span><span class="n">above_threshold_mask</span><span class="p">]</span>
            <span class="n">above_threshold_j</span> <span class="o">=</span> <span class="n">j_indices</span><span class="p">[</span><span class="n">above_threshold_mask</span><span class="p">]</span>

            <span class="c1"># Filter out pairs already in code_blocked_set</span>
            <span class="n">embedding_blocked_pairs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">above_threshold_i</span><span class="p">,</span> <span class="n">above_threshold_j</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">code_blocked_set</span>
            <span class="p">]</span>

        <span class="c1"># Combine pairs from both blocking methods</span>
        <span class="n">all_blocked_pairs</span> <span class="o">=</span> <span class="n">code_blocked_pairs</span> <span class="o">+</span> <span class="n">embedding_blocked_pairs</span>

        <span class="c1"># If no blocking was applied, compare all pairs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blocking_conditions</span> <span class="ow">and</span> <span class="n">blocking_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_blocked_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)]</span>
        <span class="c1"># Apply limit_comparisons with prioritization</span>
        <span class="k">if</span> <span class="n">limit_comparisons</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_blocked_pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">limit_comparisons</span><span class="p">:</span>
            <span class="c1"># Prioritize code-based pairs, then sample from embedding pairs if needed</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">code_blocked_pairs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">limit_comparisons</span><span class="p">:</span>
                <span class="c1"># If we have enough code-based pairs, just sample from those</span>
                <span class="n">blocked_pairs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">code_blocked_pairs</span><span class="p">,</span> <span class="n">limit_comparisons</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">limit_comparisons</span><span class="si">}</span><span class="s2"> code-based pairs (had </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">code_blocked_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> available)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Take all code-based pairs + sample from embedding pairs</span>
                <span class="n">remaining_slots</span> <span class="o">=</span> <span class="n">limit_comparisons</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">code_blocked_pairs</span><span class="p">)</span>
                <span class="n">sampled_embedding_pairs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="n">embedding_blocked_pairs</span><span class="p">,</span>
                    <span class="nb">min</span><span class="p">(</span><span class="n">remaining_slots</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">embedding_blocked_pairs</span><span class="p">)),</span>
                <span class="p">)</span>
                <span class="n">blocked_pairs</span> <span class="o">=</span> <span class="n">code_blocked_pairs</span> <span class="o">+</span> <span class="n">sampled_embedding_pairs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">code_blocked_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> code-based + </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sampled_embedding_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> embedding-based pairs &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(total: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">blocked_pairs</span> <span class="o">=</span> <span class="n">all_blocked_pairs</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">code_blocked_pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">embedding_blocked_pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Using all </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">code_blocked_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> code-based + </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">embedding_blocked_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> embedding-based pairs&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Initialize clusters with all indices</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="p">[{</span><span class="n">i</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))]</span>
        <span class="n">cluster_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))}</span>

        <span class="c1"># Modified merge_clusters to handle all indices with the same value</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">merge_clusters</span><span class="p">(</span><span class="n">item1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">item2</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">root1</span><span class="p">,</span> <span class="n">root2</span> <span class="o">=</span> <span class="n">find_cluster</span><span class="p">(</span><span class="n">item1</span><span class="p">,</span> <span class="n">cluster_map</span><span class="p">),</span> <span class="n">find_cluster</span><span class="p">(</span>
                <span class="n">item2</span><span class="p">,</span> <span class="n">cluster_map</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">root1</span> <span class="o">!=</span> <span class="n">root2</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">root1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">root2</span><span class="p">]):</span>
                    <span class="n">root1</span><span class="p">,</span> <span class="n">root2</span> <span class="o">=</span> <span class="n">root2</span><span class="p">,</span> <span class="n">root1</span>
                <span class="n">clusters</span><span class="p">[</span><span class="n">root1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">clusters</span><span class="p">[</span><span class="n">root2</span><span class="p">]</span>
                <span class="n">cluster_map</span><span class="p">[</span><span class="n">root2</span><span class="p">]</span> <span class="o">=</span> <span class="n">root1</span>
                <span class="n">clusters</span><span class="p">[</span><span class="n">root2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

                <span class="c1"># Also merge all other indices that share the same values</span>
                <span class="n">key1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="n">item1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">blocking_keys</span><span class="p">)</span>
                <span class="n">key2</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="n">item2</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">blocking_keys</span><span class="p">)</span>

                <span class="c1"># Merge all indices with the same values</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">value_to_indices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key1</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">if</span> <span class="n">idx</span> <span class="o">!=</span> <span class="n">item1</span><span class="p">:</span>
                        <span class="n">root_idx</span> <span class="o">=</span> <span class="n">find_cluster</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cluster_map</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">root_idx</span> <span class="o">!=</span> <span class="n">root1</span><span class="p">:</span>
                            <span class="n">clusters</span><span class="p">[</span><span class="n">root1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">clusters</span><span class="p">[</span><span class="n">root_idx</span><span class="p">]</span>
                            <span class="n">cluster_map</span><span class="p">[</span><span class="n">root_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">root1</span>
                            <span class="n">clusters</span><span class="p">[</span><span class="n">root_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">value_to_indices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key2</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">if</span> <span class="n">idx</span> <span class="o">!=</span> <span class="n">item2</span><span class="p">:</span>
                        <span class="n">root_idx</span> <span class="o">=</span> <span class="n">find_cluster</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cluster_map</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">root_idx</span> <span class="o">!=</span> <span class="n">root1</span><span class="p">:</span>
                            <span class="n">clusters</span><span class="p">[</span><span class="n">root1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">clusters</span><span class="p">[</span><span class="n">root_idx</span><span class="p">]</span>
                            <span class="n">cluster_map</span><span class="p">[</span><span class="n">root_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">root1</span>
                            <span class="n">clusters</span><span class="p">[</span><span class="n">root_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Compute an auto-batch size based on the number of comparisons</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">auto_batch</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
            <span class="c1"># Maximum batch size limit for 4o-mini model</span>
            <span class="n">M</span> <span class="o">=</span> <span class="mi">500</span>

            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span>

            <span class="c1"># https://www.wolframalpha.com/input?i=k%28k-1%29%2F2+%2B+%28n-k%29%28k-1%29+%3D+m%2C+solve+for+k</span>
            <span class="c1"># Two possible solutions for k:</span>
            <span class="c1"># k = -1/2 sqrt((1 - 2n)^2 - 8m) + n + 1/2</span>
            <span class="c1"># k = 1/2 (sqrt((1 - 2n)^2 - 8m) + 2n + 1)</span>

            <span class="n">discriminant</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">m</span>
            <span class="n">sqrt_discriminant</span> <span class="o">=</span> <span class="n">discriminant</span><span class="o">**</span><span class="mf">0.5</span>

            <span class="n">k1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">sqrt_discriminant</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span> <span class="mf">0.5</span>
            <span class="n">k2</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sqrt_discriminant</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Take the maximum viable solution</span>
            <span class="n">k</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">M</span> <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">M</span><span class="p">)</span>

        <span class="c1"># Compare pairs and update clusters in real-time</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compare_batch_size&quot;</span><span class="p">,</span> <span class="n">auto_batch</span><span class="p">())</span>

        <span class="c1"># Log blocking summary</span>
        <span class="n">total_possible_comparisons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Comparing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> pairs &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span><span class="o">/</span><span class="n">total_possible_comparisons</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% of </span><span class="si">{</span><span class="n">total_possible_comparisons</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> total, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;batch size: </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
        <span class="n">pair_costs</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">pbar</span> <span class="o">=</span> <span class="n">RichLoopBar</span><span class="p">(</span>
            <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">),</span>
            <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Processing batches of </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2"> LLM comparisons&quot;</span><span class="p">,</span>
            <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">last_processed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">batch_end</span> <span class="o">=</span> <span class="n">last_processed</span> <span class="o">+</span> <span class="n">batch_size</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">blocked_pairs</span><span class="p">[</span><span class="n">last_processed</span><span class="p">:</span><span class="n">batch_end</span><span class="p">]</span>
            <span class="c1"># Filter pairs for the initial batch</span>
            <span class="n">better_batch</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">pair</span>
                <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">batch</span>
                <span class="k">if</span> <span class="n">find_cluster</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cluster_map</span><span class="p">)</span> <span class="o">==</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">find_cluster</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cluster_map</span><span class="p">)</span> <span class="o">==</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">]</span>

            <span class="c1"># Expand better_batch if it doesnt reach batch_size</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">better_batch</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">batch_size</span> <span class="ow">and</span> <span class="n">batch_end</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">):</span>
                <span class="c1"># Move batch_end forward by batch_size to get more pairs</span>
                <span class="n">next_end</span> <span class="o">=</span> <span class="n">batch_end</span> <span class="o">+</span> <span class="n">batch_size</span>
                <span class="n">next_batch</span> <span class="o">=</span> <span class="n">blocked_pairs</span><span class="p">[</span><span class="n">batch_end</span><span class="p">:</span><span class="n">next_end</span><span class="p">]</span>

                <span class="n">better_batch</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="n">pair</span>
                    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">next_batch</span>
                    <span class="k">if</span> <span class="n">find_cluster</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cluster_map</span><span class="p">)</span> <span class="o">==</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">find_cluster</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cluster_map</span><span class="p">)</span> <span class="o">==</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="c1"># Update batch_end to prevent overlapping in the next loop</span>
                <span class="n">batch_end</span> <span class="o">=</span> <span class="n">next_end</span>
            <span class="n">better_batch</span> <span class="o">=</span> <span class="n">better_batch</span><span class="p">[:</span><span class="n">batch_size</span><span class="p">]</span>
            <span class="n">last_processed</span> <span class="o">=</span> <span class="n">batch_end</span>
            <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                <span class="n">future_to_pair</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">compare_pair</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comparison_model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">),</span>
                        <span class="n">input_data</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                        <span class="n">input_data</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                        <span class="n">blocking_keys</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
                        <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span>
                        <span class="p">),</span>
                    <span class="p">):</span> <span class="n">pair</span>
                    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">better_batch</span>
                <span class="p">}</span>

                <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">future_to_pair</span><span class="p">):</span>
                    <span class="n">pair</span> <span class="o">=</span> <span class="n">future_to_pair</span><span class="p">[</span><span class="n">future</span><span class="p">]</span>
                    <span class="n">is_match_result</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">prompt</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                    <span class="n">pair_costs</span> <span class="o">+=</span> <span class="n">cost</span>
                    <span class="k">if</span> <span class="n">is_match_result</span><span class="p">:</span>
                        <span class="n">merge_clusters</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_observability&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                        <span class="n">observability_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_observability_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="n">observability_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
                                <span class="n">input_data</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">observability_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s2">&quot;comparison_prompts&quot;</span><span class="p">:</span> <span class="p">[],</span>
                                    <span class="s2">&quot;resolution_prompt&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="p">}</span>
                            <span class="n">input_data</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">observability_key</span><span class="p">][</span>
                                <span class="s2">&quot;comparison_prompts&quot;</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>

        <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">pair_costs</span>

        <span class="c1"># Collect final clusters</span>
        <span class="n">final_clusters</span> <span class="o">=</span> <span class="p">[</span><span class="n">cluster</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span> <span class="k">if</span> <span class="n">cluster</span><span class="p">]</span>

        <span class="c1"># Process each cluster</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">process_cluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cluster_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">input_schema</span><span class="p">:</span>
                    <span class="n">cluster_items</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">item</span><span class="p">}</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cluster_items</span>
                    <span class="p">]</span>

                <span class="n">resolution_prompt</span> <span class="o">=</span> <span class="n">strict_render</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;resolution_prompt&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">cluster_items</span><span class="p">}</span>
                <span class="p">)</span>
                <span class="n">reduction_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">call_llm</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolution_model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">),</span>
                    <span class="s2">&quot;reduce&quot;</span><span class="p">,</span>
                    <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">resolution_prompt</span><span class="p">}],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
                    <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
                    <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span>
                    <span class="p">),</span>
                    <span class="n">bypass_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bypass_cache&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bypass_cache</span><span class="p">),</span>
                    <span class="n">validation_config</span><span class="o">=</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;val_rule&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                            <span class="s2">&quot;validation_fn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_fn</span><span class="p">,</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">),</span>
                    <span class="n">litellm_completion_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;litellm_completion_kwargs&quot;</span><span class="p">,</span> <span class="p">{}</span>
                    <span class="p">),</span>
                    <span class="n">op_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">reduction_cost</span> <span class="o">=</span> <span class="n">reduction_response</span><span class="o">.</span><span class="n">total_cost</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_observability&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">]:</span>
                        <span class="n">observability_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_observability_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">if</span> <span class="n">observability_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                            <span class="n">item</span><span class="p">[</span><span class="n">observability_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;comparison_prompts&quot;</span><span class="p">:</span> <span class="p">[],</span>
                                <span class="s2">&quot;resolution_prompt&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="n">item</span><span class="p">[</span><span class="n">observability_key</span><span class="p">][</span><span class="s2">&quot;resolution_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolution_prompt</span>

                <span class="k">if</span> <span class="n">reduction_response</span><span class="o">.</span><span class="n">validated</span><span class="p">:</span>
                    <span class="n">reduction_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
                        <span class="n">reduction_response</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
                        <span class="n">manually_fix_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manually_fix_errors</span><span class="p">,</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># If the output is overwriting an existing key, we want to save the kv pairs</span>
                    <span class="n">keys_in_output</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">k</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">reduction_output</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cluster_items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="p">]</span>

                    <span class="k">return</span> <span class="p">(</span>
                        <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="o">**</span><span class="n">item</span><span class="p">,</span>
                                <span class="sa">f</span><span class="s2">&quot;_kv_pairs_preresolve_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="p">{</span>
                                    <span class="n">k</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys_in_output</span>
                                <span class="p">},</span>
                                <span class="o">**</span><span class="p">{</span>
                                    <span class="n">k</span><span class="p">:</span> <span class="n">reduction_output</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span>
                                <span class="p">},</span>
                            <span class="p">}</span>
                            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">]</span>
                        <span class="p">],</span>
                        <span class="n">reduction_cost</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="p">[],</span> <span class="n">reduction_cost</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Set the output schema to be the keys found in the compare_prompt</span>
                <span class="n">compare_prompt_keys</span> <span class="o">=</span> <span class="n">extract_jinja_variables</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="c1"># Get the set of keys in the compare_prompt</span>
                <span class="n">compare_prompt_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;input1.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">compare_prompt_keys</span>
                        <span class="k">if</span> <span class="s2">&quot;input1&quot;</span> <span class="ow">in</span> <span class="n">k</span>
                    <span class="p">]</span>
                <span class="p">)</span>

                <span class="c1"># For each key in the output schema, find the most similar key in the compare_prompt</span>
                <span class="n">output_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">key_mapping</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">output_key</span> <span class="ow">in</span> <span class="n">output_keys</span><span class="p">:</span>
                    <span class="n">best_match</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">best_score</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">compare_key</span> <span class="ow">in</span> <span class="n">compare_prompt_keys</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                            <span class="n">c1</span> <span class="o">==</span> <span class="n">c2</span> <span class="k">for</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">output_key</span><span class="p">,</span> <span class="n">compare_key</span><span class="p">)</span>
                        <span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output_key</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">compare_key</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
                            <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
                            <span class="n">best_match</span> <span class="o">=</span> <span class="n">compare_key</span>
                    <span class="n">key_mapping</span><span class="p">[</span><span class="n">output_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_match</span>

                <span class="c1"># Create the result dictionary using the key mapping</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">cluster</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_kv_pairs_preresolve_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">ok</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="n">ck</span><span class="p">]</span> <span class="k">for</span> <span class="n">ok</span><span class="p">,</span> <span class="n">ck</span> <span class="ow">in</span> <span class="n">key_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">ck</span> <span class="ow">in</span> <span class="n">result</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">output_key</span><span class="p">,</span> <span class="n">compare_key</span> <span class="ow">in</span> <span class="n">key_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">compare_key</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">cluster</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]:</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">output_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">cluster</span><span class="p">)[</span><span class="mi">0</span><span class="p">]][</span><span class="n">compare_key</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">output_key</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">cluster</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]:</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">output_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">cluster</span><span class="p">)[</span><span class="mi">0</span><span class="p">]][</span><span class="n">output_key</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">output_key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># or some default value</span>

                <span class="k">return</span> <span class="p">[</span><span class="n">result</span><span class="p">],</span> <span class="mi">0</span>

        <span class="c1"># Calculate the number of records before and clusters after</span>
        <span class="n">num_records_before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="n">num_clusters_after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_clusters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of keys before resolution: </span><span class="si">{</span><span class="n">num_records_before</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Number of distinct keys after resolution: </span><span class="si">{</span><span class="n">num_clusters_after</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># If no resolution prompt is provided, we can skip the resolution phase</span>
        <span class="c1"># And simply select the most common value for each key</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolution_prompt&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">final_clusters</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;keys&quot;</span><span class="p">]:</span>
                        <span class="n">most_common_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                            <span class="nb">set</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">),</span>
                            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span>
                                <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster</span> <span class="k">if</span> <span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
                            <span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">most_common_value</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">input_data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">process_cluster</span><span class="p">,</span> <span class="n">cluster</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">final_clusters</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">rich_as_completed</span><span class="p">(</span>
                    <span class="n">futures</span><span class="p">,</span>
                    <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">futures</span><span class="p">),</span>
                    <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Determining resolved key for each group of equivalent keys&quot;</span><span class="p">,</span>
                    <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="n">cluster_results</span><span class="p">,</span> <span class="n">cluster_cost</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cluster_results</span><span class="p">)</span>
                    <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">cluster_cost</span>

        <span class="n">total_pairs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">true_match_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">final_clusters</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">true_match_selectivity</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">true_match_count</span> <span class="o">/</span> <span class="n">total_pairs</span> <span class="k">if</span> <span class="n">total_pairs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Self-join selectivity: </span><span class="si">{</span><span class="n">true_match_selectivity</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">total_cost</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="docetl.operations.resolve.ResolveOperation.compare_pair" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compare_pair</span><span class="p">(</span><span class="n">comparison_prompt</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">item1</span><span class="p">,</span> <span class="n">item2</span><span class="p">,</span> <span class="n">blocking_keys</span><span class="o">=</span><span class="p">[],</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compares two items using an LLM model to determine if they match.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>comparison_prompt</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The prompt template for comparison.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The LLM model to use for comparison.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>item1</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The first item to compare.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>item2</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The second item to compare.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="bool">bool</span>, <span title="float">float</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[bool, float, str]: A tuple containing a boolean indicating whether the items match, the cost of the comparison, and the prompt.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>docetl/operations/resolve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compare_pair</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">comparison_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">item1</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">item2</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">blocking_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">timeout_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
    <span class="n">max_retries_per_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compares two items using an LLM model to determine if they match.</span>

<span class="sd">    Args:</span>
<span class="sd">        comparison_prompt (str): The prompt template for comparison.</span>
<span class="sd">        model (str): The LLM model to use for comparison.</span>
<span class="sd">        item1 (dict): The first item to compare.</span>
<span class="sd">        item2 (dict): The second item to compare.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[bool, float, str]: A tuple containing a boolean indicating whether the items match, the cost of the comparison, and the prompt.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">blocking_keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">key</span> <span class="ow">in</span> <span class="n">item1</span>
            <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item2</span>
            <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">item1</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">item2</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">blocking_keys</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>

    <span class="n">prompt</span> <span class="o">=</span> <span class="n">strict_render</span><span class="p">(</span><span class="n">comparison_prompt</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;input1&quot;</span><span class="p">:</span> <span class="n">item1</span><span class="p">,</span> <span class="s2">&quot;input2&quot;</span><span class="p">:</span> <span class="n">item2</span><span class="p">})</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">call_llm</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="s2">&quot;compare&quot;</span><span class="p">,</span>
        <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
        <span class="p">{</span><span class="s2">&quot;is_match&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">},</span>
        <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout_seconds</span><span class="p">,</span>
        <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="n">max_retries_per_timeout</span><span class="p">,</span>
        <span class="n">bypass_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bypass_cache&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bypass_cache</span><span class="p">),</span>
        <span class="n">litellm_completion_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;litellm_completion_kwargs&quot;</span><span class="p">,</span> <span class="p">{}),</span>
        <span class="n">op_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
        <span class="n">response</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;is_match&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">},</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;is_match&quot;</span><span class="p">],</span> <span class="n">response</span><span class="o">.</span><span class="n">total_cost</span><span class="p">,</span> <span class="n">prompt</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.operations.resolve.ResolveOperation.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Executes the resolve operation on the provided dataset.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_data</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dataset to resolve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="list">list</span>[<span title="dict">dict</span>], <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[list[dict], float]: A tuple containing the resolved results and the total cost of the operation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>This method performs the following steps:
1. Initial blocking based on specified conditions and/or embedding similarity
2. Pairwise comparison of potentially matching entries using LLM
3. Clustering of matched entries
4. Resolution of each cluster into a single entry (if applicable)
5. Result aggregation and validation</p>
<p>The method also calculates and logs statistics such as comparisons saved by blocking and self-join selectivity.</p>


            <details class="quote">
              <summary>Source code in <code>docetl/operations/resolve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes the resolve operation on the provided dataset.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_data (list[dict]): The dataset to resolve.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[list[dict], float]: A tuple containing the resolved results and the total cost of the operation.</span>

<span class="sd">    This method performs the following steps:</span>
<span class="sd">    1. Initial blocking based on specified conditions and/or embedding similarity</span>
<span class="sd">    2. Pairwise comparison of potentially matching entries using LLM</span>
<span class="sd">    3. Clustering of matched entries</span>
<span class="sd">    4. Resolution of each cluster into a single entry (if applicable)</span>
<span class="sd">    5. Result aggregation and validation</span>

<span class="sd">    The method also calculates and logs statistics such as comparisons saved by blocking and self-join selectivity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="mi">0</span>

    <span class="c1"># Initialize observability data for all items at the start</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_observability&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">observability_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_observability_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">observability_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">item</span><span class="p">[</span><span class="n">observability_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;comparison_prompts&quot;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s2">&quot;resolution_prompt&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>

    <span class="n">blocking_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_keys&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">blocking_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_threshold&quot;</span><span class="p">)</span>
    <span class="n">blocking_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_conditions&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">limit_comparisons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limit_comparisons&quot;</span><span class="p">)</span>
    <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="c1"># Track pre-computed embeddings from auto-optimization</span>
    <span class="n">precomputed_embeddings</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Auto-compute blocking threshold if no blocking configuration is provided</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">blocking_threshold</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">blocking_conditions</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">limit_comparisons</span><span class="p">:</span>
        <span class="c1"># Get target recall from operation config (default 0.95)</span>
        <span class="n">target_recall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_target_recall&quot;</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[yellow]No blocking configuration. Auto-computing threshold (target recall: </span><span class="si">{</span><span class="n">target_recall</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2">)...[/yellow]&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Determine blocking keys if not set</span>
        <span class="n">auto_blocking_keys</span> <span class="o">=</span> <span class="n">blocking_keys</span> <span class="k">if</span> <span class="n">blocking_keys</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">auto_blocking_keys</span><span class="p">:</span>
            <span class="n">prompt_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">prompt_vars</span> <span class="o">=</span> <span class="n">extract_jinja_variables</span><span class="p">(</span><span class="n">prompt_template</span><span class="p">)</span>
            <span class="n">prompt_vars</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">var</span>
                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">prompt_vars</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;input1&quot;</span><span class="p">,</span> <span class="s2">&quot;input2&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="n">auto_blocking_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">([</span><span class="n">var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">prompt_vars</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">auto_blocking_keys</span><span class="p">:</span>
            <span class="n">auto_blocking_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">blocking_keys</span> <span class="o">=</span> <span class="n">auto_blocking_keys</span>

        <span class="c1"># Create comparison function for threshold optimization</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">compare_fn_for_optimization</span><span class="p">(</span><span class="n">item1</span><span class="p">,</span> <span class="n">item2</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compare_pair</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comparison_model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">),</span>
                <span class="n">item1</span><span class="p">,</span>
                <span class="n">item2</span><span class="p">,</span>
                <span class="n">blocking_keys</span><span class="o">=</span><span class="p">[],</span>  <span class="c1"># Don&#39;t use key-based shortcut during optimization</span>
                <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
                <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Run threshold optimization</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">RuntimeBlockingOptimizer</span><span class="p">(</span>
            <span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="n">default_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">,</span>
            <span class="n">max_threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
            <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
            <span class="n">target_recall</span><span class="o">=</span><span class="n">target_recall</span><span class="p">,</span>
            <span class="n">sample_size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">blocking_threshold</span><span class="p">,</span> <span class="n">precomputed_embeddings</span><span class="p">,</span> <span class="n">optimization_cost</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">optimize_resolve</span><span class="p">(</span>
                <span class="n">input_data</span><span class="p">,</span>
                <span class="n">compare_fn_for_optimization</span><span class="p">,</span>
                <span class="n">blocking_keys</span><span class="o">=</span><span class="n">blocking_keys</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">optimization_cost</span>

    <span class="n">input_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">blocking_keys</span><span class="p">:</span>
        <span class="c1"># Set them to all keys in the input data</span>
        <span class="n">blocking_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_match</span><span class="p">(</span><span class="n">item1</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">item2</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span>
            <span class="nb">eval</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;input1&quot;</span><span class="p">:</span> <span class="n">item1</span><span class="p">,</span> <span class="s2">&quot;input2&quot;</span><span class="p">:</span> <span class="n">item2</span><span class="p">})</span>
            <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">blocking_conditions</span>
        <span class="p">)</span>

    <span class="c1"># Calculate embeddings if blocking_threshold is set</span>
    <span class="n">embeddings</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">blocking_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Use precomputed embeddings if available from auto-optimization</span>
        <span class="k">if</span> <span class="n">precomputed_embeddings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">embeddings</span> <span class="o">=</span> <span class="n">precomputed_embeddings</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[cyan]Creating embeddings for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> items...[/cyan]&quot;</span>
            <span class="p">)</span>
            <span class="n">embedding_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;embedding_model&quot;</span><span class="p">,</span> <span class="s2">&quot;text-embedding-3-small&quot;</span>
            <span class="p">)</span>
            <span class="n">model_input_context_length</span> <span class="o">=</span> <span class="n">model_cost</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">embedding_model</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;max_input_tokens&quot;</span><span class="p">,</span> <span class="mi">8192</span>
            <span class="p">)</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;embedding_batch_size&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="n">embeddings</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">embedding_cost</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">num_batches</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span>

            <span class="k">for</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_batches</span><span class="p">):</span>
                <span class="n">start_idx</span> <span class="o">=</span> <span class="n">batch_idx</span> <span class="o">*</span> <span class="n">batch_size</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_idx</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">num_batches</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[dim]Creating embeddings: batch </span><span class="si">{</span><span class="n">batch_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_batches</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">end_idx</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> items)[/dim]&quot;</span>
                    <span class="p">)</span>

                <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">blocking_keys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span>
                    <span class="p">)[:</span> <span class="n">model_input_context_length</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch</span>
                <span class="p">]</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">gen_embedding</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">embedding_model</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">texts</span>
                <span class="p">)</span>
                <span class="n">embeddings</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;embedding&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]])</span>
                <span class="n">embedding_cost</span> <span class="o">+=</span> <span class="n">completion_cost</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

            <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">embedding_cost</span>

    <span class="c1"># Build a mapping of blocking key values to indices</span>
    <span class="c1"># This is used later for cluster merging (when two items match, merge all items sharing their key values)</span>
    <span class="n">value_to_indices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_data</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">blocking_keys</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value_to_indices</span><span class="p">:</span>
            <span class="n">value_to_indices</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">value_to_indices</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="c1"># Total number of pairs to potentially compare</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
    <span class="n">total_pairs</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="c1"># Apply code-based blocking conditions (check all pairs)</span>
    <span class="n">code_blocked_pairs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">blocking_conditions</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">is_match</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">input_data</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                    <span class="n">code_blocked_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>

    <span class="c1"># Apply cosine similarity blocking if threshold is specified</span>
    <span class="n">embedding_blocked_pairs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">blocking_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">embeddings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics.pairwise</span><span class="w"> </span><span class="kn">import</span> <span class="n">cosine_similarity</span>

        <span class="n">similarity_matrix</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span>
        <span class="n">code_blocked_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">code_blocked_pairs</span><span class="p">)</span>

        <span class="c1"># Use numpy to efficiently find all pairs above threshold</span>
        <span class="n">i_indices</span><span class="p">,</span> <span class="n">j_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">similarities</span> <span class="o">=</span> <span class="n">similarity_matrix</span><span class="p">[</span><span class="n">i_indices</span><span class="p">,</span> <span class="n">j_indices</span><span class="p">]</span>
        <span class="n">above_threshold_mask</span> <span class="o">=</span> <span class="n">similarities</span> <span class="o">&gt;=</span> <span class="n">blocking_threshold</span>

        <span class="c1"># Get pairs above threshold</span>
        <span class="n">above_threshold_i</span> <span class="o">=</span> <span class="n">i_indices</span><span class="p">[</span><span class="n">above_threshold_mask</span><span class="p">]</span>
        <span class="n">above_threshold_j</span> <span class="o">=</span> <span class="n">j_indices</span><span class="p">[</span><span class="n">above_threshold_mask</span><span class="p">]</span>

        <span class="c1"># Filter out pairs already in code_blocked_set</span>
        <span class="n">embedding_blocked_pairs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">above_threshold_i</span><span class="p">,</span> <span class="n">above_threshold_j</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">code_blocked_set</span>
        <span class="p">]</span>

    <span class="c1"># Combine pairs from both blocking methods</span>
    <span class="n">all_blocked_pairs</span> <span class="o">=</span> <span class="n">code_blocked_pairs</span> <span class="o">+</span> <span class="n">embedding_blocked_pairs</span>

    <span class="c1"># If no blocking was applied, compare all pairs</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">blocking_conditions</span> <span class="ow">and</span> <span class="n">blocking_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">all_blocked_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)]</span>
    <span class="c1"># Apply limit_comparisons with prioritization</span>
    <span class="k">if</span> <span class="n">limit_comparisons</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_blocked_pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">limit_comparisons</span><span class="p">:</span>
        <span class="c1"># Prioritize code-based pairs, then sample from embedding pairs if needed</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">code_blocked_pairs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">limit_comparisons</span><span class="p">:</span>
            <span class="c1"># If we have enough code-based pairs, just sample from those</span>
            <span class="n">blocked_pairs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">code_blocked_pairs</span><span class="p">,</span> <span class="n">limit_comparisons</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">limit_comparisons</span><span class="si">}</span><span class="s2"> code-based pairs (had </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">code_blocked_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> available)&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Take all code-based pairs + sample from embedding pairs</span>
            <span class="n">remaining_slots</span> <span class="o">=</span> <span class="n">limit_comparisons</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">code_blocked_pairs</span><span class="p">)</span>
            <span class="n">sampled_embedding_pairs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                <span class="n">embedding_blocked_pairs</span><span class="p">,</span>
                <span class="nb">min</span><span class="p">(</span><span class="n">remaining_slots</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">embedding_blocked_pairs</span><span class="p">)),</span>
            <span class="p">)</span>
            <span class="n">blocked_pairs</span> <span class="o">=</span> <span class="n">code_blocked_pairs</span> <span class="o">+</span> <span class="n">sampled_embedding_pairs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">code_blocked_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> code-based + </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sampled_embedding_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> embedding-based pairs &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(total: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">blocked_pairs</span> <span class="o">=</span> <span class="n">all_blocked_pairs</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">code_blocked_pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">embedding_blocked_pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Using all </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">code_blocked_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> code-based + </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">embedding_blocked_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> embedding-based pairs&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Initialize clusters with all indices</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="p">[{</span><span class="n">i</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))]</span>
    <span class="n">cluster_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))}</span>

    <span class="c1"># Modified merge_clusters to handle all indices with the same value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">merge_clusters</span><span class="p">(</span><span class="n">item1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">item2</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">root1</span><span class="p">,</span> <span class="n">root2</span> <span class="o">=</span> <span class="n">find_cluster</span><span class="p">(</span><span class="n">item1</span><span class="p">,</span> <span class="n">cluster_map</span><span class="p">),</span> <span class="n">find_cluster</span><span class="p">(</span>
            <span class="n">item2</span><span class="p">,</span> <span class="n">cluster_map</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">root1</span> <span class="o">!=</span> <span class="n">root2</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">root1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">root2</span><span class="p">]):</span>
                <span class="n">root1</span><span class="p">,</span> <span class="n">root2</span> <span class="o">=</span> <span class="n">root2</span><span class="p">,</span> <span class="n">root1</span>
            <span class="n">clusters</span><span class="p">[</span><span class="n">root1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">clusters</span><span class="p">[</span><span class="n">root2</span><span class="p">]</span>
            <span class="n">cluster_map</span><span class="p">[</span><span class="n">root2</span><span class="p">]</span> <span class="o">=</span> <span class="n">root1</span>
            <span class="n">clusters</span><span class="p">[</span><span class="n">root2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="c1"># Also merge all other indices that share the same values</span>
            <span class="n">key1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="n">item1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">blocking_keys</span><span class="p">)</span>
            <span class="n">key2</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="n">item2</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">blocking_keys</span><span class="p">)</span>

            <span class="c1"># Merge all indices with the same values</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">value_to_indices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key1</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">!=</span> <span class="n">item1</span><span class="p">:</span>
                    <span class="n">root_idx</span> <span class="o">=</span> <span class="n">find_cluster</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cluster_map</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">root_idx</span> <span class="o">!=</span> <span class="n">root1</span><span class="p">:</span>
                        <span class="n">clusters</span><span class="p">[</span><span class="n">root1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">clusters</span><span class="p">[</span><span class="n">root_idx</span><span class="p">]</span>
                        <span class="n">cluster_map</span><span class="p">[</span><span class="n">root_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">root1</span>
                        <span class="n">clusters</span><span class="p">[</span><span class="n">root_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">value_to_indices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key2</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">!=</span> <span class="n">item2</span><span class="p">:</span>
                    <span class="n">root_idx</span> <span class="o">=</span> <span class="n">find_cluster</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cluster_map</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">root_idx</span> <span class="o">!=</span> <span class="n">root1</span><span class="p">:</span>
                        <span class="n">clusters</span><span class="p">[</span><span class="n">root1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">clusters</span><span class="p">[</span><span class="n">root_idx</span><span class="p">]</span>
                        <span class="n">cluster_map</span><span class="p">[</span><span class="n">root_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">root1</span>
                        <span class="n">clusters</span><span class="p">[</span><span class="n">root_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># Compute an auto-batch size based on the number of comparisons</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">auto_batch</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># Maximum batch size limit for 4o-mini model</span>
        <span class="n">M</span> <span class="o">=</span> <span class="mi">500</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span>

        <span class="c1"># https://www.wolframalpha.com/input?i=k%28k-1%29%2F2+%2B+%28n-k%29%28k-1%29+%3D+m%2C+solve+for+k</span>
        <span class="c1"># Two possible solutions for k:</span>
        <span class="c1"># k = -1/2 sqrt((1 - 2n)^2 - 8m) + n + 1/2</span>
        <span class="c1"># k = 1/2 (sqrt((1 - 2n)^2 - 8m) + 2n + 1)</span>

        <span class="n">discriminant</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">m</span>
        <span class="n">sqrt_discriminant</span> <span class="o">=</span> <span class="n">discriminant</span><span class="o">**</span><span class="mf">0.5</span>

        <span class="n">k1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">sqrt_discriminant</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span> <span class="mf">0.5</span>
        <span class="n">k2</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sqrt_discriminant</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Take the maximum viable solution</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">M</span> <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">M</span><span class="p">)</span>

    <span class="c1"># Compare pairs and update clusters in real-time</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compare_batch_size&quot;</span><span class="p">,</span> <span class="n">auto_batch</span><span class="p">())</span>

    <span class="c1"># Log blocking summary</span>
    <span class="n">total_possible_comparisons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Comparing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> pairs &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span><span class="o">/</span><span class="n">total_possible_comparisons</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% of </span><span class="si">{</span><span class="n">total_possible_comparisons</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> total, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;batch size: </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="p">)</span>
    <span class="n">pair_costs</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">pbar</span> <span class="o">=</span> <span class="n">RichLoopBar</span><span class="p">(</span>
        <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">),</span>
        <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Processing batches of </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2"> LLM comparisons&quot;</span><span class="p">,</span>
        <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">last_processed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="n">batch_end</span> <span class="o">=</span> <span class="n">last_processed</span> <span class="o">+</span> <span class="n">batch_size</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">blocked_pairs</span><span class="p">[</span><span class="n">last_processed</span><span class="p">:</span><span class="n">batch_end</span><span class="p">]</span>
        <span class="c1"># Filter pairs for the initial batch</span>
        <span class="n">better_batch</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">pair</span>
            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">batch</span>
            <span class="k">if</span> <span class="n">find_cluster</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cluster_map</span><span class="p">)</span> <span class="o">==</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">find_cluster</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cluster_map</span><span class="p">)</span> <span class="o">==</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="c1"># Expand better_batch if it doesnt reach batch_size</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">better_batch</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">batch_size</span> <span class="ow">and</span> <span class="n">batch_end</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">):</span>
            <span class="c1"># Move batch_end forward by batch_size to get more pairs</span>
            <span class="n">next_end</span> <span class="o">=</span> <span class="n">batch_end</span> <span class="o">+</span> <span class="n">batch_size</span>
            <span class="n">next_batch</span> <span class="o">=</span> <span class="n">blocked_pairs</span><span class="p">[</span><span class="n">batch_end</span><span class="p">:</span><span class="n">next_end</span><span class="p">]</span>

            <span class="n">better_batch</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">pair</span>
                <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">next_batch</span>
                <span class="k">if</span> <span class="n">find_cluster</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cluster_map</span><span class="p">)</span> <span class="o">==</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">find_cluster</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cluster_map</span><span class="p">)</span> <span class="o">==</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># Update batch_end to prevent overlapping in the next loop</span>
            <span class="n">batch_end</span> <span class="o">=</span> <span class="n">next_end</span>
        <span class="n">better_batch</span> <span class="o">=</span> <span class="n">better_batch</span><span class="p">[:</span><span class="n">batch_size</span><span class="p">]</span>
        <span class="n">last_processed</span> <span class="o">=</span> <span class="n">batch_end</span>
        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">future_to_pair</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compare_pair</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comparison_model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">),</span>
                    <span class="n">input_data</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                    <span class="n">input_data</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                    <span class="n">blocking_keys</span><span class="p">,</span>
                    <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
                    <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span>
                    <span class="p">),</span>
                <span class="p">):</span> <span class="n">pair</span>
                <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">better_batch</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">future_to_pair</span><span class="p">):</span>
                <span class="n">pair</span> <span class="o">=</span> <span class="n">future_to_pair</span><span class="p">[</span><span class="n">future</span><span class="p">]</span>
                <span class="n">is_match_result</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">prompt</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="n">pair_costs</span> <span class="o">+=</span> <span class="n">cost</span>
                <span class="k">if</span> <span class="n">is_match_result</span><span class="p">:</span>
                    <span class="n">merge_clusters</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_observability&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">observability_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_observability_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="n">observability_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
                            <span class="n">input_data</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">observability_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;comparison_prompts&quot;</span><span class="p">:</span> <span class="p">[],</span>
                                <span class="s2">&quot;resolution_prompt&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="n">input_data</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">observability_key</span><span class="p">][</span>
                            <span class="s2">&quot;comparison_prompts&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>

    <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">pair_costs</span>

    <span class="c1"># Collect final clusters</span>
    <span class="n">final_clusters</span> <span class="o">=</span> <span class="p">[</span><span class="n">cluster</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span> <span class="k">if</span> <span class="n">cluster</span><span class="p">]</span>

    <span class="c1"># Process each cluster</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_cluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cluster_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">input_schema</span><span class="p">:</span>
                <span class="n">cluster_items</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">item</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cluster_items</span>
                <span class="p">]</span>

            <span class="n">resolution_prompt</span> <span class="o">=</span> <span class="n">strict_render</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;resolution_prompt&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">cluster_items</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">reduction_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">call_llm</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolution_model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">),</span>
                <span class="s2">&quot;reduce&quot;</span><span class="p">,</span>
                <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">resolution_prompt</span><span class="p">}],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
                <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
                <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span>
                <span class="p">),</span>
                <span class="n">bypass_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bypass_cache&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bypass_cache</span><span class="p">),</span>
                <span class="n">validation_config</span><span class="o">=</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;val_rule&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                        <span class="s2">&quot;validation_fn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_fn</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
                <span class="n">litellm_completion_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;litellm_completion_kwargs&quot;</span><span class="p">,</span> <span class="p">{}</span>
                <span class="p">),</span>
                <span class="n">op_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">reduction_cost</span> <span class="o">=</span> <span class="n">reduction_response</span><span class="o">.</span><span class="n">total_cost</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_observability&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">]:</span>
                    <span class="n">observability_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_observability_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">observability_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                        <span class="n">item</span><span class="p">[</span><span class="n">observability_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;comparison_prompts&quot;</span><span class="p">:</span> <span class="p">[],</span>
                            <span class="s2">&quot;resolution_prompt&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="n">item</span><span class="p">[</span><span class="n">observability_key</span><span class="p">][</span><span class="s2">&quot;resolution_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolution_prompt</span>

            <span class="k">if</span> <span class="n">reduction_response</span><span class="o">.</span><span class="n">validated</span><span class="p">:</span>
                <span class="n">reduction_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
                    <span class="n">reduction_response</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
                    <span class="n">manually_fix_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manually_fix_errors</span><span class="p">,</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># If the output is overwriting an existing key, we want to save the kv pairs</span>
                <span class="n">keys_in_output</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">k</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">reduction_output</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cluster_items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="p">]</span>

                <span class="k">return</span> <span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="o">**</span><span class="n">item</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;_kv_pairs_preresolve_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="n">k</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys_in_output</span>
                            <span class="p">},</span>
                            <span class="o">**</span><span class="p">{</span>
                                <span class="n">k</span><span class="p">:</span> <span class="n">reduction_output</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span>
                            <span class="p">},</span>
                        <span class="p">}</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">]</span>
                    <span class="p">],</span>
                    <span class="n">reduction_cost</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="n">reduction_cost</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Set the output schema to be the keys found in the compare_prompt</span>
            <span class="n">compare_prompt_keys</span> <span class="o">=</span> <span class="n">extract_jinja_variables</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># Get the set of keys in the compare_prompt</span>
            <span class="n">compare_prompt_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;input1.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">compare_prompt_keys</span>
                    <span class="k">if</span> <span class="s2">&quot;input1&quot;</span> <span class="ow">in</span> <span class="n">k</span>
                <span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># For each key in the output schema, find the most similar key in the compare_prompt</span>
            <span class="n">output_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">key_mapping</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">output_key</span> <span class="ow">in</span> <span class="n">output_keys</span><span class="p">:</span>
                <span class="n">best_match</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">best_score</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">compare_key</span> <span class="ow">in</span> <span class="n">compare_prompt_keys</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                        <span class="n">c1</span> <span class="o">==</span> <span class="n">c2</span> <span class="k">for</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">output_key</span><span class="p">,</span> <span class="n">compare_key</span><span class="p">)</span>
                    <span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output_key</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">compare_key</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
                        <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
                        <span class="n">best_match</span> <span class="o">=</span> <span class="n">compare_key</span>
                <span class="n">key_mapping</span><span class="p">[</span><span class="n">output_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_match</span>

            <span class="c1"># Create the result dictionary using the key mapping</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">cluster</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_kv_pairs_preresolve_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">ok</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="n">ck</span><span class="p">]</span> <span class="k">for</span> <span class="n">ok</span><span class="p">,</span> <span class="n">ck</span> <span class="ow">in</span> <span class="n">key_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">ck</span> <span class="ow">in</span> <span class="n">result</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">output_key</span><span class="p">,</span> <span class="n">compare_key</span> <span class="ow">in</span> <span class="n">key_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">compare_key</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">cluster</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">output_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">cluster</span><span class="p">)[</span><span class="mi">0</span><span class="p">]][</span><span class="n">compare_key</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">output_key</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">cluster</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">output_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">cluster</span><span class="p">)[</span><span class="mi">0</span><span class="p">]][</span><span class="n">output_key</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">output_key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># or some default value</span>

            <span class="k">return</span> <span class="p">[</span><span class="n">result</span><span class="p">],</span> <span class="mi">0</span>

    <span class="c1"># Calculate the number of records before and clusters after</span>
    <span class="n">num_records_before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
    <span class="n">num_clusters_after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_clusters</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of keys before resolution: </span><span class="si">{</span><span class="n">num_records_before</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Number of distinct keys after resolution: </span><span class="si">{</span><span class="n">num_clusters_after</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="c1"># If no resolution prompt is provided, we can skip the resolution phase</span>
    <span class="c1"># And simply select the most common value for each key</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolution_prompt&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">final_clusters</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;keys&quot;</span><span class="p">]:</span>
                    <span class="n">most_common_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                        <span class="nb">set</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">),</span>
                        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span>
                            <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster</span> <span class="k">if</span> <span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
                        <span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">most_common_value</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">input_data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">process_cluster</span><span class="p">,</span> <span class="n">cluster</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">final_clusters</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">rich_as_completed</span><span class="p">(</span>
                <span class="n">futures</span><span class="p">,</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">futures</span><span class="p">),</span>
                <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Determining resolved key for each group of equivalent keys&quot;</span><span class="p">,</span>
                <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">cluster_results</span><span class="p">,</span> <span class="n">cluster_cost</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cluster_results</span><span class="p">)</span>
                <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">cluster_cost</span>

    <span class="n">total_pairs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">true_match_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">final_clusters</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">true_match_selectivity</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">true_match_count</span> <span class="o">/</span> <span class="n">total_pairs</span> <span class="k">if</span> <span class="n">total_pairs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Self-join selectivity: </span><span class="si">{</span><span class="n">true_match_selectivity</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">total_cost</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="docetl.operations.reduce.ReduceOperation" class="doc doc-heading">
            <code>docetl.operations.reduce.ReduceOperation</code>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="docetl.operations.base.BaseOperation">BaseOperation</span></code></p>


        <p>A class that implements a reduce operation on input data using language models.</p>
<p>This class extends BaseOperation to provide functionality for reducing grouped data
using various strategies including batch reduce, incremental reduce, and parallel fold and merge.</p>







              <details class="quote">
                <summary>Source code in <code>docetl/operations/reduce.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  42</span>
<span class="normal">  43</span>
<span class="normal">  44</span>
<span class="normal">  45</span>
<span class="normal">  46</span>
<span class="normal">  47</span>
<span class="normal">  48</span>
<span class="normal">  49</span>
<span class="normal">  50</span>
<span class="normal">  51</span>
<span class="normal">  52</span>
<span class="normal">  53</span>
<span class="normal">  54</span>
<span class="normal">  55</span>
<span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ReduceOperation</span><span class="p">(</span><span class="n">BaseOperation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that implements a reduce operation on input data using language models.</span>

<span class="sd">    This class extends BaseOperation to provide functionality for reducing grouped data</span>
<span class="sd">    using various strategies including batch reduce, incremental reduce, and parallel fold and merge.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">schema</span><span class="p">(</span><span class="n">BaseOperation</span><span class="o">.</span><span class="n">schema</span><span class="p">):</span>
        <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;reduce&quot;</span>
        <span class="n">reduce_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
        <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">optimize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">synthesize_resolve</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">input</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pass_through</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">associative</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fold_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fold_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">merge_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">merge_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">value_sampling</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">litellm_completion_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
        <span class="n">enable_observability</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;prompt&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_prompt</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Check if it has Jinja syntax</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                    <span class="c1"># This will be handled during initialization with user confirmation</span>
                    <span class="k">return</span> <span class="n">v</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">template_vars</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span>
                        <span class="n">jinja2</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">Name</span>
                    <span class="p">)</span>
                    <span class="n">template_var_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">template_vars</span><span class="p">}</span>
                    <span class="k">if</span> <span class="s2">&quot;inputs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">template_var_names</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;Prompt template must include the &#39;inputs&#39; variable&quot;</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid Jinja2 template in &#39;prompt&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;fold_prompt&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_fold_prompt</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Check if it has Jinja syntax</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                    <span class="c1"># This will be handled during initialization with user confirmation</span>
                    <span class="k">return</span> <span class="n">v</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fold_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">fold_template_vars</span> <span class="o">=</span> <span class="n">fold_template</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span>
                        <span class="n">jinja2</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">Name</span>
                    <span class="p">)</span>
                    <span class="n">fold_template_var_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">fold_template_vars</span><span class="p">}</span>
                    <span class="n">required_vars</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;output&quot;</span><span class="p">}</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">required_vars</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">fold_template_var_names</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Fold template must include variables: </span><span class="si">{</span><span class="n">required_vars</span><span class="si">}</span><span class="s2">. Current template includes: </span><span class="si">{</span><span class="n">fold_template_var_names</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Invalid Jinja2 template in &#39;fold_prompt&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;merge_prompt&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_merge_prompt</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Check if it has Jinja syntax</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                    <span class="c1"># This will be handled during initialization with user confirmation</span>
                    <span class="k">return</span> <span class="n">v</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">merge_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">merge_template_vars</span> <span class="o">=</span> <span class="n">merge_template</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span>
                        <span class="n">jinja2</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">Name</span>
                    <span class="p">)</span>
                    <span class="n">merge_template_var_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">merge_template_vars</span><span class="p">}</span>
                    <span class="k">if</span> <span class="s2">&quot;outputs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merge_template_var_names</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;Merge template must include the &#39;outputs&#39; variable&quot;</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Invalid Jinja2 template in &#39;merge_prompt&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;value_sampling&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_value_sampling</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;enabled&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="s2">&quot;first_n&quot;</span><span class="p">,</span> <span class="s2">&quot;cluster&quot;</span><span class="p">,</span> <span class="s2">&quot;sem_sim&quot;</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;Invalid &#39;method&#39;. Must be &#39;random&#39;, &#39;first_n&#39;, &#39;cluster&#39;, or &#39;sem_sim&#39;&quot;</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;embedding&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;embedding_model&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;&#39;embedding_model&#39; is required when using embedding-based sampling&quot;</span>
                            <span class="p">)</span>
                        <span class="k">if</span> <span class="s2">&quot;embedding_keys&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;&#39;embedding_keys&#39; is required when using embedding-based sampling&quot;</span>
                            <span class="p">)</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_complex_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># Check dependencies between merge_prompt and fold_prompt</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_prompt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_prompt</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;fold_prompt&#39; is required when &#39;merge_prompt&#39; is specified&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Check batch size requirements</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_prompt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_batch_size</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;fold_batch_size&#39; is required when &#39;fold_prompt&#39; is specified&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_prompt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_batch_size</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;merge_batch_size&#39; is required when &#39;merge_prompt&#39; is specified&quot;</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the ReduceOperation.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Variable length argument list.</span>
<span class="sd">            **kwargs: Arbitrary keyword arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_samples</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_samples</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fold_times</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_samples</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merge_times</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_samples</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intermediates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineage_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lineage&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># Check for non-Jinja prompts and prompt user for confirmation</span>
        <span class="k">if</span> <span class="s2">&quot;prompt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">prompt_user_for_non_jinja_confirmation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="s2">&quot;prompt&quot;</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Operation &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; cancelled by user. Please add Jinja2 template syntax to your prompt.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Mark that we need to append document statement (for reduce, use inputs)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_append_document_to_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_is_reduce_operation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s2">&quot;fold_prompt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;fold_prompt&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">prompt_user_for_non_jinja_confirmation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;fold_prompt&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="s2">&quot;fold_prompt&quot;</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Operation &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; cancelled by user. Please add Jinja2 template syntax to your fold_prompt.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_append_document_to_fold_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_is_reduce_operation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s2">&quot;merge_prompt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;merge_prompt&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">prompt_user_for_non_jinja_confirmation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;merge_prompt&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="s2">&quot;merge_prompt&quot;</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Operation &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; cancelled by user. Please add Jinja2 template syntax to your merge_prompt.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_append_document_to_merge_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_is_reduce_operation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the reduce operation on the provided input data.</span>

<span class="sd">        This method sorts and groups the input data by the reduce key(s), then processes each group</span>
<span class="sd">        using either parallel fold and merge, incremental reduce, or batch reduce strategies.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_data (list[dict]): The input data to process.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[list[dict], float]: A tuple containing the processed results and the total cost of the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gleaning&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validation_prompt&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Using gleaning with validation prompt: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gleaning&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;validation_prompt&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">reduce_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reduce_keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">reduce_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">reduce_keys</span><span class="p">]</span>
        <span class="n">input_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="c1"># Check if we need to group everything into one group</span>
        <span class="k">if</span> <span class="n">reduce_keys</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;_all&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">reduce_keys</span> <span class="o">==</span> <span class="s2">&quot;_all&quot;</span><span class="p">:</span>
            <span class="n">grouped_data</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;_all&quot;</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Group the input data by the reduce key(s) while maintaining original order</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">get_group_key</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                <span class="n">key_values</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">reduce_keys</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="c1"># Special handling for list-type values</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">key_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                        <span class="p">)</span>  <span class="c1"># Convert list to sorted tuple</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">key_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">key_values</span><span class="p">)</span>

            <span class="n">grouped_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">get_group_key</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grouped_data</span><span class="p">:</span>
                    <span class="n">grouped_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">grouped_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

            <span class="c1"># Convert the grouped data to a list of tuples</span>
            <span class="n">grouped_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">grouped_data</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="n">limit_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limit&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">limit_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Sort by group size (smallest first) and take the limit</span>
            <span class="n">grouped_data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">grouped_data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">grouped_data</span> <span class="o">=</span> <span class="n">grouped_data</span><span class="p">[:</span><span class="n">limit_value</span><span class="p">]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">process_group</span><span class="p">(</span>
            <span class="n">key</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">group_elems</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">input_schema</span><span class="p">:</span>
                <span class="n">group_list</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">item</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">group_elems</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group_list</span> <span class="o">=</span> <span class="n">group_elems</span>

            <span class="n">total_cost</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="c1"># Build retrieval context once per group</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">retrieval_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_build_retrieval_context</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;reduce_key&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">],</span> <span class="n">key</span><span class="p">)),</span>
                        <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">group_list</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">retrieval_context</span> <span class="o">=</span> <span class="s2">&quot;No extra context available.&quot;</span>

            <span class="c1"># Apply value sampling if enabled</span>
            <span class="n">value_sampling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value_sampling&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">value_sampling</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">value_sampling</span><span class="p">[</span><span class="s2">&quot;sample_size&quot;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_list</span><span class="p">))</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">value_sampling</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
                    <span class="n">group_sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">group_list</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">)</span>
                    <span class="n">group_sample</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">group_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;first_n&quot;</span><span class="p">:</span>
                    <span class="n">group_sample</span> <span class="o">=</span> <span class="n">group_list</span><span class="p">[:</span><span class="n">sample_size</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;cluster&quot;</span><span class="p">:</span>
                    <span class="n">group_sample</span><span class="p">,</span> <span class="n">embedding_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_based_sampling</span><span class="p">(</span>
                        <span class="n">group_list</span><span class="p">,</span> <span class="n">value_sampling</span><span class="p">,</span> <span class="n">sample_size</span>
                    <span class="p">)</span>
                    <span class="n">group_sample</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">group_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                    <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">embedding_cost</span>
                <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;sem_sim&quot;</span><span class="p">:</span>
                    <span class="n">group_sample</span><span class="p">,</span> <span class="n">embedding_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_semantic_similarity_sampling</span><span class="p">(</span>
                        <span class="n">key</span><span class="p">,</span> <span class="n">group_list</span><span class="p">,</span> <span class="n">value_sampling</span><span class="p">,</span> <span class="n">sample_size</span>
                    <span class="p">)</span>
                    <span class="n">group_sample</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">group_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                    <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">embedding_cost</span>

                <span class="n">group_list</span> <span class="o">=</span> <span class="n">group_sample</span>

            <span class="c1"># Only execute merge-based plans if associative = True</span>
            <span class="k">if</span> <span class="s2">&quot;merge_prompt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;associative&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parallel_fold_and_merge</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">group_list</span><span class="p">,</span> <span class="n">retrieval_context</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fold_batch_size&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;fold_batch_size&quot;</span>
            <span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_list</span><span class="p">):</span>
                <span class="c1"># If the fold batch size is greater than or equal to the number of items in the group,</span>
                <span class="c1"># we can just run a single fold operation</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_reduce</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">group_list</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">retrieval_context</span>
                <span class="p">)</span>
                <span class="n">prompts</span> <span class="o">=</span> <span class="p">[</span><span class="n">prompt</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s2">&quot;fold_prompt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_incremental_reduce</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">group_list</span><span class="p">,</span> <span class="n">retrieval_context</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_reduce</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">group_list</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">retrieval_context</span>
                <span class="p">)</span>
                <span class="n">prompts</span> <span class="o">=</span> <span class="p">[</span><span class="n">prompt</span><span class="p">]</span>

            <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">cost</span>

            <span class="c1"># Add the counts of items in the group to the result</span>
            <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_counts_prereduce_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_elems</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_observability&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="c1"># Add the _observability_{self.config[&#39;name&#39;]} key to the result</span>
                <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_observability_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;prompts&quot;</span><span class="p">:</span> <span class="n">prompts</span><span class="p">}</span>

            <span class="c1"># Add retrieved context if save_retriever_output is enabled</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_retriever_output&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">retrieval_context</span>
                    <span class="k">if</span> <span class="n">retrieval_context</span>
                    <span class="ow">and</span> <span class="n">retrieval_context</span> <span class="o">!=</span> <span class="s2">&quot;No extra context available.&quot;</span>
                    <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_retrieved_context&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span>

            <span class="c1"># Apply pass-through at the group level</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pass_through&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">group_elems</span>
            <span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">group_elems</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

            <span class="c1"># Add lineage information</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineage_keys</span><span class="p">:</span>
                <span class="n">lineage</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">group_elems</span><span class="p">:</span>
                    <span class="n">lineage_item</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">k</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineage_keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">item</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="n">lineage_item</span><span class="p">:</span>
                        <span class="n">lineage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lineage_item</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_lineage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lineage</span>

            <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">total_cost</span>

        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">process_group</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped_data</span>
            <span class="p">]</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">rich_as_completed</span><span class="p">(</span>
                <span class="n">futures</span><span class="p">,</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">futures</span><span class="p">),</span>
                <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (reduce) on all documents&quot;</span><span class="p">,</span>
                <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">output</span><span class="p">,</span> <span class="n">item_cost</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">item_cost</span>
                <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">limit_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">limit_value</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:</span><span class="n">limit_value</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;persist_intermediates&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intermediates</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_intermediates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">intermediates</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">total_cost</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_cluster_based_sampling</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">group_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">value_sampling</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">sample_size</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">group_list</span><span class="p">,</span> <span class="mi">0</span>

        <span class="n">clusters</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">cluster_documents</span><span class="p">(</span>
            <span class="n">group_list</span><span class="p">,</span> <span class="n">value_sampling</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span>
        <span class="p">)</span>

        <span class="n">sampled_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">idx_added_already</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">num_clusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sample_size</span><span class="p">):</span>
            <span class="c1"># Add a random item from the cluster</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">num_clusters</span>

            <span class="c1"># Skip if there are no items in the cluster</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># If there&#39;s only one item in the cluster, add it directly if we haven&#39;t already</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idx_added_already</span><span class="p">:</span>
                    <span class="n">sampled_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="n">random_choice_idx</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">max_attempts</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="k">while</span> <span class="n">random_choice_idx</span> <span class="ow">in</span> <span class="n">idx_added_already</span> <span class="ow">and</span> <span class="n">max_attempts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">random_choice_idx</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">max_attempts</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">idx_added_already</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">random_choice_idx</span><span class="p">)</span>
            <span class="n">sampled_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">random_choice_idx</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">sampled_items</span><span class="p">,</span> <span class="n">cost</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_semantic_similarity_sampling</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">group_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">value_sampling</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">embedding_model</span> <span class="o">=</span> <span class="n">value_sampling</span><span class="p">[</span><span class="s2">&quot;embedding_model&quot;</span><span class="p">]</span>
        <span class="n">query_text</span> <span class="o">=</span> <span class="n">strict_render</span><span class="p">(</span>
            <span class="n">value_sampling</span><span class="p">[</span><span class="s2">&quot;query_text&quot;</span><span class="p">],</span>
            <span class="p">{</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">],</span> <span class="n">key</span><span class="p">))},</span>
        <span class="p">)</span>

        <span class="n">embeddings</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">get_embeddings_for_clustering</span><span class="p">(</span>
            <span class="n">group_list</span><span class="p">,</span> <span class="n">value_sampling</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span>
        <span class="p">)</span>

        <span class="n">query_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">gen_embedding</span><span class="p">(</span><span class="n">embedding_model</span><span class="p">,</span> <span class="p">[</span><span class="n">query_text</span><span class="p">])</span>
        <span class="n">query_embedding</span> <span class="o">=</span> <span class="n">query_response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;embedding&quot;</span><span class="p">]</span>
        <span class="n">cost</span> <span class="o">+=</span> <span class="n">completion_cost</span><span class="p">(</span><span class="n">query_response</span><span class="p">)</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics.pairwise</span><span class="w"> </span><span class="kn">import</span> <span class="n">cosine_similarity</span>

        <span class="n">similarities</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">([</span><span class="n">query_embedding</span><span class="p">],</span> <span class="n">embeddings</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">top_k_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">similarities</span><span class="p">)[</span><span class="o">-</span><span class="n">sample_size</span><span class="p">:]</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">group_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">top_k_indices</span><span class="p">],</span> <span class="n">cost</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parallel_fold_and_merge</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">group_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">retrieval_context</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform parallel folding and merging on a group of items.</span>

<span class="sd">        This method implements a strategy that combines parallel folding of input items</span>
<span class="sd">        and merging of intermediate results to efficiently process large groups. It works as follows:</span>
<span class="sd">        1. The input group is initially divided into smaller batches for efficient processing.</span>
<span class="sd">        2. The method performs an initial round of folding operations on these batches.</span>
<span class="sd">        3. After the first round of folds, a few merges are performed to estimate the merge runtime.</span>
<span class="sd">        4. Based on the estimated merge runtime and observed fold runtime, it calculates the optimal number of parallel folds. Subsequent rounds of folding are then performed concurrently, with the number of parallel folds determined by the runtime estimates.</span>
<span class="sd">        5. The folding process repeats in rounds, progressively reducing the number of items to be processed.</span>
<span class="sd">        6. Once all folding operations are complete, the method recursively performs final merges on the fold results to combine them into a final result.</span>
<span class="sd">        7. Throughout this process, the method may adjust the number of parallel folds based on updated performance metrics (i.e., fold and merge runtimes) to maintain efficiency.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (tuple): The reduce key tuple for the group.</span>
<span class="sd">            group_list (list[dict]): The list of items in the group to be processed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[dict | None, float]: A tuple containing the final merged result (or None if processing failed)</span>
<span class="sd">            and the total cost of the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fold_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;fold_batch_size&quot;</span><span class="p">]</span>
        <span class="n">merge_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;merge_batch_size&quot;</span><span class="p">]</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">prompts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">calculate_num_parallel_folds</span><span class="p">():</span>
            <span class="n">fold_time</span><span class="p">,</span> <span class="n">fold_default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fold_time</span><span class="p">()</span>
            <span class="n">merge_time</span><span class="p">,</span> <span class="n">merge_default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_merge_time</span><span class="p">()</span>
            <span class="n">num_group_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_list</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="nb">max</span><span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="nb">int</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">fold_time</span> <span class="o">*</span> <span class="n">num_group_items</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">merge_batch_size</span><span class="p">))</span>
                        <span class="o">/</span> <span class="p">(</span><span class="n">fold_batch_size</span> <span class="o">*</span> <span class="n">merge_time</span><span class="p">)</span>
                    <span class="p">),</span>
                <span class="p">),</span>
                <span class="n">fold_default</span> <span class="ow">or</span> <span class="n">merge_default</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">num_parallel_folds</span><span class="p">,</span> <span class="n">used_default_times</span> <span class="o">=</span> <span class="n">calculate_num_parallel_folds</span><span class="p">()</span>
        <span class="n">fold_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">remaining_items</span> <span class="o">=</span> <span class="n">group_list</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;persist_intermediates&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intermediates</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">iter_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Parallel folding and merging</span>
        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">remaining_items</span><span class="p">:</span>
                <span class="c1"># Folding phase</span>
                <span class="n">fold_futures</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">num_parallel_folds</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining_items</span><span class="p">))):</span>
                    <span class="n">batch</span> <span class="o">=</span> <span class="n">remaining_items</span><span class="p">[:</span><span class="n">fold_batch_size</span><span class="p">]</span>
                    <span class="n">remaining_items</span> <span class="o">=</span> <span class="n">remaining_items</span><span class="p">[</span><span class="n">fold_batch_size</span><span class="p">:]</span>
                    <span class="n">current_output</span> <span class="o">=</span> <span class="n">fold_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">fold_results</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="n">fold_futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_increment_fold</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">current_output</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">new_fold_results</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">fold_futures</span><span class="p">):</span>
                    <span class="n">result</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                    <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">cost</span>
                    <span class="n">prompts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">new_fold_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;persist_intermediates&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">intermediates</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;iter&quot;</span><span class="p">:</span> <span class="n">iter_count</span><span class="p">,</span>
                                    <span class="s2">&quot;intermediate&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
                                    <span class="s2">&quot;scratchpad&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;updated_scratchpad&quot;</span><span class="p">],</span>
                                <span class="p">}</span>
                            <span class="p">)</span>
                            <span class="n">iter_count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Update fold_results with new results</span>
                <span class="n">fold_results</span> <span class="o">=</span> <span class="n">new_fold_results</span> <span class="o">+</span> <span class="n">fold_results</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">new_fold_results</span><span class="p">)</span> <span class="p">:]</span>

                <span class="c1"># Single pass merging phase</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merge_times</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_samples</span>
                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">fold_results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">merge_batch_size</span>
                <span class="p">):</span>
                    <span class="n">merge_futures</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fold_results</span><span class="p">),</span> <span class="n">merge_batch_size</span><span class="p">):</span>
                        <span class="n">batch</span> <span class="o">=</span> <span class="n">fold_results</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">merge_batch_size</span><span class="p">]</span>
                        <span class="n">merge_futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_merge_results</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="n">new_results</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">merge_futures</span><span class="p">):</span>
                        <span class="n">result</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                        <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">cost</span>
                        <span class="n">prompts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">new_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;persist_intermediates&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">intermediates</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="p">{</span>
                                        <span class="s2">&quot;iter&quot;</span><span class="p">:</span> <span class="n">iter_count</span><span class="p">,</span>
                                        <span class="s2">&quot;intermediate&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
                                        <span class="s2">&quot;scratchpad&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="p">}</span>
                                <span class="p">)</span>
                                <span class="n">iter_count</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="n">fold_results</span> <span class="o">=</span> <span class="n">new_results</span>

                <span class="c1"># Recalculate num_parallel_folds if we used default times</span>
                <span class="k">if</span> <span class="n">used_default_times</span><span class="p">:</span>
                    <span class="n">new_num_parallel_folds</span><span class="p">,</span> <span class="n">used_default_times</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">calculate_num_parallel_folds</span><span class="p">()</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">used_default_times</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Recalculated num_parallel_folds from </span><span class="si">{</span><span class="n">num_parallel_folds</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new_num_parallel_folds</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">num_parallel_folds</span> <span class="o">=</span> <span class="n">new_num_parallel_folds</span>

        <span class="c1"># Final merging if needed</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">fold_results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished folding! Merging </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fold_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> items.&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                <span class="n">merge_futures</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fold_results</span><span class="p">),</span> <span class="n">merge_batch_size</span><span class="p">):</span>
                    <span class="n">batch</span> <span class="o">=</span> <span class="n">fold_results</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">merge_batch_size</span><span class="p">]</span>
                    <span class="n">merge_futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_merge_results</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">new_results</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">merge_futures</span><span class="p">):</span>
                    <span class="n">result</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                    <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">cost</span>
                    <span class="n">prompts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">new_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;persist_intermediates&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">intermediates</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;iter&quot;</span><span class="p">:</span> <span class="n">iter_count</span><span class="p">,</span>
                                    <span class="s2">&quot;intermediate&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
                                    <span class="s2">&quot;scratchpad&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="p">}</span>
                            <span class="p">)</span>
                            <span class="n">iter_count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">fold_results</span> <span class="o">=</span> <span class="n">new_results</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">fold_results</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">total_cost</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fold_results</span>
            <span class="k">else</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">total_cost</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_incremental_reduce</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">group_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">retrieval_context</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform an incremental reduce operation on a group of items.</span>

<span class="sd">        This method processes the group in batches, incrementally folding the results.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (tuple): The reduce key tuple for the group.</span>
<span class="sd">            group_list (list[dict]): The list of items in the group to be processed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[dict | None, list[str], float]: A tuple containing the final reduced result (or None if processing failed),</span>
<span class="sd">            the list of prompts used, and the total cost of the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fold_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;fold_batch_size&quot;</span><span class="p">]</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">current_output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">prompts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Calculate and log the number of folds to be performed</span>
        <span class="n">num_folds</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group_list</span><span class="p">)</span> <span class="o">+</span> <span class="n">fold_batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">fold_batch_size</span>

        <span class="n">scratchpad</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;persist_intermediates&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intermediates</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">iter_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_list</span><span class="p">),</span> <span class="n">fold_batch_size</span><span class="p">):</span>
            <span class="c1"># Log the current iteration and total number of folds</span>
            <span class="n">current_fold</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="n">fold_batch_size</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Processing fold </span><span class="si">{</span><span class="n">current_fold</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">num_folds</span><span class="si">}</span><span class="s2"> for group with key </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">group_list</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">fold_batch_size</span><span class="p">]</span>

            <span class="n">folded_output</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">fold_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_increment_fold</span><span class="p">(</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">current_output</span><span class="p">,</span> <span class="n">scratchpad</span>
            <span class="p">)</span>
            <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">fold_cost</span>
            <span class="n">prompts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">folded_output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;persist_intermediates&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">intermediates</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;iter&quot;</span><span class="p">:</span> <span class="n">iter_count</span><span class="p">,</span>
                        <span class="s2">&quot;intermediate&quot;</span><span class="p">:</span> <span class="n">folded_output</span><span class="p">,</span>
                        <span class="s2">&quot;scratchpad&quot;</span><span class="p">:</span> <span class="n">folded_output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;updated_scratchpad&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="n">iter_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Pop off updated_scratchpad</span>
            <span class="k">if</span> <span class="s2">&quot;updated_scratchpad&quot;</span> <span class="ow">in</span> <span class="n">folded_output</span><span class="p">:</span>
                <span class="n">scratchpad</span> <span class="o">=</span> <span class="n">folded_output</span><span class="p">[</span><span class="s2">&quot;updated_scratchpad&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Updated scratchpad for fold </span><span class="si">{</span><span class="n">current_fold</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">scratchpad</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">del</span> <span class="n">folded_output</span><span class="p">[</span><span class="s2">&quot;updated_scratchpad&quot;</span><span class="p">]</span>

            <span class="n">current_output</span> <span class="o">=</span> <span class="n">folded_output</span>

        <span class="k">return</span> <span class="n">current_output</span><span class="p">,</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">total_cost</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validation_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="n">structured_mode</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span>
            <span class="o">==</span> <span class="n">OutputMode</span><span class="o">.</span><span class="n">STRUCTURED_OUTPUT</span><span class="o">.</span><span class="n">value</span>
        <span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
            <span class="n">response</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
            <span class="n">use_structured_output</span><span class="o">=</span><span class="n">structured_mode</span><span class="p">,</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Enforce type validation against output schema</span>
        <span class="n">is_types_valid</span><span class="p">,</span> <span class="n">_errors</span> <span class="o">=</span> <span class="n">validate_output_types</span><span class="p">(</span>
            <span class="n">output</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_types_valid</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">validate_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_increment_fold</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
        <span class="n">batch</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
        <span class="n">current_output</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scratchpad</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">retrieval_context</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform an incremental fold operation on a batch of items.</span>

<span class="sd">        This method folds a batch of items into the current output using the fold prompt.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (tuple): The reduce key tuple for the group.</span>
<span class="sd">            batch (list[dict]): The batch of items to be folded.</span>
<span class="sd">            current_output (dict | None): The current accumulated output, if any.</span>
<span class="sd">            scratchpad (str | None): The scratchpad to use for the fold operation.</span>
<span class="sd">        Returns:</span>
<span class="sd">            tuple[dict | None, str, float]: A tuple containing the folded output (or None if processing failed),</span>
<span class="sd">            the prompt used, and the cost of the fold operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">current_output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_reduce</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">scratchpad</span><span class="p">,</span> <span class="n">retrieval_context</span><span class="p">)</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">fold_prompt</span> <span class="o">=</span> <span class="n">strict_render</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;fold_prompt&quot;</span><span class="p">],</span>
            <span class="p">{</span>
                <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">batch</span><span class="p">,</span>
                <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">current_output</span><span class="p">,</span>
                <span class="s2">&quot;reduce_key&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">],</span> <span class="n">key</span><span class="p">)),</span>
                <span class="s2">&quot;retrieval_context&quot;</span><span class="p">:</span> <span class="n">retrieval_context</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">retrieval_context</span> <span class="ow">and</span> <span class="s2">&quot;retrieval_context&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;fold_prompt&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="p">):</span>
            <span class="n">fold_prompt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Here is some extra context:</span><span class="se">\n</span><span class="si">{</span><span class="n">retrieval_context</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">fold_prompt</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">call_llm</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">),</span>
            <span class="s2">&quot;reduce&quot;</span><span class="p">,</span>
            <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">fold_prompt</span><span class="p">}],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
            <span class="n">scratchpad</span><span class="o">=</span><span class="n">scratchpad</span><span class="p">,</span>
            <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
            <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">validation_config</span><span class="o">=</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;num_retries&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_retries_on_validate_failure</span><span class="p">,</span>
                    <span class="s2">&quot;val_rule&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="s2">&quot;validation_fn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_fn</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">),</span>
            <span class="n">bypass_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bypass_cache&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bypass_cache</span><span class="p">),</span>
            <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">litellm_completion_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;litellm_completion_kwargs&quot;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">op_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_fold_time</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
        <span class="n">fold_cost</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">total_cost</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">validated</span><span class="p">:</span>
            <span class="n">structured_mode</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span>
                <span class="o">==</span> <span class="n">OutputMode</span><span class="o">.</span><span class="n">STRUCTURED_OUTPUT</span><span class="o">.</span><span class="n">value</span>
            <span class="p">)</span>
            <span class="n">folded_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
                <span class="n">response</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
                <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
                <span class="n">manually_fix_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manually_fix_errors</span><span class="p">,</span>
                <span class="n">use_structured_output</span><span class="o">=</span><span class="n">structured_mode</span><span class="p">,</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">folded_output</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">],</span> <span class="n">key</span><span class="p">)))</span>
            <span class="n">fold_cost</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">total_cost</span>

            <span class="k">return</span> <span class="n">folded_output</span><span class="p">,</span> <span class="n">fold_prompt</span><span class="p">,</span> <span class="n">fold_cost</span>

        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fold_prompt</span><span class="p">,</span> <span class="n">fold_cost</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_merge_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">outputs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">retrieval_context</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge multiple outputs into a single result.</span>

<span class="sd">        This method merges a list of outputs using the merge prompt.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (tuple): The reduce key tuple for the group.</span>
<span class="sd">            outputs (list[dict]): The list of outputs to be merged.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[dict | None, str, float]: A tuple containing the merged output (or None if processing failed),</span>
<span class="sd">            the prompt used, and the cost of the merge operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">merge_prompt</span> <span class="o">=</span> <span class="n">strict_render</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;merge_prompt&quot;</span><span class="p">],</span>
            <span class="p">{</span>
                <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">outputs</span><span class="p">,</span>
                <span class="s2">&quot;reduce_key&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">],</span> <span class="n">key</span><span class="p">)),</span>
                <span class="s2">&quot;retrieval_context&quot;</span><span class="p">:</span> <span class="n">retrieval_context</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">retrieval_context</span> <span class="ow">and</span> <span class="s2">&quot;retrieval_context&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;merge_prompt&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="p">):</span>
            <span class="n">merge_prompt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Here is some extra context:</span><span class="se">\n</span><span class="si">{</span><span class="n">retrieval_context</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">merge_prompt</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">call_llm</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">),</span>
            <span class="s2">&quot;merge&quot;</span><span class="p">,</span>
            <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">merge_prompt</span><span class="p">}],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
            <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
            <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">validation_config</span><span class="o">=</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;num_retries&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_retries_on_validate_failure</span><span class="p">,</span>
                    <span class="s2">&quot;val_rule&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="s2">&quot;validation_fn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_fn</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">),</span>
            <span class="n">bypass_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bypass_cache&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bypass_cache</span><span class="p">),</span>
            <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">litellm_completion_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;litellm_completion_kwargs&quot;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">op_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_merge_time</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
        <span class="n">merge_cost</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">total_cost</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">validated</span><span class="p">:</span>
            <span class="n">structured_mode</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span>
                <span class="o">==</span> <span class="n">OutputMode</span><span class="o">.</span><span class="n">STRUCTURED_OUTPUT</span><span class="o">.</span><span class="n">value</span>
            <span class="p">)</span>
            <span class="n">merged_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
                <span class="n">response</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
                <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
                <span class="n">manually_fix_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manually_fix_errors</span><span class="p">,</span>
                <span class="n">use_structured_output</span><span class="o">=</span><span class="n">structured_mode</span><span class="p">,</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">merged_output</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">],</span> <span class="n">key</span><span class="p">)))</span>
            <span class="n">merge_cost</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">total_cost</span>
            <span class="k">return</span> <span class="n">merged_output</span><span class="p">,</span> <span class="n">merge_prompt</span><span class="p">,</span> <span class="n">merge_cost</span>

        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">merge_prompt</span><span class="p">,</span> <span class="n">merge_cost</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_fold_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the average fold time or a default value.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[float, bool]: A tuple containing the average fold time (or default) and a boolean</span>
<span class="sd">            indicating whether the default value was used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;fold_time&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;fold_time&quot;</span><span class="p">],</span> <span class="kc">False</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fold_times</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_samples</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fold_times</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fold_times</span><span class="p">),</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="mf">1.0</span><span class="p">,</span> <span class="kc">True</span>  <span class="c1"># Default to 1 second if no data is available</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_merge_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the average merge time or a default value.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[float, bool]: A tuple containing the average merge time (or default) and a boolean</span>
<span class="sd">            indicating whether the default value was used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;merge_time&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;merge_time&quot;</span><span class="p">],</span> <span class="kc">False</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merge_times</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_samples</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merge_times</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merge_times</span><span class="p">),</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="mf">1.0</span><span class="p">,</span> <span class="kc">True</span>  <span class="c1"># Default to 1 second if no data is available</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_fold_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the fold time statistics.</span>

<span class="sd">        Args:</span>
<span class="sd">            time (float): The time taken for a fold operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fold_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_merge_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the merge time statistics.</span>

<span class="sd">        Args:</span>
<span class="sd">            time (float): The time taken for a merge operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">merge_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_batch_reduce</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
        <span class="n">group_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
        <span class="n">scratchpad</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">retrieval_context</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a batch reduce operation on a group of items.</span>

<span class="sd">        This method reduces a group of items into a single output using the reduce prompt.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (tuple): The reduce key tuple for the group.</span>
<span class="sd">            group_list (list[dict]): The list of items to be reduced.</span>
<span class="sd">            scratchpad (str | None): The scratchpad to use for the reduce operation.</span>
<span class="sd">        Returns:</span>
<span class="sd">            tuple[dict | None, str, float]: A tuple containing the reduced output (or None if processing failed),</span>
<span class="sd">            the prompt used, and the cost of the reduce operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">strict_render</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">],</span>
            <span class="p">{</span>
                <span class="s2">&quot;reduce_key&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">],</span> <span class="n">key</span><span class="p">)),</span>
                <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">group_list</span><span class="p">,</span>
                <span class="s2">&quot;retrieval_context&quot;</span><span class="p">:</span> <span class="n">retrieval_context</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">retrieval_context</span> <span class="ow">and</span> <span class="s2">&quot;retrieval_context&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;prompt&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="p">):</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Here is some extra context:</span><span class="se">\n</span><span class="si">{</span><span class="n">retrieval_context</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">item_cost</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">call_llm</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">),</span>
            <span class="s2">&quot;reduce&quot;</span><span class="p">,</span>
            <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
            <span class="n">scratchpad</span><span class="o">=</span><span class="n">scratchpad</span><span class="p">,</span>
            <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
            <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">bypass_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bypass_cache&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bypass_cache</span><span class="p">),</span>
            <span class="n">validation_config</span><span class="o">=</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;num_retries&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_retries_on_validate_failure</span><span class="p">,</span>
                    <span class="s2">&quot;val_rule&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="s2">&quot;validation_fn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_fn</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">),</span>
            <span class="n">gleaning_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gleaning&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">litellm_completion_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;litellm_completion_kwargs&quot;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">op_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">item_cost</span> <span class="o">+=</span> <span class="n">response</span><span class="o">.</span><span class="n">total_cost</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">validated</span><span class="p">:</span>
            <span class="n">structured_mode</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span>
                <span class="o">==</span> <span class="n">OutputMode</span><span class="o">.</span><span class="n">STRUCTURED_OUTPUT</span><span class="o">.</span><span class="n">value</span>
            <span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
                <span class="n">response</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
                <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
                <span class="n">manually_fix_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manually_fix_errors</span><span class="p">,</span>
                <span class="n">use_structured_output</span><span class="o">=</span><span class="n">structured_mode</span><span class="p">,</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">output</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">],</span> <span class="n">key</span><span class="p">)))</span>

            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">item_cost</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">item_cost</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="docetl.operations.reduce.ReduceOperation.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the ReduceOperation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>*args</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Variable length argument list.</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Arbitrary keyword arguments.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>docetl/operations/reduce.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the ReduceOperation.</span>

<span class="sd">    Args:</span>
<span class="sd">        *args: Variable length argument list.</span>
<span class="sd">        **kwargs: Arbitrary keyword arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">min_samples</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_samples</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fold_times</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_samples</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">merge_times</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_samples</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">intermediates</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lineage_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lineage&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="c1"># Check for non-Jinja prompts and prompt user for confirmation</span>
    <span class="k">if</span> <span class="s2">&quot;prompt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prompt_user_for_non_jinja_confirmation</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="s2">&quot;prompt&quot;</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Operation &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; cancelled by user. Please add Jinja2 template syntax to your prompt.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Mark that we need to append document statement (for reduce, use inputs)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_append_document_to_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_is_reduce_operation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="s2">&quot;fold_prompt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;fold_prompt&quot;</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prompt_user_for_non_jinja_confirmation</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;fold_prompt&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="s2">&quot;fold_prompt&quot;</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Operation &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; cancelled by user. Please add Jinja2 template syntax to your fold_prompt.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_append_document_to_fold_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_is_reduce_operation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="s2">&quot;merge_prompt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;merge_prompt&quot;</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prompt_user_for_non_jinja_confirmation</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;merge_prompt&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="s2">&quot;merge_prompt&quot;</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Operation &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; cancelled by user. Please add Jinja2 template syntax to your merge_prompt.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_append_document_to_merge_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_is_reduce_operation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.operations.reduce.ReduceOperation.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Execute the reduce operation on the provided input data.</p>
<p>This method sorts and groups the input data by the reduce key(s), then processes each group
using either parallel fold and merge, incremental reduce, or batch reduce strategies.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_data</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input data to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="list">list</span>[<span title="dict">dict</span>], <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[list[dict], float]: A tuple containing the processed results and the total cost of the operation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>docetl/operations/reduce.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute the reduce operation on the provided input data.</span>

<span class="sd">    This method sorts and groups the input data by the reduce key(s), then processes each group</span>
<span class="sd">    using either parallel fold and merge, incremental reduce, or batch reduce strategies.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_data (list[dict]): The input data to process.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[list[dict], float]: A tuple containing the processed results and the total cost of the operation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gleaning&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validation_prompt&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Using gleaning with validation prompt: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gleaning&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;validation_prompt&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">reduce_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reduce_keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">reduce_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">reduce_keys</span><span class="p">]</span>
    <span class="n">input_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="c1"># Check if we need to group everything into one group</span>
    <span class="k">if</span> <span class="n">reduce_keys</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;_all&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">reduce_keys</span> <span class="o">==</span> <span class="s2">&quot;_all&quot;</span><span class="p">:</span>
        <span class="n">grouped_data</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;_all&quot;</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Group the input data by the reduce key(s) while maintaining original order</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_group_key</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="n">key_values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">reduce_keys</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="c1"># Special handling for list-type values</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">key_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                    <span class="p">)</span>  <span class="c1"># Convert list to sorted tuple</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">key_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">key_values</span><span class="p">)</span>

        <span class="n">grouped_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">get_group_key</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grouped_data</span><span class="p">:</span>
                <span class="n">grouped_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">grouped_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="c1"># Convert the grouped data to a list of tuples</span>
        <span class="n">grouped_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">grouped_data</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

    <span class="n">limit_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limit&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">limit_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Sort by group size (smallest first) and take the limit</span>
        <span class="n">grouped_data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">grouped_data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">grouped_data</span> <span class="o">=</span> <span class="n">grouped_data</span><span class="p">[:</span><span class="n">limit_value</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_group</span><span class="p">(</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">group_elems</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">input_schema</span><span class="p">:</span>
            <span class="n">group_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">item</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">group_elems</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">group_list</span> <span class="o">=</span> <span class="n">group_elems</span>

        <span class="n">total_cost</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># Build retrieval context once per group</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">retrieval_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_build_retrieval_context</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;reduce_key&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">],</span> <span class="n">key</span><span class="p">)),</span>
                    <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">group_list</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">retrieval_context</span> <span class="o">=</span> <span class="s2">&quot;No extra context available.&quot;</span>

        <span class="c1"># Apply value sampling if enabled</span>
        <span class="n">value_sampling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value_sampling&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">value_sampling</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">value_sampling</span><span class="p">[</span><span class="s2">&quot;sample_size&quot;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_list</span><span class="p">))</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">value_sampling</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
                <span class="n">group_sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">group_list</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">)</span>
                <span class="n">group_sample</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">group_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;first_n&quot;</span><span class="p">:</span>
                <span class="n">group_sample</span> <span class="o">=</span> <span class="n">group_list</span><span class="p">[:</span><span class="n">sample_size</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;cluster&quot;</span><span class="p">:</span>
                <span class="n">group_sample</span><span class="p">,</span> <span class="n">embedding_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_based_sampling</span><span class="p">(</span>
                    <span class="n">group_list</span><span class="p">,</span> <span class="n">value_sampling</span><span class="p">,</span> <span class="n">sample_size</span>
                <span class="p">)</span>
                <span class="n">group_sample</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">group_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">embedding_cost</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;sem_sim&quot;</span><span class="p">:</span>
                <span class="n">group_sample</span><span class="p">,</span> <span class="n">embedding_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_semantic_similarity_sampling</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">group_list</span><span class="p">,</span> <span class="n">value_sampling</span><span class="p">,</span> <span class="n">sample_size</span>
                <span class="p">)</span>
                <span class="n">group_sample</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">group_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">embedding_cost</span>

            <span class="n">group_list</span> <span class="o">=</span> <span class="n">group_sample</span>

        <span class="c1"># Only execute merge-based plans if associative = True</span>
        <span class="k">if</span> <span class="s2">&quot;merge_prompt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;associative&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">result</span><span class="p">,</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parallel_fold_and_merge</span><span class="p">(</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">group_list</span><span class="p">,</span> <span class="n">retrieval_context</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fold_batch_size&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;fold_batch_size&quot;</span>
        <span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_list</span><span class="p">):</span>
            <span class="c1"># If the fold batch size is greater than or equal to the number of items in the group,</span>
            <span class="c1"># we can just run a single fold operation</span>
            <span class="n">result</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_reduce</span><span class="p">(</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">group_list</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">retrieval_context</span>
            <span class="p">)</span>
            <span class="n">prompts</span> <span class="o">=</span> <span class="p">[</span><span class="n">prompt</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;fold_prompt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="n">result</span><span class="p">,</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_incremental_reduce</span><span class="p">(</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">group_list</span><span class="p">,</span> <span class="n">retrieval_context</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_reduce</span><span class="p">(</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">group_list</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">retrieval_context</span>
            <span class="p">)</span>
            <span class="n">prompts</span> <span class="o">=</span> <span class="p">[</span><span class="n">prompt</span><span class="p">]</span>

        <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">cost</span>

        <span class="c1"># Add the counts of items in the group to the result</span>
        <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_counts_prereduce_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_elems</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_observability&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="c1"># Add the _observability_{self.config[&#39;name&#39;]} key to the result</span>
            <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_observability_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;prompts&quot;</span><span class="p">:</span> <span class="n">prompts</span><span class="p">}</span>

        <span class="c1"># Add retrieved context if save_retriever_output is enabled</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_retriever_output&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">retrieval_context</span>
                <span class="k">if</span> <span class="n">retrieval_context</span>
                <span class="ow">and</span> <span class="n">retrieval_context</span> <span class="o">!=</span> <span class="s2">&quot;No extra context available.&quot;</span>
                <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_retrieved_context&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span>

        <span class="c1"># Apply pass-through at the group level</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pass_through&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">group_elems</span>
        <span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">group_elems</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="c1"># Add lineage information</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineage_keys</span><span class="p">:</span>
            <span class="n">lineage</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">group_elems</span><span class="p">:</span>
                <span class="n">lineage_item</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineage_keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">item</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">lineage_item</span><span class="p">:</span>
                    <span class="n">lineage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lineage_item</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_lineage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lineage</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">total_cost</span>

    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">process_group</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped_data</span>
        <span class="p">]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">rich_as_completed</span><span class="p">(</span>
            <span class="n">futures</span><span class="p">,</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">futures</span><span class="p">),</span>
            <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (reduce) on all documents&quot;</span><span class="p">,</span>
            <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">item_cost</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">item_cost</span>
            <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">limit_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">limit_value</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:</span><span class="n">limit_value</span><span class="p">]</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;persist_intermediates&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intermediates</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_intermediates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">intermediates</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">total_cost</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.operations.reduce.ReduceOperation.get_fold_time" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_fold_time</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Get the average fold time or a default value.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[float, bool]: A tuple containing the average fold time (or default) and a boolean</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>indicating whether the default value was used.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>docetl/operations/reduce.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_fold_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the average fold time or a default value.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[float, bool]: A tuple containing the average fold time (or default) and a boolean</span>
<span class="sd">        indicating whether the default value was used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;fold_time&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;fold_time&quot;</span><span class="p">],</span> <span class="kc">False</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fold_times</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_samples</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fold_times</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fold_times</span><span class="p">),</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="mf">1.0</span><span class="p">,</span> <span class="kc">True</span>  <span class="c1"># Default to 1 second if no data is available</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.operations.reduce.ReduceOperation.get_merge_time" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_merge_time</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Get the average merge time or a default value.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[float, bool]: A tuple containing the average merge time (or default) and a boolean</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>indicating whether the default value was used.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>docetl/operations/reduce.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_merge_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the average merge time or a default value.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[float, bool]: A tuple containing the average merge time (or default) and a boolean</span>
<span class="sd">        indicating whether the default value was used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;merge_time&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;merge_time&quot;</span><span class="p">],</span> <span class="kc">False</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merge_times</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_samples</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merge_times</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merge_times</span><span class="p">),</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="mf">1.0</span><span class="p">,</span> <span class="kc">True</span>  <span class="c1"># Default to 1 second if no data is available</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="docetl.operations.map.ParallelMapOperation" class="doc doc-heading">
            <code>docetl.operations.map.ParallelMapOperation</code>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="docetl.operations.base.BaseOperation">BaseOperation</span></code></p>








              <details class="quote">
                <summary>Source code in <code>docetl/operations/map.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ParallelMapOperation</span><span class="p">(</span><span class="n">BaseOperation</span><span class="p">):</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">schema</span><span class="p">(</span><span class="n">BaseOperation</span><span class="o">.</span><span class="n">schema</span><span class="p">):</span>
        <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;parallel_map&quot;</span>
        <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">drop_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">enable_observability</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">pdf_url_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;prompts&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_prompts</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;prompts&#39; list cannot be empty&quot;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">prompt_config</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                    <span class="c1"># Validate required keys exist</span>
                    <span class="k">if</span> <span class="s2">&quot;prompt&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prompt_config</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Missing required key &#39;prompt&#39; in prompt configuration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="s2">&quot;output_keys&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prompt_config</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Missing required key &#39;output_keys&#39; in prompt configuration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                    <span class="c1"># Validate output_keys is not empty</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">prompt_config</span><span class="p">[</span><span class="s2">&quot;output_keys&quot;</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;&#39;output_keys&#39; list in prompt configuration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> cannot be empty&quot;</span>
                        <span class="p">)</span>

                    <span class="c1"># Check if the prompt is a valid Jinja2 template</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">Template</span><span class="p">(</span><span class="n">prompt_config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Invalid Jinja2 template in prompt configuration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_prompt_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># If drop_keys is not specified, prompts must be present</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_keys</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompts</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;If &#39;drop_keys&#39; is not specified, &#39;prompts&#39; must be present in the configuration&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Check if all output schema keys are covered by the prompts</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompts</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="s2">&quot;schema&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="n">output_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span>
                <span class="n">output_keys_covered</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">prompt_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompts</span><span class="p">:</span>
                    <span class="n">output_keys_covered</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">prompt_config</span><span class="p">[</span><span class="s2">&quot;output_keys&quot;</span><span class="p">])</span>

                <span class="n">missing_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">output_schema</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="n">output_keys_covered</span>
                <span class="k">if</span> <span class="n">missing_keys</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The following output schema keys are not covered by any prompt: </span><span class="si">{</span><span class="n">missing_keys</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the parallel map operation on the provided input data.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_data (list[dict]): The input data to process.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[list[dict], float]: A tuple containing the processed results and the total cost of the operation.</span>

<span class="sd">        This method performs the following steps:</span>
<span class="sd">        1. If prompts are specified, it processes each input item using multiple prompts in parallel</span>
<span class="sd">        2. Aggregates results from different prompts for each input item</span>
<span class="sd">        3. Validates the combined output for each item</span>
<span class="sd">        4. If drop_keys is specified, it drops the specified keys from each document</span>
<span class="sd">        5. Calculates total cost of the operation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">output_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># Check if there&#39;s no prompt and only drop_keys</span>
        <span class="k">if</span> <span class="s2">&quot;prompts&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="s2">&quot;drop_keys&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="c1"># If only drop_keys is specified, simply drop the keys and return</span>
            <span class="n">dropped_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
                <span class="n">new_item</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;drop_keys&quot;</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="n">dropped_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_item</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dropped_results</span><span class="p">,</span> <span class="mf">0.0</span>  <span class="c1"># Return the modified data with no cost</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">process_prompt</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">prompt_config</span><span class="p">):</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="n">strict_render</span><span class="p">(</span><span class="n">prompt_config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">})</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pdf_url_key&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pdf_url</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pdf_url_key&quot;</span><span class="p">]]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;PDF URL key &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pdf_url_key&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; not found in input data&quot;</span>
                    <span class="p">)</span>
                <span class="c1"># Download content</span>
                <span class="k">if</span> <span class="n">pdf_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
                    <span class="n">file_data</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf_url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdf_url</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">file_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">encoded_file</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                <span class="n">base64_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data:application/pdf;base64,</span><span class="si">{</span><span class="n">encoded_file</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;image_url&quot;</span><span class="p">,</span> <span class="s2">&quot;image_url&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">base64_url</span><span class="p">}},</span>
                    <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
                <span class="p">]</span>

            <span class="n">local_output_schema</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">output_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">prompt_config</span><span class="p">[</span><span class="s2">&quot;output_keys&quot;</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">prompt_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span>

            <span class="c1"># Start of Selection</span>
            <span class="c1"># If there are tools, we need to pass in the tools</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">call_llm</span><span class="p">(</span>
                <span class="n">model</span><span class="p">,</span>
                <span class="s2">&quot;parallel_map&quot;</span><span class="p">,</span>
                <span class="n">messages</span><span class="p">,</span>
                <span class="n">local_output_schema</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">prompt_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
                <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">gleaning_config</span><span class="o">=</span><span class="n">prompt_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gleaning&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">bypass_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bypass_cache&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bypass_cache</span><span class="p">),</span>
                <span class="n">litellm_completion_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;litellm_completion_kwargs&quot;</span><span class="p">,</span> <span class="p">{}</span>
                <span class="p">),</span>
                <span class="n">op_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">structured_mode</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span>
                <span class="o">==</span> <span class="n">OutputMode</span><span class="o">.</span><span class="n">STRUCTURED_OUTPUT</span><span class="o">.</span><span class="n">value</span>
            <span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
                <span class="n">response</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
                <span class="n">schema</span><span class="o">=</span><span class="n">local_output_schema</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">prompt_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">manually_fix_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manually_fix_errors</span><span class="p">,</span>
                <span class="n">use_structured_output</span><span class="o">=</span><span class="n">structured_mode</span><span class="p">,</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">total_cost</span>

        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;prompts&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="c1"># Create all futures at once</span>
                <span class="n">all_futures</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">process_prompt</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">prompt_config</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_data</span>
                    <span class="k">for</span> <span class="n">prompt_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">]</span>
                <span class="p">]</span>

                <span class="c1"># Process results in order</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
                    <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_futures</span><span class="p">)),</span>
                    <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing parallel map items&quot;</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="n">future</span> <span class="o">=</span> <span class="n">all_futures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">output</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                    <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">cost</span>

                    <span class="c1"># Determine which item this future corresponds to</span>
                    <span class="n">item_index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">])</span>
                    <span class="n">prompt_index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">])</span>

                    <span class="c1"># Initialize or update the item_result</span>
                    <span class="k">if</span> <span class="n">prompt_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">item_result</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="n">item_index</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">item_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_result</span>

                    <span class="c1"># Fetch the item_result</span>
                    <span class="n">item_result</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">item_index</span><span class="p">]</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_observability&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                        <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;_observability_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item_result</span><span class="p">:</span>
                            <span class="n">item_result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_observability_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">item_result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_observability_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;prompt_</span><span class="si">{</span><span class="n">prompt_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}</span>
                        <span class="p">)</span>

                    <span class="c1"># Update the item_result with the output</span>
                    <span class="n">item_result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_data</span><span class="p">)}</span>

        <span class="c1"># Apply drop_keys if specified</span>
        <span class="k">if</span> <span class="s2">&quot;drop_keys&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="n">drop_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;drop_keys&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">drop_keys</span><span class="p">:</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># Return the results in order</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span> <span class="n">total_cost</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="docetl.operations.map.ParallelMapOperation.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Executes the parallel map operation on the provided input data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_data</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input data to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="list">list</span>[<span title="dict">dict</span>], <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[list[dict], float]: A tuple containing the processed results and the total cost of the operation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>This method performs the following steps:
1. If prompts are specified, it processes each input item using multiple prompts in parallel
2. Aggregates results from different prompts for each input item
3. Validates the combined output for each item
4. If drop_keys is specified, it drops the specified keys from each document
5. Calculates total cost of the operation</p>


            <details class="quote">
              <summary>Source code in <code>docetl/operations/map.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes the parallel map operation on the provided input data.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_data (list[dict]): The input data to process.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[list[dict], float]: A tuple containing the processed results and the total cost of the operation.</span>

<span class="sd">    This method performs the following steps:</span>
<span class="sd">    1. If prompts are specified, it processes each input item using multiple prompts in parallel</span>
<span class="sd">    2. Aggregates results from different prompts for each input item</span>
<span class="sd">    3. Validates the combined output for each item</span>
<span class="sd">    4. If drop_keys is specified, it drops the specified keys from each document</span>
<span class="sd">    5. Calculates total cost of the operation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">output_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="c1"># Check if there&#39;s no prompt and only drop_keys</span>
    <span class="k">if</span> <span class="s2">&quot;prompts&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="s2">&quot;drop_keys&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
        <span class="c1"># If only drop_keys is specified, simply drop the keys and return</span>
        <span class="n">dropped_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
            <span class="n">new_item</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;drop_keys&quot;</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="n">dropped_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dropped_results</span><span class="p">,</span> <span class="mf">0.0</span>  <span class="c1"># Return the modified data with no cost</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_prompt</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">prompt_config</span><span class="p">):</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">strict_render</span><span class="p">(</span><span class="n">prompt_config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">})</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pdf_url_key&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pdf_url</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pdf_url_key&quot;</span><span class="p">]]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;PDF URL key &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pdf_url_key&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; not found in input data&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Download content</span>
            <span class="k">if</span> <span class="n">pdf_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
                <span class="n">file_data</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf_url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdf_url</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">file_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">encoded_file</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">base64_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data:application/pdf;base64,</span><span class="si">{</span><span class="n">encoded_file</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;image_url&quot;</span><span class="p">,</span> <span class="s2">&quot;image_url&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">base64_url</span><span class="p">}},</span>
                <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
            <span class="p">]</span>

        <span class="n">local_output_schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">output_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">prompt_config</span><span class="p">[</span><span class="s2">&quot;output_keys&quot;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">prompt_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span>

        <span class="c1"># Start of Selection</span>
        <span class="c1"># If there are tools, we need to pass in the tools</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">call_llm</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="s2">&quot;parallel_map&quot;</span><span class="p">,</span>
            <span class="n">messages</span><span class="p">,</span>
            <span class="n">local_output_schema</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">prompt_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
            <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">gleaning_config</span><span class="o">=</span><span class="n">prompt_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gleaning&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">bypass_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bypass_cache&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bypass_cache</span><span class="p">),</span>
            <span class="n">litellm_completion_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;litellm_completion_kwargs&quot;</span><span class="p">,</span> <span class="p">{}</span>
            <span class="p">),</span>
            <span class="n">op_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">structured_mode</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span>
            <span class="o">==</span> <span class="n">OutputMode</span><span class="o">.</span><span class="n">STRUCTURED_OUTPUT</span><span class="o">.</span><span class="n">value</span>
        <span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
            <span class="n">response</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="n">local_output_schema</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">prompt_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">manually_fix_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manually_fix_errors</span><span class="p">,</span>
            <span class="n">use_structured_output</span><span class="o">=</span><span class="n">structured_mode</span><span class="p">,</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">total_cost</span>

    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;prompts&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="c1"># Create all futures at once</span>
            <span class="n">all_futures</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">process_prompt</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">prompt_config</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_data</span>
                <span class="k">for</span> <span class="n">prompt_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">]</span>
            <span class="p">]</span>

            <span class="c1"># Process results in order</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_futures</span><span class="p">)),</span>
                <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing parallel map items&quot;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">future</span> <span class="o">=</span> <span class="n">all_futures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">output</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">cost</span>

                <span class="c1"># Determine which item this future corresponds to</span>
                <span class="n">item_index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">])</span>
                <span class="n">prompt_index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">])</span>

                <span class="c1"># Initialize or update the item_result</span>
                <span class="k">if</span> <span class="n">prompt_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">item_result</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="n">item_index</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">item_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_result</span>

                <span class="c1"># Fetch the item_result</span>
                <span class="n">item_result</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">item_index</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_observability&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;_observability_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item_result</span><span class="p">:</span>
                        <span class="n">item_result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_observability_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">item_result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_observability_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;prompt_</span><span class="si">{</span><span class="n">prompt_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}</span>
                    <span class="p">)</span>

                <span class="c1"># Update the item_result with the output</span>
                <span class="n">item_result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_data</span><span class="p">)}</span>

    <span class="c1"># Apply drop_keys if specified</span>
    <span class="k">if</span> <span class="s2">&quot;drop_keys&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
        <span class="n">drop_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;drop_keys&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">drop_keys</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Return the results in order</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span> <span class="n">total_cost</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="docetl.operations.filter.FilterOperation" class="doc doc-heading">
            <code>docetl.operations.filter.FilterOperation</code>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="docetl.operations.map.MapOperation" href="#docetl.operations.map.MapOperation">MapOperation</a></code></p>








              <details class="quote">
                <summary>Source code in <code>docetl/operations/filter.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FilterOperation</span><span class="p">(</span><span class="n">MapOperation</span><span class="p">):</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">schema</span><span class="p">(</span><span class="n">MapOperation</span><span class="o">.</span><span class="n">schema</span><span class="p">):</span>
        <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;filter&quot;</span>
        <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

        <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_filter_output_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># Check that schema exists and has the right structure for filtering</span>
            <span class="n">schema_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span>

            <span class="c1"># Filter out _short_explanation for validation</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">schema_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;_short_explanation&quot;</span><span class="p">}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The &#39;schema&#39; in &#39;output&#39; configuration must have exactly one key-value pair that maps to a boolean value&quot;</span>
                <span class="p">)</span>

            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bool&quot;</span><span class="p">,</span> <span class="s2">&quot;boolean&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The value in the &#39;schema&#39; must be of type bool, got </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filter_key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="nb">iter</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">k</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;_short_explanation&quot;</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filter_is_build</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_limit_applies_to_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="n">keep_record</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filter_key</span><span class="p">))</span>
        <span class="n">result</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filter_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_is_build</span> <span class="ow">or</span> <span class="n">keep_record</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">keep_record</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">is_build</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the filter operation on the input data.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_data (list[dict]): A list of dictionaries to process.</span>
<span class="sd">            is_build (bool): Whether the operation is being executed in the build phase. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[list[dict], float]: A tuple containing the filtered list of dictionaries</span>
<span class="sd">            and the total cost of the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">previous_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_is_build</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filter_is_build</span> <span class="o">=</span> <span class="n">is_build</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filter_is_build</span> <span class="o">=</span> <span class="n">previous_state</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="docetl.operations.filter.FilterOperation.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">is_build</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Executes the filter operation on the input data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_data</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of dictionaries to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>is_build</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the operation is being executed in the build phase. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[list[dict], float]: A tuple containing the filtered list of dictionaries</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>and the total cost of the operation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>docetl/operations/filter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">is_build</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes the filter operation on the input data.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_data (list[dict]): A list of dictionaries to process.</span>
<span class="sd">        is_build (bool): Whether the operation is being executed in the build phase. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[list[dict], float]: A tuple containing the filtered list of dictionaries</span>
<span class="sd">        and the total cost of the operation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">previous_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_is_build</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_filter_is_build</span> <span class="o">=</span> <span class="n">is_build</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filter_is_build</span> <span class="o">=</span> <span class="n">previous_state</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="docetl.operations.equijoin.EquijoinOperation" class="doc doc-heading">
            <code>docetl.operations.equijoin.EquijoinOperation</code>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="docetl.operations.base.BaseOperation">BaseOperation</span></code></p>








              <details class="quote">
                <summary>Source code in <code>docetl/operations/equijoin.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">EquijoinOperation</span><span class="p">(</span><span class="n">BaseOperation</span><span class="p">):</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">schema</span><span class="p">(</span><span class="n">BaseOperation</span><span class="o">.</span><span class="n">schema</span><span class="p">):</span>
        <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;equijoin&quot;</span>
        <span class="n">comparison_prompt</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">blocking_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">blocking_target_recall</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">blocking_conditions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">limits</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">comparison_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">optimize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">embedding_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">embedding_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">compare_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">limit_comparisons</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">blocking_keys</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">litellm_completion_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;blocking_keys&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_blocking_keys</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;left&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span> <span class="ow">or</span> <span class="s2">&quot;right&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Both &#39;left&#39; and &#39;right&#39; must be specified in &#39;blocking_keys&#39;&quot;</span>
                    <span class="p">)</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;limits&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_limits</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;left&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span> <span class="ow">or</span> <span class="s2">&quot;right&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Both &#39;left&#39; and &#39;right&#39; must be specified in &#39;limits&#39;&quot;</span>
                    <span class="p">)</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_comparison_prompt</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="c1"># Check if it has Jinja syntax</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="c1"># This will be handled during initialization with user confirmation</span>
                <span class="k">return</span> <span class="n">v</span>
            <span class="c1"># If it has Jinja syntax, validate it&#39;s a valid template</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">jinja2</span><span class="w"> </span><span class="kn">import</span> <span class="n">Template</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">Template</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Invalid Jinja2 template in &#39;comparison_prompt&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">v</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Check for non-Jinja prompts and prompt user for confirmation</span>
        <span class="k">if</span> <span class="s2">&quot;comparison_prompt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">prompt_user_for_non_jinja_confirmation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                <span class="s2">&quot;comparison_prompt&quot;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Operation &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; cancelled by user. Please add Jinja2 template syntax to your comparison_prompt.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Mark that we need to append document statement</span>
            <span class="c1"># Note: equijoin uses left and right, so we&#39;ll handle it in strict_render</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_append_document_to_comparison_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compare_pair</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">comparison_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">item1</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">item2</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">timeout_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
        <span class="n">max_retries_per_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compares two items using an LLM model to determine if they match.</span>

<span class="sd">        Args:</span>
<span class="sd">            comparison_prompt (str): The prompt template for comparison.</span>
<span class="sd">            model (str): The LLM model to use for comparison.</span>
<span class="sd">            item1 (dict): The first item to compare.</span>
<span class="sd">            item2 (dict): The second item to compare.</span>
<span class="sd">            timeout_seconds (int): The timeout for the LLM call in seconds.</span>
<span class="sd">            max_retries_per_timeout (int): The maximum number of retries per timeout.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[bool, float]: A tuple containing a boolean indicating whether the items match and the cost of the comparison.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="n">strict_render</span><span class="p">(</span><span class="n">comparison_prompt</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="n">item1</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="n">item2</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Error rendering prompt: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">call_llm</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="s2">&quot;compare&quot;</span><span class="p">,</span>
            <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
            <span class="p">{</span><span class="s2">&quot;is_match&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">},</span>
            <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout_seconds</span><span class="p">,</span>
            <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="n">max_retries_per_timeout</span><span class="p">,</span>
            <span class="n">bypass_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bypass_cache&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bypass_cache</span><span class="p">),</span>
            <span class="n">litellm_completion_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;litellm_completion_kwargs&quot;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">op_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">total_cost</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
                <span class="n">response</span><span class="o">.</span><span class="n">response</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;is_match&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">}</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Error parsing LLM response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cost</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;is_match&quot;</span><span class="p">],</span> <span class="n">cost</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">left_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">right_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the equijoin operation on the provided datasets.</span>

<span class="sd">        Args:</span>
<span class="sd">            left_data (list[dict]): The left dataset to join.</span>
<span class="sd">            right_data (list[dict]): The right dataset to join.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[list[dict], float]: A tuple containing the joined results and the total cost of the operation.</span>

<span class="sd">        Usage:</span>
<span class="sd">        ```python</span>
<span class="sd">        from docetl.operations import EquijoinOperation</span>

<span class="sd">        config = {</span>
<span class="sd">            &quot;blocking_keys&quot;: {</span>
<span class="sd">                &quot;left&quot;: [&quot;id&quot;],</span>
<span class="sd">                &quot;right&quot;: [&quot;user_id&quot;]</span>
<span class="sd">            },</span>
<span class="sd">            &quot;limits&quot;: {</span>
<span class="sd">                &quot;left&quot;: 1,</span>
<span class="sd">                &quot;right&quot;: 1</span>
<span class="sd">            },</span>
<span class="sd">            &quot;comparison_prompt&quot;: &quot;Compare {{left}} and {{right}} and determine if they match.&quot;,</span>
<span class="sd">            &quot;blocking_threshold&quot;: 0.8,</span>
<span class="sd">            &quot;blocking_conditions&quot;: [&quot;left[&#39;id&#39;] == right[&#39;user_id&#39;]&quot;],</span>
<span class="sd">            &quot;limit_comparisons&quot;: 1000</span>
<span class="sd">        }</span>
<span class="sd">        equijoin_op = EquijoinOperation(config)</span>
<span class="sd">        left_data = [{&quot;id&quot;: 1, &quot;name&quot;: &quot;Alice&quot;}, {&quot;id&quot;: 2, &quot;name&quot;: &quot;Bob&quot;}]</span>
<span class="sd">        right_data = [{&quot;user_id&quot;: 1, &quot;age&quot;: 30}, {&quot;user_id&quot;: 2, &quot;age&quot;: 25}]</span>
<span class="sd">        results, cost = equijoin_op.execute(left_data, right_data)</span>
<span class="sd">        print(f&quot;Joined results: {results}&quot;)</span>
<span class="sd">        print(f&quot;Total cost: {cost}&quot;)</span>
<span class="sd">        ```</span>

<span class="sd">        This method performs the following steps:</span>
<span class="sd">        1. Initial blocking based on specified conditions (if any)</span>
<span class="sd">        2. Embedding-based blocking (if threshold is provided)</span>
<span class="sd">        3. LLM-based comparison for blocked pairs</span>
<span class="sd">        4. Result aggregation and validation</span>

<span class="sd">        The method also calculates and logs statistics such as comparisons saved by blocking and join selectivity.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">blocking_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_keys&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">left_keys</span> <span class="o">=</span> <span class="n">blocking_keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">left_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">left_data</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">)</span>
        <span class="n">right_keys</span> <span class="o">=</span> <span class="n">blocking_keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">right_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">right_data</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">)</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;limits&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">),</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)}</span>
        <span class="p">)</span>
        <span class="n">left_limit</span> <span class="o">=</span> <span class="n">limits</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span>
        <span class="n">right_limit</span> <span class="o">=</span> <span class="n">limits</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span>
        <span class="n">blocking_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_threshold&quot;</span><span class="p">)</span>
        <span class="n">blocking_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_conditions&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">limit_comparisons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limit_comparisons&quot;</span><span class="p">)</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="c1"># Track pre-computed embeddings from auto-optimization</span>
        <span class="n">precomputed_left_embeddings</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">precomputed_right_embeddings</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Auto-compute blocking threshold if no blocking configuration is provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blocking_threshold</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">blocking_conditions</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">limit_comparisons</span><span class="p">:</span>
            <span class="c1"># Get target recall from operation config (default 0.95)</span>
            <span class="n">target_recall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_target_recall&quot;</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[yellow]No blocking configuration. Auto-computing threshold (target recall: </span><span class="si">{</span><span class="n">target_recall</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2">)...[/yellow]&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Create comparison function for threshold optimization</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">compare_fn_for_optimization</span><span class="p">(</span><span class="n">left_item</span><span class="p">,</span> <span class="n">right_item</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compare_pair</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comparison_model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">),</span>
                    <span class="n">left_item</span><span class="p">,</span>
                    <span class="n">right_item</span><span class="p">,</span>
                    <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
                    <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span>
                    <span class="p">),</span>
                <span class="p">)</span>

            <span class="c1"># Run threshold optimization</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">RuntimeBlockingOptimizer</span><span class="p">(</span>
                <span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                <span class="n">default_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">,</span>
                <span class="n">max_threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
                <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
                <span class="n">target_recall</span><span class="o">=</span><span class="n">target_recall</span><span class="p">,</span>
                <span class="n">sample_size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_data</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="p">(</span>
                <span class="n">blocking_threshold</span><span class="p">,</span>
                <span class="n">precomputed_left_embeddings</span><span class="p">,</span>
                <span class="n">precomputed_right_embeddings</span><span class="p">,</span>
                <span class="n">optimization_cost</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">optimize_equijoin</span><span class="p">(</span>
                <span class="n">left_data</span><span class="p">,</span>
                <span class="n">right_data</span><span class="p">,</span>
                <span class="n">compare_fn_for_optimization</span><span class="p">,</span>
                <span class="n">left_keys</span><span class="o">=</span><span class="n">left_keys</span><span class="p">,</span>
                <span class="n">right_keys</span><span class="o">=</span><span class="n">right_keys</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">optimization_cost</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[green]Using auto-computed blocking threshold: </span><span class="si">{</span><span class="n">blocking_threshold</span><span class="si">}</span><span class="s2">[/green]&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Initial blocking using multiprocessing</span>
        <span class="n">num_processes</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cpu_count</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Starting to run code-based blocking rules for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> left and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">right_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> right rows (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">right_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> total pairs) with </span><span class="si">{</span><span class="n">num_processes</span><span class="si">}</span><span class="s2"> processes...&quot;</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span>
            <span class="n">processes</span><span class="o">=</span><span class="n">num_processes</span><span class="p">,</span>
            <span class="n">initializer</span><span class="o">=</span><span class="n">init_worker</span><span class="p">,</span>
            <span class="n">initargs</span><span class="o">=</span><span class="p">(</span><span class="n">right_data</span><span class="p">,</span> <span class="n">blocking_conditions</span><span class="p">),</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">blocked_pairs_nested</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">process_left_item</span><span class="p">,</span> <span class="n">left_data</span><span class="p">)</span>

        <span class="c1"># Flatten the nested list of blocked pairs</span>
        <span class="n">blocked_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pair</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">blocked_pairs_nested</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>

        <span class="c1"># Check if we have exceeded the pairwise comparison limit</span>
        <span class="k">if</span> <span class="n">limit_comparisons</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">limit_comparisons</span><span class="p">:</span>
            <span class="c1"># Sample pairs based on cardinality and length</span>
            <span class="n">sampled_pairs</span> <span class="o">=</span> <span class="n">stratified_length_sample</span><span class="p">(</span>
                <span class="n">blocked_pairs</span><span class="p">,</span> <span class="n">limit_comparisons</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span>
            <span class="p">)</span>

            <span class="c1"># Calculate number of dropped pairs</span>
            <span class="n">dropped_pairs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span> <span class="o">-</span> <span class="n">limit_comparisons</span>

            <span class="c1"># Prompt the user for confirmation</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Confirm</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[yellow]Warning: </span><span class="si">{</span><span class="n">dropped_pairs</span><span class="si">}</span><span class="s2"> pairs will be dropped due to the comparison limit. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Proceeding with </span><span class="si">{</span><span class="n">limit_comparisons</span><span class="si">}</span><span class="s2"> randomly sampled pairs. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Do you want to continue?[/yellow]&quot;</span><span class="p">,</span>
                <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Operation cancelled by user due to pair limit.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="n">blocked_pairs</span> <span class="o">=</span> <span class="n">sampled_pairs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Number of blocked pairs after initial blocking: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">blocking_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use precomputed embeddings if available from auto-optimization</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">precomputed_left_embeddings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">precomputed_right_embeddings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="n">left_embeddings</span> <span class="o">=</span> <span class="n">precomputed_left_embeddings</span>
                <span class="n">right_embeddings</span> <span class="o">=</span> <span class="n">precomputed_right_embeddings</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">embedding_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;embedding_model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">)</span>
                <span class="n">model_input_context_length</span> <span class="o">=</span> <span class="n">model_cost</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">embedding_model</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;max_input_tokens&quot;</span><span class="p">,</span> <span class="mi">8192</span>
                <span class="p">)</span>
                <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">2000</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">get_embeddings</span><span class="p">(</span>
                    <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
                <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]:</span>
                    <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">)[</span>
                            <span class="p">:</span> <span class="n">model_input_context_length</span> <span class="o">*</span> <span class="mi">4</span>
                        <span class="p">]</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_data</span>
                    <span class="p">]</span>
                    <span class="n">embeddings</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">embedding_cost</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">num_batches</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span>

                    <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">)):</span>
                        <span class="n">batch</span> <span class="o">=</span> <span class="n">texts</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">num_batches</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;[dim]Creating </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> embeddings: batch </span><span class="si">{</span><span class="n">batch_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_batches</span><span class="si">}</span><span class="s2"> &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">batch_size</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">))</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span><span class="si">}</span><span class="s2"> items)[/dim]&quot;</span>
                            <span class="p">)</span>
                        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">gen_embedding</span><span class="p">(</span>
                            <span class="n">model</span><span class="o">=</span><span class="n">embedding_model</span><span class="p">,</span>
                            <span class="nb">input</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">embeddings</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;embedding&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]]</span>
                        <span class="p">)</span>
                        <span class="n">embedding_cost</span> <span class="o">+=</span> <span class="n">completion_cost</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">embedding_cost</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[cyan]Creating embeddings for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> left + </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">right_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> right items...[/cyan]&quot;</span>
                <span class="p">)</span>
                <span class="n">left_embeddings</span><span class="p">,</span> <span class="n">left_cost</span> <span class="o">=</span> <span class="n">get_embeddings</span><span class="p">(</span>
                    <span class="n">left_data</span><span class="p">,</span> <span class="n">left_keys</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span>
                <span class="p">)</span>
                <span class="n">right_embeddings</span><span class="p">,</span> <span class="n">right_cost</span> <span class="o">=</span> <span class="n">get_embeddings</span><span class="p">(</span>
                    <span class="n">right_data</span><span class="p">,</span> <span class="n">right_keys</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span>
                <span class="p">)</span>
                <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">left_cost</span> <span class="o">+</span> <span class="n">right_cost</span>

            <span class="c1"># Compute all cosine similarities in one call</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics.pairwise</span><span class="w"> </span><span class="kn">import</span> <span class="n">cosine_similarity</span>

            <span class="n">similarities</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">left_embeddings</span><span class="p">,</span> <span class="n">right_embeddings</span><span class="p">)</span>

            <span class="c1"># Additional blocking based on embeddings</span>
            <span class="c1"># Find indices where similarity is above threshold</span>
            <span class="n">above_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">similarities</span> <span class="o">&gt;=</span> <span class="n">blocking_threshold</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="n">above_threshold</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> pairs above the threshold.&quot;</span>
            <span class="p">)</span>
            <span class="n">block_pair_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="p">(</span><span class="n">get_hashable_key</span><span class="p">(</span><span class="n">left_item</span><span class="p">),</span> <span class="n">get_hashable_key</span><span class="p">(</span><span class="n">right_item</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">left_item</span><span class="p">,</span> <span class="n">right_item</span> <span class="ow">in</span> <span class="n">blocked_pairs</span>
            <span class="p">)</span>

            <span class="c1"># If limit_comparisons is set, take only the top pairs</span>
            <span class="k">if</span> <span class="n">limit_comparisons</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># First, get all pairs above threshold</span>
                <span class="n">above_threshold_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">above_threshold</span><span class="p">]</span>

                <span class="c1"># Sort these pairs by their similarity scores</span>
                <span class="n">sorted_pairs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="n">above_threshold_pairs</span><span class="p">,</span>
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span> <span class="n">similarities</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                    <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Take the top &#39;limit_comparisons&#39; pairs</span>
                <span class="n">top_pairs</span> <span class="o">=</span> <span class="n">sorted_pairs</span><span class="p">[:</span><span class="n">limit_comparisons</span><span class="p">]</span>

                <span class="c1"># Create new blocked_pairs based on top similarities and existing blocked pairs</span>
                <span class="n">new_blocked_pairs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">remaining_limit</span> <span class="o">=</span> <span class="n">limit_comparisons</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span>

                <span class="c1"># First, include all existing blocked pairs</span>
                <span class="n">final_blocked_pairs</span> <span class="o">=</span> <span class="n">blocked_pairs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="c1"># Then, add new pairs from top similarities until we reach the limit</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">top_pairs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">remaining_limit</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">left_item</span><span class="p">,</span> <span class="n">right_item</span> <span class="o">=</span> <span class="n">left_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">right_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">left_key</span> <span class="o">=</span> <span class="n">get_hashable_key</span><span class="p">(</span><span class="n">left_item</span><span class="p">)</span>
                    <span class="n">right_key</span> <span class="o">=</span> <span class="n">get_hashable_key</span><span class="p">(</span><span class="n">right_item</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">left_key</span><span class="p">,</span> <span class="n">right_key</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">block_pair_set</span><span class="p">:</span>
                        <span class="n">new_blocked_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">left_item</span><span class="p">,</span> <span class="n">right_item</span><span class="p">))</span>
                        <span class="n">block_pair_set</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">left_key</span><span class="p">,</span> <span class="n">right_key</span><span class="p">))</span>
                        <span class="n">remaining_limit</span> <span class="o">-=</span> <span class="mi">1</span>

                <span class="n">final_blocked_pairs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_blocked_pairs</span><span class="p">)</span>
                <span class="n">blocked_pairs</span> <span class="o">=</span> <span class="n">final_blocked_pairs</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Limited comparisons to top </span><span class="si">{</span><span class="n">limit_comparisons</span><span class="si">}</span><span class="s2"> pairs, including </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">new_blocked_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> from code-based blocking and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">new_blocked_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> based on cosine similarity. Lowest cosine similarity included: </span><span class="si">{</span><span class="n">similarities</span><span class="p">[</span><span class="n">top_pairs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Add new pairs to blocked_pairs</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">above_threshold</span><span class="p">:</span>
                    <span class="n">left_item</span><span class="p">,</span> <span class="n">right_item</span> <span class="o">=</span> <span class="n">left_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">right_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">left_key</span> <span class="o">=</span> <span class="n">get_hashable_key</span><span class="p">(</span><span class="n">left_item</span><span class="p">)</span>
                    <span class="n">right_key</span> <span class="o">=</span> <span class="n">get_hashable_key</span><span class="p">(</span><span class="n">right_item</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">left_key</span><span class="p">,</span> <span class="n">right_key</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">block_pair_set</span><span class="p">:</span>
                        <span class="n">blocked_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">left_item</span><span class="p">,</span> <span class="n">right_item</span><span class="p">))</span>
                        <span class="n">block_pair_set</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">left_key</span><span class="p">,</span> <span class="n">right_key</span><span class="p">))</span>

        <span class="c1"># If there are no blocking conditions or embedding threshold, use all pairs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blocking_conditions</span> <span class="ow">and</span> <span class="n">blocking_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">blocked_pairs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">left_item</span><span class="p">,</span> <span class="n">right_item</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">left_item</span> <span class="ow">in</span> <span class="n">left_data</span>
                <span class="k">for</span> <span class="n">right_item</span> <span class="ow">in</span> <span class="n">right_data</span>
            <span class="p">]</span>

        <span class="c1"># If there&#39;s a limit on the number of comparisons, randomly sample pairs</span>
        <span class="k">if</span> <span class="n">limit_comparisons</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">limit_comparisons</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Randomly sampling </span><span class="si">{</span><span class="n">limit_comparisons</span><span class="si">}</span><span class="s2"> pairs out of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> blocked pairs.&quot;</span>
            <span class="p">)</span>
            <span class="n">blocked_pairs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">,</span> <span class="n">limit_comparisons</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Total pairs to compare after blocking and sampling: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Calculate and print statistics</span>
        <span class="n">total_possible_comparisons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_data</span><span class="p">)</span>
        <span class="n">comparisons_made</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span>
        <span class="n">comparisons_saved</span> <span class="o">=</span> <span class="n">total_possible_comparisons</span> <span class="o">-</span> <span class="n">comparisons_made</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[green]Comparisons saved by blocking: </span><span class="si">{</span><span class="n">comparisons_saved</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="p">(</span><span class="n">comparisons_saved</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">total_possible_comparisons</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)[/green]&quot;</span>
        <span class="p">)</span>

        <span class="n">left_match_counts</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">right_match_counts</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">comparison_costs</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">future_to_pair</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compare_pair</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comparison_model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">),</span>
                    <span class="n">left</span><span class="p">,</span>
                    <span class="n">right</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">):</span> <span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="ow">in</span> <span class="n">blocked_pairs</span>
            <span class="p">}</span>

            <span class="n">pbar</span> <span class="o">=</span> <span class="n">RichLoopBar</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">future_to_pair</span><span class="p">)),</span>
                <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Comparing pairs&quot;</span><span class="p">,</span>
                <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="n">future</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">future_to_pair</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">pair</span> <span class="o">=</span> <span class="n">future_to_pair</span><span class="p">[</span><span class="n">future</span><span class="p">]</span>
                <span class="n">is_match</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="n">comparison_costs</span> <span class="o">+=</span> <span class="n">cost</span>

                <span class="k">if</span> <span class="n">is_match</span><span class="p">:</span>
                    <span class="n">joined_item</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">left_item</span><span class="p">,</span> <span class="n">right_item</span> <span class="o">=</span> <span class="n">pair</span>
                    <span class="n">left_key_hash</span> <span class="o">=</span> <span class="n">get_hashable_key</span><span class="p">(</span><span class="n">left_item</span><span class="p">)</span>
                    <span class="n">right_key_hash</span> <span class="o">=</span> <span class="n">get_hashable_key</span><span class="p">(</span><span class="n">right_item</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">left_match_counts</span><span class="p">[</span><span class="n">left_key_hash</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">left_limit</span>
                        <span class="ow">or</span> <span class="n">right_match_counts</span><span class="p">[</span><span class="n">right_key_hash</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">right_limit</span>
                    <span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">left_item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">joined_item</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_left&quot;</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">right_item</span> <span class="k">else</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">right_item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">joined_item</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_right&quot;</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">left_item</span> <span class="k">else</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">validate_output</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">joined_item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span>
                    <span class="p">):</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joined_item</span><span class="p">)</span>
                        <span class="n">left_match_counts</span><span class="p">[</span><span class="n">left_key_hash</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">right_match_counts</span><span class="p">[</span><span class="n">right_key_hash</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="c1"># TODO: support retry in validation failure</span>

        <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">comparison_costs</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># Calculate and print the join selectivity</span>
        <span class="n">join_selectivity</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_data</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Equijoin selectivity: </span><span class="si">{</span><span class="n">join_selectivity</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">total_cost</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="docetl.operations.equijoin.EquijoinOperation.compare_pair" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compare_pair</span><span class="p">(</span><span class="n">comparison_prompt</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">item1</span><span class="p">,</span> <span class="n">item2</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compares two items using an LLM model to determine if they match.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>comparison_prompt</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The prompt template for comparison.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The LLM model to use for comparison.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>item1</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The first item to compare.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>item2</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The second item to compare.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timeout_seconds</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The timeout for the LLM call in seconds.</p>
              </div>
            </td>
            <td>
                  <code>120</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_retries_per_timeout</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of retries per timeout.</p>
              </div>
            </td>
            <td>
                  <code>2</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="bool">bool</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[bool, float]: A tuple containing a boolean indicating whether the items match and the cost of the comparison.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>docetl/operations/equijoin.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compare_pair</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">comparison_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">item1</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">item2</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">timeout_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
    <span class="n">max_retries_per_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compares two items using an LLM model to determine if they match.</span>

<span class="sd">    Args:</span>
<span class="sd">        comparison_prompt (str): The prompt template for comparison.</span>
<span class="sd">        model (str): The LLM model to use for comparison.</span>
<span class="sd">        item1 (dict): The first item to compare.</span>
<span class="sd">        item2 (dict): The second item to compare.</span>
<span class="sd">        timeout_seconds (int): The timeout for the LLM call in seconds.</span>
<span class="sd">        max_retries_per_timeout (int): The maximum number of retries per timeout.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[bool, float]: A tuple containing a boolean indicating whether the items match and the cost of the comparison.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">strict_render</span><span class="p">(</span><span class="n">comparison_prompt</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="n">item1</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="n">item2</span><span class="p">})</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Error rendering prompt: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">call_llm</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="s2">&quot;compare&quot;</span><span class="p">,</span>
        <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
        <span class="p">{</span><span class="s2">&quot;is_match&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">},</span>
        <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout_seconds</span><span class="p">,</span>
        <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="n">max_retries_per_timeout</span><span class="p">,</span>
        <span class="n">bypass_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bypass_cache&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bypass_cache</span><span class="p">),</span>
        <span class="n">litellm_completion_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;litellm_completion_kwargs&quot;</span><span class="p">,</span> <span class="p">{}),</span>
        <span class="n">op_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">total_cost</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
            <span class="n">response</span><span class="o">.</span><span class="n">response</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;is_match&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">}</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Error parsing LLM response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cost</span>
    <span class="k">return</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;is_match&quot;</span><span class="p">],</span> <span class="n">cost</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.operations.equijoin.EquijoinOperation.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">left_data</span><span class="p">,</span> <span class="n">right_data</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Executes the equijoin operation on the provided datasets.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>left_data</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The left dataset to join.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>right_data</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The right dataset to join.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="list">list</span>[<span title="dict">dict</span>], <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[list[dict], float]: A tuple containing the joined results and the total cost of the operation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Usage:
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">docetl.operations</span><span class="w"> </span><span class="kn">import</span> <span class="n">EquijoinOperation</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;blocking_keys&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="s2">&quot;comparison_prompt&quot;</span><span class="p">:</span> <span class="s2">&quot;Compare {{left}} and {{right}} and determine if they match.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;blocking_threshold&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="s2">&quot;blocking_conditions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;left[&#39;id&#39;] == right[&#39;user_id&#39;]&quot;</span><span class="p">],</span>
    <span class="s2">&quot;limit_comparisons&quot;</span><span class="p">:</span> <span class="mi">1000</span>
<span class="p">}</span>
<span class="n">equijoin_op</span> <span class="o">=</span> <span class="n">EquijoinOperation</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">left_data</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Bob&quot;</span><span class="p">}]</span>
<span class="n">right_data</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">}]</span>
<span class="n">results</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">equijoin_op</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">left_data</span><span class="p">,</span> <span class="n">right_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Joined results: </span><span class="si">{</span><span class="n">results</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total cost: </span><span class="si">{</span><span class="n">cost</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></p>
<p>This method performs the following steps:
1. Initial blocking based on specified conditions (if any)
2. Embedding-based blocking (if threshold is provided)
3. LLM-based comparison for blocked pairs
4. Result aggregation and validation</p>
<p>The method also calculates and logs statistics such as comparisons saved by blocking and join selectivity.</p>


            <details class="quote">
              <summary>Source code in <code>docetl/operations/equijoin.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">left_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">right_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes the equijoin operation on the provided datasets.</span>

<span class="sd">    Args:</span>
<span class="sd">        left_data (list[dict]): The left dataset to join.</span>
<span class="sd">        right_data (list[dict]): The right dataset to join.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[list[dict], float]: A tuple containing the joined results and the total cost of the operation.</span>

<span class="sd">    Usage:</span>
<span class="sd">    ```python</span>
<span class="sd">    from docetl.operations import EquijoinOperation</span>

<span class="sd">    config = {</span>
<span class="sd">        &quot;blocking_keys&quot;: {</span>
<span class="sd">            &quot;left&quot;: [&quot;id&quot;],</span>
<span class="sd">            &quot;right&quot;: [&quot;user_id&quot;]</span>
<span class="sd">        },</span>
<span class="sd">        &quot;limits&quot;: {</span>
<span class="sd">            &quot;left&quot;: 1,</span>
<span class="sd">            &quot;right&quot;: 1</span>
<span class="sd">        },</span>
<span class="sd">        &quot;comparison_prompt&quot;: &quot;Compare {{left}} and {{right}} and determine if they match.&quot;,</span>
<span class="sd">        &quot;blocking_threshold&quot;: 0.8,</span>
<span class="sd">        &quot;blocking_conditions&quot;: [&quot;left[&#39;id&#39;] == right[&#39;user_id&#39;]&quot;],</span>
<span class="sd">        &quot;limit_comparisons&quot;: 1000</span>
<span class="sd">    }</span>
<span class="sd">    equijoin_op = EquijoinOperation(config)</span>
<span class="sd">    left_data = [{&quot;id&quot;: 1, &quot;name&quot;: &quot;Alice&quot;}, {&quot;id&quot;: 2, &quot;name&quot;: &quot;Bob&quot;}]</span>
<span class="sd">    right_data = [{&quot;user_id&quot;: 1, &quot;age&quot;: 30}, {&quot;user_id&quot;: 2, &quot;age&quot;: 25}]</span>
<span class="sd">    results, cost = equijoin_op.execute(left_data, right_data)</span>
<span class="sd">    print(f&quot;Joined results: {results}&quot;)</span>
<span class="sd">    print(f&quot;Total cost: {cost}&quot;)</span>
<span class="sd">    ```</span>

<span class="sd">    This method performs the following steps:</span>
<span class="sd">    1. Initial blocking based on specified conditions (if any)</span>
<span class="sd">    2. Embedding-based blocking (if threshold is provided)</span>
<span class="sd">    3. LLM-based comparison for blocked pairs</span>
<span class="sd">    4. Result aggregation and validation</span>

<span class="sd">    The method also calculates and logs statistics such as comparisons saved by blocking and join selectivity.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">blocking_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_keys&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">left_keys</span> <span class="o">=</span> <span class="n">blocking_keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">left_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">left_data</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="p">)</span>
    <span class="n">right_keys</span> <span class="o">=</span> <span class="n">blocking_keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">right_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">right_data</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="p">)</span>
    <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;limits&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">),</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)}</span>
    <span class="p">)</span>
    <span class="n">left_limit</span> <span class="o">=</span> <span class="n">limits</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span>
    <span class="n">right_limit</span> <span class="o">=</span> <span class="n">limits</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span>
    <span class="n">blocking_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_threshold&quot;</span><span class="p">)</span>
    <span class="n">blocking_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_conditions&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">limit_comparisons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limit_comparisons&quot;</span><span class="p">)</span>
    <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="c1"># Track pre-computed embeddings from auto-optimization</span>
    <span class="n">precomputed_left_embeddings</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">precomputed_right_embeddings</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Auto-compute blocking threshold if no blocking configuration is provided</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">blocking_threshold</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">blocking_conditions</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">limit_comparisons</span><span class="p">:</span>
        <span class="c1"># Get target recall from operation config (default 0.95)</span>
        <span class="n">target_recall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_target_recall&quot;</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[yellow]No blocking configuration. Auto-computing threshold (target recall: </span><span class="si">{</span><span class="n">target_recall</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2">)...[/yellow]&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Create comparison function for threshold optimization</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">compare_fn_for_optimization</span><span class="p">(</span><span class="n">left_item</span><span class="p">,</span> <span class="n">right_item</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compare_pair</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comparison_model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">),</span>
                <span class="n">left_item</span><span class="p">,</span>
                <span class="n">right_item</span><span class="p">,</span>
                <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
                <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Run threshold optimization</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">RuntimeBlockingOptimizer</span><span class="p">(</span>
            <span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="n">default_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">,</span>
            <span class="n">max_threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
            <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
            <span class="n">target_recall</span><span class="o">=</span><span class="n">target_recall</span><span class="p">,</span>
            <span class="n">sample_size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_data</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="p">(</span>
            <span class="n">blocking_threshold</span><span class="p">,</span>
            <span class="n">precomputed_left_embeddings</span><span class="p">,</span>
            <span class="n">precomputed_right_embeddings</span><span class="p">,</span>
            <span class="n">optimization_cost</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">optimize_equijoin</span><span class="p">(</span>
            <span class="n">left_data</span><span class="p">,</span>
            <span class="n">right_data</span><span class="p">,</span>
            <span class="n">compare_fn_for_optimization</span><span class="p">,</span>
            <span class="n">left_keys</span><span class="o">=</span><span class="n">left_keys</span><span class="p">,</span>
            <span class="n">right_keys</span><span class="o">=</span><span class="n">right_keys</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">optimization_cost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[green]Using auto-computed blocking threshold: </span><span class="si">{</span><span class="n">blocking_threshold</span><span class="si">}</span><span class="s2">[/green]&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Initial blocking using multiprocessing</span>
    <span class="n">num_processes</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cpu_count</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Starting to run code-based blocking rules for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> left and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">right_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> right rows (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">right_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> total pairs) with </span><span class="si">{</span><span class="n">num_processes</span><span class="si">}</span><span class="s2"> processes...&quot;</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span>
        <span class="n">processes</span><span class="o">=</span><span class="n">num_processes</span><span class="p">,</span>
        <span class="n">initializer</span><span class="o">=</span><span class="n">init_worker</span><span class="p">,</span>
        <span class="n">initargs</span><span class="o">=</span><span class="p">(</span><span class="n">right_data</span><span class="p">,</span> <span class="n">blocking_conditions</span><span class="p">),</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">blocked_pairs_nested</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">process_left_item</span><span class="p">,</span> <span class="n">left_data</span><span class="p">)</span>

    <span class="c1"># Flatten the nested list of blocked pairs</span>
    <span class="n">blocked_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pair</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">blocked_pairs_nested</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>

    <span class="c1"># Check if we have exceeded the pairwise comparison limit</span>
    <span class="k">if</span> <span class="n">limit_comparisons</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">limit_comparisons</span><span class="p">:</span>
        <span class="c1"># Sample pairs based on cardinality and length</span>
        <span class="n">sampled_pairs</span> <span class="o">=</span> <span class="n">stratified_length_sample</span><span class="p">(</span>
            <span class="n">blocked_pairs</span><span class="p">,</span> <span class="n">limit_comparisons</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span>
        <span class="p">)</span>

        <span class="c1"># Calculate number of dropped pairs</span>
        <span class="n">dropped_pairs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span> <span class="o">-</span> <span class="n">limit_comparisons</span>

        <span class="c1"># Prompt the user for confirmation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Confirm</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[yellow]Warning: </span><span class="si">{</span><span class="n">dropped_pairs</span><span class="si">}</span><span class="s2"> pairs will be dropped due to the comparison limit. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Proceeding with </span><span class="si">{</span><span class="n">limit_comparisons</span><span class="si">}</span><span class="s2"> randomly sampled pairs. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Do you want to continue?[/yellow]&quot;</span><span class="p">,</span>
            <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Operation cancelled by user due to pair limit.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">blocked_pairs</span> <span class="o">=</span> <span class="n">sampled_pairs</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Number of blocked pairs after initial blocking: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">blocking_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Use precomputed embeddings if available from auto-optimization</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">precomputed_left_embeddings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">precomputed_right_embeddings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">left_embeddings</span> <span class="o">=</span> <span class="n">precomputed_left_embeddings</span>
            <span class="n">right_embeddings</span> <span class="o">=</span> <span class="n">precomputed_right_embeddings</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">embedding_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;embedding_model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">)</span>
            <span class="n">model_input_context_length</span> <span class="o">=</span> <span class="n">model_cost</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">embedding_model</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;max_input_tokens&quot;</span><span class="p">,</span> <span class="mi">8192</span>
            <span class="p">)</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">2000</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">get_embeddings</span><span class="p">(</span>
                <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]:</span>
                <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">)[</span>
                        <span class="p">:</span> <span class="n">model_input_context_length</span> <span class="o">*</span> <span class="mi">4</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_data</span>
                <span class="p">]</span>
                <span class="n">embeddings</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">embedding_cost</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">num_batches</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span>

                <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">)):</span>
                    <span class="n">batch</span> <span class="o">=</span> <span class="n">texts</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">num_batches</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;[dim]Creating </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> embeddings: batch </span><span class="si">{</span><span class="n">batch_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_batches</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">batch_size</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">))</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span><span class="si">}</span><span class="s2"> items)[/dim]&quot;</span>
                        <span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">gen_embedding</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">=</span><span class="n">embedding_model</span><span class="p">,</span>
                        <span class="nb">input</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">embeddings</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;embedding&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]]</span>
                    <span class="p">)</span>
                    <span class="n">embedding_cost</span> <span class="o">+=</span> <span class="n">completion_cost</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">embedding_cost</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[cyan]Creating embeddings for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> left + </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">right_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> right items...[/cyan]&quot;</span>
            <span class="p">)</span>
            <span class="n">left_embeddings</span><span class="p">,</span> <span class="n">left_cost</span> <span class="o">=</span> <span class="n">get_embeddings</span><span class="p">(</span>
                <span class="n">left_data</span><span class="p">,</span> <span class="n">left_keys</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span>
            <span class="p">)</span>
            <span class="n">right_embeddings</span><span class="p">,</span> <span class="n">right_cost</span> <span class="o">=</span> <span class="n">get_embeddings</span><span class="p">(</span>
                <span class="n">right_data</span><span class="p">,</span> <span class="n">right_keys</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span>
            <span class="p">)</span>
            <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">left_cost</span> <span class="o">+</span> <span class="n">right_cost</span>

        <span class="c1"># Compute all cosine similarities in one call</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics.pairwise</span><span class="w"> </span><span class="kn">import</span> <span class="n">cosine_similarity</span>

        <span class="n">similarities</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">left_embeddings</span><span class="p">,</span> <span class="n">right_embeddings</span><span class="p">)</span>

        <span class="c1"># Additional blocking based on embeddings</span>
        <span class="c1"># Find indices where similarity is above threshold</span>
        <span class="n">above_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">similarities</span> <span class="o">&gt;=</span> <span class="n">blocking_threshold</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="n">above_threshold</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> pairs above the threshold.&quot;</span>
        <span class="p">)</span>
        <span class="n">block_pair_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="p">(</span><span class="n">get_hashable_key</span><span class="p">(</span><span class="n">left_item</span><span class="p">),</span> <span class="n">get_hashable_key</span><span class="p">(</span><span class="n">right_item</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">left_item</span><span class="p">,</span> <span class="n">right_item</span> <span class="ow">in</span> <span class="n">blocked_pairs</span>
        <span class="p">)</span>

        <span class="c1"># If limit_comparisons is set, take only the top pairs</span>
        <span class="k">if</span> <span class="n">limit_comparisons</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># First, get all pairs above threshold</span>
            <span class="n">above_threshold_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">above_threshold</span><span class="p">]</span>

            <span class="c1"># Sort these pairs by their similarity scores</span>
            <span class="n">sorted_pairs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="n">above_threshold_pairs</span><span class="p">,</span>
                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span> <span class="n">similarities</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Take the top &#39;limit_comparisons&#39; pairs</span>
            <span class="n">top_pairs</span> <span class="o">=</span> <span class="n">sorted_pairs</span><span class="p">[:</span><span class="n">limit_comparisons</span><span class="p">]</span>

            <span class="c1"># Create new blocked_pairs based on top similarities and existing blocked pairs</span>
            <span class="n">new_blocked_pairs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">remaining_limit</span> <span class="o">=</span> <span class="n">limit_comparisons</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span>

            <span class="c1"># First, include all existing blocked pairs</span>
            <span class="n">final_blocked_pairs</span> <span class="o">=</span> <span class="n">blocked_pairs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Then, add new pairs from top similarities until we reach the limit</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">top_pairs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">remaining_limit</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">left_item</span><span class="p">,</span> <span class="n">right_item</span> <span class="o">=</span> <span class="n">left_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">right_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">left_key</span> <span class="o">=</span> <span class="n">get_hashable_key</span><span class="p">(</span><span class="n">left_item</span><span class="p">)</span>
                <span class="n">right_key</span> <span class="o">=</span> <span class="n">get_hashable_key</span><span class="p">(</span><span class="n">right_item</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">left_key</span><span class="p">,</span> <span class="n">right_key</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">block_pair_set</span><span class="p">:</span>
                    <span class="n">new_blocked_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">left_item</span><span class="p">,</span> <span class="n">right_item</span><span class="p">))</span>
                    <span class="n">block_pair_set</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">left_key</span><span class="p">,</span> <span class="n">right_key</span><span class="p">))</span>
                    <span class="n">remaining_limit</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="n">final_blocked_pairs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_blocked_pairs</span><span class="p">)</span>
            <span class="n">blocked_pairs</span> <span class="o">=</span> <span class="n">final_blocked_pairs</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Limited comparisons to top </span><span class="si">{</span><span class="n">limit_comparisons</span><span class="si">}</span><span class="s2"> pairs, including </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">new_blocked_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> from code-based blocking and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">new_blocked_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> based on cosine similarity. Lowest cosine similarity included: </span><span class="si">{</span><span class="n">similarities</span><span class="p">[</span><span class="n">top_pairs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Add new pairs to blocked_pairs</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">above_threshold</span><span class="p">:</span>
                <span class="n">left_item</span><span class="p">,</span> <span class="n">right_item</span> <span class="o">=</span> <span class="n">left_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">right_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">left_key</span> <span class="o">=</span> <span class="n">get_hashable_key</span><span class="p">(</span><span class="n">left_item</span><span class="p">)</span>
                <span class="n">right_key</span> <span class="o">=</span> <span class="n">get_hashable_key</span><span class="p">(</span><span class="n">right_item</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">left_key</span><span class="p">,</span> <span class="n">right_key</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">block_pair_set</span><span class="p">:</span>
                    <span class="n">blocked_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">left_item</span><span class="p">,</span> <span class="n">right_item</span><span class="p">))</span>
                    <span class="n">block_pair_set</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">left_key</span><span class="p">,</span> <span class="n">right_key</span><span class="p">))</span>

    <span class="c1"># If there are no blocking conditions or embedding threshold, use all pairs</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">blocking_conditions</span> <span class="ow">and</span> <span class="n">blocking_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">blocked_pairs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">left_item</span><span class="p">,</span> <span class="n">right_item</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">left_item</span> <span class="ow">in</span> <span class="n">left_data</span>
            <span class="k">for</span> <span class="n">right_item</span> <span class="ow">in</span> <span class="n">right_data</span>
        <span class="p">]</span>

    <span class="c1"># If there&#39;s a limit on the number of comparisons, randomly sample pairs</span>
    <span class="k">if</span> <span class="n">limit_comparisons</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">limit_comparisons</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Randomly sampling </span><span class="si">{</span><span class="n">limit_comparisons</span><span class="si">}</span><span class="s2"> pairs out of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> blocked pairs.&quot;</span>
        <span class="p">)</span>
        <span class="n">blocked_pairs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">,</span> <span class="n">limit_comparisons</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Total pairs to compare after blocking and sampling: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Calculate and print statistics</span>
    <span class="n">total_possible_comparisons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_data</span><span class="p">)</span>
    <span class="n">comparisons_made</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocked_pairs</span><span class="p">)</span>
    <span class="n">comparisons_saved</span> <span class="o">=</span> <span class="n">total_possible_comparisons</span> <span class="o">-</span> <span class="n">comparisons_made</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[green]Comparisons saved by blocking: </span><span class="si">{</span><span class="n">comparisons_saved</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="p">(</span><span class="n">comparisons_saved</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">total_possible_comparisons</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)[/green]&quot;</span>
    <span class="p">)</span>

    <span class="n">left_match_counts</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">right_match_counts</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">comparison_costs</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">future_to_pair</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compare_pair</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comparison_model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">),</span>
                <span class="n">left</span><span class="p">,</span>
                <span class="n">right</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">):</span> <span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="ow">in</span> <span class="n">blocked_pairs</span>
        <span class="p">}</span>

        <span class="n">pbar</span> <span class="o">=</span> <span class="n">RichLoopBar</span><span class="p">(</span>
            <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">future_to_pair</span><span class="p">)),</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Comparing pairs&quot;</span><span class="p">,</span>
            <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">future</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">future_to_pair</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">pair</span> <span class="o">=</span> <span class="n">future_to_pair</span><span class="p">[</span><span class="n">future</span><span class="p">]</span>
            <span class="n">is_match</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="n">comparison_costs</span> <span class="o">+=</span> <span class="n">cost</span>

            <span class="k">if</span> <span class="n">is_match</span><span class="p">:</span>
                <span class="n">joined_item</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">left_item</span><span class="p">,</span> <span class="n">right_item</span> <span class="o">=</span> <span class="n">pair</span>
                <span class="n">left_key_hash</span> <span class="o">=</span> <span class="n">get_hashable_key</span><span class="p">(</span><span class="n">left_item</span><span class="p">)</span>
                <span class="n">right_key_hash</span> <span class="o">=</span> <span class="n">get_hashable_key</span><span class="p">(</span><span class="n">right_item</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">left_match_counts</span><span class="p">[</span><span class="n">left_key_hash</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">left_limit</span>
                    <span class="ow">or</span> <span class="n">right_match_counts</span><span class="p">[</span><span class="n">right_key_hash</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">right_limit</span>
                <span class="p">):</span>
                    <span class="k">continue</span>

                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">left_item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">joined_item</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_left&quot;</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">right_item</span> <span class="k">else</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">right_item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">joined_item</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_right&quot;</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">left_item</span> <span class="k">else</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">validate_output</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">joined_item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span>
                <span class="p">):</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joined_item</span><span class="p">)</span>
                    <span class="n">left_match_counts</span><span class="p">[</span><span class="n">left_key_hash</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">right_match_counts</span><span class="p">[</span><span class="n">right_key_hash</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># TODO: support retry in validation failure</span>

    <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">comparison_costs</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Calculate and print the join selectivity</span>
    <span class="n">join_selectivity</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_data</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">else</span> <span class="mi">0</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Equijoin selectivity: </span><span class="si">{</span><span class="n">join_selectivity</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">total_cost</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="docetl.operations.cluster.ClusterOperation" class="doc doc-heading">
            <code>docetl.operations.cluster.ClusterOperation</code>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="docetl.operations.base.BaseOperation">BaseOperation</span></code></p>








              <details class="quote">
                <summary>Source code in <code>docetl/operations/cluster.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ClusterOperation</span><span class="p">(</span><span class="n">BaseOperation</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;max_batch_size&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_batch_size&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="c1"># Check for non-Jinja prompts and prompt user for confirmation</span>
        <span class="k">if</span> <span class="s2">&quot;summary_prompt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary_prompt&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">prompt_user_for_non_jinja_confirmation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary_prompt&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="s2">&quot;summary_prompt&quot;</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Operation &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; cancelled by user. Please add Jinja2 template syntax to your summary_prompt.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Mark that we need to append document statement (cluster uses inputs)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_append_document_to_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;_is_reduce_operation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">syntax_check</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks the configuration of the ClusterOperation for required keys and valid structure.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If required keys are missing or invalid in the configuration.</span>
<span class="sd">            TypeError: If configuration values have incorrect types.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">required_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;embedding_keys&quot;</span><span class="p">,</span> <span class="s2">&quot;summary_schema&quot;</span><span class="p">,</span> <span class="s2">&quot;summary_prompt&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Missing required key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; in ClusterOperation configuration&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;embedding_keys&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;embedding_keys&#39; must be a list of strings&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;output_key&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_key&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;output_key&#39; must be a string&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary_schema&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;summary_schema&#39; must be a dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary_prompt&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;prompt&#39; must be a string&quot;</span><span class="p">)</span>

        <span class="c1"># Check if the prompt has Jinja syntax</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary_prompt&quot;</span><span class="p">]):</span>
            <span class="c1"># This will be handled during initialization with user confirmation</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Check if the prompt is a valid Jinja2 template</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">Template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary_prompt&quot;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid Jinja2 template in &#39;prompt&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check optional parameters</span>
        <span class="k">if</span> <span class="s2">&quot;max_batch_size&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_batch_size&quot;</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;max_batch_size&#39; must be an integer&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;embedding_model&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;embedding_model&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;embedding_model&#39; must be a string&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;model&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;model&#39; must be a string&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;validate&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;validate&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;validate&#39; must be a list of strings&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;validate&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Each validation rule must be a string&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">is_build</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the cluster operation on the input data. Modifies the</span>
<span class="sd">        input data and returns it in place.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_data (list[dict]): A list of dictionaries to process.</span>
<span class="sd">            is_build (bool): Whether the operation is being executed</span>
<span class="sd">              in the build phase. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[list[dict], float]: A tuple containing the clustered</span>
<span class="sd">              list of dictionaries and the total cost of the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">input_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">input_data</span><span class="p">,</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">input_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_key&quot;</span><span class="p">,</span> <span class="s2">&quot;clusters&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">()</span>
            <span class="k">return</span> <span class="n">input_data</span><span class="p">,</span> <span class="mi">0</span>

        <span class="n">embeddings</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">get_embeddings_for_clustering</span><span class="p">(</span>
            <span class="n">input_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span>
        <span class="p">)</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agglomerative_cluster_of_embeddings</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;collapse&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapse_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">collapse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;collapse&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary_prompt&quot;</span><span class="p">])</span>
        <span class="n">cost</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotate_clustering_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotate_leaves</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">cost</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">agglomerative_cluster_of_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">):</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">sklearn.cluster</span>

        <span class="n">cl</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">AgglomerativeClustering</span><span class="p">(</span>
            <span class="n">compute_full_tree</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compute_distances</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">cl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span>

        <span class="n">nsamples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">build_tree</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nsamples</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="c1">#                res[&quot;embedding&quot;] = list(embeddings[i])</span>
                <span class="k">return</span> <span class="n">res</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;children&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">build_tree</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">children_</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">nsamples</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
                    <span class="n">build_tree</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">children_</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">nsamples</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
                <span class="p">],</span>
                <span class="s2">&quot;distance&quot;</span><span class="p">:</span> <span class="n">cl</span><span class="o">.</span><span class="n">distances_</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">nsamples</span><span class="p">],</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">build_tree</span><span class="p">(</span><span class="n">nsamples</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">children_</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_tree_distances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;distance&quot;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">t</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">child</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;children&quot;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s2">&quot;distance&quot;</span> <span class="ow">in</span> <span class="n">child</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;children&quot;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;children&quot;</span><span class="p">]:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_tree_distances</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_collapse_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">parent_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">collapse</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;children&quot;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;distance&quot;</span> <span class="ow">in</span> <span class="n">t</span>
                <span class="ow">and</span> <span class="n">parent_dist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">collapse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">parent_dist</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">collapse</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span>
                    <span class="n">grandchild</span>
                    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;children&quot;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">grandchild</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collapse_tree</span><span class="p">(</span>
                        <span class="n">child</span><span class="p">,</span> <span class="n">parent_dist</span><span class="o">=</span><span class="n">parent_dist</span><span class="p">,</span> <span class="n">collapse</span><span class="o">=</span><span class="n">collapse</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;children&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">grandchild</span>
                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;children&quot;</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">grandchild</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collapse_tree</span><span class="p">(</span>
                        <span class="n">child</span><span class="p">,</span> <span class="n">parent_dist</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">],</span> <span class="n">collapse</span><span class="o">=</span><span class="n">collapse</span>
                    <span class="p">)</span>
                <span class="p">]</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">res</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">t</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">collapse_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">collapse</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">collapse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tree_distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_tree_distances</span><span class="p">(</span><span class="n">tree</span><span class="p">)))</span>
            <span class="n">collapse</span> <span class="o">=</span> <span class="n">tree_distances</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tree_distances</span><span class="p">)</span> <span class="o">*</span> <span class="n">collapse</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collapse_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">collapse</span><span class="o">=</span><span class="n">collapse</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">annotate_clustering_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;children&quot;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_batch_size</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotate_clustering_tree</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;children&quot;</span><span class="p">]</span>
                <span class="p">]</span>

                <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">pbar</span> <span class="o">=</span> <span class="n">RichLoopBar</span><span class="p">(</span>
                    <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">futures</span><span class="p">)),</span>
                    <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (map) on all documents&quot;</span><span class="p">,</span>
                    <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
                    <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">futures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="n">prompt</span> <span class="o">=</span> <span class="n">strict_render</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt_template</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;children&quot;</span><span class="p">]})</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">validation_fn</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
                    <span class="n">response</span><span class="p">,</span>
                    <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary_schema&quot;</span><span class="p">],</span>
                    <span class="n">manually_fix_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manually_fix_errors</span><span class="p">,</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">validate_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="kc">False</span>

            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">call_llm</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">),</span>
                <span class="n">op_type</span><span class="o">=</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
                <span class="n">output_schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary_schema&quot;</span><span class="p">],</span>
                <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
                <span class="n">bypass_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bypass_cache&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bypass_cache</span><span class="p">),</span>
                <span class="n">max_retries_per_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_retries_per_timeout&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">validation_config</span><span class="o">=</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;num_retries&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_retries_on_validate_failure</span><span class="p">,</span>
                        <span class="s2">&quot;val_rule&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                        <span class="s2">&quot;validation_fn&quot;</span><span class="p">:</span> <span class="n">validation_fn</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
                <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="n">litellm_completion_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;litellm_completion_kwargs&quot;</span><span class="p">,</span> <span class="p">{}</span>
                <span class="p">),</span>
                <span class="n">op_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">response</span><span class="o">.</span><span class="n">total_cost</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">validated</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">parse_llm_response</span><span class="p">(</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
                    <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary_schema&quot;</span><span class="p">],</span>
                    <span class="n">manually_fix_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manually_fix_errors</span><span class="p">,</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">t</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">total_cost</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">annotate_leaves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="p">()):</span>
        <span class="k">if</span> <span class="s2">&quot;children&quot;</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
            <span class="n">item</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;children&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="s2">&quot;children&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">annotate_leaves</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="p">(</span><span class="n">item</span><span class="p">,)</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tree</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_key&quot;</span><span class="p">,</span> <span class="s2">&quot;clusters&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">path</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="docetl.operations.cluster.ClusterOperation.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">is_build</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Executes the cluster operation on the input data. Modifies the
input data and returns it in place.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_data</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of dictionaries to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>is_build</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the operation is being executed
in the build phase. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="list">list</span>[<span title="dict">dict</span>], <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[list[dict], float]: A tuple containing the clustered
list of dictionaries and the total cost of the operation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>docetl/operations/cluster.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">is_build</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes the cluster operation on the input data. Modifies the</span>
<span class="sd">    input data and returns it in place.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_data (list[dict]): A list of dictionaries to process.</span>
<span class="sd">        is_build (bool): Whether the operation is being executed</span>
<span class="sd">          in the build phase. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[list[dict], float]: A tuple containing the clustered</span>
<span class="sd">          list of dictionaries and the total cost of the operation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">input_data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">input_data</span><span class="p">,</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">input_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_key&quot;</span><span class="p">,</span> <span class="s2">&quot;clusters&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">return</span> <span class="n">input_data</span><span class="p">,</span> <span class="mi">0</span>

    <span class="n">embeddings</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">get_embeddings_for_clustering</span><span class="p">(</span>
        <span class="n">input_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span>
    <span class="p">)</span>

    <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agglomerative_cluster_of_embeddings</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;collapse&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapse_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">collapse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;collapse&quot;</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">prompt_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary_prompt&quot;</span><span class="p">])</span>
    <span class="n">cost</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotate_clustering_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">annotate_leaves</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">cost</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.operations.cluster.ClusterOperation.syntax_check" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">syntax_check</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Checks the configuration of the ClusterOperation for required keys and valid structure.</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If required keys are missing or invalid in the configuration.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If configuration values have incorrect types.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>docetl/operations/cluster.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">syntax_check</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks the configuration of the ClusterOperation for required keys and valid structure.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If required keys are missing or invalid in the configuration.</span>
<span class="sd">        TypeError: If configuration values have incorrect types.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">required_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;embedding_keys&quot;</span><span class="p">,</span> <span class="s2">&quot;summary_schema&quot;</span><span class="p">,</span> <span class="s2">&quot;summary_prompt&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required_keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Missing required key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; in ClusterOperation configuration&quot;</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;embedding_keys&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;embedding_keys&#39; must be a list of strings&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;output_key&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_key&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;output_key&#39; must be a string&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary_schema&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;summary_schema&#39; must be a dictionary&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary_prompt&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;prompt&#39; must be a string&quot;</span><span class="p">)</span>

    <span class="c1"># Check if the prompt has Jinja syntax</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_jinja_syntax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary_prompt&quot;</span><span class="p">]):</span>
        <span class="c1"># This will be handled during initialization with user confirmation</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Check if the prompt is a valid Jinja2 template</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary_prompt&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid Jinja2 template in &#39;prompt&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Check optional parameters</span>
    <span class="k">if</span> <span class="s2">&quot;max_batch_size&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_batch_size&quot;</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;max_batch_size&#39; must be an integer&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;embedding_model&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;embedding_model&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;embedding_model&#39; must be a string&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;model&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;model&#39; must be a string&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;validate&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;validate&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;validate&#39; must be a list of strings&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;validate&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Each validation rule must be a string&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h1 id="auxiliary-operators">Auxiliary Operators</h1>


<div class="doc doc-object doc-class">



<h3 id="docetl.operations.split.SplitOperation" class="doc doc-heading">
            <code>docetl.operations.split.SplitOperation</code>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="docetl.operations.base.BaseOperation">BaseOperation</span></code></p>


        <p>A class that implements a split operation on input data, dividing it into manageable chunks.</p>
<p>This class extends BaseOperation to:
1. Split input data into chunks of specified size based on the 'split_key' and 'token_count' configuration.
2. Assign unique identifiers to each original document and number chunks sequentially.
3. Return results containing:
   - {split_key}_chunk: The content of the split chunk.
   - {name}_id: A unique identifier for each original document.
   - {name}_chunk_num: The sequential number of the chunk within its original document.</p>







              <details class="quote">
                <summary>Source code in <code>docetl/operations/split.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SplitOperation</span><span class="p">(</span><span class="n">BaseOperation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that implements a split operation on input data, dividing it into manageable chunks.</span>

<span class="sd">    This class extends BaseOperation to:</span>
<span class="sd">    1. Split input data into chunks of specified size based on the &#39;split_key&#39; and &#39;token_count&#39; configuration.</span>
<span class="sd">    2. Assign unique identifiers to each original document and number chunks sequentially.</span>
<span class="sd">    3. Return results containing:</span>
<span class="sd">       - {split_key}_chunk: The content of the split chunk.</span>
<span class="sd">       - {name}_id: A unique identifier for each original document.</span>
<span class="sd">       - {name}_chunk_num: The sequential number of the chunk within its original document.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">schema</span><span class="p">(</span><span class="n">BaseOperation</span><span class="o">.</span><span class="n">schema</span><span class="p">):</span>
        <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;split&quot;</span>
        <span class="n">split_key</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">method_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_method</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;token_count&quot;</span><span class="p">,</span> <span class="s2">&quot;delimiter&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Invalid method &#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#39;. Must be &#39;token_count&#39; or &#39;delimiter&#39;&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_method_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;token_count&quot;</span><span class="p">:</span>
                <span class="n">num_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_tokens&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">num_tokens</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">num_tokens</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;num_tokens&#39; must be a positive integer&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;delimiter&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;delimiter&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_kwargs</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;delimiter&#39; is required for delimiter method&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">split_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;split_key&quot;</span><span class="p">]</span>
        <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span>
        <span class="n">method_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;method_kwargs&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">encoder</span> <span class="o">=</span> <span class="n">tiktoken</span><span class="o">.</span><span class="n">encoding_for_model</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;method_kwargs&quot;</span><span class="p">]</span>
                <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">)</span>
                <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">encoder</span> <span class="o">=</span> <span class="n">tiktoken</span><span class="o">.</span><span class="n">encoding_for_model</span><span class="p">(</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">split_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Split key &#39;</span><span class="si">{</span><span class="n">split_key</span><span class="si">}</span><span class="s2">&#39; not found in item&quot;</span><span class="p">)</span>

            <span class="n">content</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">split_key</span><span class="p">]</span>
            <span class="n">doc_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;token_count&quot;</span><span class="p">:</span>
                <span class="n">token_count</span> <span class="o">=</span> <span class="n">method_kwargs</span><span class="p">[</span><span class="s2">&quot;num_tokens&quot;</span><span class="p">]</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">chunk_num</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">),</span> <span class="n">token_count</span><span class="p">),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">):</span>
                    <span class="n">chunk_tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">token_count</span><span class="p">]</span>
                    <span class="n">chunk</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">chunk_tokens</span><span class="p">)</span>

                    <span class="n">result</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">split_key</span><span class="si">}</span><span class="s2">_chunk&quot;</span><span class="p">:</span> <span class="n">chunk</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_id&quot;</span><span class="p">:</span> <span class="n">doc_id</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_chunk_num&quot;</span><span class="p">:</span> <span class="n">chunk_num</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;delimiter&quot;</span><span class="p">:</span>
                <span class="n">delimiter</span> <span class="o">=</span> <span class="n">method_kwargs</span><span class="p">[</span><span class="s2">&quot;delimiter&quot;</span><span class="p">]</span>
                <span class="n">num_splits_to_group</span> <span class="o">=</span> <span class="n">method_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_splits_to_group&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">chunks</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span>

                <span class="c1"># Get rid of empty chunks</span>
                <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">chunk</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">chunk</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>

                <span class="k">for</span> <span class="n">chunk_num</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">),</span> <span class="n">num_splits_to_group</span><span class="p">),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">):</span>
                    <span class="n">grouped_chunks</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">num_splits_to_group</span><span class="p">]</span>
                    <span class="n">joined_chunk</span> <span class="o">=</span> <span class="n">delimiter</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grouped_chunks</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                    <span class="n">result</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">split_key</span><span class="si">}</span><span class="s2">_chunk&quot;</span><span class="p">:</span> <span class="n">joined_chunk</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_id&quot;</span><span class="p">:</span> <span class="n">doc_id</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_chunk_num&quot;</span><span class="p">:</span> <span class="n">chunk_num</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">cost</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="docetl.operations.gather.GatherOperation" class="doc doc-heading">
            <code>docetl.operations.gather.GatherOperation</code>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="docetl.operations.base.BaseOperation">BaseOperation</span></code></p>


        <p>A class that implements a gather operation on input data, adding contextual information from surrounding chunks.</p>
<p>This class extends BaseOperation to:
1. Group chunks by their document ID.
2. Order chunks within each group.
3. Add peripheral context to each chunk based on the configuration.
4. Include headers for each chunk and its upward hierarchy.
5. Return results containing the rendered chunks with added context, including information about skipped characters and headers.</p>







              <details class="quote">
                <summary>Source code in <code>docetl/operations/gather.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GatherOperation</span><span class="p">(</span><span class="n">BaseOperation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that implements a gather operation on input data, adding contextual information from surrounding chunks.</span>

<span class="sd">    This class extends BaseOperation to:</span>
<span class="sd">    1. Group chunks by their document ID.</span>
<span class="sd">    2. Order chunks within each group.</span>
<span class="sd">    3. Add peripheral context to each chunk based on the configuration.</span>
<span class="sd">    4. Include headers for each chunk and its upward hierarchy.</span>
<span class="sd">    5. Return results containing the rendered chunks with added context, including information about skipped characters and headers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">schema</span><span class="p">(</span><span class="n">BaseOperation</span><span class="o">.</span><span class="n">schema</span><span class="p">):</span>
        <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gather&quot;</span>
        <span class="n">content_key</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">doc_id_key</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">order_key</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">peripheral_chunks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">doc_header_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">main_chunk_start</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">main_chunk_end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;peripheral_chunks&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_peripheral_chunks</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;previous&quot;</span><span class="p">,</span> <span class="s2">&quot;next&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;head&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">,</span> <span class="s2">&quot;tail&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">v</span><span class="p">[</span><span class="n">direction</span><span class="p">]:</span>
                        <span class="n">section_config</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="n">section</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">section</span> <span class="o">!=</span> <span class="s2">&quot;middle&quot;</span> <span class="ow">and</span> <span class="s2">&quot;count&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">section_config</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Missing &#39;count&#39; in </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s2"> configuration&quot;</span>
                            <span class="p">)</span>
            <span class="k">return</span> <span class="n">v</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the GatherOperation.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Variable length argument list.</span>
<span class="sd">            **kwargs: Arbitrary keyword arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">syntax_check</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a syntax check on the operation configuration.&quot;&quot;&quot;</span>
        <span class="c1"># Validate the schema using Pydantic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the gather operation on the input data.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_data (list[dict]): The input data to process.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[list[dict], float]: A tuple containing the processed results and the cost of the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">content_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;content_key&quot;</span><span class="p">]</span>
        <span class="n">doc_id_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;doc_id_key&quot;</span><span class="p">]</span>
        <span class="n">order_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;order_key&quot;</span><span class="p">]</span>
        <span class="n">peripheral_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;peripheral_chunks&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">main_chunk_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;main_chunk_start&quot;</span><span class="p">,</span> <span class="s2">&quot;--- Begin Main Chunk ---&quot;</span>
        <span class="p">)</span>
        <span class="n">main_chunk_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;main_chunk_end&quot;</span><span class="p">,</span> <span class="s2">&quot;--- End Main Chunk ---&quot;</span><span class="p">)</span>
        <span class="n">doc_header_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;doc_header_key&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Group chunks by document ID</span>
        <span class="n">grouped_chunks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
            <span class="n">doc_id</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">doc_id_key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">doc_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grouped_chunks</span><span class="p">:</span>
                <span class="n">grouped_chunks</span><span class="p">[</span><span class="n">doc_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">grouped_chunks</span><span class="p">[</span><span class="n">doc_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="c1"># Process each group of chunks</span>
        <span class="k">for</span> <span class="n">chunks</span> <span class="ow">in</span> <span class="n">grouped_chunks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="c1"># Sort chunks by their order within the document</span>
            <span class="n">chunks</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">order_key</span><span class="p">])</span>

            <span class="c1"># Process each chunk with its peripheral context and headers</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
                <span class="n">rendered_chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_chunk_with_context</span><span class="p">(</span>
                    <span class="n">chunks</span><span class="p">,</span>
                    <span class="n">i</span><span class="p">,</span>
                    <span class="n">peripheral_config</span><span class="p">,</span>
                    <span class="n">content_key</span><span class="p">,</span>
                    <span class="n">order_key</span><span class="p">,</span>
                    <span class="n">main_chunk_start</span><span class="p">,</span>
                    <span class="n">main_chunk_end</span><span class="p">,</span>
                    <span class="n">doc_header_key</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">result</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">content_key</span><span class="si">}</span><span class="s2">_rendered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rendered_chunk</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">cost</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">render_chunk_with_context</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">chunks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
        <span class="n">current_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">peripheral_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">content_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">order_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">main_chunk_start</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">main_chunk_end</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">doc_header_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Render a chunk with its peripheral context and headers.</span>

<span class="sd">        Args:</span>
<span class="sd">            chunks (list[dict]): List of all chunks in the document.</span>
<span class="sd">            current_index (int): Index of the current chunk being processed.</span>
<span class="sd">            peripheral_config (dict): Configuration for peripheral chunks.</span>
<span class="sd">            content_key (str): Key for the content in each chunk.</span>
<span class="sd">            order_key (str): Key for the order of each chunk.</span>
<span class="sd">            main_chunk_start (str): String to mark the start of the main chunk.</span>
<span class="sd">            main_chunk_end (str): String to mark the end of the main chunk.</span>
<span class="sd">            doc_header_key (str): The key for the headers in the current chunk.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Renderted chunk with context and headers.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># If there are no peripheral chunks, return the main chunk</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">peripheral_config</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">chunks</span><span class="p">[</span><span class="n">current_index</span><span class="p">][</span><span class="n">content_key</span><span class="p">]</span>

        <span class="n">combined_parts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;--- Previous Context ---&quot;</span><span class="p">]</span>

        <span class="n">combined_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_peripheral_chunks</span><span class="p">(</span>
                <span class="n">chunks</span><span class="p">[:</span><span class="n">current_index</span><span class="p">],</span>
                <span class="n">peripheral_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;previous&quot;</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="n">content_key</span><span class="p">,</span>
                <span class="n">order_key</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">combined_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--- End Previous Context ---</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Process main chunk</span>
        <span class="n">main_chunk</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">[</span><span class="n">current_index</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">headers</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_hierarchy_headers</span><span class="p">(</span>
            <span class="n">main_chunk</span><span class="p">,</span> <span class="n">chunks</span><span class="p">[:</span> <span class="n">current_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">doc_header_key</span>
        <span class="p">):</span>
            <span class="n">combined_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">combined_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">main_chunk_start</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">main_chunk</span><span class="p">[</span><span class="n">content_key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">main_chunk_end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Next Context ---&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">combined_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_peripheral_chunks</span><span class="p">(</span>
                <span class="n">chunks</span><span class="p">[</span><span class="n">current_index</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:],</span>
                <span class="n">peripheral_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;next&quot;</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="n">content_key</span><span class="p">,</span>
                <span class="n">order_key</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">combined_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--- End Next Context ---&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">combined_parts</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_peripheral_chunks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">chunks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">content_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">order_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">reverse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process peripheral chunks according to the configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            chunks (list[dict]): List of chunks to process.</span>
<span class="sd">            config (dict): Configuration for processing peripheral chunks.</span>
<span class="sd">            content_key (str): Key for the content in each chunk.</span>
<span class="sd">            order_key (str): Key for the order of each chunk.</span>
<span class="sd">            reverse (bool, optional): Whether to process chunks in reverse order. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[str]: List of processed chunk strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">chunks</span><span class="p">))</span>

        <span class="n">processed_parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">included_chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_chunks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>

        <span class="n">head_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;head&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">tail_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tail&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">head_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">head_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">tail_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tail_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">in_skip</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">skip_char_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">head_count</span><span class="p">:</span>
                <span class="n">section</span> <span class="o">=</span> <span class="s2">&quot;head&quot;</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">total_chunks</span> <span class="o">-</span> <span class="n">tail_count</span><span class="p">:</span>
                <span class="n">section</span> <span class="o">=</span> <span class="s2">&quot;tail&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;middle&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                <span class="n">section</span> <span class="o">=</span> <span class="s2">&quot;middle&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Show number of characters skipped</span>
                <span class="n">skipped_chars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="n">content_key</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">in_skip</span><span class="p">:</span>
                    <span class="n">skip_char_count</span> <span class="o">=</span> <span class="n">skipped_chars</span>
                    <span class="n">in_skip</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">skip_char_count</span> <span class="o">+=</span> <span class="n">skipped_chars</span>

                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">in_skip</span><span class="p">:</span>
                <span class="n">processed_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[... </span><span class="si">{</span><span class="n">skip_char_count</span><span class="si">}</span><span class="s2"> characters skipped ...]&quot;</span>
                <span class="p">)</span>
                <span class="n">in_skip</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">skip_char_count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">section_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">section_content_key</span> <span class="o">=</span> <span class="n">section_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content_key&quot;</span><span class="p">,</span> <span class="n">content_key</span><span class="p">)</span>

            <span class="n">is_summary</span> <span class="o">=</span> <span class="n">section_content_key</span> <span class="o">!=</span> <span class="n">content_key</span>
            <span class="n">summary_suffix</span> <span class="o">=</span> <span class="s2">&quot; (Summary)&quot;</span> <span class="k">if</span> <span class="n">is_summary</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

            <span class="n">chunk_prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[Chunk </span><span class="si">{</span><span class="n">chunk</span><span class="p">[</span><span class="n">order_key</span><span class="p">]</span><span class="si">}{</span><span class="n">summary_suffix</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="n">processed_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">chunk_prefix</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">chunk</span><span class="p">[</span><span class="n">section_content_key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="n">included_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">in_skip</span><span class="p">:</span>
            <span class="n">processed_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[... </span><span class="si">{</span><span class="n">skip_char_count</span><span class="si">}</span><span class="s2"> characters skipped ...]&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="n">processed_parts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">processed_parts</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">processed_parts</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">render_hierarchy_headers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">current_chunk</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">chunks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
        <span class="n">doc_header_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Render headers for the current chunk&#39;s hierarchy.</span>

<span class="sd">        Args:</span>
<span class="sd">            current_chunk (dict): The current chunk being processed.</span>
<span class="sd">            chunks (list[dict]): List of chunks up to and including the current chunk.</span>
<span class="sd">            doc_header_key (str): The key for the headers in the current chunk.</span>
<span class="sd">        Returns:</span>
<span class="sd">            str: Renderted headers in the current chunk&#39;s hierarchy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_hierarchy</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">doc_header_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Find the largest/highest level in the current chunk</span>
        <span class="n">current_chunk_headers</span> <span class="o">=</span> <span class="n">current_chunk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">doc_header_key</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># If there are no headers in the current chunk, return an empty string</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">current_chunk_headers</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="n">highest_level</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>  <span class="c1"># Initialize with positive infinity</span>
        <span class="k">for</span> <span class="n">header_info</span> <span class="ow">in</span> <span class="n">current_chunk_headers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">header_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;level&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="n">highest_level</span><span class="p">:</span>
                    <span class="n">highest_level</span> <span class="o">=</span> <span class="n">level</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Error processing header: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Header: </span><span class="si">{</span><span class="n">header_info</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># If no headers found in the current chunk, set highest_level to None</span>
        <span class="k">if</span> <span class="n">highest_level</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">):</span>
            <span class="n">highest_level</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">header_info</span> <span class="ow">in</span> <span class="n">chunk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">doc_header_key</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="n">header_info</span><span class="p">[</span><span class="s2">&quot;header&quot;</span><span class="p">]</span>
                    <span class="n">level</span> <span class="o">=</span> <span class="n">header_info</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">header</span> <span class="ow">and</span> <span class="n">level</span><span class="p">:</span>
                        <span class="n">current_hierarchy</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span>
                    <span class="c1"># Clear lower levels when a higher level header is found</span>
                    <span class="k">for</span> <span class="n">lower_level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_hierarchy</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">lower_level</span> <span class="ow">in</span> <span class="n">current_hierarchy</span><span class="p">:</span>
                            <span class="n">current_hierarchy</span><span class="p">[</span><span class="n">lower_level</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Error processing header: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Header: </span><span class="si">{</span><span class="n">header_info</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="n">rendered_headers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;#&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">level</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">header</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">current_hierarchy</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">highest_level</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="n">highest_level</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">rendered_headers</span> <span class="o">=</span> <span class="s2">&quot; &gt; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rendered_headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;_Current Section:_ </span><span class="si">{</span><span class="n">rendered_headers</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">rendered_headers</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="docetl.operations.gather.GatherOperation.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the GatherOperation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>*args</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Variable length argument list.</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Arbitrary keyword arguments.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>docetl/operations/gather.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the GatherOperation.</span>

<span class="sd">    Args:</span>
<span class="sd">        *args: Variable length argument list.</span>
<span class="sd">        **kwargs: Arbitrary keyword arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.operations.gather.GatherOperation.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Execute the gather operation on the input data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_data</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input data to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="list">list</span>[<span title="dict">dict</span>], <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[list[dict], float]: A tuple containing the processed results and the cost of the operation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>docetl/operations/gather.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute the gather operation on the input data.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_data (list[dict]): The input data to process.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[list[dict], float]: A tuple containing the processed results and the cost of the operation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">content_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;content_key&quot;</span><span class="p">]</span>
    <span class="n">doc_id_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;doc_id_key&quot;</span><span class="p">]</span>
    <span class="n">order_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;order_key&quot;</span><span class="p">]</span>
    <span class="n">peripheral_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;peripheral_chunks&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">main_chunk_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;main_chunk_start&quot;</span><span class="p">,</span> <span class="s2">&quot;--- Begin Main Chunk ---&quot;</span>
    <span class="p">)</span>
    <span class="n">main_chunk_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;main_chunk_end&quot;</span><span class="p">,</span> <span class="s2">&quot;--- End Main Chunk ---&quot;</span><span class="p">)</span>
    <span class="n">doc_header_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;doc_header_key&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Group chunks by document ID</span>
    <span class="n">grouped_chunks</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
        <span class="n">doc_id</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">doc_id_key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">doc_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grouped_chunks</span><span class="p">:</span>
            <span class="n">grouped_chunks</span><span class="p">[</span><span class="n">doc_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">grouped_chunks</span><span class="p">[</span><span class="n">doc_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="c1"># Process each group of chunks</span>
    <span class="k">for</span> <span class="n">chunks</span> <span class="ow">in</span> <span class="n">grouped_chunks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="c1"># Sort chunks by their order within the document</span>
        <span class="n">chunks</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">order_key</span><span class="p">])</span>

        <span class="c1"># Process each chunk with its peripheral context and headers</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
            <span class="n">rendered_chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_chunk_with_context</span><span class="p">(</span>
                <span class="n">chunks</span><span class="p">,</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="n">peripheral_config</span><span class="p">,</span>
                <span class="n">content_key</span><span class="p">,</span>
                <span class="n">order_key</span><span class="p">,</span>
                <span class="n">main_chunk_start</span><span class="p">,</span>
                <span class="n">main_chunk_end</span><span class="p">,</span>
                <span class="n">doc_header_key</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">content_key</span><span class="si">}</span><span class="s2">_rendered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rendered_chunk</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">cost</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.operations.gather.GatherOperation.process_peripheral_chunks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_peripheral_chunks</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">content_key</span><span class="p">,</span> <span class="n">order_key</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Process peripheral chunks according to the configuration.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>chunks</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of chunks to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration for processing peripheral chunks.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>content_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Key for the content in each chunk.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>order_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Key for the order of each chunk.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reverse</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to process chunks in reverse order. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str]: List of processed chunk strings.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>docetl/operations/gather.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process_peripheral_chunks</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">content_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">order_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">reverse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process peripheral chunks according to the configuration.</span>

<span class="sd">    Args:</span>
<span class="sd">        chunks (list[dict]): List of chunks to process.</span>
<span class="sd">        config (dict): Configuration for processing peripheral chunks.</span>
<span class="sd">        content_key (str): Key for the content in each chunk.</span>
<span class="sd">        order_key (str): Key for the order of each chunk.</span>
<span class="sd">        reverse (bool, optional): Whether to process chunks in reverse order. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[str]: List of processed chunk strings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">chunks</span><span class="p">))</span>

    <span class="n">processed_parts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">included_chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total_chunks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>

    <span class="n">head_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;head&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">tail_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tail&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="n">head_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">head_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">tail_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tail_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">in_skip</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">skip_char_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">head_count</span><span class="p">:</span>
            <span class="n">section</span> <span class="o">=</span> <span class="s2">&quot;head&quot;</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">total_chunks</span> <span class="o">-</span> <span class="n">tail_count</span><span class="p">:</span>
            <span class="n">section</span> <span class="o">=</span> <span class="s2">&quot;tail&quot;</span>
        <span class="k">elif</span> <span class="s2">&quot;middle&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">section</span> <span class="o">=</span> <span class="s2">&quot;middle&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Show number of characters skipped</span>
            <span class="n">skipped_chars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="n">content_key</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_skip</span><span class="p">:</span>
                <span class="n">skip_char_count</span> <span class="o">=</span> <span class="n">skipped_chars</span>
                <span class="n">in_skip</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">skip_char_count</span> <span class="o">+=</span> <span class="n">skipped_chars</span>

            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">in_skip</span><span class="p">:</span>
            <span class="n">processed_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[... </span><span class="si">{</span><span class="n">skip_char_count</span><span class="si">}</span><span class="s2"> characters skipped ...]&quot;</span>
            <span class="p">)</span>
            <span class="n">in_skip</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">skip_char_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">section_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">section_content_key</span> <span class="o">=</span> <span class="n">section_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content_key&quot;</span><span class="p">,</span> <span class="n">content_key</span><span class="p">)</span>

        <span class="n">is_summary</span> <span class="o">=</span> <span class="n">section_content_key</span> <span class="o">!=</span> <span class="n">content_key</span>
        <span class="n">summary_suffix</span> <span class="o">=</span> <span class="s2">&quot; (Summary)&quot;</span> <span class="k">if</span> <span class="n">is_summary</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="n">chunk_prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[Chunk </span><span class="si">{</span><span class="n">chunk</span><span class="p">[</span><span class="n">order_key</span><span class="p">]</span><span class="si">}{</span><span class="n">summary_suffix</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="n">processed_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">chunk_prefix</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">chunk</span><span class="p">[</span><span class="n">section_content_key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="n">included_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">in_skip</span><span class="p">:</span>
        <span class="n">processed_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[... </span><span class="si">{</span><span class="n">skip_char_count</span><span class="si">}</span><span class="s2"> characters skipped ...]&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
        <span class="n">processed_parts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">processed_parts</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">processed_parts</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.operations.gather.GatherOperation.render_chunk_with_context" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">render_chunk_with_context</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="n">current_index</span><span class="p">,</span> <span class="n">peripheral_config</span><span class="p">,</span> <span class="n">content_key</span><span class="p">,</span> <span class="n">order_key</span><span class="p">,</span> <span class="n">main_chunk_start</span><span class="p">,</span> <span class="n">main_chunk_end</span><span class="p">,</span> <span class="n">doc_header_key</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Render a chunk with its peripheral context and headers.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>chunks</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of all chunks in the document.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>current_index</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Index of the current chunk being processed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>peripheral_config</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration for peripheral chunks.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>content_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Key for the content in each chunk.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>order_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Key for the order of each chunk.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>main_chunk_start</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String to mark the start of the main chunk.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>main_chunk_end</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String to mark the end of the main chunk.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>doc_header_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The key for the headers in the current chunk.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Renderted chunk with context and headers.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>docetl/operations/gather.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">render_chunk_with_context</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
    <span class="n">current_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">peripheral_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">content_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">order_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">main_chunk_start</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">main_chunk_end</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">doc_header_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render a chunk with its peripheral context and headers.</span>

<span class="sd">    Args:</span>
<span class="sd">        chunks (list[dict]): List of all chunks in the document.</span>
<span class="sd">        current_index (int): Index of the current chunk being processed.</span>
<span class="sd">        peripheral_config (dict): Configuration for peripheral chunks.</span>
<span class="sd">        content_key (str): Key for the content in each chunk.</span>
<span class="sd">        order_key (str): Key for the order of each chunk.</span>
<span class="sd">        main_chunk_start (str): String to mark the start of the main chunk.</span>
<span class="sd">        main_chunk_end (str): String to mark the end of the main chunk.</span>
<span class="sd">        doc_header_key (str): The key for the headers in the current chunk.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Renderted chunk with context and headers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># If there are no peripheral chunks, return the main chunk</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">peripheral_config</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">chunks</span><span class="p">[</span><span class="n">current_index</span><span class="p">][</span><span class="n">content_key</span><span class="p">]</span>

    <span class="n">combined_parts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;--- Previous Context ---&quot;</span><span class="p">]</span>

    <span class="n">combined_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_peripheral_chunks</span><span class="p">(</span>
            <span class="n">chunks</span><span class="p">[:</span><span class="n">current_index</span><span class="p">],</span>
            <span class="n">peripheral_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;previous&quot;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">content_key</span><span class="p">,</span>
            <span class="n">order_key</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">combined_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--- End Previous Context ---</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Process main chunk</span>
    <span class="n">main_chunk</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">[</span><span class="n">current_index</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">headers</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_hierarchy_headers</span><span class="p">(</span>
        <span class="n">main_chunk</span><span class="p">,</span> <span class="n">chunks</span><span class="p">[:</span> <span class="n">current_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">doc_header_key</span>
    <span class="p">):</span>
        <span class="n">combined_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">combined_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">main_chunk_start</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">main_chunk</span><span class="p">[</span><span class="n">content_key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">main_chunk_end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Next Context ---&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">combined_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_peripheral_chunks</span><span class="p">(</span>
            <span class="n">chunks</span><span class="p">[</span><span class="n">current_index</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:],</span>
            <span class="n">peripheral_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;next&quot;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">content_key</span><span class="p">,</span>
            <span class="n">order_key</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">combined_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--- End Next Context ---&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">combined_parts</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.operations.gather.GatherOperation.render_hierarchy_headers" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">render_hierarchy_headers</span><span class="p">(</span><span class="n">current_chunk</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">doc_header_key</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Render headers for the current chunk's hierarchy.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>current_chunk</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current chunk being processed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chunks</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of chunks up to and including the current chunk.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>doc_header_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The key for the headers in the current chunk.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    str: Renderted headers in the current chunk's hierarchy.</p>


            <details class="quote">
              <summary>Source code in <code>docetl/operations/gather.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">render_hierarchy_headers</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">current_chunk</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
    <span class="n">doc_header_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render headers for the current chunk&#39;s hierarchy.</span>

<span class="sd">    Args:</span>
<span class="sd">        current_chunk (dict): The current chunk being processed.</span>
<span class="sd">        chunks (list[dict]): List of chunks up to and including the current chunk.</span>
<span class="sd">        doc_header_key (str): The key for the headers in the current chunk.</span>
<span class="sd">    Returns:</span>
<span class="sd">        str: Renderted headers in the current chunk&#39;s hierarchy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_hierarchy</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">doc_header_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># Find the largest/highest level in the current chunk</span>
    <span class="n">current_chunk_headers</span> <span class="o">=</span> <span class="n">current_chunk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">doc_header_key</span><span class="p">,</span> <span class="p">[])</span>

    <span class="c1"># If there are no headers in the current chunk, return an empty string</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">current_chunk_headers</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="n">highest_level</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>  <span class="c1"># Initialize with positive infinity</span>
    <span class="k">for</span> <span class="n">header_info</span> <span class="ow">in</span> <span class="n">current_chunk_headers</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">header_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;level&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="n">highest_level</span><span class="p">:</span>
                <span class="n">highest_level</span> <span class="o">=</span> <span class="n">level</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Error processing header: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Header: </span><span class="si">{</span><span class="n">header_info</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># If no headers found in the current chunk, set highest_level to None</span>
    <span class="k">if</span> <span class="n">highest_level</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">):</span>
        <span class="n">highest_level</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">header_info</span> <span class="ow">in</span> <span class="n">chunk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">doc_header_key</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">header_info</span><span class="p">[</span><span class="s2">&quot;header&quot;</span><span class="p">]</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">header_info</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">header</span> <span class="ow">and</span> <span class="n">level</span><span class="p">:</span>
                    <span class="n">current_hierarchy</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span>
                <span class="c1"># Clear lower levels when a higher level header is found</span>
                <span class="k">for</span> <span class="n">lower_level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_hierarchy</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">lower_level</span> <span class="ow">in</span> <span class="n">current_hierarchy</span><span class="p">:</span>
                        <span class="n">current_hierarchy</span><span class="p">[</span><span class="n">lower_level</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Error processing header: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Header: </span><span class="si">{</span><span class="n">header_info</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="n">rendered_headers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;#&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">level</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">header</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">current_hierarchy</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">highest_level</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="n">highest_level</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">rendered_headers</span> <span class="o">=</span> <span class="s2">&quot; &gt; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rendered_headers</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;_Current Section:_ </span><span class="si">{</span><span class="n">rendered_headers</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">rendered_headers</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.operations.gather.GatherOperation.syntax_check" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">syntax_check</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Perform a syntax check on the operation configuration.</p>


            <details class="quote">
              <summary>Source code in <code>docetl/operations/gather.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">syntax_check</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform a syntax check on the operation configuration.&quot;&quot;&quot;</span>
    <span class="c1"># Validate the schema using Pydantic</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="docetl.operations.unnest.UnnestOperation" class="doc doc-heading">
            <code>docetl.operations.unnest.UnnestOperation</code>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="docetl.operations.base.BaseOperation">BaseOperation</span></code></p>


        <p>A class that represents an operation to unnest a list-like or dictionary value in a dictionary into multiple dictionaries.</p>
<p>This operation takes a list of dictionaries and a specified key, and creates new dictionaries based on the value type:
- For list-like values: Creates a new dictionary for each element in the list, copying all other key-value pairs.
- For dictionary values: Expands specified fields from the nested dictionary into the parent dictionary.</p>


<details class="inherits-from" open>
  <summary>Inherits from</summary>
  <p>BaseOperation</p>
</details>        <p>Usage:
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">docetl.operations</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnnestOperation</span>

<span class="c1"># Unnesting a list</span>
<span class="n">config_list</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;unnest_key&quot;</span><span class="p">:</span> <span class="s2">&quot;tags&quot;</span><span class="p">}</span>
<span class="n">input_data_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">]},</span>
    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">]}</span>
<span class="p">]</span>

<span class="n">unnest_op_list</span> <span class="o">=</span> <span class="n">UnnestOperation</span><span class="p">(</span><span class="n">config_list</span><span class="p">)</span>
<span class="n">result_list</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">unnest_op_list</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">input_data_list</span><span class="p">)</span>

<span class="c1"># Result will be:</span>
<span class="c1"># [</span>
<span class="c1">#     {&quot;id&quot;: 1, &quot;tags&quot;: &quot;a&quot;},</span>
<span class="c1">#     {&quot;id&quot;: 1, &quot;tags&quot;: &quot;b&quot;},</span>
<span class="c1">#     {&quot;id&quot;: 1, &quot;tags&quot;: &quot;c&quot;},</span>
<span class="c1">#     {&quot;id&quot;: 2, &quot;tags&quot;: &quot;d&quot;},</span>
<span class="c1">#     {&quot;id&quot;: 2, &quot;tags&quot;: &quot;e&quot;}</span>
<span class="c1"># ]</span>

<span class="c1"># Unnesting a dictionary</span>
<span class="n">config_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;unnest_key&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;expand_fields&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">]}</span>
<span class="n">input_data_dict</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">}},</span>
    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Bob&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;bob@example.com&quot;</span><span class="p">}}</span>
<span class="p">]</span>

<span class="n">unnest_op_dict</span> <span class="o">=</span> <span class="n">UnnestOperation</span><span class="p">(</span><span class="n">config_dict</span><span class="p">)</span>
<span class="n">result_dict</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">unnest_op_dict</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">input_data_dict</span><span class="p">)</span>

<span class="c1"># Result will be:</span>
<span class="c1"># [</span>
<span class="c1">#     {&quot;id&quot;: 1, &quot;name&quot;: &quot;Alice&quot;, &quot;age&quot;: 30, &quot;user&quot;: {&quot;name&quot;: &quot;Alice&quot;, &quot;age&quot;: 30, &quot;email&quot;: &quot;alice@example.com&quot;}},</span>
<span class="c1">#     {&quot;id&quot;: 2, &quot;name&quot;: &quot;Bob&quot;, &quot;age&quot;: 25, &quot;user&quot;: {&quot;name&quot;: &quot;Bob&quot;, &quot;age&quot;: 25, &quot;email&quot;: &quot;bob@example.com&quot;}}</span>
<span class="c1"># ]</span>
</code></pre></div></p>







              <details class="quote">
                <summary>Source code in <code>docetl/operations/unnest.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">UnnestOperation</span><span class="p">(</span><span class="n">BaseOperation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that represents an operation to unnest a list-like or dictionary value in a dictionary into multiple dictionaries.</span>

<span class="sd">    This operation takes a list of dictionaries and a specified key, and creates new dictionaries based on the value type:</span>
<span class="sd">    - For list-like values: Creates a new dictionary for each element in the list, copying all other key-value pairs.</span>
<span class="sd">    - For dictionary values: Expands specified fields from the nested dictionary into the parent dictionary.</span>

<span class="sd">    Inherits from:</span>
<span class="sd">        BaseOperation</span>

<span class="sd">    Usage:</span>
<span class="sd">    ```python</span>
<span class="sd">    from docetl.operations import UnnestOperation</span>

<span class="sd">    # Unnesting a list</span>
<span class="sd">    config_list = {&quot;unnest_key&quot;: &quot;tags&quot;}</span>
<span class="sd">    input_data_list = [</span>
<span class="sd">        {&quot;id&quot;: 1, &quot;tags&quot;: [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]},</span>
<span class="sd">        {&quot;id&quot;: 2, &quot;tags&quot;: [&quot;d&quot;, &quot;e&quot;]}</span>
<span class="sd">    ]</span>

<span class="sd">    unnest_op_list = UnnestOperation(config_list)</span>
<span class="sd">    result_list, _ = unnest_op_list.execute(input_data_list)</span>

<span class="sd">    # Result will be:</span>
<span class="sd">    # [</span>
<span class="sd">    #     {&quot;id&quot;: 1, &quot;tags&quot;: &quot;a&quot;},</span>
<span class="sd">    #     {&quot;id&quot;: 1, &quot;tags&quot;: &quot;b&quot;},</span>
<span class="sd">    #     {&quot;id&quot;: 1, &quot;tags&quot;: &quot;c&quot;},</span>
<span class="sd">    #     {&quot;id&quot;: 2, &quot;tags&quot;: &quot;d&quot;},</span>
<span class="sd">    #     {&quot;id&quot;: 2, &quot;tags&quot;: &quot;e&quot;}</span>
<span class="sd">    # ]</span>

<span class="sd">    # Unnesting a dictionary</span>
<span class="sd">    config_dict = {&quot;unnest_key&quot;: &quot;user&quot;, &quot;expand_fields&quot;: [&quot;name&quot;, &quot;age&quot;]}</span>
<span class="sd">    input_data_dict = [</span>
<span class="sd">        {&quot;id&quot;: 1, &quot;user&quot;: {&quot;name&quot;: &quot;Alice&quot;, &quot;age&quot;: 30, &quot;email&quot;: &quot;alice@example.com&quot;}},</span>
<span class="sd">        {&quot;id&quot;: 2, &quot;user&quot;: {&quot;name&quot;: &quot;Bob&quot;, &quot;age&quot;: 25, &quot;email&quot;: &quot;bob@example.com&quot;}}</span>
<span class="sd">    ]</span>

<span class="sd">    unnest_op_dict = UnnestOperation(config_dict)</span>
<span class="sd">    result_dict, _ = unnest_op_dict.execute(input_data_dict)</span>

<span class="sd">    # Result will be:</span>
<span class="sd">    # [</span>
<span class="sd">    #     {&quot;id&quot;: 1, &quot;name&quot;: &quot;Alice&quot;, &quot;age&quot;: 30, &quot;user&quot;: {&quot;name&quot;: &quot;Alice&quot;, &quot;age&quot;: 30, &quot;email&quot;: &quot;alice@example.com&quot;}},</span>
<span class="sd">    #     {&quot;id&quot;: 2, &quot;name&quot;: &quot;Bob&quot;, &quot;age&quot;: 25, &quot;user&quot;: {&quot;name&quot;: &quot;Bob&quot;, &quot;age&quot;: 25, &quot;email&quot;: &quot;bob@example.com&quot;}}</span>
<span class="sd">    # ]</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">schema</span><span class="p">(</span><span class="n">BaseOperation</span><span class="o">.</span><span class="n">schema</span><span class="p">):</span>
        <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;unnest&quot;</span>
        <span class="n">unnest_key</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">keep_empty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">expand_fields</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the unnest operation on the input data.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_data (list[dict]): A list of dictionaries to process.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[list[dict], float]: A tuple containing the processed list of dictionaries</span>
<span class="sd">            and a float value (always 0 in this implementation).</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If the specified unnest_key is not found in an input dictionary.</span>
<span class="sd">            TypeError: If the value of the unnest_key is not iterable (list, tuple, set, or dict).</span>
<span class="sd">            ValueError: If unnesting a dictionary and &#39;expand_fields&#39; is not provided in the config.</span>

<span class="sd">        The operation supports unnesting of both list-like values and dictionary values:</span>

<span class="sd">        1. For list-like values (list, tuple, set):</span>
<span class="sd">           Each element in the list becomes a separate dictionary in the output.</span>

<span class="sd">        2. For dictionary values:</span>
<span class="sd">           The operation expands specified fields from the nested dictionary into the parent dictionary.</span>
<span class="sd">           The &#39;expand_fields&#39; config parameter must be provided to specify which fields to expand.</span>

<span class="sd">        Examples:</span>
<span class="sd">        ```python</span>
<span class="sd">        # Unnesting a list</span>
<span class="sd">        unnest_op = UnnestOperation({&quot;unnest_key&quot;: &quot;colors&quot;})</span>
<span class="sd">        input_data = [</span>
<span class="sd">            {&quot;id&quot;: 1, &quot;colors&quot;: [&quot;red&quot;, &quot;blue&quot;]},</span>
<span class="sd">            {&quot;id&quot;: 2, &quot;colors&quot;: [&quot;green&quot;]}</span>
<span class="sd">        ]</span>
<span class="sd">        result, _ = unnest_op.execute(input_data)</span>
<span class="sd">        # Result will be:</span>
<span class="sd">        # [</span>
<span class="sd">        #     {&quot;id&quot;: 1, &quot;colors&quot;: &quot;red&quot;},</span>
<span class="sd">        #     {&quot;id&quot;: 1, &quot;colors&quot;: &quot;blue&quot;},</span>
<span class="sd">        #     {&quot;id&quot;: 2, &quot;colors&quot;: &quot;green&quot;}</span>
<span class="sd">        # ]</span>

<span class="sd">        # Unnesting a dictionary</span>
<span class="sd">        unnest_op = UnnestOperation({&quot;unnest_key&quot;: &quot;details&quot;, &quot;expand_fields&quot;: [&quot;color&quot;, &quot;size&quot;]})</span>
<span class="sd">        input_data = [</span>
<span class="sd">            {&quot;id&quot;: 1, &quot;details&quot;: {&quot;color&quot;: &quot;red&quot;, &quot;size&quot;: &quot;large&quot;, &quot;stock&quot;: 5}},</span>
<span class="sd">            {&quot;id&quot;: 2, &quot;details&quot;: {&quot;color&quot;: &quot;blue&quot;, &quot;size&quot;: &quot;medium&quot;, &quot;stock&quot;: 3}}</span>
<span class="sd">        ]</span>
<span class="sd">        result, _ = unnest_op.execute(input_data)</span>
<span class="sd">        # Result will be:</span>
<span class="sd">        # [</span>
<span class="sd">        #     {&quot;id&quot;: 1, &quot;details&quot;: {&quot;color&quot;: &quot;red&quot;, &quot;size&quot;: &quot;large&quot;, &quot;stock&quot;: 5}, &quot;color&quot;: &quot;red&quot;, &quot;size&quot;: &quot;large&quot;},</span>
<span class="sd">        #     {&quot;id&quot;: 2, &quot;details&quot;: {&quot;color&quot;: &quot;blue&quot;, &quot;size&quot;: &quot;medium&quot;, &quot;stock&quot;: 3}, &quot;color&quot;: &quot;blue&quot;, &quot;size&quot;: &quot;medium&quot;}</span>
<span class="sd">        # ]</span>
<span class="sd">        ```</span>

<span class="sd">        Note: When unnesting dictionaries, the original nested dictionary is preserved in the output,</span>
<span class="sd">        and the specified fields are expanded into the parent dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">unnest_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;unnest_key&quot;</span><span class="p">]</span>
        <span class="n">recursive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;recursive&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">depth</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">recursive</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">unnest_recursive</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value of unnest key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; is not iterable&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="n">depth</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">expand_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;expand_fields&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">expand_fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">expand_fields</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">new_item</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">expand_fields</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">new_item</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                        <span class="n">new_item</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_item</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">field</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_item</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">new_item</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nested_results</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="n">new_item</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="n">new_item</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">if</span> <span class="n">recursive</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
                        <span class="n">nested_results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                            <span class="n">unnest_recursive</span><span class="p">(</span><span class="n">new_item</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nested_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_item</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">nested_results</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">unnest_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unnest key &#39;</span><span class="si">{</span><span class="n">unnest_key</span><span class="si">}</span><span class="s2">&#39; not found in item. Other keys are </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">unnest_recursive</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">unnest_key</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">[</span><span class="n">unnest_key</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keep_empty&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">expand_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;expand_fields&quot;</span><span class="p">)</span>
                <span class="n">new_item</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">unnest_key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">expand_fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">expand_fields</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">unnest_key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">expand_fields</span><span class="p">:</span>
                        <span class="n">new_item</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_item</span><span class="p">[</span><span class="n">unnest_key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_item</span><span class="p">)</span>

        <span class="c1"># Assert that no keys are missing after the operation</span>
        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">original_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">assert</span> <span class="n">original_keys</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="p">),</span> <span class="s2">&quot;Keys lost during unnest operation&quot;</span>

        <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="docetl.operations.unnest.UnnestOperation.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Executes the unnest operation on the input data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_data</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of dictionaries to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[list[dict], float]: A tuple containing the processed list of dictionaries</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>and a float value (always 0 in this implementation).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="KeyError">KeyError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the specified unnest_key is not found in an input dictionary.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the value of the unnest_key is not iterable (list, tuple, set, or dict).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If unnesting a dictionary and 'expand_fields' is not provided in the config.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>The operation supports unnesting of both list-like values and dictionary values:</p>
<ol>
<li>
<p>For list-like values (list, tuple, set):
   Each element in the list becomes a separate dictionary in the output.</p>
</li>
<li>
<p>For dictionary values:
   The operation expands specified fields from the nested dictionary into the parent dictionary.
   The 'expand_fields' config parameter must be provided to specify which fields to expand.</p>
</li>
</ol>
<p>Examples:
<div class="highlight"><pre><span></span><code><span class="c1"># Unnesting a list</span>
<span class="n">unnest_op</span> <span class="o">=</span> <span class="n">UnnestOperation</span><span class="p">({</span><span class="s2">&quot;unnest_key&quot;</span><span class="p">:</span> <span class="s2">&quot;colors&quot;</span><span class="p">})</span>
<span class="n">input_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;colors&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">]},</span>
    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;colors&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;green&quot;</span><span class="p">]}</span>
<span class="p">]</span>
<span class="n">result</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">unnest_op</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
<span class="c1"># Result will be:</span>
<span class="c1"># [</span>
<span class="c1">#     {&quot;id&quot;: 1, &quot;colors&quot;: &quot;red&quot;},</span>
<span class="c1">#     {&quot;id&quot;: 1, &quot;colors&quot;: &quot;blue&quot;},</span>
<span class="c1">#     {&quot;id&quot;: 2, &quot;colors&quot;: &quot;green&quot;}</span>
<span class="c1"># ]</span>

<span class="c1"># Unnesting a dictionary</span>
<span class="n">unnest_op</span> <span class="o">=</span> <span class="n">UnnestOperation</span><span class="p">({</span><span class="s2">&quot;unnest_key&quot;</span><span class="p">:</span> <span class="s2">&quot;details&quot;</span><span class="p">,</span> <span class="s2">&quot;expand_fields&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">]})</span>
<span class="n">input_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="s2">&quot;large&quot;</span><span class="p">,</span> <span class="s2">&quot;stock&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}},</span>
    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="s2">&quot;medium&quot;</span><span class="p">,</span> <span class="s2">&quot;stock&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}}</span>
<span class="p">]</span>
<span class="n">result</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">unnest_op</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
<span class="c1"># Result will be:</span>
<span class="c1"># [</span>
<span class="c1">#     {&quot;id&quot;: 1, &quot;details&quot;: {&quot;color&quot;: &quot;red&quot;, &quot;size&quot;: &quot;large&quot;, &quot;stock&quot;: 5}, &quot;color&quot;: &quot;red&quot;, &quot;size&quot;: &quot;large&quot;},</span>
<span class="c1">#     {&quot;id&quot;: 2, &quot;details&quot;: {&quot;color&quot;: &quot;blue&quot;, &quot;size&quot;: &quot;medium&quot;, &quot;stock&quot;: 3}, &quot;color&quot;: &quot;blue&quot;, &quot;size&quot;: &quot;medium&quot;}</span>
<span class="c1"># ]</span>
</code></pre></div></p>
<p>Note: When unnesting dictionaries, the original nested dictionary is preserved in the output,
and the specified fields are expanded into the parent dictionary.</p>


            <details class="quote">
              <summary>Source code in <code>docetl/operations/unnest.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes the unnest operation on the input data.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_data (list[dict]): A list of dictionaries to process.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[list[dict], float]: A tuple containing the processed list of dictionaries</span>
<span class="sd">        and a float value (always 0 in this implementation).</span>

<span class="sd">    Raises:</span>
<span class="sd">        KeyError: If the specified unnest_key is not found in an input dictionary.</span>
<span class="sd">        TypeError: If the value of the unnest_key is not iterable (list, tuple, set, or dict).</span>
<span class="sd">        ValueError: If unnesting a dictionary and &#39;expand_fields&#39; is not provided in the config.</span>

<span class="sd">    The operation supports unnesting of both list-like values and dictionary values:</span>

<span class="sd">    1. For list-like values (list, tuple, set):</span>
<span class="sd">       Each element in the list becomes a separate dictionary in the output.</span>

<span class="sd">    2. For dictionary values:</span>
<span class="sd">       The operation expands specified fields from the nested dictionary into the parent dictionary.</span>
<span class="sd">       The &#39;expand_fields&#39; config parameter must be provided to specify which fields to expand.</span>

<span class="sd">    Examples:</span>
<span class="sd">    ```python</span>
<span class="sd">    # Unnesting a list</span>
<span class="sd">    unnest_op = UnnestOperation({&quot;unnest_key&quot;: &quot;colors&quot;})</span>
<span class="sd">    input_data = [</span>
<span class="sd">        {&quot;id&quot;: 1, &quot;colors&quot;: [&quot;red&quot;, &quot;blue&quot;]},</span>
<span class="sd">        {&quot;id&quot;: 2, &quot;colors&quot;: [&quot;green&quot;]}</span>
<span class="sd">    ]</span>
<span class="sd">    result, _ = unnest_op.execute(input_data)</span>
<span class="sd">    # Result will be:</span>
<span class="sd">    # [</span>
<span class="sd">    #     {&quot;id&quot;: 1, &quot;colors&quot;: &quot;red&quot;},</span>
<span class="sd">    #     {&quot;id&quot;: 1, &quot;colors&quot;: &quot;blue&quot;},</span>
<span class="sd">    #     {&quot;id&quot;: 2, &quot;colors&quot;: &quot;green&quot;}</span>
<span class="sd">    # ]</span>

<span class="sd">    # Unnesting a dictionary</span>
<span class="sd">    unnest_op = UnnestOperation({&quot;unnest_key&quot;: &quot;details&quot;, &quot;expand_fields&quot;: [&quot;color&quot;, &quot;size&quot;]})</span>
<span class="sd">    input_data = [</span>
<span class="sd">        {&quot;id&quot;: 1, &quot;details&quot;: {&quot;color&quot;: &quot;red&quot;, &quot;size&quot;: &quot;large&quot;, &quot;stock&quot;: 5}},</span>
<span class="sd">        {&quot;id&quot;: 2, &quot;details&quot;: {&quot;color&quot;: &quot;blue&quot;, &quot;size&quot;: &quot;medium&quot;, &quot;stock&quot;: 3}}</span>
<span class="sd">    ]</span>
<span class="sd">    result, _ = unnest_op.execute(input_data)</span>
<span class="sd">    # Result will be:</span>
<span class="sd">    # [</span>
<span class="sd">    #     {&quot;id&quot;: 1, &quot;details&quot;: {&quot;color&quot;: &quot;red&quot;, &quot;size&quot;: &quot;large&quot;, &quot;stock&quot;: 5}, &quot;color&quot;: &quot;red&quot;, &quot;size&quot;: &quot;large&quot;},</span>
<span class="sd">    #     {&quot;id&quot;: 2, &quot;details&quot;: {&quot;color&quot;: &quot;blue&quot;, &quot;size&quot;: &quot;medium&quot;, &quot;stock&quot;: 3}, &quot;color&quot;: &quot;blue&quot;, &quot;size&quot;: &quot;medium&quot;}</span>
<span class="sd">    # ]</span>
<span class="sd">    ```</span>

<span class="sd">    Note: When unnesting dictionaries, the original nested dictionary is preserved in the output,</span>
<span class="sd">    and the specified fields are expanded into the parent dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">unnest_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;unnest_key&quot;</span><span class="p">]</span>
    <span class="n">recursive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;recursive&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">depth</span><span class="p">:</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">recursive</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">unnest_recursive</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value of unnest key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; is not iterable&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="n">depth</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">expand_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;expand_fields&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">expand_fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">expand_fields</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">new_item</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">expand_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">new_item</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="n">new_item</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_item</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">field</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_item</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">new_item</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nested_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="n">new_item</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">new_item</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">if</span> <span class="n">recursive</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
                    <span class="n">nested_results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="n">unnest_recursive</span><span class="p">(</span><span class="n">new_item</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nested_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_item</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nested_results</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">unnest_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unnest key &#39;</span><span class="si">{</span><span class="n">unnest_key</span><span class="si">}</span><span class="s2">&#39; not found in item. Other keys are </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">unnest_recursive</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">unnest_key</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">[</span><span class="n">unnest_key</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keep_empty&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">expand_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;expand_fields&quot;</span><span class="p">)</span>
            <span class="n">new_item</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">unnest_key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">expand_fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">expand_fields</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">unnest_key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">expand_fields</span><span class="p">:</span>
                    <span class="n">new_item</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_item</span><span class="p">[</span><span class="n">unnest_key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_item</span><span class="p">)</span>

    <span class="c1"># Assert that no keys are missing after the operation</span>
    <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">original_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">assert</span> <span class="n">original_keys</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="p">),</span> <span class="s2">&quot;Keys lost during unnest operation&quot;</span>

    <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../cli/" class="md-footer__link md-footer__link--prev" aria-label="Previous: CLI Interface">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                CLI Interface
              </div>
            </div>
          </a>
        
        
          
          <a href="../optimizers/" class="md-footer__link md-footer__link--next" aria-label="Next: Optimizers">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Optimizers
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.instant.prefetch", "navigation.tracking", "navigation.expand", "navigation.path", "navigation.prune", "navigation.indexes", "navigation.top", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "toc.follow", "navigation.footer", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>