
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../operations/">
      
      
        <link rel="next" href="../python/">
      
      
      <link rel="icon" href="../../assets/docetl-favicon-color.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Optimizers - docetl docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CSource+Code+Pro:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"Source Code Pro"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="#FDB515">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#docetl.optimizers.map_optimizer.optimizer.MapOptimizer" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="docetl docs" class="md-header__button md-logo" aria-label="docetl docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M0 112c0-41.5 31.6-75.6 72-79.6V32h280c53 0 96 43 96 96v176H272c-39.8 0-72 32.2-72 72v60c0 24.3-19.7 44-44 44s-44-19.7-44-44V208H48c-26.5 0-48-21.5-48-48zm236.8 368c7.1-13.1 11.2-28.1 11.2-44v-60c0-13.3 10.7-24 24-24h248c13.3 0 24 10.7 24 24v24c0 44.2-35.8 80-80 80zM80 80c-17.7 0-32 14.3-32 32v48h64v-48c0-17.7-14.3-32-32-32"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            docetl docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Optimizers
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="#FDB515"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="#FDB515"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="#FDB515"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/ucbepic/docetl" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    ucbepic/docetl
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  
    
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../concepts/operators/" class="md-tabs__link">
          
  
  
    
  
  User Guide

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../examples/presidential-debate-themes/" class="md-tabs__link">
          
  
  
    
  
  Tutorials & Examples

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../examples/custom-parsing/" class="md-tabs__link">
          
  
  
    
  
  Developer Reference

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../playground/" class="md-tabs__link">
          
  
  
    
  
  Tools & Resources

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="docetl docs" class="md-nav__button md-logo" aria-label="docetl docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M0 112c0-41.5 31.6-75.6 72-79.6V32h280c53 0 96 43 96 96v176H272c-39.8 0-72 32.2-72 72v60c0 24.3-19.7 44-44 44s-44-19.7-44-44V208H48c-26.5 0-48-21.5-48-48zm236.8 368c7.1-13.1 11.2-28.1 11.2-44v-60c0-13.3 10.7-24 24-24h248c13.3 0 24 10.7 24 24v24c0 44.2-35.8 80-80 80zM80 80c-17.7 0-32 14.3-32 32v48h64v-48c0-17.7-14.3-32-32-32"/></svg>

    </a>
    docetl docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ucbepic/docetl" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    ucbepic/docetl
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../.." class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../concepts/operators/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    User Guide
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../examples/presidential-debate-themes/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Tutorials & Examples
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Developer Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Developer Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Technical Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            Technical Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/custom-parsing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Custom Data Parsing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/rate-limiting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rate Limiting Implementation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" checked>
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../docetl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    docetl Core
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CLI Interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../operations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Operations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Optimizers
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Optimizers
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#docetl.optimizers.map_optimizer.optimizer.MapOptimizer" class="md-nav__link">
    <span class="md-ellipsis">
      MapOptimizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MapOptimizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.optimizers.map_optimizer.optimizer.MapOptimizer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.optimizers.map_optimizer.optimizer.MapOptimizer.optimize" class="md-nav__link">
    <span class="md-ellipsis">
      optimize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.optimizers.map_optimizer.optimizer.MapOptimizer.should_optimize" class="md-nav__link">
    <span class="md-ellipsis">
      should_optimize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docetl.optimizers.reduce_optimizer.ReduceOptimizer" class="md-nav__link">
    <span class="md-ellipsis">
      ReduceOptimizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ReduceOptimizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.optimizers.reduce_optimizer.ReduceOptimizer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.optimizers.reduce_optimizer.ReduceOptimizer.optimize" class="md-nav__link">
    <span class="md-ellipsis">
      optimize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docetl.optimizers.join_optimizer.JoinOptimizer" class="md-nav__link">
    <span class="md-ellipsis">
      JoinOptimizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="JoinOptimizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.optimizers.join_optimizer.JoinOptimizer.should_optimize" class="md-nav__link">
    <span class="md-ellipsis">
      should_optimize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../python/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Python API
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../playground/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Tools & Resources
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#docetl.optimizers.map_optimizer.optimizer.MapOptimizer" class="md-nav__link">
    <span class="md-ellipsis">
      MapOptimizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MapOptimizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.optimizers.map_optimizer.optimizer.MapOptimizer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.optimizers.map_optimizer.optimizer.MapOptimizer.optimize" class="md-nav__link">
    <span class="md-ellipsis">
      optimize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.optimizers.map_optimizer.optimizer.MapOptimizer.should_optimize" class="md-nav__link">
    <span class="md-ellipsis">
      should_optimize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docetl.optimizers.reduce_optimizer.ReduceOptimizer" class="md-nav__link">
    <span class="md-ellipsis">
      ReduceOptimizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ReduceOptimizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.optimizers.reduce_optimizer.ReduceOptimizer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.optimizers.reduce_optimizer.ReduceOptimizer.optimize" class="md-nav__link">
    <span class="md-ellipsis">
      optimize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docetl.optimizers.join_optimizer.JoinOptimizer" class="md-nav__link">
    <span class="md-ellipsis">
      JoinOptimizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="JoinOptimizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.optimizers.join_optimizer.JoinOptimizer.should_optimize" class="md-nav__link">
    <span class="md-ellipsis">
      should_optimize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>Optimizers</h1>

<div class="doc doc-object doc-class">



<h3 id="docetl.optimizers.map_optimizer.optimizer.MapOptimizer" class="doc doc-heading">
            <code>docetl.optimizers.map_optimizer.optimizer.MapOptimizer</code>


</h3>


    <div class="doc doc-contents first">


        <p>A class for optimizing map operations in data processing pipelines.</p>
<p>This optimizer analyzes the input operation configuration and data,
and generates optimized plans for executing the operation. It can
create plans for chunking, metadata extraction, gleaning, chain
decomposition, and parallel execution.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="docetl.optimizers.map_optimizer.optimizer.MapOptimizer.config">config</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The configuration dictionary for the optimizer.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.optimizers.map_optimizer.optimizer.MapOptimizer.console">console</span></code></td>
            <td>
                  <code><span title="Console">Console</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A Rich console object for pretty printing.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.optimizers.map_optimizer.optimizer.MapOptimizer.llm_client">llm_client</span></code></td>
            <td>
                  <code><span title="LLMClient">LLMClient</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A client for interacting with a language model.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.optimizers.map_optimizer.optimizer.MapOptimizer._run_operation">_run_operation</span></code></td>
            <td>
                  <code><span title="typing.Callable">Callable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A function to execute operations.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.optimizers.map_optimizer.optimizer.MapOptimizer.max_threads">max_threads</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of threads to use for parallel execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.optimizers.map_optimizer.optimizer.MapOptimizer.timeout">timeout</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The timeout in seconds for operation execution.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>docetl/optimizers/map_optimizer/optimizer.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MapOptimizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for optimizing map operations in data processing pipelines.</span>

<span class="sd">    This optimizer analyzes the input operation configuration and data,</span>
<span class="sd">    and generates optimized plans for executing the operation. It can</span>
<span class="sd">    create plans for chunking, metadata extraction, gleaning, chain</span>
<span class="sd">    decomposition, and parallel execution.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        config (dict[str, Any]): The configuration dictionary for the optimizer.</span>
<span class="sd">        console (Console): A Rich console object for pretty printing.</span>
<span class="sd">        llm_client (LLMClient): A client for interacting with a language model.</span>
<span class="sd">        _run_operation (Callable): A function to execute operations.</span>
<span class="sd">        max_threads (int): The maximum number of threads to use for parallel execution.</span>
<span class="sd">        timeout (int): The timeout in seconds for operation execution.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">runner</span><span class="p">,</span>
        <span class="n">run_operation</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">is_filter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the MapOptimizer.</span>

<span class="sd">        Args:</span>
<span class="sd">            runner (Runner): The runner object.</span>
<span class="sd">            run_operation (Callable): A function to execute operations.</span>
<span class="sd">            timeout (int, optional): The timeout in seconds for operation execution. Defaults to 10.</span>
<span class="sd">            is_filter (bool, optional): If True, the operation is a filter operation. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span> <span class="o">=</span> <span class="n">runner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">console</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">llm_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_operation</span> <span class="o">=</span> <span class="n">run_operation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">max_threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_plans_to_evaluate_in_parallel</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_filter</span> <span class="o">=</span> <span class="n">is_filter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_to_pairwise_compare</span> <span class="o">=</span> <span class="mi">6</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plan_generator</span> <span class="o">=</span> <span class="n">PlanGenerator</span><span class="p">(</span>
            <span class="n">runner</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="n">run_operation</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
            <span class="n">is_filter</span><span class="p">,</span>
            <span class="n">depth</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">Evaluator</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_operation</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_plans_to_evaluate_in_parallel</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_filter</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_generator</span> <span class="o">=</span> <span class="n">PromptGenerator</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_filter</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">should_optimize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if the given operation configuration should be optimized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span>
            <span class="n">input_data</span><span class="p">,</span>
            <span class="n">output_data</span><span class="p">,</span>
            <span class="n">_</span><span class="p">,</span>
            <span class="n">_</span><span class="p">,</span>
            <span class="n">validator_prompt</span><span class="p">,</span>
            <span class="n">assessment</span><span class="p">,</span>
            <span class="n">data_exceeds_limit</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_optimize_helper</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_exceeds_limit</span> <span class="ow">or</span> <span class="n">assessment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;needs_improvement&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">assessment_str</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">assessment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reasons&quot;</span><span class="p">,</span> <span class="p">[]))</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Here are some improvements that may help:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">assessment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;improvements&quot;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">data_exceeds_limit</span><span class="p">:</span>
                <span class="n">assessment_str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Also, the input data exceeds the token limit.&quot;</span>
            <span class="k">return</span> <span class="n">assessment_str</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">output_data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">output_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_should_optimize_helper</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="nb">int</span><span class="p">,</span>
        <span class="nb">float</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="nb">bool</span><span class="p">,</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if the given operation configuration should be optimized.</span>
<span class="sd">        Create a custom validator prompt and assess the operation&#39;s performance</span>
<span class="sd">        using the validator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">post_optimizer_status</span><span class="p">(</span><span class="n">StageType</span><span class="o">.</span><span class="n">SAMPLE_RUN</span><span class="p">)</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="c1"># Add id to each input_data</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)):</span>
            <span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;_map_opt_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

        <span class="c1"># Define the token limit (adjust as needed)</span>
        <span class="n">model_input_context_length</span> <span class="o">=</span> <span class="n">model_cost</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_model&quot;</span><span class="p">)),</span> <span class="p">{}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_input_tokens&quot;</span><span class="p">,</span> <span class="mi">8192</span><span class="p">)</span>

        <span class="c1"># Render the prompt with all sample inputs and count tokens</span>
        <span class="n">total_tokens</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">exceed_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
            <span class="n">rendered_prompt</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">sample</span><span class="p">)</span>
            <span class="n">prompt_tokens</span> <span class="o">=</span> <span class="n">count_tokens</span><span class="p">(</span>
                <span class="n">rendered_prompt</span><span class="p">,</span>
                <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_model&quot;</span><span class="p">)),</span>
            <span class="p">)</span>
            <span class="n">total_tokens</span> <span class="o">+=</span> <span class="n">prompt_tokens</span>

            <span class="k">if</span> <span class="n">prompt_tokens</span> <span class="o">&gt;</span> <span class="n">model_input_context_length</span><span class="p">:</span>
                <span class="n">exceed_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Calculate average tokens and percentage of samples exceeding limit</span>
        <span class="n">avg_tokens</span> <span class="o">=</span> <span class="n">total_tokens</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="n">exceed_percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">exceed_count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="n">data_exceeds_limit</span> <span class="o">=</span> <span class="n">exceed_count</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">exceed_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[yellow]Warning: </span><span class="si">{</span><span class="n">exceed_percentage</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% of prompts exceed token limit. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Average token count: </span><span class="si">{</span><span class="n">avg_tokens</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Truncating input data when generating validators.[/yellow]&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Execute the original operation on the sample data</span>
        <span class="n">no_change_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">output_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_operation</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">is_build</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">no_change_runtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">no_change_start</span>

        <span class="c1"># Capture output for the sample run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">captured_output</span><span class="o">.</span><span class="n">save_optimizer_output</span><span class="p">(</span>
            <span class="n">stage_type</span><span class="o">=</span><span class="n">StageType</span><span class="o">.</span><span class="n">SAMPLE_RUN</span><span class="p">,</span>
            <span class="n">output</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;operation_config&quot;</span><span class="p">:</span> <span class="n">op_config</span><span class="p">,</span>
                <span class="s2">&quot;input_data&quot;</span><span class="p">:</span> <span class="n">input_data</span><span class="p">,</span>
                <span class="s2">&quot;output_data&quot;</span><span class="p">:</span> <span class="n">output_data</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># Generate custom validator prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">post_optimizer_status</span><span class="p">(</span><span class="n">StageType</span><span class="o">.</span><span class="n">SHOULD_OPTIMIZE</span><span class="p">)</span>
        <span class="n">validator_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_generator</span><span class="o">.</span><span class="n">_generate_validator_prompt</span><span class="p">(</span>
            <span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">output_data</span>
        <span class="p">)</span>

        <span class="c1"># Log the validator prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[bold]Validator Prompt:[/bold]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">validator_prompt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Add a newline for better readability</span>

        <span class="c1"># Step 2: Use the validator prompt to assess the operation&#39;s performance</span>
        <span class="n">assessment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">_assess_operation</span><span class="p">(</span>
            <span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">output_data</span><span class="p">,</span> <span class="n">validator_prompt</span>
        <span class="p">)</span>

        <span class="c1"># Print out the assessment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[bold]Assessment for whether we should improve operation </span><span class="si">{</span><span class="n">op_config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:[/bold]&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">assessment</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold cyan]</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:[/bold cyan] [yellow]</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">[/yellow]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Add a newline for better readability</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">captured_output</span><span class="o">.</span><span class="n">save_optimizer_output</span><span class="p">(</span>
            <span class="n">stage_type</span><span class="o">=</span><span class="n">StageType</span><span class="o">.</span><span class="n">SHOULD_OPTIMIZE</span><span class="p">,</span>
            <span class="n">output</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;validator_prompt&quot;</span><span class="p">:</span> <span class="n">validator_prompt</span><span class="p">,</span>
                <span class="s2">&quot;needs_improvement&quot;</span><span class="p">:</span> <span class="n">assessment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;needs_improvement&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="s2">&quot;reasons&quot;</span><span class="p">:</span> <span class="n">assessment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reasons&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="s2">&quot;improvements&quot;</span><span class="p">:</span> <span class="n">assessment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;improvements&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">post_optimizer_rationale</span><span class="p">(</span>
            <span class="n">assessment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;needs_improvement&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">assessment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reasons&quot;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">assessment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;improvements&quot;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="n">validator_prompt</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">input_data</span><span class="p">,</span>
            <span class="n">output_data</span><span class="p">,</span>
            <span class="n">model_input_context_length</span><span class="p">,</span>
            <span class="n">no_change_runtime</span><span class="p">,</span>
            <span class="n">validator_prompt</span><span class="p">,</span>
            <span class="n">assessment</span><span class="p">,</span>
            <span class="n">data_exceeds_limit</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">plan_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;chunk&quot;</span><span class="p">,</span> <span class="s2">&quot;proj_synthesis&quot;</span><span class="p">,</span> <span class="s2">&quot;glean&quot;</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimize the given operation configuration for the input data.</span>
<span class="sd">        Uses a staged evaluation approach:</span>
<span class="sd">        1. For data exceeding limits: Try all plan types at once</span>
<span class="sd">        2. For data within limits:</span>
<span class="sd">            - First try gleaning/proj synthesis</span>
<span class="sd">            - Compare with baseline</span>
<span class="sd">            - Selectively try chunking plans based on initial results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Verify that the plan types are valid</span>
        <span class="k">for</span> <span class="n">plan_type</span> <span class="ow">in</span> <span class="n">plan_types</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">plan_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;chunk&quot;</span><span class="p">,</span> <span class="s2">&quot;proj_synthesis&quot;</span><span class="p">,</span> <span class="s2">&quot;glean&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Invalid plan type: </span><span class="si">{</span><span class="n">plan_type</span><span class="si">}</span><span class="s2">. Valid plan types are: chunk, proj_synthesis, glean.&quot;</span>
                <span class="p">)</span>

        <span class="p">(</span>
            <span class="n">input_data</span><span class="p">,</span>
            <span class="n">output_data</span><span class="p">,</span>
            <span class="n">model_input_context_length</span><span class="p">,</span>
            <span class="n">no_change_runtime</span><span class="p">,</span>
            <span class="n">validator_prompt</span><span class="p">,</span>
            <span class="n">assessment</span><span class="p">,</span>
            <span class="n">data_exceeds_limit</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_optimize_helper</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;force_decompose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data_exceeds_limit</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">assessment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;needs_improvement&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[green]No improvement needed for operation </span><span class="si">{</span><span class="n">op_config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">[/green]&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="p">[</span><span class="n">op_config</span><span class="p">],</span>
                    <span class="n">output_data</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plan_generator</span><span class="o">.</span><span class="n">subplan_optimizer_cost</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># Select consistent evaluation samples</span>
        <span class="n">num_evaluations</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))</span>
        <span class="n">evaluation_samples</span> <span class="o">=</span> <span class="n">select_evaluation_samples</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">num_evaluations</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data_exceeds_limit</span><span class="p">:</span>
            <span class="c1"># For data exceeding limits, try all plan types at once</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_all_plans</span><span class="p">(</span>
                <span class="n">op_config</span><span class="p">,</span>
                <span class="n">input_data</span><span class="p">,</span>
                <span class="n">evaluation_samples</span><span class="p">,</span>
                <span class="n">validator_prompt</span><span class="p">,</span>
                <span class="n">plan_types</span><span class="p">,</span>
                <span class="n">model_input_context_length</span><span class="p">,</span>
                <span class="n">data_exceeds_limit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># For data within limits, use staged evaluation</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staged_evaluation</span><span class="p">(</span>
            <span class="n">op_config</span><span class="p">,</span>
            <span class="n">input_data</span><span class="p">,</span>
            <span class="n">evaluation_samples</span><span class="p">,</span>
            <span class="n">validator_prompt</span><span class="p">,</span>
            <span class="n">plan_types</span><span class="p">,</span>
            <span class="n">no_change_runtime</span><span class="p">,</span>
            <span class="n">model_input_context_length</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_select_best_plan</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">results</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]],</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">evaluation_samples</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">validator_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">candidate_plans</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select the best plan from evaluation results using top-k comparison.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (best plan, best output, best plan name, pairwise rankings)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Sort results by score in descending order</span>
        <span class="n">sorted_results</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Take the top k plans</span>
        <span class="n">top_plans</span> <span class="o">=</span> <span class="n">sorted_results</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_to_pairwise_compare</span><span class="p">]</span>

        <span class="c1"># Check if there are no top plans</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_plans</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No valid plans were generated. Unable to proceed with optimization.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Include any additional plans that are tied with the last plan</span>
        <span class="n">tail_score</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">top_plans</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_plans</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_to_pairwise_compare</span>
            <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">filtered_results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">top_plans</span>
            <span class="o">+</span> <span class="p">[</span>
                <span class="n">item</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sorted_results</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">top_plans</span><span class="p">)</span> <span class="p">:]</span>
                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">tail_score</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Perform pairwise comparisons on filtered plans</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pairwise_rankings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">_pairwise_compare_plans</span><span class="p">(</span>
                <span class="n">filtered_results</span><span class="p">,</span> <span class="n">validator_prompt</span><span class="p">,</span> <span class="n">op_config</span><span class="p">,</span> <span class="n">evaluation_samples</span>
            <span class="p">)</span>
            <span class="n">best_plan_name</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pairwise_rankings</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">pairwise_rankings</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pairwise_rankings</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
            <span class="n">best_plan_name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">filtered_results</span><span class="p">))</span>

        <span class="c1"># Display results table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold]Plan Evaluation Results for </span><span class="si">{</span><span class="n">op_config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">op_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> plans, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">evaluation_samples</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples):[/bold]&quot;</span>
        <span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">show_header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header_style</span><span class="o">=</span><span class="s2">&quot;bold magenta&quot;</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Plan&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;dim&quot;</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Score&quot;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Runtime&quot;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Pairwise Wins&quot;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">plan_name</span><span class="p">,</span> <span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">runtime</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sorted_results</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span>
                <span class="n">plan_name</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">runtime</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pairwise_rankings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">plan_name</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">best_plan</span> <span class="o">=</span> <span class="n">candidate_plans</span><span class="p">[</span><span class="n">best_plan_name</span><span class="p">]</span>
            <span class="n">best_output</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">best_plan_name</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Best plan name </span><span class="si">{</span><span class="n">best_plan_name</span><span class="si">}</span><span class="s2"> not found in candidate plans. Candidate plan names: </span><span class="si">{</span><span class="n">candidate_plans</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[green]Current best plan: </span><span class="si">{</span><span class="n">best_plan_name</span><span class="si">}</span><span class="s2"> for operation </span><span class="si">{</span><span class="n">op_config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(Score: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="n">best_plan_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Runtime: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="n">best_plan_name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)[/green]&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">best_plan</span><span class="p">,</span> <span class="n">best_output</span><span class="p">,</span> <span class="n">best_plan_name</span><span class="p">,</span> <span class="n">pairwise_rankings</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_staged_evaluation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">evaluation_samples</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">validator_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">plan_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">no_change_runtime</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">model_input_context_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stage 1: Try gleaning and proj synthesis plans first&quot;&quot;&quot;</span>
        <span class="n">candidate_plans</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;no_change&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">op_config</span><span class="p">]}</span>

        <span class="c1"># Generate initial plans (gleaning and proj synthesis)</span>
        <span class="k">if</span> <span class="s2">&quot;glean&quot;</span> <span class="ow">in</span> <span class="n">plan_types</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="s2">&quot;[bold magenta]Generating gleaning plans...[/bold magenta]&quot;</span>
            <span class="p">)</span>
            <span class="n">gleaning_plans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_generator</span><span class="o">.</span><span class="n">_generate_gleaning_plans</span><span class="p">(</span>
                <span class="n">op_config</span><span class="p">,</span> <span class="n">validator_prompt</span>
            <span class="p">)</span>
            <span class="n">candidate_plans</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gleaning_plans</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;proj_synthesis&quot;</span> <span class="ow">in</span> <span class="n">plan_types</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_filter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="s2">&quot;[bold magenta]Generating independent projection synthesis plans...[/bold magenta]&quot;</span>
            <span class="p">)</span>
            <span class="n">parallel_plans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_generator</span><span class="o">.</span><span class="n">_generate_parallel_plans</span><span class="p">(</span>
                <span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span>
            <span class="p">)</span>
            <span class="n">candidate_plans</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parallel_plans</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="s2">&quot;[bold magenta]Generating chain projection synthesis plans...[/bold magenta]&quot;</span>
            <span class="p">)</span>
            <span class="n">chain_plans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_generator</span><span class="o">.</span><span class="n">_generate_chain_plans</span><span class="p">(</span>
                <span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span>
            <span class="p">)</span>
            <span class="n">candidate_plans</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chain_plans</span><span class="p">)</span>

        <span class="c1"># Evaluate initial plans</span>
        <span class="n">initial_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_plans</span><span class="p">(</span>
            <span class="n">candidate_plans</span><span class="p">,</span>
            <span class="n">op_config</span><span class="p">,</span>
            <span class="n">evaluation_samples</span><span class="p">,</span>
            <span class="n">validator_prompt</span><span class="p">,</span>
            <span class="n">no_change_runtime</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Get best initial plan</span>
        <span class="n">best_plan</span><span class="p">,</span> <span class="n">best_output</span><span class="p">,</span> <span class="n">best_plan_name</span><span class="p">,</span> <span class="n">pairwise_rankings</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_select_best_plan</span><span class="p">(</span>
                <span class="n">initial_results</span><span class="p">,</span>
                <span class="n">op_config</span><span class="p">,</span>
                <span class="n">evaluation_samples</span><span class="p">,</span>
                <span class="n">validator_prompt</span><span class="p">,</span>
                <span class="n">candidate_plans</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">best_is_better_than_baseline</span> <span class="o">=</span> <span class="n">best_plan_name</span> <span class="o">!=</span> <span class="s2">&quot;no_change&quot;</span>

        <span class="c1"># Stage 2: Decide whether/how to try chunking plans</span>
        <span class="k">if</span> <span class="s2">&quot;chunk&quot;</span> <span class="ow">in</span> <span class="n">plan_types</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">best_is_better_than_baseline</span><span class="p">:</span>
                <span class="c1"># Try 2 random chunking plans first</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s2">&quot;[bold magenta]Trying sample of chunking plans...[/bold magenta]&quot;</span>
                <span class="p">)</span>
                <span class="n">chunk_plans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_generator</span><span class="o">.</span><span class="n">_generate_chunk_size_plans</span><span class="p">(</span>
                    <span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">validator_prompt</span><span class="p">,</span> <span class="n">model_input_context_length</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">chunk_plans</span><span class="p">:</span>
                    <span class="c1"># Sample 2 random plans</span>
                    <span class="n">chunk_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chunk_plans</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                    <span class="n">sample_plans</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">chunk_items</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk_items</span><span class="p">)))</span>
                    <span class="p">)</span>
                    <span class="n">sample_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_plans</span><span class="p">(</span>
                        <span class="n">sample_plans</span><span class="p">,</span> <span class="n">op_config</span><span class="p">,</span> <span class="n">evaluation_samples</span><span class="p">,</span> <span class="n">validator_prompt</span>
                    <span class="p">)</span>

                    <span class="c1"># Do pairwise comparison between sampled plans and current best</span>
                    <span class="n">current_best</span> <span class="o">=</span> <span class="p">{</span><span class="n">best_plan_name</span><span class="p">:</span> <span class="n">initial_results</span><span class="p">[</span><span class="n">best_plan_name</span><span class="p">]}</span>
                    <span class="n">current_best</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sample_results</span><span class="p">)</span>

                    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">new_best_name</span><span class="p">,</span> <span class="n">new_pairwise_rankings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_best_plan</span><span class="p">(</span>
                        <span class="n">current_best</span><span class="p">,</span>
                        <span class="n">op_config</span><span class="p">,</span>
                        <span class="n">evaluation_samples</span><span class="p">,</span>
                        <span class="n">validator_prompt</span><span class="p">,</span>
                        <span class="p">{</span><span class="o">**</span><span class="p">{</span><span class="n">best_plan_name</span><span class="p">:</span> <span class="n">best_plan</span><span class="p">},</span> <span class="o">**</span><span class="n">sample_plans</span><span class="p">},</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">new_best_name</span> <span class="o">==</span> <span class="n">best_plan_name</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="s2">&quot;[yellow]Sample chunking plans did not improve results. Keeping current best plan.[/yellow]&quot;</span>
                        <span class="p">)</span>
                        <span class="k">return</span> <span class="p">(</span>
                            <span class="n">best_plan</span><span class="p">,</span>
                            <span class="n">best_output</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">plan_generator</span><span class="o">.</span><span class="n">subplan_optimizer_cost</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="c1"># If a sampled plan wins, evaluate all chunking plans</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="s2">&quot;[bold magenta]Generating all chunking plans...[/bold magenta]&quot;</span>
                    <span class="p">)</span>
                    <span class="n">chunk_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_plans</span><span class="p">(</span>
                        <span class="n">chunk_plans</span><span class="p">,</span> <span class="n">op_config</span><span class="p">,</span> <span class="n">evaluation_samples</span><span class="p">,</span> <span class="n">validator_prompt</span>
                    <span class="p">)</span>
                    <span class="n">initial_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk_results</span><span class="p">)</span>
                    <span class="n">candidate_plans</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk_plans</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Try all chunking plans since no improvement found yet</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s2">&quot;[bold magenta]Generating chunking plans...[/bold magenta]&quot;</span>
                <span class="p">)</span>
                <span class="n">chunk_plans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_generator</span><span class="o">.</span><span class="n">_generate_chunk_size_plans</span><span class="p">(</span>
                    <span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">validator_prompt</span><span class="p">,</span> <span class="n">model_input_context_length</span>
                <span class="p">)</span>
                <span class="n">chunk_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_plans</span><span class="p">(</span>
                    <span class="n">chunk_plans</span><span class="p">,</span> <span class="n">op_config</span><span class="p">,</span> <span class="n">evaluation_samples</span><span class="p">,</span> <span class="n">validator_prompt</span>
                <span class="p">)</span>
                <span class="n">initial_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk_results</span><span class="p">)</span>
                <span class="n">candidate_plans</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk_plans</span><span class="p">)</span>

        <span class="c1"># Final selection of best plan</span>
        <span class="n">best_plan</span><span class="p">,</span> <span class="n">best_output</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">final_pairwise_rankings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_best_plan</span><span class="p">(</span>
            <span class="n">initial_results</span><span class="p">,</span>
            <span class="n">op_config</span><span class="p">,</span>
            <span class="n">evaluation_samples</span><span class="p">,</span>
            <span class="n">validator_prompt</span><span class="p">,</span>
            <span class="n">candidate_plans</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Capture evaluation results with pairwise rankings</span>
        <span class="n">ratings</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">initial_results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">runtime</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">initial_results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">sample_outputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">initial_results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">captured_output</span><span class="o">.</span><span class="n">save_optimizer_output</span><span class="p">(</span>
            <span class="n">stage_type</span><span class="o">=</span><span class="n">StageType</span><span class="o">.</span><span class="n">EVALUATION_RESULTS</span><span class="p">,</span>
            <span class="n">output</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;input_data&quot;</span><span class="p">:</span> <span class="n">evaluation_samples</span><span class="p">,</span>
                <span class="s2">&quot;all_plan_ratings&quot;</span><span class="p">:</span> <span class="n">ratings</span><span class="p">,</span>
                <span class="s2">&quot;all_plan_runtimes&quot;</span><span class="p">:</span> <span class="n">runtime</span><span class="p">,</span>
                <span class="s2">&quot;all_plan_sample_outputs&quot;</span><span class="p">:</span> <span class="n">sample_outputs</span><span class="p">,</span>
                <span class="s2">&quot;all_plan_pairwise_rankings&quot;</span><span class="p">:</span> <span class="n">final_pairwise_rankings</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">post_optimizer_status</span><span class="p">(</span><span class="n">StageType</span><span class="o">.</span><span class="n">END</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best_plan</span><span class="p">,</span> <span class="n">best_output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_generator</span><span class="o">.</span><span class="n">subplan_optimizer_cost</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_evaluate_plans</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">plans</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">evaluation_samples</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">validator_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">no_change_runtime</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method to evaluate a set of plans in parallel&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">plans_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">plans</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plans_list</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_plans_to_evaluate_in_parallel</span><span class="p">):</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">plans_list</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_plans_to_evaluate_in_parallel</span><span class="p">]</span>
            <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span>
                <span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_plans_to_evaluate_in_parallel</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                <span class="n">futures</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">_evaluate_plan</span><span class="p">,</span>
                        <span class="n">plan_name</span><span class="p">,</span>
                        <span class="n">op_config</span><span class="p">,</span>
                        <span class="n">plan</span><span class="p">,</span>
                        <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">evaluation_samples</span><span class="p">),</span>
                        <span class="n">validator_prompt</span><span class="p">,</span>
                    <span class="p">):</span> <span class="n">plan_name</span>
                    <span class="k">for</span> <span class="n">plan_name</span><span class="p">,</span> <span class="n">plan</span> <span class="ow">in</span> <span class="n">batch</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
                    <span class="n">plan_name</span> <span class="o">=</span> <span class="n">futures</span><span class="p">[</span><span class="n">future</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">score</span><span class="p">,</span> <span class="n">runtime</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">plan_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">runtime</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;[yellow]Plan </span><span class="si">{</span><span class="n">plan_name</span><span class="si">}</span><span class="s2"> timed out and will be skipped.[/yellow]&quot;</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;[red]Error in plan </span><span class="si">{</span><span class="n">plan_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">[/red]&quot;</span>
                        <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;no_change&quot;</span> <span class="ow">in</span> <span class="n">results</span> <span class="ow">and</span> <span class="n">no_change_runtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;no_change&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;no_change&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">no_change_runtime</span><span class="p">,</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;no_change&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_evaluate_all_plans</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">evaluation_samples</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">validator_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">plan_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">model_input_context_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">data_exceeds_limit</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate all plans for a given operation configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">candidate_plans</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Generate all plans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">post_optimizer_status</span><span class="p">(</span><span class="n">StageType</span><span class="o">.</span><span class="n">CANDIDATE_PLANS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[bold magenta]Generating </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">plan_types</span><span class="p">)</span><span class="si">}</span><span class="s2"> plans...[/bold magenta]&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">plan_type</span> <span class="ow">in</span> <span class="n">plan_types</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">plan_type</span> <span class="o">==</span> <span class="s2">&quot;chunk&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s2">&quot;[bold magenta]Generating chunking plans...[/bold magenta]&quot;</span>
                <span class="p">)</span>
                <span class="n">chunk_size_plans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_generator</span><span class="o">.</span><span class="n">_generate_chunk_size_plans</span><span class="p">(</span>
                    <span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">validator_prompt</span><span class="p">,</span> <span class="n">model_input_context_length</span>
                <span class="p">)</span>
                <span class="n">candidate_plans</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk_size_plans</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">plan_type</span> <span class="o">==</span> <span class="s2">&quot;proj_synthesis&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_filter</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="s2">&quot;[bold magenta]Generating independent projection synthesis plans...[/bold magenta]&quot;</span>
                    <span class="p">)</span>
                    <span class="n">parallel_plans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_generator</span><span class="o">.</span><span class="n">_generate_parallel_plans</span><span class="p">(</span>
                        <span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span>
                    <span class="p">)</span>
                    <span class="n">candidate_plans</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parallel_plans</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="s2">&quot;[bold magenta]Generating chain projection synthesis plans...[/bold magenta]&quot;</span>
                    <span class="p">)</span>
                    <span class="n">chain_plans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_generator</span><span class="o">.</span><span class="n">_generate_chain_plans</span><span class="p">(</span>
                        <span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span>
                    <span class="p">)</span>
                    <span class="n">candidate_plans</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chain_plans</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">plan_type</span> <span class="o">==</span> <span class="s2">&quot;glean&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s2">&quot;[bold magenta]Generating gleaning plans...[/bold magenta]&quot;</span>
                <span class="p">)</span>
                <span class="n">gleaning_plans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_generator</span><span class="o">.</span><span class="n">_generate_gleaning_plans</span><span class="p">(</span>
                    <span class="n">op_config</span><span class="p">,</span> <span class="n">validator_prompt</span>
                <span class="p">)</span>
                <span class="n">candidate_plans</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gleaning_plans</span><span class="p">)</span>

        <span class="c1"># Capture candidate plans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">captured_output</span><span class="o">.</span><span class="n">save_optimizer_output</span><span class="p">(</span>
            <span class="n">stage_type</span><span class="o">=</span><span class="n">StageType</span><span class="o">.</span><span class="n">CANDIDATE_PLANS</span><span class="p">,</span>
            <span class="n">output</span><span class="o">=</span><span class="n">candidate_plans</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">post_optimizer_status</span><span class="p">(</span><span class="n">StageType</span><span class="o">.</span><span class="n">EVALUATION_RESULTS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[bold magenta]Evaluating </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">candidate_plans</span><span class="p">)</span><span class="si">}</span><span class="s2"> plans...[/bold magenta]&quot;</span>
        <span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_plans</span><span class="p">(</span>
            <span class="n">candidate_plans</span><span class="p">,</span> <span class="n">op_config</span><span class="p">,</span> <span class="n">evaluation_samples</span><span class="p">,</span> <span class="n">validator_prompt</span>
        <span class="p">)</span>

        <span class="c1"># Select best plan using the centralized method</span>
        <span class="n">best_plan</span><span class="p">,</span> <span class="n">best_output</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">pairwise_rankings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_best_plan</span><span class="p">(</span>
            <span class="n">results</span><span class="p">,</span> <span class="n">op_config</span><span class="p">,</span> <span class="n">evaluation_samples</span><span class="p">,</span> <span class="n">validator_prompt</span><span class="p">,</span> <span class="n">candidate_plans</span>
        <span class="p">)</span>

        <span class="c1"># Capture evaluation results with pairwise rankings</span>
        <span class="n">ratings</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">runtime</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">sample_outputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">captured_output</span><span class="o">.</span><span class="n">save_optimizer_output</span><span class="p">(</span>
            <span class="n">stage_type</span><span class="o">=</span><span class="n">StageType</span><span class="o">.</span><span class="n">EVALUATION_RESULTS</span><span class="p">,</span>
            <span class="n">output</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;input_data&quot;</span><span class="p">:</span> <span class="n">evaluation_samples</span><span class="p">,</span>
                <span class="s2">&quot;all_plan_ratings&quot;</span><span class="p">:</span> <span class="n">ratings</span><span class="p">,</span>
                <span class="s2">&quot;all_plan_runtimes&quot;</span><span class="p">:</span> <span class="n">runtime</span><span class="p">,</span>
                <span class="s2">&quot;all_plan_sample_outputs&quot;</span><span class="p">:</span> <span class="n">sample_outputs</span><span class="p">,</span>
                <span class="s2">&quot;all_plan_pairwise_rankings&quot;</span><span class="p">:</span> <span class="n">pairwise_rankings</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">post_optimizer_status</span><span class="p">(</span><span class="n">StageType</span><span class="o">.</span><span class="n">END</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best_plan</span><span class="p">,</span> <span class="n">best_output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_generator</span><span class="o">.</span><span class="n">subplan_optimizer_cost</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="docetl.optimizers.map_optimizer.optimizer.MapOptimizer.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">run_operation</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">is_filter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the MapOptimizer.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>runner</code>
            </td>
            <td>
                  <code><span title="Runner">Runner</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The runner object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>run_operation</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A function to execute operations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timeout</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The timeout in seconds for operation execution. Defaults to 10.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>is_filter</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, the operation is a filter operation. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>docetl/optimizers/map_optimizer/optimizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">runner</span><span class="p">,</span>
    <span class="n">run_operation</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">is_filter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the MapOptimizer.</span>

<span class="sd">    Args:</span>
<span class="sd">        runner (Runner): The runner object.</span>
<span class="sd">        run_operation (Callable): A function to execute operations.</span>
<span class="sd">        timeout (int, optional): The timeout in seconds for operation execution. Defaults to 10.</span>
<span class="sd">        is_filter (bool, optional): If True, the operation is a filter operation. Defaults to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">runner</span> <span class="o">=</span> <span class="n">runner</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">console</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">llm_client</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_run_operation</span> <span class="o">=</span> <span class="n">run_operation</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">max_threads</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">timeout</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_num_plans_to_evaluate_in_parallel</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">is_filter</span> <span class="o">=</span> <span class="n">is_filter</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">k_to_pairwise_compare</span> <span class="o">=</span> <span class="mi">6</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">plan_generator</span> <span class="o">=</span> <span class="n">PlanGenerator</span><span class="p">(</span>
        <span class="n">runner</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="n">run_operation</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
        <span class="n">is_filter</span><span class="p">,</span>
        <span class="n">depth</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">Evaluator</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_operation</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_plans_to_evaluate_in_parallel</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_filter</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">prompt_generator</span> <span class="o">=</span> <span class="n">PromptGenerator</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_filter</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.optimizers.map_optimizer.optimizer.MapOptimizer.optimize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">plan_types</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chunk&#39;</span><span class="p">,</span> <span class="s1">&#39;proj_synthesis&#39;</span><span class="p">,</span> <span class="s1">&#39;glean&#39;</span><span class="p">])</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Optimize the given operation configuration for the input data.
Uses a staged evaluation approach:
1. For data exceeding limits: Try all plan types at once
2. For data within limits:
    - First try gleaning/proj synthesis
    - Compare with baseline
    - Selectively try chunking plans based on initial results</p>


            <details class="quote">
              <summary>Source code in <code>docetl/optimizers/map_optimizer/optimizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">plan_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;chunk&quot;</span><span class="p">,</span> <span class="s2">&quot;proj_synthesis&quot;</span><span class="p">,</span> <span class="s2">&quot;glean&quot;</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimize the given operation configuration for the input data.</span>
<span class="sd">    Uses a staged evaluation approach:</span>
<span class="sd">    1. For data exceeding limits: Try all plan types at once</span>
<span class="sd">    2. For data within limits:</span>
<span class="sd">        - First try gleaning/proj synthesis</span>
<span class="sd">        - Compare with baseline</span>
<span class="sd">        - Selectively try chunking plans based on initial results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Verify that the plan types are valid</span>
    <span class="k">for</span> <span class="n">plan_type</span> <span class="ow">in</span> <span class="n">plan_types</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">plan_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;chunk&quot;</span><span class="p">,</span> <span class="s2">&quot;proj_synthesis&quot;</span><span class="p">,</span> <span class="s2">&quot;glean&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid plan type: </span><span class="si">{</span><span class="n">plan_type</span><span class="si">}</span><span class="s2">. Valid plan types are: chunk, proj_synthesis, glean.&quot;</span>
            <span class="p">)</span>

    <span class="p">(</span>
        <span class="n">input_data</span><span class="p">,</span>
        <span class="n">output_data</span><span class="p">,</span>
        <span class="n">model_input_context_length</span><span class="p">,</span>
        <span class="n">no_change_runtime</span><span class="p">,</span>
        <span class="n">validator_prompt</span><span class="p">,</span>
        <span class="n">assessment</span><span class="p">,</span>
        <span class="n">data_exceeds_limit</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_optimize_helper</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;force_decompose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_exceeds_limit</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">assessment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;needs_improvement&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[green]No improvement needed for operation </span><span class="si">{</span><span class="n">op_config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">[/green]&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="p">[</span><span class="n">op_config</span><span class="p">],</span>
                <span class="n">output_data</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plan_generator</span><span class="o">.</span><span class="n">subplan_optimizer_cost</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Select consistent evaluation samples</span>
    <span class="n">num_evaluations</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))</span>
    <span class="n">evaluation_samples</span> <span class="o">=</span> <span class="n">select_evaluation_samples</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">num_evaluations</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">data_exceeds_limit</span><span class="p">:</span>
        <span class="c1"># For data exceeding limits, try all plan types at once</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_all_plans</span><span class="p">(</span>
            <span class="n">op_config</span><span class="p">,</span>
            <span class="n">input_data</span><span class="p">,</span>
            <span class="n">evaluation_samples</span><span class="p">,</span>
            <span class="n">validator_prompt</span><span class="p">,</span>
            <span class="n">plan_types</span><span class="p">,</span>
            <span class="n">model_input_context_length</span><span class="p">,</span>
            <span class="n">data_exceeds_limit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># For data within limits, use staged evaluation</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staged_evaluation</span><span class="p">(</span>
        <span class="n">op_config</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">,</span>
        <span class="n">evaluation_samples</span><span class="p">,</span>
        <span class="n">validator_prompt</span><span class="p">,</span>
        <span class="n">plan_types</span><span class="p">,</span>
        <span class="n">no_change_runtime</span><span class="p">,</span>
        <span class="n">model_input_context_length</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.optimizers.map_optimizer.optimizer.MapOptimizer.should_optimize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">should_optimize</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Determine if the given operation configuration should be optimized.</p>


            <details class="quote">
              <summary>Source code in <code>docetl/optimizers/map_optimizer/optimizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">should_optimize</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine if the given operation configuration should be optimized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span>
        <span class="n">input_data</span><span class="p">,</span>
        <span class="n">output_data</span><span class="p">,</span>
        <span class="n">_</span><span class="p">,</span>
        <span class="n">_</span><span class="p">,</span>
        <span class="n">validator_prompt</span><span class="p">,</span>
        <span class="n">assessment</span><span class="p">,</span>
        <span class="n">data_exceeds_limit</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_optimize_helper</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data_exceeds_limit</span> <span class="ow">or</span> <span class="n">assessment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;needs_improvement&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">assessment_str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">assessment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reasons&quot;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Here are some improvements that may help:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">assessment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;improvements&quot;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">data_exceeds_limit</span><span class="p">:</span>
            <span class="n">assessment_str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Also, the input data exceeds the token limit.&quot;</span>
        <span class="k">return</span> <span class="n">assessment_str</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">output_data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">output_data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="docetl.optimizers.reduce_optimizer.ReduceOptimizer" class="doc doc-heading">
            <code>docetl.optimizers.reduce_optimizer.ReduceOptimizer</code>


</h3>


    <div class="doc doc-contents first">


        <p>A class that optimizes reduce operations in data processing pipelines.</p>
<p>This optimizer analyzes the input and output of a reduce operation, creates and evaluates
multiple reduce plans, and selects the best plan for optimizing the operation's performance.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="docetl.optimizers.reduce_optimizer.ReduceOptimizer.config">config</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary for the optimizer.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.optimizers.reduce_optimizer.ReduceOptimizer.console">console</span></code></td>
            <td>
                  <code><span title="Console">Console</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Rich console object for pretty printing.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.optimizers.reduce_optimizer.ReduceOptimizer.llm_client">llm_client</span></code></td>
            <td>
                  <code><span title="LLMClient">LLMClient</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Client for interacting with a language model.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.optimizers.reduce_optimizer.ReduceOptimizer._run_operation">_run_operation</span></code></td>
            <td>
                  <code><span title="typing.Callable">Callable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function to run an operation.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.optimizers.reduce_optimizer.ReduceOptimizer.max_threads">max_threads</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of threads to use for parallel processing.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.optimizers.reduce_optimizer.ReduceOptimizer.num_fold_prompts">num_fold_prompts</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of fold prompts to generate.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.optimizers.reduce_optimizer.ReduceOptimizer.num_samples_in_validation">num_samples_in_validation</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of samples to use in validation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>docetl/optimizers/reduce_optimizer.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  19</span>
<span class="normal">  20</span>
<span class="normal">  21</span>
<span class="normal">  22</span>
<span class="normal">  23</span>
<span class="normal">  24</span>
<span class="normal">  25</span>
<span class="normal">  26</span>
<span class="normal">  27</span>
<span class="normal">  28</span>
<span class="normal">  29</span>
<span class="normal">  30</span>
<span class="normal">  31</span>
<span class="normal">  32</span>
<span class="normal">  33</span>
<span class="normal">  34</span>
<span class="normal">  35</span>
<span class="normal">  36</span>
<span class="normal">  37</span>
<span class="normal">  38</span>
<span class="normal">  39</span>
<span class="normal">  40</span>
<span class="normal">  41</span>
<span class="normal">  42</span>
<span class="normal">  43</span>
<span class="normal">  44</span>
<span class="normal">  45</span>
<span class="normal">  46</span>
<span class="normal">  47</span>
<span class="normal">  48</span>
<span class="normal">  49</span>
<span class="normal">  50</span>
<span class="normal">  51</span>
<span class="normal">  52</span>
<span class="normal">  53</span>
<span class="normal">  54</span>
<span class="normal">  55</span>
<span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ReduceOptimizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that optimizes reduce operations in data processing pipelines.</span>

<span class="sd">    This optimizer analyzes the input and output of a reduce operation, creates and evaluates</span>
<span class="sd">    multiple reduce plans, and selects the best plan for optimizing the operation&#39;s performance.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        config (dict[str, Any]): Configuration dictionary for the optimizer.</span>
<span class="sd">        console (Console): Rich console object for pretty printing.</span>
<span class="sd">        llm_client (LLMClient): Client for interacting with a language model.</span>
<span class="sd">        _run_operation (Callable): Function to run an operation.</span>
<span class="sd">        max_threads (int): Maximum number of threads to use for parallel processing.</span>
<span class="sd">        num_fold_prompts (int): Number of fold prompts to generate.</span>
<span class="sd">        num_samples_in_validation (int): Number of samples to use in validation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">runner</span><span class="p">,</span>
        <span class="n">run_operation</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">num_fold_prompts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">num_samples_in_validation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the ReduceOptimizer.</span>

<span class="sd">        Args:</span>
<span class="sd">            config (dict[str, Any]): Configuration dictionary for the optimizer.</span>
<span class="sd">            console (Console): Rich console object for pretty printing.</span>
<span class="sd">            llm_client (LLMClient): Client for interacting with a language model.</span>
<span class="sd">            max_threads (int): Maximum number of threads to use for parallel processing.</span>
<span class="sd">            run_operation (Callable): Function to run an operation.</span>
<span class="sd">            num_fold_prompts (int, optional): Number of fold prompts to generate. Defaults to 1.</span>
<span class="sd">            num_samples_in_validation (int, optional): Number of samples to use in validation. Defaults to 10.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span> <span class="o">=</span> <span class="n">runner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">console</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">llm_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_operation</span> <span class="o">=</span> <span class="n">run_operation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">max_threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_fold_prompts</span> <span class="o">=</span> <span class="n">num_fold_prompts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_samples_in_validation</span> <span class="o">=</span> <span class="n">num_samples_in_validation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">status</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">should_optimize_helper</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Check if we&#39;re running out of token limits for the reduce prompt</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_model&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">))</span>
        <span class="n">model_input_context_length</span> <span class="o">=</span> <span class="n">model_cost</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;max_input_tokens&quot;</span><span class="p">,</span> <span class="mi">4096</span>
        <span class="p">)</span>

        <span class="c1"># Find the key with the longest value</span>
        <span class="k">if</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;_all&quot;</span><span class="p">]:</span>
            <span class="n">sample_key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="s2">&quot;_all&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">longest_key</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">k</span><span class="p">]))</span>
            <span class="p">)</span>
            <span class="n">sample_key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">input_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">longest_key</span> <span class="k">else</span> <span class="n">input_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># Render the prompt with a sample input</span>
        <span class="n">prompt_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">])</span>
        <span class="n">sample_prompt</span> <span class="o">=</span> <span class="n">prompt_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
            <span class="n">reduce_key</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">],</span> <span class="n">sample_key</span><span class="p">)),</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">input_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
        <span class="p">)</span>

        <span class="c1"># Count tokens in the sample prompt</span>
        <span class="n">prompt_tokens</span> <span class="o">=</span> <span class="n">count_tokens</span><span class="p">(</span><span class="n">sample_prompt</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">post_optimizer_status</span><span class="p">(</span><span class="n">StageType</span><span class="o">.</span><span class="n">SAMPLE_RUN</span><span class="p">)</span>
        <span class="n">original_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_operation</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>

        <span class="c1"># Step 1: Synthesize a validator prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">post_optimizer_status</span><span class="p">(</span><span class="n">StageType</span><span class="o">.</span><span class="n">SHOULD_OPTIMIZE</span><span class="p">)</span>
        <span class="n">validator_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_validator_prompt</span><span class="p">(</span>
            <span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">original_output</span>
        <span class="p">)</span>

        <span class="c1"># Log the validator prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[bold]Validator Prompt:[/bold]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">validator_prompt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Add a newline for better readability</span>

        <span class="c1"># Step 2: validate the output</span>
        <span class="n">validator_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_validation_inputs</span><span class="p">(</span>
            <span class="n">input_data</span><span class="p">,</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">validation_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_reduce_output</span><span class="p">(</span>
            <span class="n">op_config</span><span class="p">,</span> <span class="n">validator_inputs</span><span class="p">,</span> <span class="n">original_output</span><span class="p">,</span> <span class="n">validator_prompt</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">validation_results</span><span class="p">,</span>
            <span class="n">prompt_tokens</span><span class="p">,</span>
            <span class="n">model_input_context_length</span><span class="p">,</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">validator_prompt</span><span class="p">,</span>
            <span class="n">original_output</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">should_optimize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="p">(</span>
            <span class="n">validation_results</span><span class="p">,</span>
            <span class="n">prompt_tokens</span><span class="p">,</span>
            <span class="n">model_input_context_length</span><span class="p">,</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">validator_prompt</span><span class="p">,</span>
            <span class="n">original_output</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_optimize_helper</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prompt_tokens</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">&gt;</span> <span class="n">model_input_context_length</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="s2">&quot;The reduce prompt is likely to exceed the token limit for model </span><span class="si">{model}</span><span class="s2">.&quot;</span><span class="p">,</span>
                <span class="n">input_data</span><span class="p">,</span>
                <span class="n">original_output</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">validation_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;needs_improvement&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">f</span><span class="s2">&quot;Issues: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> Suggestions: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;suggestions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">validation_results</span><span class="p">[</span><span class="s2">&quot;validation_results&quot;</span><span class="p">]</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="n">input_data</span><span class="p">,</span>
                <span class="n">original_output</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">original_output</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimize the reduce operation based on the given configuration and input data.</span>

<span class="sd">        This method performs the following steps:</span>
<span class="sd">        1. Run the original operation</span>
<span class="sd">        2. Generate a validator prompt</span>
<span class="sd">        3. Validate the output</span>
<span class="sd">        4. If improvement is needed:</span>
<span class="sd">           a. Evaluate if decomposition is beneficial</span>
<span class="sd">           b. If decomposition is beneficial, recursively optimize each sub-operation</span>
<span class="sd">           c. If not, proceed with single operation optimization</span>
<span class="sd">        5. Run the optimized operation(s)</span>

<span class="sd">        Args:</span>
<span class="sd">            op_config (dict[str, Any]): Configuration for the reduce operation.</span>
<span class="sd">            input_data (list[dict[str, Any]]): Input data for the reduce operation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[list[dict[str, Any]], list[dict[str, Any]], float]: A tuple containing the list of optimized configurations</span>
<span class="sd">            and the list of outputs from the optimized operation(s), and the cost of the operation due to synthesizing any resolve operations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span>
            <span class="n">validation_results</span><span class="p">,</span>
            <span class="n">prompt_tokens</span><span class="p">,</span>
            <span class="n">model_input_context_length</span><span class="p">,</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">validator_prompt</span><span class="p">,</span>
            <span class="n">original_output</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_optimize_helper</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>

        <span class="c1"># add_map_op = False</span>
        <span class="k">if</span> <span class="n">prompt_tokens</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">model_input_context_length</span><span class="p">:</span>
            <span class="c1"># add_map_op = True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[yellow]Warning: The reduce prompt exceeds the token limit for model </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Token count: </span><span class="si">{</span><span class="n">prompt_tokens</span><span class="si">}</span><span class="s2">, Limit: </span><span class="si">{</span><span class="n">model_input_context_length</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Add a map operation to the pipeline.[/yellow]&quot;</span>
            <span class="p">)</span>

        <span class="c1"># # Also query an agent to look at a sample of the inputs and see if they think a map operation would be helpful</span>
        <span class="c1"># preprocessing_steps = &quot;&quot;</span>
        <span class="c1"># should_use_map, preprocessing_steps = self._should_use_map(</span>
        <span class="c1">#     op_config, input_data</span>
        <span class="c1"># )</span>
        <span class="c1"># if should_use_map or add_map_op:</span>
        <span class="c1">#     # Synthesize a map operation</span>
        <span class="c1">#     map_prompt, map_output_schema = self._synthesize_map_operation(</span>
        <span class="c1">#         op_config, preprocessing_steps, input_data</span>
        <span class="c1">#     )</span>
        <span class="c1">#     # Change the reduce operation prompt to use the map schema</span>
        <span class="c1">#     new_reduce_prompt = self._change_reduce_prompt_to_use_map_schema(</span>
        <span class="c1">#         op_config[&quot;prompt&quot;], map_output_schema</span>
        <span class="c1">#     )</span>
        <span class="c1">#     op_config[&quot;prompt&quot;] = new_reduce_prompt</span>

        <span class="c1">#     # Return unoptimized map and reduce operations</span>
        <span class="c1">#     return [map_prompt, op_config], input_data, 0.0</span>

        <span class="c1"># Print the validation results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[bold]Validation Results on Initial Sample:[/bold]&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validation_results</span><span class="p">[</span><span class="s2">&quot;needs_improvement&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;force_decompose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">post_optimizer_rationale</span><span class="p">(</span>
                <span class="n">should_optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">rationale</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">f</span><span class="s2">&quot;Issues: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> Suggestions: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;suggestions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">validation_results</span><span class="p">[</span><span class="s2">&quot;validation_results&quot;</span><span class="p">]</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="n">validator_prompt</span><span class="o">=</span><span class="n">validator_prompt</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">f</span><span class="s2">&quot;Issues: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> Suggestions: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;suggestions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">validation_results</span><span class="p">[</span><span class="s2">&quot;validation_results&quot;</span><span class="p">]</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Step 3: Evaluate if decomposition is beneficial</span>
            <span class="n">decomposition_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_decomposition</span><span class="p">(</span>
                <span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">level</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">decomposition_result</span><span class="p">[</span><span class="s2">&quot;should_decompose&quot;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_decomposed_reduce</span><span class="p">(</span>
                    <span class="n">decomposition_result</span><span class="p">,</span> <span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">level</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_single_reduce</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">validator_prompt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No improvements identified; </span><span class="si">{</span><span class="n">validation_results</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">post_optimizer_rationale</span><span class="p">(</span>
                <span class="n">should_optimize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">rationale</span><span class="o">=</span><span class="s2">&quot;No improvements identified; no optimization recommended.&quot;</span><span class="p">,</span>
                <span class="n">validator_prompt</span><span class="o">=</span><span class="n">validator_prompt</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">op_config</span><span class="p">],</span> <span class="n">original_output</span><span class="p">,</span> <span class="mf">0.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_should_use_map</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if a map operation should be used based on the input data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Sample a random input item</span>
        <span class="n">sample_input</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

        <span class="c1"># Format the prompt with the sample input</span>
        <span class="n">prompt_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">])</span>
        <span class="n">formatted_prompt</span> <span class="o">=</span> <span class="n">prompt_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
            <span class="n">reduce_key</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">],</span> <span class="n">sample_input</span><span class="p">[</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]])</span>
            <span class="p">),</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">sample_input</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Prepare the message for the LLM</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">formatted_prompt</span><span class="p">}]</span>

        <span class="c1"># Truncate the messages to fit the model&#39;s context window</span>
        <span class="n">truncated_messages</span> <span class="o">=</span> <span class="n">truncate_messages</span><span class="p">(</span>
            <span class="n">messages</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Query the LLM for preprocessing suggestions</span>
        <span class="n">preprocessing_prompt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Based on the following reduce operation prompt, should we do any preprocessing on the input data? &quot;</span>
            <span class="s2">&quot;Consider if we need to remove unnecessary context, or logically construct an output that will help in the task. &quot;</span>
            <span class="s2">&quot;If preprocessing would be beneficial, explain why and suggest specific steps. If not, explain why preprocessing isn&#39;t necessary.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Reduce operation prompt:</span><span class="se">\n</span><span class="si">{</span><span class="n">truncated_messages</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">preprocessing_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">),</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">preprocessing_prompt</span><span class="p">}],</span>
            <span class="n">response_format</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;json_object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;preprocessing_needed&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">},</span>
                        <span class="s2">&quot;rationale&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                        <span class="s2">&quot;suggested_steps&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;preprocessing_needed&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;rationale&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;suggested_steps&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="n">preprocessing_result</span> <span class="o">=</span> <span class="n">preprocessing_response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>

        <span class="n">should_preprocess</span> <span class="o">=</span> <span class="n">preprocessing_result</span><span class="p">[</span><span class="s2">&quot;preprocessing_needed&quot;</span><span class="p">]</span>
        <span class="n">preprocessing_rationale</span> <span class="o">=</span> <span class="n">preprocessing_result</span><span class="p">[</span><span class="s2">&quot;rationale&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[bold]Map-Reduce Decomposition Analysis:[/bold]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Should write a map operation: </span><span class="si">{</span><span class="n">should_preprocess</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rationale: </span><span class="si">{</span><span class="n">preprocessing_rationale</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">should_preprocess</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Suggested steps: </span><span class="si">{</span><span class="n">preprocessing_result</span><span class="p">[</span><span class="s1">&#39;suggested_steps&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">should_preprocess</span><span class="p">,</span> <span class="n">preprocessing_result</span><span class="p">[</span><span class="s2">&quot;suggested_steps&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_optimize_single_reduce</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">validator_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimize a single reduce operation.</span>

<span class="sd">        This method performs the following steps:</span>
<span class="sd">        1. Determine and configure value sampling</span>
<span class="sd">        2. Determine if the reduce operation is associative</span>
<span class="sd">        3. Create and evaluate multiple reduce plans</span>
<span class="sd">        4. Run the best reduce plan</span>

<span class="sd">        Args:</span>
<span class="sd">            op_config (dict[str, Any]): Configuration for the reduce operation.</span>
<span class="sd">            input_data (list[dict[str, Any]]): Input data for the reduce operation.</span>
<span class="sd">            validator_prompt (str): The validator prompt for evaluating reduce plans.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[list[dict[str, Any]], list[dict[str, Any]], float]: A tuple containing a single-item list with the optimized configuration</span>
<span class="sd">            and a single-item list with the output from the optimized operation, and the cost of the operation due to synthesizing any resolve operations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Step 1: Determine and configure value sampling (TODO: re-enable this when the agent is more reliable)</span>
        <span class="c1"># value_sampling_config = self._determine_value_sampling(op_config, input_data)</span>
        <span class="c1"># if value_sampling_config[&quot;enabled&quot;]:</span>
        <span class="c1">#     op_config[&quot;value_sampling&quot;] = value_sampling_config</span>
        <span class="c1">#     self.console.log(&quot;[bold]Value Sampling Configuration:[/bold]&quot;)</span>
        <span class="c1">#     self.console.log(json.dumps(value_sampling_config, indent=2))</span>

        <span class="c1"># Step 2: Determine if the reduce operation is associative</span>
        <span class="n">is_associative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_associative</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>

        <span class="c1"># Step 3: Create and evaluate multiple reduce plans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">post_optimizer_status</span><span class="p">(</span><span class="n">StageType</span><span class="o">.</span><span class="n">CANDIDATE_PLANS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[bold magenta]Generating batched plans...[/bold magenta]&quot;</span><span class="p">)</span>
        <span class="n">reduce_plans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_reduce_plans</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">is_associative</span><span class="p">)</span>

        <span class="c1"># Create gleaning plans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[bold magenta]Generating gleaning plans...[/bold magenta]&quot;</span><span class="p">)</span>
        <span class="n">gleaning_plans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_gleaning_plans</span><span class="p">(</span><span class="n">reduce_plans</span><span class="p">,</span> <span class="n">validator_prompt</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[bold magenta]Evaluating plans...[/bold magenta]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">post_optimizer_status</span><span class="p">(</span><span class="n">StageType</span><span class="o">.</span><span class="n">EVALUATION_RESULTS</span><span class="p">)</span>
        <span class="n">best_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_reduce_plans</span><span class="p">(</span>
            <span class="n">op_config</span><span class="p">,</span> <span class="n">reduce_plans</span> <span class="o">+</span> <span class="n">gleaning_plans</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">validator_prompt</span>
        <span class="p">)</span>

        <span class="c1"># Step 4: Run the best reduce plan</span>
        <span class="n">optimized_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_operation</span><span class="p">(</span><span class="n">best_plan</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">post_optimizer_status</span><span class="p">(</span><span class="n">StageType</span><span class="o">.</span><span class="n">END</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">best_plan</span><span class="p">],</span> <span class="n">optimized_output</span><span class="p">,</span> <span class="mf">0.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_gleaning_plans</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">plans</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">validation_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate plans that use gleaning for the given operation.</span>

<span class="sd">        Gleaning involves iteratively refining the output of an operation</span>
<span class="sd">        based on validation feedback. This method creates plans with different</span>
<span class="sd">        numbers of gleaning rounds.</span>

<span class="sd">        Args:</span>
<span class="sd">            plans (list[dict[str, Any]]): The list of plans to use for gleaning.</span>
<span class="sd">            validation_prompt (str): The prompt used for validating the operation&#39;s output.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, list[dict[str, Any]]]: A dictionary of gleaning plans, where each key</span>
<span class="sd">            is a plan name and each value is a list containing a single operation configuration</span>
<span class="sd">            with gleaning parameters.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Generate an op with gleaning num_rounds and validation_prompt</span>
        <span class="n">gleaning_plans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">gleaning_rounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">biggest_batch_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">plan</span><span class="p">[</span><span class="s2">&quot;fold_batch_size&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">plan</span> <span class="ow">in</span> <span class="n">plans</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">plan</span> <span class="ow">in</span> <span class="n">plans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;fold_batch_size&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">biggest_batch_size</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">gleaning_round</span> <span class="ow">in</span> <span class="n">gleaning_rounds</span><span class="p">:</span>
                <span class="n">plan_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
                <span class="n">plan_copy</span><span class="p">[</span><span class="s2">&quot;gleaning&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;num_rounds&quot;</span><span class="p">:</span> <span class="n">gleaning_round</span><span class="p">,</span>
                    <span class="s2">&quot;validation_prompt&quot;</span><span class="p">:</span> <span class="n">validation_prompt</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">plan_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;gleaning_</span><span class="si">{</span><span class="n">gleaning_round</span><span class="si">}</span><span class="s2">_rounds_</span><span class="si">{</span><span class="n">plan</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">plan_copy</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plan_name</span>
                <span class="n">gleaning_plans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plan_copy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gleaning_plans</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_optimize_decomposed_reduce</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">decomposition_result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimize a decomposed reduce operation.</span>

<span class="sd">        This method performs the following steps:</span>
<span class="sd">        1. Group the input data by the sub-group key.</span>
<span class="sd">        2. Optimize the first reduce operation.</span>
<span class="sd">        3. Run the optimized first reduce operation on all groups.</span>
<span class="sd">        4. Optimize the second reduce operation using the results of the first.</span>
<span class="sd">        5. Run the optimized second reduce operation.</span>

<span class="sd">        Args:</span>
<span class="sd">            decomposition_result (dict[str, Any]): The result of the decomposition evaluation.</span>
<span class="sd">            op_config (dict[str, Any]): The original reduce operation configuration.</span>
<span class="sd">            input_data (list[dict[str, Any]]): The input data for the reduce operation.</span>
<span class="sd">            level (int): The current level of decomposition.</span>
<span class="sd">        Returns:</span>
<span class="sd">            tuple[list[dict[str, Any]], list[dict[str, Any]], float]: A tuple containing the list of optimized configurations</span>
<span class="sd">            for both reduce operations and the final output of the second reduce operation, and the cost of the operation due to synthesizing any resolve operations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sub_group_key</span> <span class="o">=</span> <span class="n">decomposition_result</span><span class="p">[</span><span class="s2">&quot;sub_group_key&quot;</span><span class="p">]</span>
        <span class="n">first_reduce_prompt</span> <span class="o">=</span> <span class="n">decomposition_result</span><span class="p">[</span><span class="s2">&quot;first_reduce_prompt&quot;</span><span class="p">]</span>
        <span class="n">second_reduce_prompt</span> <span class="o">=</span> <span class="n">decomposition_result</span><span class="p">[</span><span class="s2">&quot;second_reduce_prompt&quot;</span><span class="p">]</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_cost</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">first_reduce_config</span> <span class="o">=</span> <span class="n">op_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">first_reduce_config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_reduce_prompt</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">first_reduce_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sub_group_key</span><span class="p">]</span> <span class="o">+</span> <span class="n">op_config</span><span class="p">[</span>
                <span class="s2">&quot;reduce_key&quot;</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">first_reduce_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sub_group_key</span><span class="p">,</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]]</span>
        <span class="n">first_reduce_config</span><span class="p">[</span><span class="s2">&quot;pass_through&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">first_reduce_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;synthesize_resolve&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">resolve_config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;synthesized_resolve_</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;resolve&quot;</span><span class="p">,</span>
                <span class="s2">&quot;empty&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;embedding_model&quot;</span><span class="p">:</span> <span class="s2">&quot;text-embedding-3-small&quot;</span><span class="p">,</span>
                <span class="s2">&quot;resolution_model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_model&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">),</span>
                <span class="s2">&quot;comparison_model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_model&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">),</span>
                <span class="s2">&quot;_intermediates&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;map_prompt&quot;</span><span class="p">:</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_intermediates&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;last_map_prompt&quot;</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;reduce_key&quot;</span><span class="p">:</span> <span class="n">first_reduce_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">],</span>
                <span class="p">},</span>
            <span class="p">}</span>
            <span class="n">optimized_resolve_config</span><span class="p">,</span> <span class="n">resolve_cost</span> <span class="o">=</span> <span class="n">JoinOptimizer</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                <span class="n">resolve_config</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">optimize_resolve</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
            <span class="n">all_cost</span> <span class="o">+=</span> <span class="n">resolve_cost</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">optimized_resolve_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;empty&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="c1"># Add this to the pipeline</span>
                <span class="n">pipeline</span> <span class="o">+=</span> <span class="p">[</span><span class="n">optimized_resolve_config</span><span class="p">]</span>

                <span class="c1"># Run the resolver</span>
                <span class="n">optimized_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_operation</span><span class="p">(</span>
                    <span class="n">optimized_resolve_config</span><span class="p">,</span> <span class="n">input_data</span>
                <span class="p">)</span>
                <span class="n">input_data</span> <span class="o">=</span> <span class="n">optimized_output</span>

        <span class="n">first_optimized_configs</span><span class="p">,</span> <span class="n">first_outputs</span><span class="p">,</span> <span class="n">first_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
            <span class="n">first_reduce_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">pipeline</span> <span class="o">+=</span> <span class="n">first_optimized_configs</span>
        <span class="n">all_cost</span> <span class="o">+=</span> <span class="n">first_cost</span>

        <span class="c1"># Optimize second reduce operation</span>
        <span class="n">second_reduce_config</span> <span class="o">=</span> <span class="n">op_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">second_reduce_config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">second_reduce_prompt</span>
        <span class="n">second_reduce_config</span><span class="p">[</span><span class="s2">&quot;pass_through&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">second_optimized_configs</span><span class="p">,</span> <span class="n">second_outputs</span><span class="p">,</span> <span class="n">second_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
            <span class="n">second_reduce_config</span><span class="p">,</span> <span class="n">first_outputs</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>

        <span class="c1"># Combine optimized configs and return with final output</span>
        <span class="n">pipeline</span> <span class="o">+=</span> <span class="n">second_optimized_configs</span>
        <span class="n">all_cost</span> <span class="o">+=</span> <span class="n">second_cost</span>

        <span class="k">return</span> <span class="n">pipeline</span><span class="p">,</span> <span class="n">second_outputs</span><span class="p">,</span> <span class="n">all_cost</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_evaluate_decomposition</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate whether decomposing the reduce operation would be beneficial.</span>

<span class="sd">        This method first determines if decomposition would be helpful, and if so,</span>
<span class="sd">        it then determines the sub-group key and prompts for the decomposed operations.</span>

<span class="sd">        Args:</span>
<span class="sd">            op_config (dict[str, Any]): Configuration for the reduce operation.</span>
<span class="sd">            input_data (list[dict[str, Any]]): Input data for the reduce operation.</span>
<span class="sd">            level (int): The current level of decomposition.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, Any]: A dictionary containing the decomposition decision and details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">should_decompose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_decompose</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="c1"># Log the decomposition decision</span>
        <span class="k">if</span> <span class="n">should_decompose</span><span class="p">[</span><span class="s2">&quot;should_decompose&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[bold green]Decomposition recommended:[/bold green] </span><span class="si">{</span><span class="n">should_decompose</span><span class="p">[</span><span class="s1">&#39;explanation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[bold yellow]Decomposition not recommended:[/bold yellow] </span><span class="si">{</span><span class="n">should_decompose</span><span class="p">[</span><span class="s1">&#39;explanation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Return early if decomposition is not recommended</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">should_decompose</span><span class="p">[</span><span class="s2">&quot;should_decompose&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">should_decompose</span>

        <span class="c1"># Temporarily stop the status</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="c1"># Ask user if they agree with the decomposition assessment</span>
        <span class="n">user_agrees</span> <span class="o">=</span> <span class="n">Confirm</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Do you agree with the decomposition assessment? &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;[bold]</span><span class="si">{</span><span class="s1">&#39;Recommended&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">should_decompose</span><span class="p">[</span><span class="s1">&#39;should_decompose&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;Not recommended&#39;</span><span class="si">}</span><span class="s2">[/bold]&quot;</span><span class="p">,</span>
            <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># If user disagrees, invert the decomposition decision</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_agrees</span><span class="p">:</span>
            <span class="n">should_decompose</span><span class="p">[</span><span class="s2">&quot;should_decompose&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">should_decompose</span><span class="p">[</span>
                <span class="s2">&quot;should_decompose&quot;</span>
            <span class="p">]</span>
            <span class="n">should_decompose</span><span class="p">[</span><span class="s2">&quot;explanation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;User disagreed with the initial assessment.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Restart the status</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># Return if decomposition is not recommended</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">should_decompose</span><span class="p">[</span><span class="s2">&quot;should_decompose&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">should_decompose</span>

        <span class="n">decomposition_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_decomposition_details</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">should_decompose</span><span class="p">,</span> <span class="o">**</span><span class="n">decomposition_details</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">decomposition_details</span><span class="p">[</span><span class="s2">&quot;sub_group_key&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;should_decompose&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">result</span><span class="p">[</span>
                <span class="s2">&quot;explanation&quot;</span>
            <span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot; However, the suggested sub-group key is already part of the current reduce key(s), so decomposition is not recommended.&quot;</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;sub_group_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_should_decompose</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if decomposing the reduce operation would be beneficial.</span>

<span class="sd">        Args:</span>
<span class="sd">            op_config (dict[str, Any]): Configuration for the reduce operation.</span>
<span class="sd">            input_data (list[dict[str, Any]]): Input data for the reduce operation.</span>
<span class="sd">            level (int): The current level of decomposition.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, Any]: A dictionary containing the decomposition decision and explanation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: we have not enabled recursive decomposition yet</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;recursively_optimize&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;should_decompose&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;explanation&quot;</span><span class="p">:</span> <span class="s2">&quot;Recursive decomposition is not enabled.&quot;</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="n">system_prompt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;You are an AI assistant tasked with optimizing data processing pipelines.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Sample a subset of input data for analysis</span>
        <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))</span>
        <span class="n">sample_input</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">)</span>

        <span class="c1"># Get all keys from the input data</span>
        <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sample_input</span><span class="p">))</span>
        <span class="n">reduce_key</span> <span class="o">=</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span>
        <span class="n">reduce_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">reduce_key</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reduce_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">reduce_key</span>
        <span class="n">other_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_keys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reduce_keys</span><span class="p">]</span>

        <span class="c1"># See if there&#39;s an input schema and constrain the sample_input to that schema</span>
        <span class="n">input_schema</span> <span class="o">=</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">input_schema</span><span class="p">:</span>
            <span class="n">sample_input</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">input_schema</span><span class="p">}</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sample_input</span>
            <span class="p">]</span>

        <span class="c1"># Create a sample of values for other keys</span>
        <span class="n">sample_values</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))[:</span><span class="mi">50</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sample_input</span><span class="p">))[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">other_keys</span>
        <span class="p">}</span>

        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Analyze the following reduce operation and determine if it should be decomposed into two reduce operations chained together:</span>

<span class="s2">        Reduce Operation Prompt:</span>
<span class="s2">        ```</span>
<span class="s2">        </span><span class="si">{</span><span class="n">op_config</span><span class="p">[</span><span class="s1">&#39;prompt&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">        ```</span>

<span class="s2">        Current Reduce Key(s): </span><span class="si">{</span><span class="n">reduce_keys</span><span class="si">}</span>
<span class="s2">        Other Available Keys: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other_keys</span><span class="p">)</span><span class="si">}</span>

<span class="s2">        Sample values for other keys:</span>
<span class="s2">        </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sample_values</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">        Based on this information, determine if it would be beneficial to decompose this reduce operation into a sub-reduce operation followed by a final reduce operation. Consider ALL of the following:</span>

<span class="s2">        1. Is there a natural hierarchy in the data (e.g., country -&gt; state -&gt; city) among the other available keys, with a key at a finer level of granularity than the current reduce key(s)?</span>
<span class="s2">        2. Are the current reduce key(s) some form of ID, and are there many different types of inputs for that ID among the other available keys?</span>
<span class="s2">        3. Does the prompt implicitly ask for sub-grouping based on the other available keys (e.g., &quot;summarize policies by state, then by country&quot;)?</span>
<span class="s2">        4. Would splitting the operation improve accuracy (i.e., make sure information isn&#39;t lost when reducing)?</span>
<span class="s2">        5. Are all the keys of the potential hierarchy provided in the other available keys? If not, we should not decompose.</span>
<span class="s2">        6. Importantly, do not suggest decomposition using any key that is already part of the current reduce key(s). We are looking for a new key from the other available keys to use for sub-grouping.</span>
<span class="s2">        7. Do not suggest keys that don&#39;t contain meaningful information (e.g., id-related keys).</span>

<span class="s2">        Provide your analysis in the following format:</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;should_decompose&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">},</span>
                <span class="s2">&quot;explanation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
            <span class="p">},</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;should_decompose&quot;</span><span class="p">,</span> <span class="s2">&quot;explanation&quot;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
            <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
            <span class="n">system_prompt</span><span class="p">,</span>
            <span class="n">parameters</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_decomposition_details</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the sub-group key and prompts for decomposed reduce operations.</span>

<span class="sd">        Args:</span>
<span class="sd">            op_config (dict[str, Any]): Configuration for the reduce operation.</span>
<span class="sd">            input_data (list[dict[str, Any]]): Input data for the reduce operation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, Any]: A dictionary containing the sub-group key and prompts for decomposed operations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">system_prompt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;You are an AI assistant tasked with optimizing data processing pipelines.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Sample a subset of input data for analysis</span>
        <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))</span>
        <span class="n">sample_input</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">)</span>

        <span class="c1"># Get all keys from the input data</span>
        <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sample_input</span><span class="p">))</span>
        <span class="n">reduce_key</span> <span class="o">=</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span>
        <span class="n">reduce_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">reduce_key</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reduce_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">reduce_key</span>
        <span class="n">other_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_keys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reduce_keys</span><span class="p">]</span>

        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Given that we&#39;ve decided to decompose the following reduce operation, suggest a two-step reduce process:</span>

<span class="s2">        Reduce Operation Prompt:</span>
<span class="s2">        ```</span>
<span class="s2">        </span><span class="si">{</span><span class="n">op_config</span><span class="p">[</span><span class="s1">&#39;prompt&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">        ```</span>

<span class="s2">        Reduce Key(s): </span><span class="si">{</span><span class="n">reduce_key</span><span class="si">}</span>
<span class="s2">        Other Keys: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other_keys</span><span class="p">)</span><span class="si">}</span>

<span class="s2">        Provide the following:</span>
<span class="s2">        1. A sub-group key to use for the first reduce operation</span>
<span class="s2">        2. A prompt for the first reduce operation</span>
<span class="s2">        3. A prompt for the second (final) reduce operation</span>

<span class="s2">        For the reduce operation prompts, you should only minimally modify the original prompt. The prompts should be Jinja templates, and the only variables they can access are the `reduce_key` and `inputs` variables.</span>

<span class="s2">        Provide your suggestions in the following format:</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;sub_group_key&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                <span class="s2">&quot;first_reduce_prompt&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                <span class="s2">&quot;second_reduce_prompt&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
            <span class="p">},</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;sub_group_key&quot;</span><span class="p">,</span>
                <span class="s2">&quot;first_reduce_prompt&quot;</span><span class="p">,</span>
                <span class="s2">&quot;second_reduce_prompt&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">}</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
            <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
            <span class="n">system_prompt</span><span class="p">,</span>
            <span class="n">parameters</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_determine_value_sampling</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine whether value sampling should be enabled and configure its parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">system_prompt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;You are an AI assistant helping to optimize data processing pipelines.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Sample a subset of input data for analysis</span>
        <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))</span>
        <span class="n">sample_input</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">)</span>

        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Analyze the following reduce operation and determine if value sampling should be enabled:</span>

<span class="s2">        Reduce Operation Prompt:</span>
<span class="s2">        </span><span class="si">{</span><span class="n">op_config</span><span class="p">[</span><span class="s1">&#39;prompt&#39;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">        Sample Input Data (first 2 items):</span>
<span class="s2">        </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sample_input</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">        Value sampling is appropriate for reduce operations that don&#39;t need to look at all the values for each key to produce a good result, such as generic summarization tasks.</span>

<span class="s2">        Based on the reduce operation prompt and the sample input data, determine if value sampling should be enabled.</span>
<span class="s2">        Answer with &#39;yes&#39; if value sampling should be enabled or &#39;no&#39; if it should not be enabled. Explain your reasoning briefly.</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;enable_sampling&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">},</span>
                <span class="s2">&quot;explanation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
            <span class="p">},</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;enable_sampling&quot;</span><span class="p">,</span> <span class="s2">&quot;explanation&quot;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
            <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
            <span class="n">system_prompt</span><span class="p">,</span>
            <span class="n">parameters</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;enable_sampling&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

        <span class="c1"># Print the explanation for enabling value sampling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value sampling enabled: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;explanation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Determine sampling method</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        We are optimizing a reduce operation in a data processing pipeline. The reduce operation is defined by the following prompt:</span>

<span class="s2">        Reduce Operation Prompt:</span>
<span class="s2">        </span><span class="si">{</span><span class="n">op_config</span><span class="p">[</span><span class="s1">&#39;prompt&#39;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">        Sample Input Data (first 2 items):</span>
<span class="s2">        </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sample_input</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">        We have determined that value sampling should be enabled for this reduce operation. Value sampling is a technique used to process only a subset of the input data for each reduce key, rather than processing all items. This can significantly reduce processing time and costs for very large datasets, especially when the reduce operation doesn&#39;t require looking at every single item to produce a good result (e.g., summarization tasks).</span>

<span class="s2">        Now we need to choose the most appropriate sampling method. The available methods are:</span>

<span class="s2">        1. &quot;random&quot;: Randomly select a subset of values.</span>
<span class="s2">        Example: In a customer review analysis task, randomly selecting a subset of reviews to summarize the overall sentiment.</span>

<span class="s2">        2. &quot;cluster&quot;: Use K-means clustering to select representative samples.</span>
<span class="s2">        Example: In a document categorization task, clustering documents based on their content and selecting representative documents from each cluster to determine the overall categories.</span>

<span class="s2">        3. &quot;sem_sim&quot;: Use semantic similarity to select the most relevant samples to a query text.</span>
<span class="s2">        Example: In a news article summarization task, selecting articles that are semantically similar to a query like &quot;Major economic events of </span><span class="se">{{</span><span class="s2">reduce_key</span><span class="se">}}</span><span class="s2">&quot; to produce a focused summary.</span>

<span class="s2">        Based on the reduce operation prompt, the nature of the task, and the sample input data, which sampling method would be most appropriate?</span>

<span class="s2">        Provide your answer as either &quot;random&quot;, &quot;cluster&quot;, or &quot;sem_sim&quot;, and explain your reasoning in detail. Consider the following in your explanation:</span>
<span class="s2">        - The nature of the reduce task (e.g., summarization, aggregation, analysis)</span>
<span class="s2">        - The structure and content of the input data</span>
<span class="s2">        - The potential benefits and drawbacks of each sampling method for this specific task</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="s2">&quot;cluster&quot;</span><span class="p">,</span> <span class="s2">&quot;sem_sim&quot;</span><span class="p">]},</span>
                <span class="s2">&quot;explanation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
            <span class="p">},</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;explanation&quot;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
            <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
            <span class="n">system_prompt</span><span class="p">,</span>
            <span class="n">parameters</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span>

        <span class="n">value_sampling_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span>
            <span class="s2">&quot;sample_size&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>  <span class="c1"># Default sample size</span>
            <span class="s2">&quot;embedding_model&quot;</span><span class="p">:</span> <span class="s2">&quot;text-embedding-3-small&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span> <span class="s2">&quot;sem_sim&quot;</span><span class="p">]:</span>
            <span class="c1"># Determine embedding keys</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            For the </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> sampling method, we need to determine which keys from the input data should be used for generating embeddings.</span>

<span class="s2">            Input data keys:</span>
<span class="s2">            </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sample_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span>

<span class="s2">            Sample Input Data:</span>
<span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sample_input</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)[:</span><span class="mi">1000</span><span class="p">]</span><span class="si">}</span><span class="s2">...</span>

<span class="s2">            Based on the reduce operation prompt and the sample input data, which keys should be used for generating embeddings? Use keys that will create meaningful embeddings (i.e., not id-related keys).</span>
<span class="s2">            Provide your answer as a list of key names that is a subset of the input data keys. You should pick only the 1-3 keys that are necessary for generating meaningful embeddings, that have relatively short values.</span>
<span class="s2">            &quot;&quot;&quot;</span>

            <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;embedding_keys&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}},</span>
                    <span class="s2">&quot;explanation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                <span class="p">},</span>
                <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;embedding_keys&quot;</span><span class="p">,</span> <span class="s2">&quot;explanation&quot;</span><span class="p">],</span>
            <span class="p">}</span>

            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
                <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
                <span class="n">system_prompt</span><span class="p">,</span>
                <span class="n">parameters</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="c1"># TODO: validate that these exist</span>
            <span class="n">embedding_keys</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;embedding_keys&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;embedding_keys&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sample_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">embedding_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">embedding_keys</span><span class="p">:</span>
                <span class="c1"># Select the reduce key</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s2">&quot;No embedding keys found, selecting reduce key for embedding key&quot;</span>
                <span class="p">)</span>
                <span class="n">embedding_keys</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
                    <span class="k">else</span> <span class="p">[</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]]</span>
                <span class="p">)</span>

            <span class="n">value_sampling_config</span><span class="p">[</span><span class="s2">&quot;embedding_keys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">embedding_keys</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;sem_sim&quot;</span><span class="p">:</span>
            <span class="c1"># Determine query text</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            For the semantic similarity (sem_sim) sampling method, we need to determine the query text to compare against when selecting samples.</span>

<span class="s2">            Reduce Operation Prompt:</span>
<span class="s2">            </span><span class="si">{</span><span class="n">op_config</span><span class="p">[</span><span class="s1">&#39;prompt&#39;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">            The query text should be a Jinja template with access to the `reduce_key` variable.</span>
<span class="s2">            Based on the reduce operation prompt, what would be an appropriate query text for selecting relevant samples?</span>
<span class="s2">            &quot;&quot;&quot;</span>

            <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;query_text&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;explanation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                <span class="p">},</span>
                <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;query_text&quot;</span><span class="p">,</span> <span class="s2">&quot;explanation&quot;</span><span class="p">],</span>
            <span class="p">}</span>

            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
                <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
                <span class="n">system_prompt</span><span class="p">,</span>
                <span class="n">parameters</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="n">value_sampling_config</span><span class="p">[</span><span class="s2">&quot;query_text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;query_text&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">value_sampling_config</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_associative</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if the reduce operation is associative.</span>

<span class="sd">        This method analyzes the reduce operation configuration and a sample of the input data</span>
<span class="sd">        to determine if the operation is associative (i.e., the order of combining elements</span>
<span class="sd">        doesn&#39;t affect the final result).</span>

<span class="sd">        Args:</span>
<span class="sd">            op_config (dict[str, Any]): Configuration for the reduce operation.</span>
<span class="sd">            input_data (list[dict[str, Any]]): Input data for the reduce operation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the operation is determined to be associative, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">system_prompt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;You are an AI assistant helping to optimize data processing pipelines.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Sample a subset of input data for analysis</span>
        <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))</span>
        <span class="n">sample_input</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">)</span>

        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Analyze the following reduce operation and determine if it is associative:</span>

<span class="s2">        Reduce Operation Prompt:</span>
<span class="s2">        </span><span class="si">{</span><span class="n">op_config</span><span class="p">[</span><span class="s1">&#39;prompt&#39;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">        Sample Input Data:</span>
<span class="s2">        </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sample_input</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)[:</span><span class="mi">1000</span><span class="p">]</span><span class="si">}</span><span class="s2">...</span>

<span class="s2">        Based on the reduce operation prompt, determine whether the order in which we process data matters.</span>
<span class="s2">        Answer with &#39;yes&#39; if order matters or &#39;no&#39; if order doesn&#39;t matter.</span>
<span class="s2">        Explain your reasoning briefly.</span>

<span class="s2">        For example:</span>
<span class="s2">        - Merging extracted key-value pairs from documents does not require order: combining </span><span class="se">{{</span><span class="s2">&quot;name&quot;: &quot;John&quot;, &quot;age&quot;: 30</span><span class="se">}}</span><span class="s2"> with </span><span class="se">{{</span><span class="s2">&quot;city&quot;: &quot;New York&quot;, &quot;job&quot;: &quot;Engineer&quot;</span><span class="se">}}</span><span class="s2"> yields the same result regardless of order</span>
<span class="s2">        - Generating a timeline of events requires order: the order of events matters for maintaining chronological accuracy.</span>

<span class="s2">        Consider these examples when determining whether the order in which we process data matters. You might also have to consider the specific data.</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;order_matters&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">},</span>
                <span class="s2">&quot;explanation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
            <span class="p">},</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;order_matters&quot;</span><span class="p">,</span> <span class="s2">&quot;explanation&quot;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
            <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
            <span class="n">system_prompt</span><span class="p">,</span>
            <span class="n">parameters</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;is_associative&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;order_matters&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[yellow]Reduce operation </span><span class="si">{</span><span class="s1">&#39;is associative&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;is_associative&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;is not associative&#39;</span><span class="si">}</span><span class="s2">.[/yellow] Analysis: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;explanation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;is_associative&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_validator_prompt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">original_output</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a custom validator prompt for assessing the quality of the reduce operation output.</span>

<span class="sd">        This method creates a prompt that will be used to validate the output of the reduce operation.</span>
<span class="sd">        It includes specific questions about the quality and completeness of the output.</span>

<span class="sd">        Args:</span>
<span class="sd">            op_config (dict[str, Any]): Configuration for the reduce operation.</span>
<span class="sd">            input_data (list[dict[str, Any]]): Input data for the reduce operation.</span>
<span class="sd">            original_output (list[dict[str, Any]]): Original output of the reduce operation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A custom validator prompt as a string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">system_prompt</span> <span class="o">=</span> <span class="s2">&quot;You are an AI assistant tasked with creating custom validation prompts for reduce operations in data processing pipelines.&quot;</span>

        <span class="n">sample_input</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="n">input_keys</span> <span class="o">=</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">input_keys</span><span class="p">:</span>
            <span class="n">sample_input</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">sample_input</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_keys</span><span class="p">}</span>

        <span class="n">reduce_key</span> <span class="o">=</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reduce_key</span> <span class="ow">and</span> <span class="n">original_output</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reduce_key</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="nb">tuple</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">reduce_key</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">original_output</span>
                        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">reduce_key</span><span class="p">)</span>
                    <span class="p">),</span>
                    <span class="nb">tuple</span><span class="p">(</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">reduce_key</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">sample_output</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">item</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">original_output</span>
                        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">reduce_key</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                    <span class="p">),</span>
                    <span class="p">{},</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">item</span><span class="p">[</span><span class="n">reduce_key</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">original_output</span>
                        <span class="k">if</span> <span class="n">reduce_key</span> <span class="ow">in</span> <span class="n">item</span>
                    <span class="p">),</span>
                    <span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">sample_output</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">original_output</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reduce_key</span><span class="p">)</span> <span class="o">==</span> <span class="n">key</span><span class="p">),</span>
                    <span class="p">{},</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sample_output</span> <span class="o">=</span> <span class="n">original_output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">original_output</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="n">output_keys</span> <span class="o">=</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">sample_output</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">sample_output</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">output_keys</span><span class="p">}</span>

        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Analyze the following reduce operation and its input/output:</span>

<span class="s2">        Reduce Operation Prompt:</span>
<span class="s2">        </span><span class="si">{</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">        Sample Input (just one item):</span>
<span class="s2">        </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sample_input</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">        Sample Output:</span>
<span class="s2">        </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sample_output</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">        Create a custom validator prompt that will assess how well the reduce operation performed its intended task. The prompt should ask specific 2-3 questions about the quality of the output, such as:</span>
<span class="s2">        1. Does the output accurately reflect the aggregation method specified in the task? For example, if finding anomalies, are the identified anomalies actually anomalies?</span>
<span class="s2">        2. Are there any missing fields, unexpected null values, or data type mismatches in the output compared to the expected schema?</span>
<span class="s2">        3. Does the output maintain the key information from the input while appropriately condensing or summarizing it? For instance, in a text summarization task, are the main points preserved?</span>
<span class="s2">        4. How well does the output adhere to any specific formatting requirements mentioned in the original prompt, such as character limits for summaries or specific data types for aggregated values?</span>

<span class="s2">        Note that the output may reflect more than just the input provided, since we only provide a one-item sample input. Provide your response as a single string containing the custom validator prompt. The prompt should be tailored to the task and avoid generic criteria. The prompt should not reference a specific value in the sample input, but rather a general property.</span>

<span class="s2">        Your prompt should not have any placeholders like </span><span class="se">{{</span><span class="s2"> reduce_key </span><span class="se">}}</span><span class="s2"> or </span><span class="se">{{</span><span class="s2"> input_key </span><span class="se">}}</span><span class="s2">. It should just be a string.</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;validator_prompt&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}},</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;validator_prompt&quot;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
            <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
            <span class="n">system_prompt</span><span class="p">,</span>
            <span class="n">parameters</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)[</span><span class="s2">&quot;validator_prompt&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_reduce_output</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">validation_inputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
        <span class="n">output_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">validator_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the output of the reduce operation using the generated validator prompt.</span>

<span class="sd">        This method assesses the quality of the reduce operation output by applying the validator prompt</span>
<span class="sd">        to multiple samples of the input and output data.</span>

<span class="sd">        Args:</span>
<span class="sd">            op_config (dict[str, Any]): Configuration for the reduce operation.</span>
<span class="sd">            validation_inputs (dict[Any, list[dict[str, Any]]]): Validation inputs for the reduce operation.</span>
<span class="sd">            output_data (list[dict[str, Any]]): Output data from the reduce operation.</span>
<span class="sd">            validator_prompt (str): The validator prompt generated earlier.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, Any]: A dictionary containing validation results and a flag indicating if improvement is needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">system_prompt</span> <span class="o">=</span> <span class="s2">&quot;You are an AI assistant tasked with validating the output of reduce operations in data processing pipelines.&quot;</span>

        <span class="n">validation_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">reduce_key</span><span class="p">,</span> <span class="n">inputs</span> <span class="ow">in</span> <span class="n">validation_inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;_all&quot;</span><span class="p">]</span>
                    <span class="ow">or</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_all&quot;</span>
                <span class="p">):</span>
                    <span class="n">sample_output</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">sample_output</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">item</span>
                            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_data</span>
                            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
                                <span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">reduce_key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">])</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                        <span class="kc">None</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sample_output</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">item</span>
                            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_data</span>
                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">reduce_key</span>
                        <span class="p">),</span>
                        <span class="kc">None</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">sample_output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Warning: No output found for reduce key </span><span class="si">{</span><span class="n">reduce_key</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">input_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="c1"># truncate input_str to 40,000 words</span>
                <span class="n">input_str</span> <span class="o">=</span> <span class="n">input_str</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">40000</span><span class="p">]</span>
                <span class="n">input_str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>

                <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="si">{</span><span class="n">validator_prompt</span><span class="si">}</span>

<span class="s2">                Reduce Operation Task:</span>
<span class="s2">                </span><span class="si">{</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">                Input Data Samples:</span>
<span class="s2">                </span><span class="si">{</span><span class="n">input_str</span><span class="si">}</span>

<span class="s2">                Output Data Sample:</span>
<span class="s2">                </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sample_output</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">                Based on the validator prompt and the input/output samples, assess the quality (e.g., correctness, completeness) of the reduce operation output.</span>
<span class="s2">                Provide your assessment in the following format:</span>
<span class="s2">                &quot;&quot;&quot;</span>

                <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;is_correct&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">},</span>
                        <span class="s2">&quot;issues&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}},</span>
                        <span class="s2">&quot;suggestions&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}},</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;is_correct&quot;</span><span class="p">,</span> <span class="s2">&quot;issues&quot;</span><span class="p">,</span> <span class="s2">&quot;suggestions&quot;</span><span class="p">],</span>
                <span class="p">}</span>

                <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_judge</span><span class="p">,</span>
                        <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
                        <span class="n">system_prompt</span><span class="p">,</span>
                        <span class="n">parameters</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">for</span> <span class="n">future</span><span class="p">,</span> <span class="p">(</span><span class="n">reduce_key</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">futures</span><span class="p">,</span> <span class="n">validation_inputs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="n">validation_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="c1"># Determine if optimization is needed based on validation results</span>
        <span class="n">invalid_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="mi">1</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">validation_results</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;is_correct&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">needs_improvement</span> <span class="o">=</span> <span class="n">invalid_count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">invalid_count</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">validation_results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;needs_improvement&quot;</span><span class="p">:</span> <span class="n">needs_improvement</span><span class="p">,</span>
            <span class="s2">&quot;validation_results&quot;</span><span class="p">:</span> <span class="n">validation_results</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_validation_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">reduce_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="c1"># Group input data by reduce_key</span>
        <span class="n">grouped_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">reduce_key</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;_all&quot;</span><span class="p">]:</span>
            <span class="c1"># Put all data in one group under a single key</span>
            <span class="n">grouped_data</span><span class="p">[(</span><span class="s2">&quot;_all&quot;</span><span class="p">,)]</span> <span class="o">=</span> <span class="n">input_data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Group by reduce key(s) as before</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reduce_key</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">reduce_key</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">reduce_key</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grouped_data</span><span class="p">:</span>
                    <span class="n">grouped_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">grouped_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="c1"># Select a fixed number of reduce keys</span>
        <span class="n">selected_keys</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">grouped_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples_in_validation</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">grouped_data</span><span class="p">)),</span>
        <span class="p">)</span>

        <span class="c1"># Create a new dict with only the selected keys</span>
        <span class="n">validation_inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">grouped_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">selected_keys</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">validation_inputs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_reduce_plans</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">is_associative</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create multiple reduce plans based on the input data and operation configuration.</span>

<span class="sd">        This method generates various reduce plans by varying batch sizes and fold prompts.</span>
<span class="sd">        It takes into account the LLM&#39;s context window size to determine appropriate batch sizes.</span>

<span class="sd">        Args:</span>
<span class="sd">            op_config (dict[str, Any]): Configuration for the reduce operation.</span>
<span class="sd">            input_data (list[dict[str, Any]]): Input data for the reduce operation.</span>
<span class="sd">            is_associative (bool): Flag indicating whether the reduce operation is associative.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[dict[str, Any]]: A list of reduce plans, each with different batch sizes and fold prompts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">)</span>
        <span class="n">model_input_context_length</span> <span class="o">=</span> <span class="n">model_cost</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;max_input_tokens&quot;</span><span class="p">,</span> <span class="mi">8192</span>
        <span class="p">)</span>

        <span class="c1"># Estimate tokens for prompt, input, and output</span>
        <span class="n">prompt_tokens</span> <span class="o">=</span> <span class="n">count_tokens</span><span class="p">(</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">],</span> <span class="n">model</span><span class="p">)</span>
        <span class="n">sample_input</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span>
        <span class="n">sample_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_operation</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">[:</span><span class="mi">100</span><span class="p">])</span>

        <span class="n">prompt_vars</span> <span class="o">=</span> <span class="n">extract_jinja_variables</span><span class="p">(</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">])</span>
        <span class="n">prompt_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">prompt_vars</span><span class="p">]</span>
        <span class="n">avg_input_tokens</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">count_tokens</span><span class="p">(</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">prompt_vars</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">item</span><span class="p">}),</span> <span class="n">model</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sample_input</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">avg_output_tokens</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">count_tokens</span><span class="p">(</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">prompt_vars</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">item</span><span class="p">}),</span> <span class="n">model</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sample_output</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Calculate max batch size that fits in context window</span>
        <span class="n">max_batch_size</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">model_input_context_length</span> <span class="o">-</span> <span class="n">prompt_tokens</span> <span class="o">-</span> <span class="n">avg_output_tokens</span>
        <span class="p">)</span> <span class="o">//</span> <span class="n">avg_input_tokens</span>

        <span class="c1"># Generate 6 candidate batch sizes</span>
        <span class="n">batch_sizes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_batch_size</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="c1"># Log the generated batch sizes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[cyan]Generating plans for batch sizes:[/cyan]&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">batch_sizes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">batch_sizes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">batch_sizes</span><span class="p">))</span>  <span class="c1"># Remove duplicates and sort</span>

        <span class="n">plans</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Generate multiple fold prompts</span>
        <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fold_prompts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">while</span> <span class="n">retry_count</span> <span class="o">&lt;</span> <span class="n">max_retries</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fold_prompts</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fold_prompts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synthesize_fold_prompts</span><span class="p">(</span>
                    <span class="n">op_config</span><span class="p">,</span>
                    <span class="n">sample_input</span><span class="p">,</span>
                    <span class="n">sample_output</span><span class="p">,</span>
                    <span class="n">num_prompts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_fold_prompts</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">fold_prompts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fold_prompts</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fold_prompts</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No fold prompts generated&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">retry_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">retry_count</span> <span class="o">==</span> <span class="n">max_retries</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to generate fold prompts after </span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> attempts: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Retry </span><span class="si">{</span><span class="n">retry_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">: Failed to generate fold prompts. Retrying...&quot;</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">batch_size</span> <span class="ow">in</span> <span class="n">batch_sizes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fold_idx</span><span class="p">,</span> <span class="n">fold_prompt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fold_prompts</span><span class="p">):</span>
                <span class="n">plan</span> <span class="o">=</span> <span class="n">op_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;fold_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fold_prompt</span>
                <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;fold_batch_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_size</span>
                <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;associative&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_associative</span>
                <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">op_config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_bs_</span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">_fp_</span><span class="si">{</span><span class="n">fold_idx</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">plans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">plans</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_compression_ratio</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">sample_input</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">sample_output</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the compression ratio of the reduce operation.</span>

<span class="sd">        This method compares the size of the input data to the size of the output data</span>
<span class="sd">        to determine how much the data is being compressed by the reduce operation.</span>

<span class="sd">        Args:</span>
<span class="sd">            op_config (dict[str, Any]): Configuration for the reduce operation.</span>
<span class="sd">            sample_input (list[dict[str, Any]]): Sample input data.</span>
<span class="sd">            sample_output (list[dict[str, Any]]): Sample output data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The calculated compression ratio.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reduce_key</span> <span class="o">=</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span>
        <span class="n">input_schema</span> <span class="o">=</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">output_schema</span> <span class="o">=</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">)</span>

        <span class="n">compression_ratios</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Handle both single key and list of keys</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reduce_key</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">distinct_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">reduce_key</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sample_input</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">distinct_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">reduce_key</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sample_input</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">distinct_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reduce_key</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">key_input</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">item</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sample_input</span>
                    <span class="k">if</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">reduce_key</span><span class="p">)</span> <span class="o">==</span> <span class="n">key</span>
                <span class="p">]</span>
                <span class="n">key_output</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">item</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sample_output</span>
                    <span class="k">if</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">reduce_key</span><span class="p">)</span> <span class="o">==</span> <span class="n">key</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key_input</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sample_input</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="n">reduce_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">key_output</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sample_output</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="n">reduce_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">input_schema</span><span class="p">:</span>
                <span class="n">key_input_tokens</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                    <span class="n">count_tokens</span><span class="p">(</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_schema</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">item</span><span class="p">}),</span>
                        <span class="n">model</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">key_input</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key_input_tokens</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                    <span class="n">count_tokens</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="n">model</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">key_input</span>
                <span class="p">)</span>

            <span class="n">key_output_tokens</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="n">count_tokens</span><span class="p">(</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">output_schema</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">item</span><span class="p">}),</span> <span class="n">model</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">key_output</span>
            <span class="p">)</span>

            <span class="n">compression_ratios</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">key_output_tokens</span> <span class="o">/</span> <span class="n">key_input_tokens</span> <span class="k">if</span> <span class="n">key_input_tokens</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">compression_ratios</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="c1"># Calculate importance weights based on the number of items for each key</span>
        <span class="n">total_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_input</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reduce_key</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">importance_weights</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">item</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sample_input</span>
                        <span class="k">if</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">reduce_key</span><span class="p">)</span> <span class="o">==</span> <span class="n">key</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="n">total_items</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">compression_ratios</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">importance_weights</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sample_input</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="n">reduce_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">total_items</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">compression_ratios</span>
            <span class="p">}</span>

        <span class="c1"># Calculate weighted average of compression ratios</span>
        <span class="n">weighted_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">compression_ratios</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">*</span> <span class="n">importance_weights</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">compression_ratios</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">weighted_sum</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_synthesize_fold_prompts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">sample_input</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">sample_output</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">num_prompts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Synthesize fold prompts for the reduce operation. We generate multiple</span>
<span class="sd">        fold prompts in case one is bad.</span>

<span class="sd">        A fold operation is a higher-order function that iterates through a data structure,</span>
<span class="sd">        accumulating the results of applying a given combining operation to its elements.</span>
<span class="sd">        In the context of reduce operations, folding allows processing of data in batches,</span>
<span class="sd">        which can significantly improve performance for large datasets.</span>

<span class="sd">        This method generates multiple fold prompts that can be used to optimize the reduce operation</span>
<span class="sd">        by allowing it to run on batches of inputs. It uses the language model to create prompts</span>
<span class="sd">        that are variations of the original reduce prompt, adapted for folding operations.</span>

<span class="sd">        Args:</span>
<span class="sd">            op_config (dict[str, Any]): The configuration of the reduce operation.</span>
<span class="sd">            sample_input (list[dict[str, Any]]): A sample of the input data.</span>
<span class="sd">            sample_output (list[dict[str, Any]]): A sample of the output data.</span>
<span class="sd">            num_prompts (int, optional): The number of fold prompts to generate. Defaults to 2.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[str]: A list of synthesized fold prompts.</span>

<span class="sd">        The method performs the following steps:</span>
<span class="sd">        1. Sets up the system prompt and parameters for the language model.</span>
<span class="sd">        2. Defines a function to get random examples from the sample data.</span>
<span class="sd">        3. Creates a prompt template for generating fold prompts.</span>
<span class="sd">        4. Uses multi-threading to generate multiple fold prompts in parallel.</span>
<span class="sd">        5. Returns the list of generated fold prompts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">system_prompt</span> <span class="o">=</span> <span class="s2">&quot;You are an AI assistant tasked with creating a fold prompt for reduce operations in data processing pipelines.&quot;</span>
        <span class="n">original_prompt</span> <span class="o">=</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span>

        <span class="n">input_schema</span> <span class="o">=</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">output_schema</span> <span class="o">=</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_random_examples</span><span class="p">():</span>
            <span class="n">reduce_key</span> <span class="o">=</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span>
            <span class="n">reduce_key</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">reduce_key</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reduce_key</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">reduce_key</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">reduce_key</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;_all&quot;</span><span class="p">]:</span>
                <span class="c1"># For _all case, just pick random input and output examples</span>
                <span class="n">input_example</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">sample_input</span><span class="p">)</span>
                <span class="n">output_example</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">sample_output</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reduce_key</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">random_key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="nb">tuple</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">reduce_key</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">item</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sample_input</span>
                            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">reduce_key</span><span class="p">)</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">input_example</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">item</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sample_input</span>
                        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">reduce_key</span><span class="p">,</span> <span class="n">random_key</span><span class="p">))</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="n">output_example</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">item</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sample_output</span>
                        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">reduce_key</span><span class="p">,</span> <span class="n">random_key</span><span class="p">))</span>
                    <span class="p">]</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">input_schema</span><span class="p">:</span>
                <span class="n">input_example</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">input_example</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_schema</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_example</span>
                <span class="p">}</span>
            <span class="n">output_example</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">output_example</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">output_schema</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">output_example</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">input_example</span><span class="p">,</span> <span class="n">output_example</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;fold_prompt&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;fold_prompt&quot;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">generate_single_prompt</span><span class="p">():</span>
            <span class="n">input_example</span><span class="p">,</span> <span class="n">output_example</span> <span class="o">=</span> <span class="n">get_random_examples</span><span class="p">()</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            Original Reduce Operation Prompt:</span>
<span class="s2">            </span><span class="si">{</span><span class="n">original_prompt</span><span class="si">}</span>

<span class="s2">            Sample Input:</span>
<span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">input_example</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">            Sample Output:</span>
<span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output_example</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">            Create a fold prompt for the reduce operation to run on batches of inputs. The fold prompt should:</span>
<span class="s2">            1. Minimally modify the original reduce prompt</span>
<span class="s2">            2. Describe how to combine the new values with the current reduced value</span>
<span class="s2">            3. Be designed to work iteratively, allowing for multiple fold operations. The first iteration will use the original prompt, and all successive iterations will use the fold prompt.</span>

<span class="s2">            The fold prompt should be a Jinja2 template with the following variables available:</span>
<span class="s2">            - </span><span class="se">{{{{</span><span class="s2"> output </span><span class="se">}}}}</span><span class="s2">: The current reduced value (a dictionary with the current output schema)</span>
<span class="s2">            - </span><span class="se">{{{{</span><span class="s2"> inputs </span><span class="se">}}}}</span><span class="s2">: A list of new values to be folded in</span>
<span class="s2">            - </span><span class="se">{{{{</span><span class="s2"> reduce_key </span><span class="se">}}}}</span><span class="s2">: The key used for grouping in the reduce operation</span>

<span class="s2">            Provide the fold prompt as a string.</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
                <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
                <span class="n">system_prompt</span><span class="p">,</span>
                <span class="n">parameters</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">fold_prompt</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)[</span><span class="s2">&quot;fold_prompt&quot;</span><span class="p">]</span>

            <span class="c1"># Run the operation with the fold prompt</span>
            <span class="c1"># Create a temporary plan with the fold prompt</span>
            <span class="n">temp_plan</span> <span class="o">=</span> <span class="n">op_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">temp_plan</span><span class="p">[</span><span class="s2">&quot;fold_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fold_prompt</span>
            <span class="n">temp_plan</span><span class="p">[</span><span class="s2">&quot;fold_batch_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">sample_input</span><span class="p">),</span> <span class="mi">2</span>
            <span class="p">)</span>  <span class="c1"># Use a small batch size for testing</span>

            <span class="c1"># Run the operation with the fold prompt</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_operation</span><span class="p">(</span>
                    <span class="n">temp_plan</span><span class="p">,</span> <span class="n">sample_input</span><span class="p">[:</span> <span class="n">temp_plan</span><span class="p">[</span><span class="s2">&quot;fold_batch_size&quot;</span><span class="p">]]</span>
                <span class="p">)</span>

                <span class="k">return</span> <span class="n">fold_prompt</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[red]Error in agent-generated fold prompt: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span>
                <span class="p">)</span>

                <span class="c1"># Create a default fold prompt that instructs folding new data into existing output</span>
                <span class="n">fold_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Analyze this batch of data using the following instructions:</span>

<span class="si">{</span><span class="n">original_prompt</span><span class="si">}</span>

<span class="s2">However, instead of starting fresh, fold your analysis into the existing output that has already been generated. The existing output is provided in the &#39;output&#39; variable below:</span>

<span class="se">{{{{</span><span class="s2"> output </span><span class="se">}}}}</span>

<span class="s2">Remember, you must fold the new data into the existing output, do not start fresh.&quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="n">fold_prompt</span>

        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">fold_prompts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">generate_single_prompt</span><span class="p">(),</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_prompts</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">fold_prompts</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_evaluate_reduce_plans</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">plans</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">validator_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate multiple reduce plans and select the best one.</span>

<span class="sd">        This method takes a list of reduce plans, evaluates each one using the input data</span>
<span class="sd">        and a validator prompt, and selects the best plan based on the evaluation scores.</span>
<span class="sd">        It also attempts to create and evaluate a merged plan that enhances the runtime performance</span>
<span class="sd">        of the best plan.</span>

<span class="sd">        A merged plan is an optimization technique applied to the best-performing plan</span>
<span class="sd">        that uses the fold operation. It allows the best plan to run even faster by</span>
<span class="sd">        executing parallel folds and then merging the results of these individual folds</span>
<span class="sd">        together. We default to a merge batch size of 2, but one can increase this.</span>

<span class="sd">        Args:</span>
<span class="sd">            op_config (dict[str, Any]): The configuration of the reduce operation.</span>
<span class="sd">            plans (list[dict[str, Any]]): A list of reduce plans to evaluate.</span>
<span class="sd">            input_data (list[dict[str, Any]]): The input data to use for evaluation.</span>
<span class="sd">            validator_prompt (str): The prompt to use for validating the output of each plan.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, Any]: The best reduce plan, either the top-performing original plan</span>
<span class="sd">                            or a merged plan if it performs well enough.</span>

<span class="sd">        The method performs the following steps:</span>
<span class="sd">        1. Evaluates each plan using multi-threading.</span>
<span class="sd">        2. Sorts the plans based on their evaluation scores.</span>
<span class="sd">        3. Selects the best plan and attempts to create a merged plan.</span>
<span class="sd">        4. Evaluates the merged plan and compares it to the best original plan.</span>
<span class="sd">        5. Returns either the merged plan or the best original plan based on their scores.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold]Evaluating Reduce Plans:[/bold]&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">plan</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plans</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plan </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> (batch size: </span><span class="si">{</span><span class="n">plan</span><span class="p">[</span><span class="s1">&#39;fold_batch_size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">plan_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">plan_outputs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Create a fixed random sample for evaluation</span>
        <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))</span>
        <span class="n">evaluation_sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">)</span>

        <span class="c1"># Create a fixed set of validation samples</span>
        <span class="n">validation_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_validation_inputs</span><span class="p">(</span>
            <span class="n">evaluation_sample</span><span class="p">,</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_single_plan</span><span class="p">,</span>
                    <span class="n">plan</span><span class="p">,</span>
                    <span class="n">evaluation_sample</span><span class="p">,</span>
                    <span class="n">validator_prompt</span><span class="p">,</span>
                    <span class="n">validation_inputs</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">plan</span> <span class="ow">in</span> <span class="n">plans</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
                <span class="n">plan</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="n">plan_scores</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">plan</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>
                <span class="n">plan_outputs</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">plan</span><span class="p">)]</span> <span class="o">=</span> <span class="n">output</span>

        <span class="c1"># Sort plans by score in descending order, then by fold_batch_size in descending order</span>
        <span class="n">sorted_plans</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">plan_scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;fold_batch_size&quot;</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold]Reduce Plan Scores:[/bold]&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_plans</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Plan </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> (batch size: </span><span class="si">{</span><span class="n">plan</span><span class="p">[</span><span class="s1">&#39;fold_batch_size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">best_plan</span><span class="p">,</span> <span class="n">best_score</span> <span class="o">=</span> <span class="n">sorted_plans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[green]Selected best plan with score: </span><span class="si">{</span><span class="n">best_score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> and batch size: </span><span class="si">{</span><span class="n">best_plan</span><span class="p">[</span><span class="s1">&#39;fold_batch_size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">[/green]&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;synthesize_merge&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="c1"># Create a new plan with merge prompt and updated parameters</span>
            <span class="n">merged_plan</span> <span class="o">=</span> <span class="n">best_plan</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Synthesize merge prompt if it doesn&#39;t exist</span>
            <span class="k">if</span> <span class="s2">&quot;merge_prompt&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged_plan</span><span class="p">:</span>
                <span class="n">merged_plan</span><span class="p">[</span><span class="s2">&quot;merge_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synthesize_merge_prompt</span><span class="p">(</span>
                    <span class="n">merged_plan</span><span class="p">,</span> <span class="n">plan_outputs</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">best_plan</span><span class="p">)]</span>
                <span class="p">)</span>
                <span class="c1"># Print the synthesized merge prompt</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold]Synthesized Merge Prompt:[/bold]&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">merged_plan</span><span class="p">[</span><span class="s2">&quot;merge_prompt&quot;</span><span class="p">])</span>

            <span class="c1"># Set merge_batch_size to 2 and num_parallel_folds to 5</span>
            <span class="n">merged_plan</span><span class="p">[</span><span class="s2">&quot;merge_batch_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

            <span class="c1"># Evaluate the merged plan</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">merged_plan_score</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">operation_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_single_plan</span><span class="p">(</span>
                <span class="n">merged_plan</span><span class="p">,</span>
                <span class="n">evaluation_sample</span><span class="p">,</span>
                <span class="n">validator_prompt</span><span class="p">,</span>
                <span class="n">validation_inputs</span><span class="p">,</span>
                <span class="n">return_instance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Get the merge and fold times from the operation instance</span>
            <span class="n">merge_times</span> <span class="o">=</span> <span class="n">operation_instance</span><span class="o">.</span><span class="n">merge_times</span>
            <span class="n">fold_times</span> <span class="o">=</span> <span class="n">operation_instance</span><span class="o">.</span><span class="n">fold_times</span>
            <span class="n">merge_avg_time</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">merge_times</span><span class="p">)</span> <span class="k">if</span> <span class="n">merge_times</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">fold_avg_time</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">fold_times</span><span class="p">)</span> <span class="k">if</span> <span class="n">fold_times</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold]Scores:[/bold]&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original plan: </span><span class="si">{</span><span class="n">best_score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Merged plan: </span><span class="si">{</span><span class="n">merged_plan_score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Compare scores and decide which plan to use</span>
            <span class="k">if</span> <span class="n">merged_plan_score</span> <span class="o">&gt;=</span> <span class="n">best_score</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[green]Using merged plan with score: </span><span class="si">{</span><span class="n">merged_plan_score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">[/green]&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">merge_avg_time</span> <span class="ow">and</span> <span class="n">fold_avg_time</span><span class="p">:</span>
                    <span class="n">merged_plan</span><span class="p">[</span><span class="s2">&quot;merge_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merge_avg_time</span>
                    <span class="n">merged_plan</span><span class="p">[</span><span class="s2">&quot;fold_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fold_avg_time</span>
                <span class="k">return</span> <span class="n">merged_plan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[yellow]Merged plan quality too low. Using original plan with score: </span><span class="si">{</span><span class="n">best_score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">[/yellow]&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">best_plan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">best_plan</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_evaluate_single_plan</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">plan</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">validator_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">validation_inputs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">return_instance</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span>
        <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span>
        <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">BaseOperation</span><span class="p">]</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate a single reduce plan using the provided input data and validator prompt.</span>

<span class="sd">        This method runs the reduce operation with the given plan, validates the output,</span>
<span class="sd">        and calculates a score based on the validation results. The scoring works as follows:</span>
<span class="sd">        1. It counts the number of valid results from the validation.</span>
<span class="sd">        2. The score is calculated as the ratio of valid results to the total number of validation results.</span>
<span class="sd">        3. This produces a score between 0 and 1, where 1 indicates all results were valid, and 0 indicates none were valid.</span>

<span class="sd">        TODO: We should come up with a better scoring method here, maybe pairwise comparisons.</span>

<span class="sd">        Args:</span>
<span class="sd">            plan (dict[str, Any]): The reduce plan to evaluate.</span>
<span class="sd">            input_data (list[dict[str, Any]]): The input data to use for evaluation.</span>
<span class="sd">            validator_prompt (str): The prompt to use for validating the output.</span>
<span class="sd">            return_instance (bool, optional): Whether to return the operation instance. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[</span>
<span class="sd">                tuple[dict[str, Any], float, list[dict[str, Any]]],</span>
<span class="sd">                tuple[dict[str, Any], float, list[dict[str, Any]], BaseOperation],</span>
<span class="sd">            ]: A tuple containing the plan, its score, the output data, and optionally the operation instance.</span>

<span class="sd">        The method performs the following steps:</span>
<span class="sd">        1. Runs the reduce operation with the given plan on the input data.</span>
<span class="sd">        2. Validates the output using the validator prompt.</span>
<span class="sd">        3. Calculates a score based on the validation results.</span>
<span class="sd">        4. Returns the plan, score, output data, and optionally the operation instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_operation</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">return_instance</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_instance</span><span class="p">:</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">operation_instance</span> <span class="o">=</span> <span class="n">output</span>

        <span class="n">validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_reduce_output</span><span class="p">(</span>
            <span class="n">plan</span><span class="p">,</span> <span class="n">validation_inputs</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">validator_prompt</span>
        <span class="p">)</span>

        <span class="c1"># Calculate a score based on validation results</span>
        <span class="n">valid_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="mi">1</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">validation_result</span><span class="p">[</span><span class="s2">&quot;validation_results&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;is_correct&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">valid_count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">validation_result</span><span class="p">[</span><span class="s2">&quot;validation_results&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">return_instance</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">plan</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">operation_instance</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">plan</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">output</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_synthesize_merge_prompt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">plan</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">sample_outputs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Synthesize a merge prompt for combining multiple folded outputs in a reduce operation.</span>

<span class="sd">        This method generates a merge prompt that can be used to combine the results of multiple</span>
<span class="sd">        parallel fold operations into a single output. It uses the language model to create a prompt</span>
<span class="sd">        that is consistent with the original reduce and fold prompts while addressing the specific</span>
<span class="sd">        requirements of merging multiple outputs.</span>

<span class="sd">        Args:</span>
<span class="sd">            plan (dict[str, Any]): The reduce plan containing the original prompt and fold prompt.</span>
<span class="sd">            sample_outputs (list[dict[str, Any]]): Sample outputs from the fold operation to use as examples.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The synthesized merge prompt as a string.</span>

<span class="sd">        The method performs the following steps:</span>
<span class="sd">        1. Sets up the system prompt for the language model.</span>
<span class="sd">        2. Prepares a random sample output to use as an example.</span>
<span class="sd">        3. Creates a detailed prompt for the language model, including the original reduce prompt,</span>
<span class="sd">           fold prompt, sample output, and instructions for creating the merge prompt.</span>
<span class="sd">        4. Uses the language model to generate the merge prompt.</span>
<span class="sd">        5. Returns the generated merge prompt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">system_prompt</span> <span class="o">=</span> <span class="s2">&quot;You are an AI assistant tasked with creating a merge prompt for reduce operations in data processing pipelines. The pipeline has a reduce operation, and incrementally folds inputs into a single output. We want to optimize the pipeline for speed by running multiple folds on different inputs in parallel, and then merging the fold outputs into a single output.&quot;</span>

        <span class="n">output_schema</span> <span class="o">=</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span>
        <span class="n">random_output</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">sample_outputs</span><span class="p">)</span>
        <span class="n">random_output</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">random_output</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">output_schema</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">random_output</span>
        <span class="p">}</span>

        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Reduce Operation Prompt (runs on the first batch of inputs):</span>
<span class="s2">        </span><span class="si">{</span><span class="n">plan</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">        Fold Prompt (runs on the second and subsequent batches of inputs):</span>
<span class="s2">        </span><span class="si">{</span><span class="n">plan</span><span class="p">[</span><span class="s2">&quot;fold_prompt&quot;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">        Sample output of the fold operation (an input to the merge operation):</span>
<span class="s2">        </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">random_output</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">        Create a merge prompt for the reduce operation to combine 2+ folded outputs. The merge prompt should:</span>
<span class="s2">        1. Give context on the task &amp; fold operations, describing that the prompt will be used to combine multiple outputs from the fold operation (as if the original prompt was run on all inputs at once)</span>
<span class="s2">        2. Describe how to combine multiple folded outputs into a single output</span>
<span class="s2">        3. Minimally deviate from the reduce and fold prompts</span>

<span class="s2">        The merge prompt should be a Jinja2 template with the following variables available:</span>
<span class="s2">        - </span><span class="se">{{</span><span class="s2"> outputs </span><span class="se">}}</span><span class="s2">: A list of reduced outputs to be merged (each following the output schema). You can access the first output with </span><span class="se">{{</span><span class="s2"> outputs[0] </span><span class="se">}}</span><span class="s2"> and the second with </span><span class="se">{{</span><span class="s2"> outputs[1] </span><span class="se">}}</span>

<span class="s2">        Output Schema:</span>
<span class="s2">        </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output_schema</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">        Provide the merge prompt as a string.</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;merge_prompt&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;merge_prompt&quot;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
            <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
            <span class="n">system_prompt</span><span class="p">,</span>
            <span class="n">parameters</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)[</span><span class="s2">&quot;merge_prompt&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="docetl.optimizers.reduce_optimizer.ReduceOptimizer.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">run_operation</span><span class="p">,</span> <span class="n">num_fold_prompts</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_samples_in_validation</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the ReduceOptimizer.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary for the optimizer.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>console</code>
            </td>
            <td>
                  <code><span title="Console">Console</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Rich console object for pretty printing.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>llm_client</code>
            </td>
            <td>
                  <code><span title="LLMClient">LLMClient</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Client for interacting with a language model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_threads</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of threads to use for parallel processing.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>run_operation</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function to run an operation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_fold_prompts</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of fold prompts to generate. Defaults to 1.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_samples_in_validation</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of samples to use in validation. Defaults to 10.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>docetl/optimizers/reduce_optimizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">runner</span><span class="p">,</span>
    <span class="n">run_operation</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="n">num_fold_prompts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">num_samples_in_validation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the ReduceOptimizer.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (dict[str, Any]): Configuration dictionary for the optimizer.</span>
<span class="sd">        console (Console): Rich console object for pretty printing.</span>
<span class="sd">        llm_client (LLMClient): Client for interacting with a language model.</span>
<span class="sd">        max_threads (int): Maximum number of threads to use for parallel processing.</span>
<span class="sd">        run_operation (Callable): Function to run an operation.</span>
<span class="sd">        num_fold_prompts (int, optional): Number of fold prompts to generate. Defaults to 1.</span>
<span class="sd">        num_samples_in_validation (int, optional): Number of samples to use in validation. Defaults to 10.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">runner</span> <span class="o">=</span> <span class="n">runner</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">console</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">llm_client</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_run_operation</span> <span class="o">=</span> <span class="n">run_operation</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">max_threads</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_fold_prompts</span> <span class="o">=</span> <span class="n">num_fold_prompts</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_samples_in_validation</span> <span class="o">=</span> <span class="n">num_samples_in_validation</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">status</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.optimizers.reduce_optimizer.ReduceOptimizer.optimize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Optimize the reduce operation based on the given configuration and input data.</p>
<p>This method performs the following steps:
1. Run the original operation
2. Generate a validator prompt
3. Validate the output
4. If improvement is needed:
   a. Evaluate if decomposition is beneficial
   b. If decomposition is beneficial, recursively optimize each sub-operation
   c. If not, proceed with single operation optimization
5. Run the optimized operation(s)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>op_config</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration for the reduce operation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>input_data</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input data for the reduce operation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[list[dict[str, Any]], list[dict[str, Any]], float]: A tuple containing the list of optimized configurations</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>and the list of outputs from the optimized operation(s), and the cost of the operation due to synthesizing any resolve operations.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>docetl/optimizers/reduce_optimizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimize the reduce operation based on the given configuration and input data.</span>

<span class="sd">    This method performs the following steps:</span>
<span class="sd">    1. Run the original operation</span>
<span class="sd">    2. Generate a validator prompt</span>
<span class="sd">    3. Validate the output</span>
<span class="sd">    4. If improvement is needed:</span>
<span class="sd">       a. Evaluate if decomposition is beneficial</span>
<span class="sd">       b. If decomposition is beneficial, recursively optimize each sub-operation</span>
<span class="sd">       c. If not, proceed with single operation optimization</span>
<span class="sd">    5. Run the optimized operation(s)</span>

<span class="sd">    Args:</span>
<span class="sd">        op_config (dict[str, Any]): Configuration for the reduce operation.</span>
<span class="sd">        input_data (list[dict[str, Any]]): Input data for the reduce operation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[list[dict[str, Any]], list[dict[str, Any]], float]: A tuple containing the list of optimized configurations</span>
<span class="sd">        and the list of outputs from the optimized operation(s), and the cost of the operation due to synthesizing any resolve operations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span>
        <span class="n">validation_results</span><span class="p">,</span>
        <span class="n">prompt_tokens</span><span class="p">,</span>
        <span class="n">model_input_context_length</span><span class="p">,</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">validator_prompt</span><span class="p">,</span>
        <span class="n">original_output</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_optimize_helper</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>

    <span class="c1"># add_map_op = False</span>
    <span class="k">if</span> <span class="n">prompt_tokens</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">model_input_context_length</span><span class="p">:</span>
        <span class="c1"># add_map_op = True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[yellow]Warning: The reduce prompt exceeds the token limit for model </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Token count: </span><span class="si">{</span><span class="n">prompt_tokens</span><span class="si">}</span><span class="s2">, Limit: </span><span class="si">{</span><span class="n">model_input_context_length</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Add a map operation to the pipeline.[/yellow]&quot;</span>
        <span class="p">)</span>

    <span class="c1"># # Also query an agent to look at a sample of the inputs and see if they think a map operation would be helpful</span>
    <span class="c1"># preprocessing_steps = &quot;&quot;</span>
    <span class="c1"># should_use_map, preprocessing_steps = self._should_use_map(</span>
    <span class="c1">#     op_config, input_data</span>
    <span class="c1"># )</span>
    <span class="c1"># if should_use_map or add_map_op:</span>
    <span class="c1">#     # Synthesize a map operation</span>
    <span class="c1">#     map_prompt, map_output_schema = self._synthesize_map_operation(</span>
    <span class="c1">#         op_config, preprocessing_steps, input_data</span>
    <span class="c1">#     )</span>
    <span class="c1">#     # Change the reduce operation prompt to use the map schema</span>
    <span class="c1">#     new_reduce_prompt = self._change_reduce_prompt_to_use_map_schema(</span>
    <span class="c1">#         op_config[&quot;prompt&quot;], map_output_schema</span>
    <span class="c1">#     )</span>
    <span class="c1">#     op_config[&quot;prompt&quot;] = new_reduce_prompt</span>

    <span class="c1">#     # Return unoptimized map and reduce operations</span>
    <span class="c1">#     return [map_prompt, op_config], input_data, 0.0</span>

    <span class="c1"># Print the validation results</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[bold]Validation Results on Initial Sample:[/bold]&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">validation_results</span><span class="p">[</span><span class="s2">&quot;needs_improvement&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{}</span>
    <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;force_decompose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">post_optimizer_rationale</span><span class="p">(</span>
            <span class="n">should_optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">rationale</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;Issues: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> Suggestions: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;suggestions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">validation_results</span><span class="p">[</span><span class="s2">&quot;validation_results&quot;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="p">),</span>
            <span class="n">validator_prompt</span><span class="o">=</span><span class="n">validator_prompt</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;Issues: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> Suggestions: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;suggestions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">validation_results</span><span class="p">[</span><span class="s2">&quot;validation_results&quot;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Step 3: Evaluate if decomposition is beneficial</span>
        <span class="n">decomposition_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_decomposition</span><span class="p">(</span>
            <span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">level</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">decomposition_result</span><span class="p">[</span><span class="s2">&quot;should_decompose&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_decomposed_reduce</span><span class="p">(</span>
                <span class="n">decomposition_result</span><span class="p">,</span> <span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">level</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_single_reduce</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">validator_prompt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No improvements identified; </span><span class="si">{</span><span class="n">validation_results</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">post_optimizer_rationale</span><span class="p">(</span>
            <span class="n">should_optimize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">rationale</span><span class="o">=</span><span class="s2">&quot;No improvements identified; no optimization recommended.&quot;</span><span class="p">,</span>
            <span class="n">validator_prompt</span><span class="o">=</span><span class="n">validator_prompt</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">op_config</span><span class="p">],</span> <span class="n">original_output</span><span class="p">,</span> <span class="mf">0.0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="docetl.optimizers.join_optimizer.JoinOptimizer" class="doc doc-heading">
            <code>docetl.optimizers.join_optimizer.JoinOptimizer</code>


</h3>


    <div class="doc doc-contents first">








              <details class="quote">
                <summary>Source code in <code>docetl/optimizers/join_optimizer.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  15</span>
<span class="normal">  16</span>
<span class="normal">  17</span>
<span class="normal">  18</span>
<span class="normal">  19</span>
<span class="normal">  20</span>
<span class="normal">  21</span>
<span class="normal">  22</span>
<span class="normal">  23</span>
<span class="normal">  24</span>
<span class="normal">  25</span>
<span class="normal">  26</span>
<span class="normal">  27</span>
<span class="normal">  28</span>
<span class="normal">  29</span>
<span class="normal">  30</span>
<span class="normal">  31</span>
<span class="normal">  32</span>
<span class="normal">  33</span>
<span class="normal">  34</span>
<span class="normal">  35</span>
<span class="normal">  36</span>
<span class="normal">  37</span>
<span class="normal">  38</span>
<span class="normal">  39</span>
<span class="normal">  40</span>
<span class="normal">  41</span>
<span class="normal">  42</span>
<span class="normal">  43</span>
<span class="normal">  44</span>
<span class="normal">  45</span>
<span class="normal">  46</span>
<span class="normal">  47</span>
<span class="normal">  48</span>
<span class="normal">  49</span>
<span class="normal">  50</span>
<span class="normal">  51</span>
<span class="normal">  52</span>
<span class="normal">  53</span>
<span class="normal">  54</span>
<span class="normal">  55</span>
<span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">JoinOptimizer</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">runner</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">target_recall</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
        <span class="n">sampling_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">agent_max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">estimated_selectivity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span> <span class="o">=</span> <span class="n">runner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span> <span class="o">=</span> <span class="n">op_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">llm_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">max_threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">console</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_recall</span> <span class="o">=</span> <span class="n">target_recall</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampling_weight</span> <span class="o">=</span> <span class="n">sampling_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_max_retries</span> <span class="o">=</span> <span class="n">agent_max_retries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimated_selectivity</span> <span class="o">=</span> <span class="n">estimated_selectivity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target Recall: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_recall</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_comparison_sampling_attempts</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synthesized_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># if self.estimated_selectivity is not None:</span>
        <span class="c1">#     self.console.log(</span>
        <span class="c1">#         f&quot;[yellow]Using estimated selectivity of {self.estimated_selectivity}[/yellow]&quot;</span>
        <span class="c1">#     )</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_analyze_map_prompt_categorization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">map_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze the map prompt to determine if it&#39;s explicitly categorical.</span>

<span class="sd">        Args:</span>
<span class="sd">            map_prompt (str): The map prompt to analyze.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the prompt is explicitly categorical, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;You are an AI assistant tasked with analyzing prompts for data processing operations.&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Analyze the following map operation prompt and determine if it is explicitly categorical,</span>
<span class="s2">                meaning it details a specific set of possible outputs:</span>

<span class="s2">                </span><span class="si">{</span><span class="n">map_prompt</span><span class="si">}</span>

<span class="s2">                Respond with &#39;Yes&#39; if the prompt is explicitly categorical, detailing a finite set of possible outputs.</span>
<span class="s2">                Respond with &#39;No&#39; if the prompt allows for open-ended or non-categorical responses.</span>
<span class="s2">                Provide a brief explanation for your decision.&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
            <span class="n">messages</span><span class="p">,</span>
            <span class="s2">&quot;You are an expert in analyzing natural language prompts for data processing tasks.&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;is_categorical&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Yes&quot;</span><span class="p">,</span> <span class="s2">&quot;No&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Whether the prompt is explicitly categorical&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;explanation&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Brief explanation for the decision&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">},</span>
                <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;is_categorical&quot;</span><span class="p">,</span> <span class="s2">&quot;explanation&quot;</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="n">analysis</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[bold]Map Prompt Analysis:[/bold]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Is Categorical: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;is_categorical&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Explanation: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;explanation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;is_categorical&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;explanation&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_determine_duplicate_keys</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">reduce_key</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">map_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># Prepare a sample of the input data for analysis</span>
        <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))</span>
        <span class="n">data_sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="p">[{</span><span class="n">rk</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="n">rk</span><span class="p">]</span> <span class="k">for</span> <span class="n">rk</span> <span class="ow">in</span> <span class="n">reduce_key</span><span class="p">}</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">],</span> <span class="n">sample_size</span>
        <span class="p">)</span>

        <span class="n">context_prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">map_prompt</span><span class="p">:</span>
            <span class="n">context_prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;For context, these values came out of a pipeline with the following prompt:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">map_prompt</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">context_prefix</span><span class="si">}</span><span class="s2">I want to do a reduce operation on these values, and I need to determine if there are semantic duplicates in the data, where the strings are different but they technically belong in the same group. Note that exact string duplicates should not be considered here.</span><span class="se">\n\n</span><span class="s2">Here&#39;s a sample of the data (showing the &#39;</span><span class="si">{</span><span class="n">reduce_key</span><span class="si">}</span><span class="s2">&#39; field(s)): </span><span class="si">{</span><span class="n">data_sample</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Based on this </span><span class="si">{</span><span class="s1">&#39;context and &#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">map_prompt</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">sample, are there likely to be such semantic duplicates (not exact string matches) in the dataset? Respond with &#39;yes&#39; only if you think there are semantic duplicates, or &#39;no&#39; if you don&#39;t see evidence of semantic duplicates or if you only see exact string duplicates.&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
            <span class="n">messages</span><span class="p">,</span>
            <span class="s2">&quot;You are an expert data analyst. Analyze the given data sample and determine if there are likely to be semantic duplicate values that belong in the same group, even if the strings are different.&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;likely_duplicates&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Yes&quot;</span><span class="p">,</span> <span class="s2">&quot;No&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Whether duplicates are likely to exist in the full dataset&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;explanation&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Brief explanation for the decision&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">},</span>
                <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;likely_duplicates&quot;</span><span class="p">,</span> <span class="s2">&quot;explanation&quot;</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="n">analysis</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold]Duplicate Analysis for &#39;</span><span class="si">{</span><span class="n">reduce_key</span><span class="si">}</span><span class="s2">&#39;:[/bold]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Likely Duplicates: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;likely_duplicates&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Explanation: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;explanation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;likely_duplicates&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="s2">&quot;[yellow]Duplicates are likely. Consider using a deduplication strategy in the resolution step.[/yellow]&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;explanation&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_sample_random_pairs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample random pairs of indices, excluding exact matches.&quot;&quot;&quot;</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">max_attempts</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1"># Avoid infinite loop</span>
        <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="n">max_attempts</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span> <span class="ow">and</span> <span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">input_data</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">pairs</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)))</span>  <span class="c1"># Ensure ordered pairs</span>
            <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_duplicates_with_llm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">pairs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
        <span class="n">reduce_key</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">map_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Use LLM to check if any pairs are duplicates.&quot;&quot;&quot;</span>

        <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;Analyze the following pairs of entries and determine if any of them are likely duplicates. Respond with &#39;Yes&#39; if you find any likely duplicates, or &#39;No&#39; if none of the pairs seem to be duplicates. Provide a brief explanation for your decision.</span><span class="se">\n\n</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">map_prompt</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;For reference, here is the map prompt used earlier in the pipeline: </span><span class="si">{</span><span class="n">map_prompt</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="n">content</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Pair </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">content</span> <span class="o">+=</span> <span class="s2">&quot;Entry 1:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">reduce_key</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="n">idx1</span><span class="p">][</span><span class="n">key</span><span class="p">],</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">content</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Entry 2:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">reduce_key</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="n">idx2</span><span class="p">][</span><span class="n">key</span><span class="p">],</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">content</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">}]</span>

        <span class="n">system_prompt</span> <span class="o">=</span> <span class="s2">&quot;You are an AI assistant tasked with identifying potential duplicate entries in a dataset.&quot;</span>
        <span class="n">response_schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;duplicates_found&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Yes&quot;</span><span class="p">,</span> <span class="s2">&quot;No&quot;</span><span class="p">]},</span>
                <span class="s2">&quot;explanation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
            <span class="p">},</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;duplicates_found&quot;</span><span class="p">,</span> <span class="s2">&quot;explanation&quot;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
            <span class="n">messages</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">,</span> <span class="n">response_schema</span>
        <span class="p">)</span>

        <span class="c1"># Print the duplicates_found and explanation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[bold]Duplicates in keys found:[/bold] </span><span class="si">{</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;duplicates_found&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;[bold]Explanation:[/bold] </span><span class="si">{</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;explanation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;duplicates_found&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;explanation&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">synthesize_compare_prompt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">map_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">reduce_key</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>

        <span class="n">system_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;You are an AI assistant tasked with creating a comparison prompt for LLM-assisted entity resolution. Your task is to create a comparison prompt that will be used to compare two entities, referred to as input1 and input2, to see if they are likely the same entity based on the following reduce key(s): </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reduce_key</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="k">if</span> <span class="n">map_prompt</span><span class="p">:</span>
            <span class="n">system_prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">For context, here is the prompt used earlier in the pipeline to create the inputs to resolve: </span><span class="si">{</span><span class="n">map_prompt</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Create a comparison prompt for entity resolution: The prompt should:</span>
<span class="s2">    1. Be tailored to the specific domain and type of data being compared (</span><span class="si">{</span><span class="n">reduce_key</span><span class="si">}</span><span class="s2">), based on the context provided.</span>
<span class="s2">    2. Instruct to compare two entities, referred to as input1 and input2.</span>
<span class="s2">    3. Specifically mention comparing each reduce key in input1 and input2 (e.g., input1.</span><span class="se">{{</span><span class="s2">key</span><span class="se">}}</span><span class="s2"> and input2.</span><span class="se">{{</span><span class="s2">key</span><span class="se">}}</span><span class="s2"> for each key in </span><span class="si">{</span><span class="n">reduce_key</span><span class="si">}</span><span class="s2">). You can reference other fields in the input as well, as long as they are short.</span>
<span class="s2">    4. Include instructions to consider relevant attributes or characteristics for comparison.</span>
<span class="s2">    5. Ask to respond with &quot;True&quot; if the entities are likely the same, or &quot;False&quot; if they are likely different.</span>

<span class="s2">    Example structure:</span>
<span class="s2">    ```</span>
<span class="s2">    Compare the following two </span><span class="si">{</span><span class="n">reduce_key</span><span class="si">}</span><span class="s2"> from [entity or document type]:</span>

<span class="s2">    [Entity 1]:</span>
<span class="s2">    </span><span class="se">{{{{</span><span class="s2"> input1.key1 </span><span class="se">}}}}</span>
<span class="s2">    </span><span class="se">{{{{</span><span class="s2"> input1.optional_key2 </span><span class="se">}}}}</span>

<span class="s2">    [Entity 2]:</span>
<span class="s2">    </span><span class="se">{{{{</span><span class="s2"> input2.key1 </span><span class="se">}}}}</span>
<span class="s2">    </span><span class="se">{{{{</span><span class="s2"> input2.optional_key2 </span><span class="se">}}}}</span>

<span class="s2">    Are these [entities] likely referring to the same [entity type]? Consider [list relevant attributes or characteristics to compare]. Respond with &quot;True&quot; if they are likely the same [entity type], or &quot;False&quot; if they are likely different [entity types].</span>
<span class="s2">    ```</span>

<span class="s2">    Please generate the comparison prompt, which should be a Jinja2 template:</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
            <span class="n">messages</span><span class="p">,</span>
            <span class="n">system_prompt</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;comparison_prompt&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Detailed comparison prompt for entity resolution&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="n">comparison_prompt</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)[</span>
            <span class="s2">&quot;comparison_prompt&quot;</span>
        <span class="p">]</span>

        <span class="c1"># Log the synthesized comparison prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[green]Synthesized comparison prompt:[/green]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">comparison_prompt</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">comparison_prompt</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Could not synthesize a comparison prompt. Please provide a comparison prompt in the config.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">comparison_prompt</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">synthesize_resolution_prompt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">map_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reduce_key</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">output_schema</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">system_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;You are an AI assistant tasked with creating a resolution prompt for LLM-assisted entity resolution.</span>
<span class="s2">        Your task is to create a prompt that will be used to merge multiple duplicate keys into a single, consolidated key.</span>
<span class="s2">        The key(s) being resolved (known as the reduce_key) are </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reduce_key</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span>
<span class="s2">        The duplicate keys will be provided in a list called &#39;inputs&#39; in a Jinja2 template.</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">map_prompt</span><span class="p">:</span>
            <span class="n">system_prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">For context, here is the prompt used earlier in the pipeline to create the inputs to resolve: </span><span class="si">{</span><span class="n">map_prompt</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Create a resolution prompt for merging duplicate keys into a single key. The prompt should:</span>
<span class="s2">    1. Be tailored to the specific domain and type of data being merged, based on the context provided.</span>
<span class="s2">    2. Use a Jinja2 template to iterate over the duplicate keys (accessed as &#39;inputs&#39;, where each item is a dictionary containing the reduce_key fields, which you can access as entry.reduce_key for each reduce_key in </span><span class="si">{</span><span class="n">reduce_key</span><span class="si">}</span><span class="s2">).</span>
<span class="s2">    3. Instruct to create a single, consolidated key from the duplicate keys.</span>
<span class="s2">    4. Include guidelines for resolving conflicts (e.g., choosing the most recent, most complete, or most reliable information).</span>
<span class="s2">    5. Specify that the output of the resolution prompt should conform to the given output schema: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output_schema</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">    Example structure:</span>
<span class="s2">    ```</span>
<span class="s2">    Analyze the following duplicate entries for the </span><span class="si">{</span><span class="n">reduce_key</span><span class="si">}</span><span class="s2"> key:</span>

<span class="s2">    </span><span class="se">{{</span><span class="s2">% for key in inputs %</span><span class="se">}}</span>
<span class="s2">    Entry </span><span class="se">{{{{</span><span class="s2"> loop.index </span><span class="se">}}}}</span><span class="s2">:</span>
<span class="s2">    </span><span class="se">{{</span><span class="s2"> % for key in reduce_key %</span><span class="se">}}</span>
<span class="s2">    </span><span class="se">{{{{</span><span class="s2"> key </span><span class="se">}}}}</span><span class="s2">: </span><span class="se">{{{{</span><span class="s2"> key[reduce_key] </span><span class="se">}}}}</span>
<span class="s2">    </span><span class="se">{{</span><span class="s2">% endfor %</span><span class="se">}}</span>

<span class="s2">    </span><span class="se">{{</span><span class="s2">% endfor %</span><span class="se">}}</span>

<span class="s2">    Merge these into a single key.</span>
<span class="s2">    When merging, follow these guidelines:</span>
<span class="s2">    1. [Provide specific merging instructions relevant to the data type]</span>
<span class="s2">    2. [Do not make the prompt too long]</span>

<span class="s2">    Ensure that the merged key conforms to the following schema:</span>
<span class="s2">    </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output_schema</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">    Return the consolidated key as a single [appropriate data type] value.</span>
<span class="s2">    ```</span>

<span class="s2">    Please generate the resolution prompt:</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
            <span class="n">messages</span><span class="p">,</span>
            <span class="n">system_prompt</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;resolution_prompt&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Detailed resolution prompt for merging duplicate keys&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;resolution_prompt&quot;</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="n">resolution_prompt</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)[</span>
            <span class="s2">&quot;resolution_prompt&quot;</span>
        <span class="p">]</span>

        <span class="c1"># Log the synthesized resolution prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[green]Synthesized resolution prompt:[/green]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">resolution_prompt</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">resolution_prompt</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Could not synthesize a resolution prompt. Please provide a resolution prompt in the config.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">resolution_prompt</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">should_optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if the given operation configuration should be optimized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If there are no blocking keys or embeddings, then we don&#39;t need to optimize</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_conditions&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;blocking_threshold&quot;</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Check if the operation is marked as empty</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;empty&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="c1"># Extract the map prompt from the intermediates</span>
            <span class="n">map_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;_intermediates&quot;</span><span class="p">][</span><span class="s2">&quot;map_prompt&quot;</span><span class="p">]</span>
            <span class="n">reduce_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;_intermediates&quot;</span><span class="p">][</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">reduce_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;[yellow]Warning: No reduce key found in intermediates for synthesized resolve operation.[/yellow]&quot;</span>
                <span class="p">)</span>

            <span class="n">dedup</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">explanation</span> <span class="o">=</span> <span class="s2">&quot;There is a reduce operation that does not follow a resolve operation. Consider adding a resolve operation to deduplicate the data.&quot;</span>

            <span class="k">if</span> <span class="n">map_prompt</span><span class="p">:</span>
                <span class="c1"># Analyze the map prompt</span>
                <span class="n">analysis</span><span class="p">,</span> <span class="n">explanation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_map_prompt_categorization</span><span class="p">(</span>
                    <span class="n">map_prompt</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">analysis</span><span class="p">:</span>
                    <span class="n">dedup</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s2">&quot;[yellow]No map prompt found in intermediates for analysis.[/yellow]&quot;</span>
                <span class="p">)</span>

            <span class="c1"># TODO: figure out why this would ever be the case</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">map_prompt</span><span class="p">:</span>
                <span class="n">map_prompt</span> <span class="o">=</span> <span class="s2">&quot;N/A&quot;</span>

            <span class="k">if</span> <span class="n">dedup</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">dedup</span><span class="p">,</span> <span class="n">explanation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_duplicate_keys</span><span class="p">(</span>
                    <span class="n">input_data</span><span class="p">,</span> <span class="n">reduce_key</span><span class="p">,</span> <span class="n">map_prompt</span>
                <span class="p">)</span>

            <span class="c1"># Now do the last attempt of pairwise comparisons</span>
            <span class="k">if</span> <span class="n">dedup</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="c1"># Sample up to 20 random pairs of keys for duplicate analysis</span>
                <span class="n">sampled_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_random_pairs</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

                <span class="c1"># Use LLM to check for duplicates</span>
                <span class="n">duplicates_found</span><span class="p">,</span> <span class="n">explanation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_duplicates_with_llm</span><span class="p">(</span>
                    <span class="n">input_data</span><span class="p">,</span> <span class="n">sampled_pairs</span><span class="p">,</span> <span class="n">reduce_key</span><span class="p">,</span> <span class="n">map_prompt</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">duplicates_found</span><span class="p">:</span>
                    <span class="n">dedup</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">return</span> <span class="n">dedup</span><span class="p">,</span> <span class="n">explanation</span>

        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_resolve</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="c1"># Check if the operation is marked as empty</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;empty&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="c1"># Extract the map prompt from the intermediates</span>
            <span class="n">dedup</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_optimize</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
            <span class="n">reduce_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;_intermediates&quot;</span><span class="p">][</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span>
            <span class="n">map_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;_intermediates&quot;</span><span class="p">][</span><span class="s2">&quot;map_prompt&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">dedup</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="c1"># If no deduplication is needed, return the same config with 0 cost</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">,</span> <span class="mf">0.0</span>

            <span class="c1"># Add the reduce key to the output schema in the config</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">rk</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span> <span class="k">for</span> <span class="n">rk</span> <span class="ow">in</span> <span class="n">reduce_key</span><span class="p">}}</span>
            <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>  <span class="c1"># Try up to 2 times</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synthesize_compare_prompt</span><span class="p">(</span>
                    <span class="n">map_prompt</span><span class="p">,</span> <span class="n">reduce_key</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="s2">&quot;input1&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="s2">&quot;input2&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">attempt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="s2">&quot;[yellow]Warning: &#39;input1&#39; or &#39;input2&#39; not found in comparison prompt. Retrying...[/yellow]&quot;</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;input1&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">]</span>
                <span class="ow">or</span> <span class="s2">&quot;input2&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s2">&quot;[red]Error: Failed to generate comparison prompt with &#39;input1&#39; and &#39;input2&#39;. Using last generated prompt.[/red]&quot;</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>  <span class="c1"># Try up to 2 times</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;resolution_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synthesize_resolution_prompt</span><span class="p">(</span>
                    <span class="n">map_prompt</span><span class="p">,</span> <span class="n">reduce_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;inputs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;resolution_prompt&quot;</span><span class="p">]:</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">attempt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="s2">&quot;[yellow]Warning: &#39;inputs&#39; not found in resolution prompt. Retrying...[/yellow]&quot;</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;inputs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;resolution_prompt&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s2">&quot;[red]Error: Failed to generate resolution prompt with &#39;inputs&#39;. Using last generated prompt.[/red]&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Pop off the empty flag</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;empty&quot;</span><span class="p">)</span>

        <span class="n">embeddings</span><span class="p">,</span> <span class="n">blocking_keys</span><span class="p">,</span> <span class="n">embedding_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_embeddings</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[bold]Cost of creating embeddings on the sample: $</span><span class="si">{</span><span class="n">embedding_cost</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">[/bold]&quot;</span>
        <span class="p">)</span>

        <span class="n">similarities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_cosine_similarities</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span>

        <span class="n">sampled_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_pairs</span><span class="p">(</span><span class="n">similarities</span><span class="p">)</span>
        <span class="n">comparison_results</span><span class="p">,</span> <span class="n">comparison_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_comparisons_resolve</span><span class="p">(</span>
            <span class="n">input_data</span><span class="p">,</span> <span class="n">sampled_pairs</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_print_similarity_histogram</span><span class="p">(</span><span class="n">similarities</span><span class="p">,</span> <span class="n">comparison_results</span><span class="p">)</span>

        <span class="n">threshold</span><span class="p">,</span> <span class="n">estimated_selectivity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_optimal_threshold</span><span class="p">(</span>
            <span class="n">comparison_results</span><span class="p">,</span> <span class="n">similarities</span>
        <span class="p">)</span>

        <span class="n">blocking_rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_blocking_rules</span><span class="p">(</span>
            <span class="n">blocking_keys</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">comparison_results</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">blocking_rules</span><span class="p">:</span>
            <span class="n">false_negatives</span><span class="p">,</span> <span class="n">rule_selectivity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_blocking_rule</span><span class="p">(</span>
                <span class="n">input_data</span><span class="p">,</span>
                <span class="n">blocking_rules</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">blocking_keys</span><span class="p">,</span>
                <span class="n">comparison_results</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># If more than 50% of the sample is false negatives, reject the blocking rule</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">false_negatives</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sampled_pairs</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">false_negatives</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[red]Blocking rule rejected. </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">false_negatives</span><span class="p">)</span><span class="si">}</span><span class="s2"> false negatives detected in the sample (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">false_negatives</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">sampled_pairs</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> of the sample).[/red]&quot;</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">false_negatives</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>  <span class="c1"># Show up to 5 examples</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;  Filtered pair: </span><span class="se">{{</span><span class="s2"> </span><span class="si">{</span><span class="n">blocking_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">blocking_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="si">}</span><span class="s2"> </span><span class="se">}}</span><span class="s2"> and </span><span class="se">{{</span><span class="s2"> </span><span class="si">{</span><span class="n">blocking_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">input_data</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">blocking_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="si">}</span><span class="s2"> </span><span class="se">}}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">false_negatives</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ... and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">false_negatives</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> more.&quot;</span><span class="p">)</span>
                <span class="n">blocking_rules</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">[]</span>
                <span class="p">)</span>  <span class="c1"># Clear the blocking rule if it introduces false negatives or is too selective</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">false_negatives</span> <span class="ow">and</span> <span class="n">rule_selectivity</span> <span class="o">&gt;</span> <span class="n">estimated_selectivity</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s2">&quot;[green]Blocking rule verified. No false negatives detected in the sample and selectivity is within estimated selectivity.[/green]&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: ask user if they want to use the blocking rule, or come up with some good default behavior</span>
                <span class="n">blocking_rules</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">optimized_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_config</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">blocking_keys</span><span class="p">,</span> <span class="n">blocking_rules</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">optimized_config</span><span class="p">,</span> <span class="n">embedding_cost</span> <span class="o">+</span> <span class="n">comparison_cost</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_equijoin</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">left_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">right_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">skip_map_gen</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">skip_containment_gen</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">left_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_keys&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">right_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_keys&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">left_keys</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">right_keys</span><span class="p">:</span>
            <span class="c1"># Ask the LLM agent if it would be beneficial to do a map operation on</span>
            <span class="c1"># one of the datasets before doing an equijoin</span>
            <span class="n">apply_transformation</span><span class="p">,</span> <span class="n">dataset_to_transform</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_should_apply_map_transformation</span><span class="p">(</span>
                        <span class="n">left_keys</span><span class="p">,</span> <span class="n">right_keys</span><span class="p">,</span> <span class="n">left_data</span><span class="p">,</span> <span class="n">right_data</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_map_gen</span>
                <span class="k">else</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">apply_transformation</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">skip_map_gen</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;LLM agent suggested applying a map transformation to </span><span class="si">{</span><span class="n">dataset_to_transform</span><span class="si">}</span><span class="s2"> dataset because: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">extraction_prompt</span><span class="p">,</span> <span class="n">output_key</span><span class="p">,</span> <span class="n">new_comparison_prompt</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_generate_map_and_new_join_transformation</span><span class="p">(</span>
                        <span class="n">dataset_to_transform</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">left_data</span><span class="p">,</span> <span class="n">right_data</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Generated map transformation prompt: </span><span class="si">{</span><span class="n">extraction_prompt</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">New output key: </span><span class="si">{</span><span class="n">output_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">New equijoin comparison prompt: </span><span class="si">{</span><span class="n">new_comparison_prompt</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="c1"># Update the comparison prompt</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_comparison_prompt</span>

                <span class="c1"># Add the output key to the left_keys or right_keys</span>
                <span class="k">if</span> <span class="n">dataset_to_transform</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span><span class="p">:</span>
                    <span class="n">left_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_key</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">right_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_key</span><span class="p">)</span>

                <span class="c1"># Reset the blocking keys in the config</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;blocking_keys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="n">left_keys</span><span class="p">,</span>
                    <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="n">right_keys</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="c1"># Bubble up this config and return the transformation prompt, so we can optimize the map operation</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">,</span>
                    <span class="mf">0.0</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;optimize_map&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s2">&quot;map_prompt&quot;</span><span class="p">:</span> <span class="n">extraction_prompt</span><span class="p">,</span>
                        <span class="s2">&quot;output_key&quot;</span><span class="p">:</span> <span class="n">output_key</span><span class="p">,</span>
                        <span class="s2">&quot;dataset_to_transform&quot;</span><span class="p">:</span> <span class="n">dataset_to_transform</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>

            <span class="c1"># Print the reason for not applying a map transformation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Reason for not synthesizing a map transformation for either left or right dataset: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># If there are no blocking keys, generate them</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">left_keys</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">right_keys</span><span class="p">:</span>
            <span class="n">generated_left_keys</span><span class="p">,</span> <span class="n">generated_right_keys</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_generate_blocking_keys_equijoin</span><span class="p">(</span><span class="n">left_data</span><span class="p">,</span> <span class="n">right_data</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">left_keys</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">generated_left_keys</span><span class="p">)</span>
            <span class="n">right_keys</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">generated_right_keys</span><span class="p">)</span>
            <span class="n">left_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">left_keys</span><span class="p">))</span>
            <span class="n">right_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">right_keys</span><span class="p">))</span>

            <span class="c1"># Log the generated blocking keys</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="s2">&quot;[bold]Generated blocking keys (for embeddings-based blocking):[/bold]&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Left keys: </span><span class="si">{</span><span class="n">left_keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Right keys: </span><span class="si">{</span><span class="n">right_keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">left_embeddings</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">left_embedding_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_embeddings</span><span class="p">(</span>
            <span class="n">left_data</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">left_keys</span>
        <span class="p">)</span>
        <span class="n">right_embeddings</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">right_embedding_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_embeddings</span><span class="p">(</span>
            <span class="n">right_data</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">right_keys</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[bold]Cost of creating embeddings on the sample: $</span><span class="si">{</span><span class="n">left_embedding_cost</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">right_embedding_cost</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">[/bold]&quot;</span>
        <span class="p">)</span>

        <span class="n">similarities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_cross_similarities</span><span class="p">(</span>
            <span class="n">left_embeddings</span><span class="p">,</span> <span class="n">right_embeddings</span>
        <span class="p">)</span>

        <span class="n">sampled_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_pairs</span><span class="p">(</span><span class="n">similarities</span><span class="p">)</span>
        <span class="n">comparison_results</span><span class="p">,</span> <span class="n">comparison_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_comparisons_equijoin</span><span class="p">(</span>
            <span class="n">left_data</span><span class="p">,</span> <span class="n">right_data</span><span class="p">,</span> <span class="n">sampled_pairs</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_similarity_histogram</span><span class="p">(</span><span class="n">similarities</span><span class="p">,</span> <span class="n">comparison_results</span><span class="p">)</span>
        <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">comparison_results</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_comparison_sampling_attempts</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="s2">&quot;[yellow]No matches found in the current sample. Resampling pairs to compare...[/yellow]&quot;</span>
            <span class="p">)</span>
            <span class="n">sampled_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_pairs</span><span class="p">(</span><span class="n">similarities</span><span class="p">)</span>
            <span class="n">comparison_results</span><span class="p">,</span> <span class="n">current_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_comparisons_equijoin</span><span class="p">(</span>
                <span class="n">left_data</span><span class="p">,</span> <span class="n">right_data</span><span class="p">,</span> <span class="n">sampled_pairs</span>
            <span class="p">)</span>
            <span class="n">comparison_cost</span> <span class="o">+=</span> <span class="n">current_cost</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_similarity_histogram</span><span class="p">(</span><span class="n">similarities</span><span class="p">,</span> <span class="n">comparison_results</span><span class="p">)</span>
            <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">comparison_results</span><span class="p">):</span>
            <span class="c1"># If still no matches after max_comparison_sampling_attempts attempts, use 99th percentile similarity as threshold</span>
            <span class="c1"># This is a heuristic to avoid being in an infinite loop</span>
            <span class="c1"># TODO: have a better plan for sampling pairs or avoiding getting into this situation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[yellow]No matches found after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_comparison_sampling_attempts</span><span class="si">}</span><span class="s2"> attempts. Using 99th percentile similarity as threshold.[/yellow]&quot;</span>
            <span class="p">)</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">([</span><span class="n">sim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">sim</span> <span class="ow">in</span> <span class="n">similarities</span><span class="p">],</span> <span class="mi">99</span><span class="p">)</span>
            <span class="c1"># TODO: figure out how to estimate selectivity</span>
            <span class="n">estimated_selectivity</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">estimated_selectivity</span> <span class="o">=</span> <span class="n">estimated_selectivity</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">threshold</span><span class="p">,</span> <span class="n">estimated_selectivity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_optimal_threshold</span><span class="p">(</span>
                <span class="n">comparison_results</span><span class="p">,</span> <span class="n">similarities</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">estimated_selectivity</span> <span class="o">=</span> <span class="n">estimated_selectivity</span>

        <span class="n">blocking_rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_blocking_rules_equijoin</span><span class="p">(</span>
            <span class="n">left_keys</span><span class="p">,</span> <span class="n">right_keys</span><span class="p">,</span> <span class="n">left_data</span><span class="p">,</span> <span class="n">right_data</span><span class="p">,</span> <span class="n">comparison_results</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">blocking_rules</span><span class="p">:</span>
            <span class="n">false_negatives</span><span class="p">,</span> <span class="n">rule_selectivity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_blocking_rule_equijoin</span><span class="p">(</span>
                <span class="n">left_data</span><span class="p">,</span>
                <span class="n">right_data</span><span class="p">,</span>
                <span class="n">blocking_rules</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">left_keys</span><span class="p">,</span>
                <span class="n">right_keys</span><span class="p">,</span>
                <span class="n">comparison_results</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">false_negatives</span> <span class="ow">and</span> <span class="n">rule_selectivity</span> <span class="o">&lt;=</span> <span class="n">estimated_selectivity</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s2">&quot;[green]Blocking rule verified. No false negatives detected in the sample and selectivity is within bounds.[/green]&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">false_negatives</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[red]Blocking rule rejected. </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">false_negatives</span><span class="p">)</span><span class="si">}</span><span class="s2"> false negatives detected in the sample.[/red]&quot;</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">false_negatives</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>  <span class="c1"># Show up to 5 examples</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;  Filtered pair: Left: </span><span class="se">{{</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">left_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">left_keys</span><span class="p">)</span><span class="si">}</span><span class="se">}}</span><span class="s2"> and Right: </span><span class="se">{{</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">right_data</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">right_keys</span><span class="p">)</span><span class="si">}</span><span class="se">}}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">false_negatives</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ... and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">false_negatives</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> more.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rule_selectivity</span> <span class="o">&gt;</span> <span class="n">estimated_selectivity</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[red]Blocking rule rejected. Rule selectivity (</span><span class="si">{</span><span class="n">rule_selectivity</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">) is higher than the estimated selectivity (</span><span class="si">{</span><span class="n">estimated_selectivity</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">).[/red]&quot;</span>
                    <span class="p">)</span>
                <span class="n">blocking_rules</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">[]</span>
                <span class="p">)</span>  <span class="c1"># Clear the blocking rule if it introduces false negatives or is too selective</span>

        <span class="n">containment_rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_containment_rules_equijoin</span><span class="p">(</span>
            <span class="n">left_data</span><span class="p">,</span> <span class="n">right_data</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_containment_gen</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[bold]Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">containment_rules</span><span class="p">)</span><span class="si">}</span><span class="s2"> containment rules. Please select which ones to use as blocking conditions:[/bold]&quot;</span>
            <span class="p">)</span>
            <span class="n">selected_containment_rules</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">containment_rules</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[green]</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s2">[/green]&quot;</span><span class="p">)</span>
                <span class="c1"># Temporarily stop the status</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="c1"># Use Rich&#39;s Confirm for input</span>
                <span class="k">if</span> <span class="n">Confirm</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;Use this rule?&quot;</span><span class="p">,</span> <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">):</span>
                    <span class="n">selected_containment_rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
                <span class="c1"># Restart the status</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Take first 2</span>
            <span class="n">selected_containment_rules</span> <span class="o">=</span> <span class="n">containment_rules</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">containment_rules</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[bold]Selected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_containment_rules</span><span class="p">)</span><span class="si">}</span><span class="s2"> containment rules for blocking.[/bold]&quot;</span>
            <span class="p">)</span>
        <span class="n">blocking_rules</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">selected_containment_rules</span><span class="p">)</span>

        <span class="n">optimized_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_config_equijoin</span><span class="p">(</span>
            <span class="n">threshold</span><span class="p">,</span> <span class="n">left_keys</span><span class="p">,</span> <span class="n">right_keys</span><span class="p">,</span> <span class="n">blocking_rules</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">optimized_config</span><span class="p">,</span>
            <span class="n">left_embedding_cost</span> <span class="o">+</span> <span class="n">right_embedding_cost</span> <span class="o">+</span> <span class="n">comparison_cost</span><span class="p">,</span>
            <span class="p">{},</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_should_apply_map_transformation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">left_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">right_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">left_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">right_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># Sample data</span>
        <span class="n">left_sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">left_data</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">)))</span>
        <span class="n">right_sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">right_data</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_data</span><span class="p">)))</span>

        <span class="c1"># Get keys and their average lengths</span>
        <span class="n">all_left_keys</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">left_sample</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_sample</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">left_sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">all_right_keys</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">right_sample</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_sample</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">right_sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Analyze the following datasets and determine if an additional LLM transformation should be applied to generate a new key-value pair for easier joining:</span>

<span class="s2">                Comparison prompt for the join operation: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;comparison_prompt&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No comparison prompt provided.&#39;</span><span class="p">)</span><span class="si">}</span>

<span class="s2">                Left dataset keys and average lengths: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">all_left_keys</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>
<span class="s2">                Right dataset keys and average lengths: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">all_right_keys</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">                Left dataset sample:</span>
<span class="s2">                </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">left_sample</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">                Right dataset sample:</span>
<span class="s2">                </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">right_sample</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">                Current keys used for embedding-based ranking of likely matches:</span>
<span class="s2">                Left keys: </span><span class="si">{</span><span class="n">left_keys</span><span class="si">}</span>
<span class="s2">                Right keys: </span><span class="si">{</span><span class="n">right_keys</span><span class="si">}</span>

<span class="s2">                Consider the following:</span>
<span class="s2">                1. Are the current keys sufficient for accurate embedding-based ranking of likely matches? We don&#39;t want to use too many keys, or keys with too much information, as this will dilute the signal in the embeddings.</span>
<span class="s2">                2. Are there any keys particularly long (e.g., full text fields), containing information that is not relevant for the join operation? The dataset with the longer keys should be transformed.</span>
<span class="s2">                3. Would a summary or extraction of important information from long key-value pairs be beneficial? If so, the dataset with the longer keys should be transformed.</span>
<span class="s2">                4. Is there a mismatch in information representation between the datasets?</span>
<span class="s2">                5. Could an additional LLM-generated field improve the accuracy of embeddings or join comparisons?</span>

<span class="s2">                If you believe an additional LLM transformation would be beneficial, specify which dataset (left or right) should be transformed and explain why. Otherwise, indicate that no additional transformation is needed and explain why the current blocking keys are sufficient.&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
            <span class="n">messages</span><span class="p">,</span>
            <span class="s2">&quot;You are an AI expert in data analysis and entity matching.&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;apply_transformation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;dataset_to_transform&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">],</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                <span class="p">},</span>
                <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;apply_transformation&quot;</span><span class="p">,</span> <span class="s2">&quot;dataset_to_transform&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;apply_transformation&quot;</span><span class="p">],</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;dataset_to_transform&quot;</span><span class="p">],</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;reason&quot;</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_map_and_new_join_transformation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset_to_transform</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">left_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">right_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># Sample data</span>
        <span class="n">left_sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">left_data</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">)))</span>
        <span class="n">right_sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">right_data</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_data</span><span class="p">)))</span>

        <span class="n">target_data</span> <span class="o">=</span> <span class="n">left_sample</span> <span class="k">if</span> <span class="n">dataset_to_transform</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span> <span class="k">else</span> <span class="n">right_sample</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Generate an LLM prompt to transform the </span><span class="si">{</span><span class="n">dataset_to_transform</span><span class="si">}</span><span class="s2"> dataset for easier joining. The transformation should create a new key-value pair.</span>

<span class="s2">                Current comparison prompt for the join operation: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;comparison_prompt&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No comparison prompt provided.&#39;</span><span class="p">)</span><span class="si">}</span>

<span class="s2">                Target (</span><span class="si">{</span><span class="n">dataset_to_transform</span><span class="si">}</span><span class="s2">) dataset sample:</span>
<span class="s2">                </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">target_data</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">                Other (</span><span class="si">{</span><span class="s1">&#39;left&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">dataset_to_transform</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;right&quot;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;right&quot;</span><span class="si">}</span><span class="s2">) dataset sample:</span>
<span class="s2">                </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">right_sample</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">dataset_to_transform</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;left&quot;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">left_sample</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">                Reason for transforming </span><span class="si">{</span><span class="n">dataset_to_transform</span><span class="si">}</span><span class="s2"> dataset: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span>

<span class="s2">                Please provide:</span>
<span class="s2">                1. An LLM prompt to extract a smaller representation of what is relevant to the join task. The prompt should be a Jinja2 template, referring to any fields in the input data as </span><span class="se">{{{{</span><span class="s2"> input.field_name </span><span class="se">}}}}</span><span class="s2">. The prompt should instruct the LLM to return some **non-empty** string-valued output. The transformation should be tailored to the join task if possible, not just a generic summary of the data.</span>
<span class="s2">                2. A name for the new output key that will store the transformed data.</span>
<span class="s2">                3. An edited comparison prompt that leverages the new attribute created by the transformation. This prompt should be a Jinja2 template, referring to any fields in the input data as </span><span class="se">{{{{</span><span class="s2"> left.field_name </span><span class="se">}}}}</span><span class="s2"> and </span><span class="se">{{{{</span><span class="s2"> right.field_name </span><span class="se">}}}}</span><span class="s2">. The prompt should be the same as the current comparison prompt, but with a new instruction that leverages the new attribute created by the transformation (in addition to the other fields in the prompt). The prompt should instruct the LLM to return a boolean-valued output, like the current comparison prompt.&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
            <span class="n">messages</span><span class="p">,</span>
            <span class="s2">&quot;You are an AI expert in data analysis and decomposing complex data processing pipelines.&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;extraction_prompt&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;output_key&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;new_comparison_prompt&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                <span class="p">},</span>
                <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;extraction_prompt&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;output_key&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;new_comparison_prompt&quot;</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;extraction_prompt&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;left.&quot;</span><span class="p">,</span> <span class="s2">&quot;input.&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;right.&quot;</span><span class="p">,</span> <span class="s2">&quot;input.&quot;</span><span class="p">),</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;output_key&quot;</span><span class="p">],</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;new_comparison_prompt&quot;</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_blocking_keys_equijoin</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">left_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">right_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="c1"># Sample data</span>
        <span class="n">left_sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">left_data</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">)))</span>
        <span class="n">right_sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">right_data</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_data</span><span class="p">)))</span>

        <span class="c1"># Prepare sample data for LLM</span>
        <span class="n">left_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">left_sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">right_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">right_sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Given the following sample data from two datasets, select appropriate blocking keys for an equijoin operation.</span>
<span class="s2">                The blocking process works as follows:</span>
<span class="s2">                1. We create embeddings for the selected keys from both datasets.</span>
<span class="s2">                2. We use cosine similarity between these embeddings to filter pairs for more detailed LLM comparison.</span>
<span class="s2">                3. Pairs with high similarity will be passed to the LLM for final comparison.</span>

<span class="s2">                The blocking keys should have relatively short values and be useful for generating embeddings that capture the essence of potential matches.</span>

<span class="s2">                Left dataset keys: </span><span class="si">{</span><span class="n">left_keys</span><span class="si">}</span>
<span class="s2">                Right dataset keys: </span><span class="si">{</span><span class="n">right_keys</span><span class="si">}</span>

<span class="s2">                Sample from left dataset:</span>
<span class="s2">                </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">left_sample</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">                Sample from right dataset:</span>
<span class="s2">                </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">right_sample</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">                For context, here is the comparison prompt that will be used for the more detailed LLM comparison:</span>
<span class="s2">                </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;comparison_prompt&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No comparison prompt provided.&#39;</span><span class="p">)</span><span class="si">}</span>

<span class="s2">                Please select one or more keys from each dataset that would be suitable for blocking. The keys should contain information that&#39;s likely to be similar in matching records and align with the comparison prompt&#39;s focus.&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
            <span class="n">messages</span><span class="p">,</span>
            <span class="s2">&quot;You are an expert in entity matching and database operations.&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;left_blocking_keys&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;List of selected blocking keys from the left dataset&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;right_blocking_keys&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;List of selected blocking keys from the right dataset&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">},</span>
                <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;left_blocking_keys&quot;</span><span class="p">,</span> <span class="s2">&quot;right_blocking_keys&quot;</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="n">left_blocking_keys</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;left_blocking_keys&quot;</span><span class="p">]</span>
        <span class="n">right_blocking_keys</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;right_blocking_keys&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">left_blocking_keys</span><span class="p">,</span> <span class="n">right_blocking_keys</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_embeddings</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">is_join</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_keys&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">prompt_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">prompt_vars</span> <span class="o">=</span> <span class="n">extract_jinja_variables</span><span class="p">(</span><span class="n">prompt_template</span><span class="p">)</span>
                <span class="c1"># Get rid of input, input1, input2</span>
                <span class="n">prompt_vars</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">var</span>
                    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">prompt_vars</span>
                    <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;input1&quot;</span><span class="p">,</span> <span class="s2">&quot;input2&quot;</span><span class="p">]</span>
                <span class="p">]</span>

                <span class="c1"># strip all things before . in the prompt_vars</span>
                <span class="n">keys</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">prompt_vars</span><span class="p">]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keys</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s2">&quot;[yellow]Warning: No blocking keys found. Using all keys for blocking.[/yellow]&quot;</span>
                <span class="p">)</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">model_input_context_length</span> <span class="o">=</span> <span class="n">model_cost</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;embedding_model&quot;</span><span class="p">,</span> <span class="s2">&quot;text-embedding-3-small&quot;</span><span class="p">),</span> <span class="p">{}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_input_tokens&quot;</span><span class="p">,</span> <span class="mi">8192</span><span class="p">)</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">)[</span>
                <span class="p">:</span><span class="n">model_input_context_length</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_data</span>
        <span class="p">]</span>

        <span class="n">embeddings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">2000</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">texts</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[cyan]Processing batch </span><span class="si">{</span><span class="n">i</span><span class="o">//</span><span class="n">batch_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span><span class="o">//</span><span class="n">batch_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">[/cyan]&quot;</span>
            <span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">gen_embedding</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;embedding_model&quot;</span><span class="p">,</span> <span class="s2">&quot;text-embedding-3-small&quot;</span><span class="p">),</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">embeddings</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;embedding&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]])</span>
            <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">completion_cost</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;embedding&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]]</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">completion_cost</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">cost</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_cosine_similarities</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="n">embeddings_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span>
        <span class="n">norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">embeddings_array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dot_products</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">embeddings_array</span><span class="p">,</span> <span class="n">embeddings_array</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">similarities_matrix</span> <span class="o">=</span> <span class="n">dot_products</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">norms</span><span class="p">,</span> <span class="n">norms</span><span class="p">)</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">embeddings</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">similarities</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">j</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">similarities_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">similarities</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_print_similarity_histogram</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">similarities</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
        <span class="n">comparison_results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span>
    <span class="p">):</span>
        <span class="n">flat_similarities</span> <span class="o">=</span> <span class="p">[</span><span class="n">sim</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">sim</span> <span class="ow">in</span> <span class="n">similarities</span> <span class="k">if</span> <span class="n">sim</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">hist</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">flat_similarities</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">max_bar_width</span><span class="p">,</span> <span class="n">max_count</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
        <span class="n">normalized_hist</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="n">max_count</span> <span class="o">*</span> <span class="n">max_bar_width</span><span class="p">)</span> <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">hist</span><span class="p">]</span>

        <span class="c1"># Create a dictionary to store true labels</span>
        <span class="n">true_labels</span> <span class="o">=</span> <span class="p">{(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span> <span class="n">is_match</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">is_match</span> <span class="ow">in</span> <span class="n">comparison_results</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold]Embedding Cosine Similarity Distribution:[/bold]&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">normalized_hist</span><span class="p">):</span>
            <span class="n">bar</span> <span class="o">=</span> <span class="s2">&quot;█&quot;</span> <span class="o">*</span> <span class="n">count</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bin_edges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">bin_edges</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># Count true matches and not matches in this bin</span>
            <span class="n">true_matches</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">not_matches</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">labeled_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">sim</span> <span class="ow">in</span> <span class="n">similarities</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bin_edges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">sim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bin_edges</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">in</span> <span class="n">true_labels</span><span class="p">:</span>
                        <span class="n">labeled_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">true_labels</span><span class="p">[(</span><span class="n">sim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sim</span><span class="p">[</span><span class="mi">1</span><span class="p">])]:</span>
                            <span class="n">true_matches</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">not_matches</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Calculate percentages of labeled pairs</span>
            <span class="k">if</span> <span class="n">labeled_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">true_match_percent</span> <span class="o">=</span> <span class="p">(</span><span class="n">true_matches</span> <span class="o">/</span> <span class="n">labeled_count</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="n">not_match_percent</span> <span class="o">=</span> <span class="p">(</span><span class="n">not_matches</span> <span class="o">/</span> <span class="n">labeled_count</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">true_match_percent</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">not_match_percent</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">bar</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(Labeled: </span><span class="si">{</span><span class="n">labeled_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">hist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">, [green]</span><span class="si">{</span><span class="n">true_match_percent</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% match[/green], [red]</span><span class="si">{</span><span class="n">not_match_percent</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% not match[/red])&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_sample_pairs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">similarities</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
        <span class="c1"># Sort similarities in descending order</span>
        <span class="n">sorted_similarities</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">similarities</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Calculate weights using exponential weighting with self.sampling_weight</span>
        <span class="n">similarities_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">sim</span> <span class="ow">in</span> <span class="n">sorted_similarities</span><span class="p">])</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sampling_weight</span> <span class="o">*</span> <span class="n">similarities_array</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">/=</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># Normalize weights to sum to 1</span>

        <span class="c1"># Sample pairs based on the calculated weights</span>
        <span class="n">sampled_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">sorted_similarities</span><span class="p">),</span>
            <span class="n">size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_similarities</span><span class="p">)),</span>
            <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">p</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">sampled_pairs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">sorted_similarities</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">sorted_similarities</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sampled_indices</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">sampled_pairs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_cross_similarities</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">left_embeddings</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="n">right_embeddings</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="n">left_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">left_embeddings</span><span class="p">)</span>
        <span class="n">right_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">right_embeddings</span><span class="p">)</span>
        <span class="n">dot_product</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">left_array</span><span class="p">,</span> <span class="n">right_array</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">norm_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">left_array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">norm_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">right_array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">similarities</span> <span class="o">=</span> <span class="n">dot_product</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">norm_left</span><span class="p">,</span> <span class="n">norm_right</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">sim</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">similarities</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">sim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_perform_comparisons_resolve</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">pairs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">comparisons</span><span class="p">,</span> <span class="n">total_cost</span> <span class="o">=</span> <span class="p">[],</span> <span class="mi">0</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">ResolveOperation</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">default_model</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">compare_pair</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;comparison_model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">)</span>
                    <span class="p">),</span>
                    <span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">input_data</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">pairs</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">future</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">futures</span><span class="p">,</span> <span class="n">pairs</span><span class="p">):</span>
                <span class="n">is_match</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="n">comparisons</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">is_match</span><span class="p">))</span>
                <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">cost</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[bold]Cost of pairwise comparisons on the sample: $</span><span class="si">{</span><span class="n">total_cost</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">[/bold]&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">comparisons</span><span class="p">,</span> <span class="n">total_cost</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_perform_comparisons_equijoin</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">left_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">right_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">pairs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">comparisons</span><span class="p">,</span> <span class="n">total_cost</span> <span class="o">=</span> <span class="p">[],</span> <span class="mi">0</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">EquijoinOperation</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">default_model</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">compare_pair</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;comparison_model&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">)</span>
                    <span class="p">),</span>
                    <span class="n">left_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">right_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">if</span> <span class="n">right_data</span> <span class="k">else</span> <span class="n">left_data</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">pairs</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">future</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">futures</span><span class="p">,</span> <span class="n">pairs</span><span class="p">):</span>
                <span class="n">is_match</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="n">comparisons</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">is_match</span><span class="p">))</span>
                <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">cost</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[bold]Cost of pairwise comparisons on the sample: $</span><span class="si">{</span><span class="n">total_cost</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">[/bold]&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">comparisons</span><span class="p">,</span> <span class="n">total_cost</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_find_optimal_threshold</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">comparisons</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span>
        <span class="n">similarities</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">true_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">comp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comparisons</span><span class="p">])</span>
        <span class="n">sim_dict</span> <span class="o">=</span> <span class="p">{(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span> <span class="n">sim</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">sim</span> <span class="ow">in</span> <span class="n">similarities</span><span class="p">}</span>
        <span class="n">sim_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sim_dict</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">comparisons</span><span class="p">])</span>

        <span class="n">thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">precisions</span><span class="p">,</span> <span class="n">recalls</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">threshold</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">:</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">sim_scores</span> <span class="o">&gt;=</span> <span class="n">threshold</span>
            <span class="n">tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">predictions</span> <span class="o">&amp;</span> <span class="n">true_labels</span><span class="p">)</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">predictions</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">true_labels</span><span class="p">)</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">predictions</span> <span class="o">&amp;</span> <span class="n">true_labels</span><span class="p">)</span>

            <span class="n">precision</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">recall</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

            <span class="n">precisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span>
            <span class="n">recalls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recall</span><span class="p">)</span>

        <span class="n">valid_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recalls</span><span class="p">)</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_recall</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_indices</span><span class="p">:</span>
            <span class="n">optimal_threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">recalls</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">optimal_threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">)])</span>

        <span class="c1"># Improved selectivity estimation</span>
        <span class="n">all_similarities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">similarities</span><span class="p">])</span>
        <span class="n">sampled_similarities</span> <span class="o">=</span> <span class="n">sim_scores</span>

        <span class="c1"># Calculate sampling probabilities</span>
        <span class="n">sampling_probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sampling_weight</span> <span class="o">*</span> <span class="n">sampled_similarities</span><span class="p">)</span>
        <span class="n">sampling_probs</span> <span class="o">/=</span> <span class="n">sampling_probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Estimate selectivity using importance sampling</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_similarities</span><span class="p">)</span> <span class="o">*</span> <span class="n">sampling_probs</span><span class="p">)</span>
        <span class="n">numerator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">true_labels</span><span class="p">)</span>
        <span class="n">denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">selectivity_estimate</span> <span class="o">=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="s2">&quot;[bold cyan]┌─ Estimated Self-Join Selectivity ─────────────────────────┐[/bold cyan]&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[bold cyan]│[/bold cyan] [yellow]Target Recall:[/yellow] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_recall</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[bold cyan]│[/bold cyan] [yellow]Estimate:[/yellow] </span><span class="si">{</span><span class="n">selectivity_estimate</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="s2">&quot;[bold cyan]└───────────────────────────────────────────────────────────┘[/bold cyan]&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[bold]Chosen similarity threshold for blocking: </span><span class="si">{</span><span class="n">optimal_threshold</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">[/bold]&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">optimal_threshold</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">selectivity_estimate</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_blocking_rules</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">blocking_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">comparisons</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># Sample 2 true and 2 false comparisons</span>
        <span class="n">true_comparisons</span> <span class="o">=</span> <span class="p">[</span><span class="n">comp</span> <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comparisons</span> <span class="k">if</span> <span class="n">comp</span><span class="p">[</span><span class="mi">2</span><span class="p">]][:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">false_comparisons</span> <span class="o">=</span> <span class="p">[</span><span class="n">comp</span> <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comparisons</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">comp</span><span class="p">[</span><span class="mi">2</span><span class="p">]][:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">sample_datas</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">blocking_keys</span><span class="p">},</span>
                <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">input_data</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">blocking_keys</span><span class="p">},</span>
                <span class="n">is_match</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">is_match</span> <span class="ow">in</span> <span class="n">true_comparisons</span> <span class="o">+</span> <span class="n">false_comparisons</span>
        <span class="p">]</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Given the following sample comparisons between entities, generate a single-line Python statement that acts as a blocking rule for entity resolution. This rule will be used in the form: `eval(blocking_rule, </span><span class="se">{{</span><span class="s2">&quot;input1&quot;: item1, &quot;input2&quot;: item2</span><span class="se">}}</span><span class="s2">)`.</span>

<span class="s2">    Sample comparisons (note: these are just a few examples and may not represent all possible cases):</span>
<span class="s2">    </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sample_datas</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">    For context, here is the comparison prompt that will be used for the more expensive, detailed comparison:</span>
<span class="s2">    </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;comparison_prompt&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No comparison prompt provided.&#39;</span><span class="p">)</span><span class="si">}</span>

<span class="s2">    Please generate ONE one-line blocking rule that adheres to the following criteria:</span>
<span class="s2">    1. The rule should evaluate to True if the entities are possibly a match and require further comparison.</span>
<span class="s2">    2. The rule should evaluate to False ONLY if the entities are definitely not a match.</span>
<span class="s2">    3. The rule must be a single Python expression that can be evaluated using the eval() function.</span>
<span class="s2">    4. The rule should be much faster to evaluate than the full comparison prompt.</span>
<span class="s2">    5. The rule should capture the essence of the comparison prompt but in a simplified manner.</span>
<span class="s2">    6. The rule should be general enough to work well on the entire dataset, not just these specific examples.</span>
<span class="s2">    7. The rule should handle inconsistent casing by using string methods like .lower() when comparing string values.</span>
<span class="s2">    8. The rule should err on the side of inclusivity - it&#39;s better to have false positives than false negatives.</span>

<span class="s2">    Example structure of a one-line blocking rule:</span>
<span class="s2">    &quot;(condition1) or (condition2) or (condition3)&quot;</span>

<span class="s2">    Where conditions could be comparisons like:</span>
<span class="s2">    &quot;input1[&#39;field&#39;].lower() == input2[&#39;field&#39;].lower()&quot;</span>
<span class="s2">    &quot;abs(len(input1[&#39;text&#39;]) - len(input2[&#39;text&#39;])) &lt;= 5&quot;</span>
<span class="s2">    &quot;any(word in input1[&#39;description&#39;].lower() for word in input2[&#39;description&#39;].lower().split())&quot;</span>

<span class="s2">    If there&#39;s no clear rule that can be generated based on the given information, return the string &quot;True&quot; to ensure all pairs are compared.</span>

<span class="s2">    Remember, the primary goal of the blocking rule is to safely reduce the number of comparisons by quickly identifying pairs that are definitely not matches, while keeping all potential matches for further evaluation.&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_max_retries</span><span class="p">):</span>  <span class="c1"># Up to 3 attempts</span>
            <span class="c1"># Generate blocking rule using the LLM</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
                <span class="n">messages</span><span class="p">,</span>
                <span class="s2">&quot;You are an expert in entity resolution and Python programming. Your task is to generate one efficient blocking rule based on the given sample comparisons and data structure.&quot;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;blocking_rule&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;One-line Python statement acting as a blocking rule&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;blocking_rule&quot;</span><span class="p">],</span>
                <span class="p">},</span>
            <span class="p">)</span>

            <span class="c1"># Extract the blocking rule from the LLM response</span>
            <span class="n">blocking_rule</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
            <span class="n">blocking_rule</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">blocking_rule</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_rule&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">blocking_rule</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># Print a newline</span>

                <span class="k">if</span> <span class="n">blocking_rule</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="s2">&quot;[yellow]No suitable blocking rule could be found. Proceeding without a blocking rule.[/yellow]&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="p">[]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[bold]Generated blocking rule (Attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">):[/bold] </span><span class="si">{</span><span class="n">blocking_rule</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="c1"># Test the blocking rule</span>
                <span class="n">filtered_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_blocking_rule</span><span class="p">(</span>
                    <span class="n">input_data</span><span class="p">,</span> <span class="n">blocking_keys</span><span class="p">,</span> <span class="n">blocking_rule</span><span class="p">,</span> <span class="n">comparisons</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">filtered_pairs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="s2">&quot;[green]Blocking rule looks good! No known matches were filtered out.[/green]&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">blocking_rule</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">feedback</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The previous rule incorrectly filtered out </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> known matches. &quot;</span>
                    <span class="n">feedback</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="s2">&quot;Here are up to 3 examples of incorrectly filtered pairs:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">filtered_pairs</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
                        <span class="n">feedback</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Item 1: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">blocking_keys</span><span class="p">})</span><span class="si">}</span><span class="se">\n</span><span class="s2">Item 2: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">input_data</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">blocking_keys</span><span class="p">})</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="n">feedback</span> <span class="o">+=</span> <span class="s2">&quot;These pairs are known matches but were filtered out by the rule.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">feedback</span> <span class="o">+=</span> <span class="s2">&quot;Please generate a new rule that doesn&#39;t filter out these matches.&quot;</span>

                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">blocking_rule</span><span class="p">})</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">feedback</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[yellow]No blocking rule generated.[/yellow]&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[yellow]Failed to generate a suitable blocking rule after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_max_retries</span><span class="si">}</span><span class="s2"> attempts. Proceeding without a blocking rule.[/yellow]&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_test_blocking_rule</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">blocking_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">blocking_rule</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">comparisons</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">apply_blocking_rule</span><span class="p">(</span><span class="n">item1</span><span class="p">,</span> <span class="n">item2</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">blocking_rule</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;input1&quot;</span><span class="p">:</span> <span class="n">item1</span><span class="p">,</span> <span class="s2">&quot;input2&quot;</span><span class="p">:</span> <span class="n">item2</span><span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Error applying blocking rule: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># If there&#39;s an error, we default to comparing the pair</span>

        <span class="n">filtered_pairs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">is_match</span> <span class="ow">in</span> <span class="n">comparisons</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_match</span><span class="p">:</span>
                <span class="n">item1</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">blocking_keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="n">item2</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">input_data</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">blocking_keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">apply_blocking_rule</span><span class="p">(</span><span class="n">item1</span><span class="p">,</span> <span class="n">item2</span><span class="p">):</span>
                    <span class="n">filtered_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">filtered_pairs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[yellow italic]LLM Correction: The blocking rule incorrectly filtered out </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> known positive matches.[/yellow italic]&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">filtered_pairs</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>  <span class="c1"># Show up to 5 examples</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  Incorrectly filtered pair 1: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">blocking_keys</span><span class="p">})</span><span class="si">}</span><span class="s2">  and pair 2: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">input_data</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">blocking_keys</span><span class="p">})</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  ... and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_pairs</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> more incorrect pairs.&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">filtered_pairs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_containment_rules_equijoin</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">left_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">right_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># Get all available keys from the sample data</span>
        <span class="n">left_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">left_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">right_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">right_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># Find the keys that are in the config&#39;s prompt</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">left_prompt_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;{{ left.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; }}&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Error parsing comparison prompt: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
            <span class="n">left_prompt_keys</span> <span class="o">=</span> <span class="n">left_keys</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">right_prompt_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comparison_prompt&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;{{ right.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; }}&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Error parsing comparison prompt: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
            <span class="n">right_prompt_keys</span> <span class="o">=</span> <span class="n">right_keys</span>

        <span class="c1"># Sample a few records from each dataset</span>
        <span class="n">sample_left</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">left_data</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_data</span><span class="p">)))</span>
        <span class="n">sample_right</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">right_data</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_data</span><span class="p">)))</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;You are an AI assistant tasked with generating containment-based blocking rules for an equijoin operation.&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Generate multiple one-line Python statements that act as containment-based blocking rules for equijoin. These rules will be used in the form: `eval(blocking_rule, </span><span class="se">{{</span><span class="s2">&quot;left&quot;: item1, &quot;right&quot;: item2</span><span class="se">}}</span><span class="s2">)`.</span>

<span class="s2">Available keys in left dataset: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">left_keys</span><span class="p">)</span><span class="si">}</span>
<span class="s2">Available keys in right dataset: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">right_keys</span><span class="p">)</span><span class="si">}</span>

<span class="s2">Sample data from left dataset:</span>
<span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sample_left</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">Sample data from right dataset:</span>
<span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sample_right</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">Comparison prompt used for detailed comparison:</span>
<span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;comparison_prompt&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No comparison prompt provided.&#39;</span><span class="p">)</span><span class="si">}</span>

<span class="s2">Please generate multiple one-line blocking rules that adhere to the following criteria:</span>
<span class="s2">1. The rules should focus on containment relationships between fields in the left and right datasets. Containment can mean that the left field contains all the words in the right field, or the right field contains all the words in the left field.</span>
<span class="s2">2. Each rule should evaluate to True if there&#39;s a potential match based on containment, False otherwise.</span>
<span class="s2">3. Rules must be single Python expressions that can be evaluated using the eval() function.</span>
<span class="s2">4. Rules should handle inconsistent casing by using string methods like .lower() when comparing string values.</span>
<span class="s2">5. Consider the length of the fields when generating rules: for example, if the left field is much longer than the right field, it&#39;s more likely to contain all the words in the right field.</span>

<span class="s2">Example structures of containment-based blocking rules:</span>
<span class="s2">&quot;all(word in left[&#39;</span><span class="se">{{</span><span class="s2">left_key</span><span class="se">}}</span><span class="s2">&#39;].lower() for word in right[&#39;</span><span class="se">{{</span><span class="s2">right_key</span><span class="se">}}</span><span class="s2">&#39;].lower().split())&quot;</span>
<span class="s2">&quot;any(word in right[&#39;</span><span class="se">{{</span><span class="s2">right_key</span><span class="se">}}</span><span class="s2">&#39;].lower().split() for word in left[&#39;</span><span class="se">{{</span><span class="s2">left_key</span><span class="se">}}</span><span class="s2">&#39;].lower().split())&quot;</span>

<span class="s2">Please provide 3-5 different containment-based blocking rules, based on the keys and sample data provided. Prioritize rules with the following keys: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">left_prompt_keys</span><span class="p">)</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">right_prompt_keys</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
            <span class="n">messages</span><span class="p">,</span>
            <span class="s2">&quot;You are an expert in data matching and Python programming.&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;containment_rules&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;List of containment-based blocking rules as Python expressions&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;containment_rules&quot;</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="n">containment_rules</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
        <span class="n">containment_rules</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">containment_rules</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;containment_rules&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">containment_rules</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_blocking_rules_equijoin</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">left_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">right_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">left_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">right_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">comparisons</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">left_keys</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">right_keys</span><span class="p">:</span>
            <span class="n">left_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">left_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">right_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">right_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># Sample 2 true and 2 false comparisons</span>
        <span class="n">true_comparisons</span> <span class="o">=</span> <span class="p">[</span><span class="n">comp</span> <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comparisons</span> <span class="k">if</span> <span class="n">comp</span><span class="p">[</span><span class="mi">2</span><span class="p">]][:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">false_comparisons</span> <span class="o">=</span> <span class="p">[</span><span class="n">comp</span> <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comparisons</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">comp</span><span class="p">[</span><span class="mi">2</span><span class="p">]][:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">sample_datas</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">left_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">left_keys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">left_data</span><span class="p">[</span><span class="n">i</span><span class="p">]},</span>
                <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">right_data</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">right_keys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">right_data</span><span class="p">[</span><span class="n">j</span><span class="p">]},</span>
                <span class="n">is_match</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">is_match</span> <span class="ow">in</span> <span class="n">true_comparisons</span> <span class="o">+</span> <span class="n">false_comparisons</span>
        <span class="p">]</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Given the following sample comparisons between entities, generate a single-line Python statement that acts as a blocking rule for equijoin. This rule will be used in the form: `eval(blocking_rule, </span><span class="se">{{</span><span class="s2">&quot;left&quot;: item1, &quot;right&quot;: item2</span><span class="se">}}</span><span class="s2">)`.</span>

<span class="s2">    Sample comparisons (note: these are just a few examples and may not represent all possible cases):</span>
<span class="s2">    </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sample_datas</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">    For context, here is the comparison prompt that will be used for the more expensive, detailed comparison:</span>
<span class="s2">    </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;comparison_prompt&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No comparison prompt provided.&#39;</span><span class="p">)</span><span class="si">}</span>

<span class="s2">    Please generate ONE one-line blocking rule that adheres to the following criteria:</span>
<span class="s2">    1. The rule should evaluate to True if the entities are possibly a match and require further comparison.</span>
<span class="s2">    2. The rule should evaluate to False ONLY if the entities are definitely not a match.</span>
<span class="s2">    3. The rule must be a single Python expression that can be evaluated using the eval() function.</span>
<span class="s2">    4. The rule should be much faster to evaluate than the full comparison prompt.</span>
<span class="s2">    5. The rule should capture the essence of the comparison prompt but in a simplified manner.</span>
<span class="s2">    6. The rule should be general enough to work well on the entire dataset, not just these specific examples.</span>
<span class="s2">    7. The rule should handle inconsistent casing by using string methods like .lower() when comparing string values.</span>
<span class="s2">    8. The rule should err on the side of inclusivity - it&#39;s better to have false positives than false negatives.</span>

<span class="s2">    Example structure of a one-line blocking rule:</span>
<span class="s2">    &quot;(condition1) or (condition2) or (condition3)&quot;</span>

<span class="s2">    Where conditions could be comparisons like:</span>
<span class="s2">    &quot;left[&#39;</span><span class="si">{</span><span class="n">left_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;].lower() == right[&#39;</span><span class="si">{</span><span class="n">right_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;].lower()&quot;</span>
<span class="s2">    &quot;abs(len(left[&#39;</span><span class="si">{</span><span class="n">left_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;]) - len(right[&#39;</span><span class="si">{</span><span class="n">right_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;])) &lt;= 5&quot;</span>
<span class="s2">    &quot;any(word in left[&#39;</span><span class="si">{</span><span class="n">left_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;].lower() for word in right[&#39;</span><span class="si">{</span><span class="n">right_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;].lower().split())&quot;</span>

<span class="s2">    If there&#39;s no clear rule that can be generated based on the given information, return the string &quot;True&quot; to ensure all pairs are compared.</span>

<span class="s2">    Remember, the primary goal of the blocking rule is to safely reduce the number of comparisons by quickly identifying pairs that are definitely not matches, while keeping all potential matches for further evaluation.&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_max_retries</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate_rewrite</span><span class="p">(</span>
                <span class="n">messages</span><span class="p">,</span>
                <span class="s2">&quot;You are an expert in entity resolution and Python programming. Your task is to generate one efficient blocking rule based on the given sample comparisons and data structure.&quot;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;blocking_rule&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;One-line Python statement acting as a blocking rule&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;blocking_rule&quot;</span><span class="p">],</span>
                <span class="p">},</span>
            <span class="p">)</span>

            <span class="n">blocking_rule</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
            <span class="n">blocking_rule</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">blocking_rule</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_rule&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">blocking_rule</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">blocking_rule</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="s2">&quot;[yellow]No suitable blocking rule could be found. Proceeding without a blocking rule.[/yellow]&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="p">[]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[bold]Generated blocking rule (Attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">):[/bold] </span><span class="si">{</span><span class="n">blocking_rule</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="c1"># Test the blocking rule</span>
                <span class="n">filtered_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_blocking_rule_equijoin</span><span class="p">(</span>
                    <span class="n">left_data</span><span class="p">,</span>
                    <span class="n">right_data</span><span class="p">,</span>
                    <span class="n">left_keys</span><span class="p">,</span>
                    <span class="n">right_keys</span><span class="p">,</span>
                    <span class="n">blocking_rule</span><span class="p">,</span>
                    <span class="n">comparisons</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">filtered_pairs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="s2">&quot;[green]Blocking rule looks good! No known matches were filtered out.[/green]&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">blocking_rule</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">feedback</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The previous rule incorrectly filtered out </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> known matches. &quot;</span>
                    <span class="n">feedback</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="s2">&quot;Here are up to 3 examples of incorrectly filtered pairs:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">filtered_pairs</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
                        <span class="n">feedback</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Left: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">left_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">left_keys</span><span class="p">})</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="n">feedback</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Right: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">right_data</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">right_keys</span><span class="p">})</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="n">feedback</span> <span class="o">+=</span> <span class="s2">&quot;These pairs are known matches but were filtered out by the rule.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">feedback</span> <span class="o">+=</span> <span class="s2">&quot;Please generate a new rule that doesn&#39;t filter out these matches.&quot;</span>

                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">blocking_rule</span><span class="p">})</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">feedback</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[yellow]No blocking rule generated.[/yellow]&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[yellow]Failed to generate a suitable blocking rule after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_max_retries</span><span class="si">}</span><span class="s2"> attempts. Proceeding without a blocking rule.[/yellow]&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_test_blocking_rule_equijoin</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">left_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">right_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">left_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">right_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">blocking_rule</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">comparisons</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">apply_blocking_rule</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">blocking_rule</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="n">left</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="n">right</span><span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Error applying blocking rule: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># If there&#39;s an error, we default to comparing the pair</span>

        <span class="n">filtered_pairs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">is_match</span> <span class="ow">in</span> <span class="n">comparisons</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_match</span><span class="p">:</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">left_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">right</span> <span class="o">=</span> <span class="n">right_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">apply_blocking_rule</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
                    <span class="n">filtered_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">filtered_pairs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[yellow italic]LLM Correction: The blocking rule incorrectly filtered out </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> known positive matches.[/yellow italic]&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">filtered_pairs</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>  <span class="c1"># Show up to 5 examples</span>
                <span class="n">left_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">left_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">left_keys</span><span class="p">}</span>
                <span class="n">right_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">right_data</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">right_keys</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  Incorrectly filtered pair - Left: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">left_dict</span><span class="p">)</span><span class="si">}</span><span class="s2">  Right: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">right_dict</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  ... and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_pairs</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> more incorrect pairs.&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">filtered_pairs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_verify_blocking_rule_equijoin</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">left_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">right_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">blocking_rule</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">left_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">right_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">comparison_results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">apply_blocking_rule</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">blocking_rule</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="n">left</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="n">right</span><span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Error applying blocking rule: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># If there&#39;s an error, we default to comparing the pair</span>

        <span class="n">false_negatives</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_pairs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">blocked_pairs</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">is_match</span> <span class="ow">in</span> <span class="n">comparison_results</span><span class="p">:</span>
            <span class="n">total_pairs</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">left_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">right_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">apply_blocking_rule</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
                <span class="n">blocked_pairs</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">is_match</span><span class="p">:</span>
                    <span class="n">false_negatives</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>

        <span class="n">rule_selectivity</span> <span class="o">=</span> <span class="n">blocked_pairs</span> <span class="o">/</span> <span class="n">total_pairs</span> <span class="k">if</span> <span class="n">total_pairs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">false_negatives</span><span class="p">,</span> <span class="n">rule_selectivity</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_config_equijoin</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">left_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">right_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">blocking_rules</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">optimized_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;blocking_keys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="n">left_keys</span><span class="p">,</span>
            <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="n">right_keys</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;blocking_threshold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="k">if</span> <span class="n">blocking_rules</span><span class="p">:</span>
            <span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;blocking_conditions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">blocking_rules</span>
        <span class="k">if</span> <span class="s2">&quot;embedding_model&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">optimized_config</span><span class="p">:</span>
            <span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;embedding_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;text-embedding-3-small&quot;</span>
        <span class="k">return</span> <span class="n">optimized_config</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_verify_blocking_rule</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">blocking_rule</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">blocking_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">comparison_results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">apply_blocking_rule</span><span class="p">(</span><span class="n">item1</span><span class="p">,</span> <span class="n">item2</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">blocking_rule</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;input1&quot;</span><span class="p">:</span> <span class="n">item1</span><span class="p">,</span> <span class="s2">&quot;input2&quot;</span><span class="p">:</span> <span class="n">item2</span><span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Error applying blocking rule: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># If there&#39;s an error, we default to comparing the pair</span>

        <span class="n">false_negatives</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_pairs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">blocked_pairs</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">is_match</span> <span class="ow">in</span> <span class="n">comparison_results</span><span class="p">:</span>
            <span class="n">total_pairs</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">item1</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">blocking_keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span>
            <span class="n">item2</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">input_data</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">blocking_keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">[</span><span class="n">j</span><span class="p">]}</span>

            <span class="k">if</span> <span class="n">apply_blocking_rule</span><span class="p">(</span><span class="n">item1</span><span class="p">,</span> <span class="n">item2</span><span class="p">):</span>
                <span class="n">blocked_pairs</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">is_match</span><span class="p">:</span>
                    <span class="n">false_negatives</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>

        <span class="n">rule_selectivity</span> <span class="o">=</span> <span class="n">blocked_pairs</span> <span class="o">/</span> <span class="n">total_pairs</span> <span class="k">if</span> <span class="n">total_pairs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">false_negatives</span><span class="p">,</span> <span class="n">rule_selectivity</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_config</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">blocking_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">blocking_rules</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">optimized_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;blocking_keys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">blocking_keys</span>
        <span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;blocking_threshold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="k">if</span> <span class="n">blocking_rules</span><span class="p">:</span>
            <span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;blocking_conditions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">blocking_rules</span>
        <span class="k">if</span> <span class="s2">&quot;embedding_model&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">optimized_config</span><span class="p">:</span>
            <span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;embedding_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;text-embedding-3-small&quot;</span>
        <span class="k">return</span> <span class="n">optimized_config</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="docetl.optimizers.join_optimizer.JoinOptimizer.should_optimize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">should_optimize</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Determine if the given operation configuration should be optimized.</p>


            <details class="quote">
              <summary>Source code in <code>docetl/optimizers/join_optimizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">should_optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine if the given operation configuration should be optimized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If there are no blocking keys or embeddings, then we don&#39;t need to optimize</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_conditions&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;blocking_threshold&quot;</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># Check if the operation is marked as empty</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;empty&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Extract the map prompt from the intermediates</span>
        <span class="n">map_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;_intermediates&quot;</span><span class="p">][</span><span class="s2">&quot;map_prompt&quot;</span><span class="p">]</span>
        <span class="n">reduce_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;_intermediates&quot;</span><span class="p">][</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">reduce_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;[yellow]Warning: No reduce key found in intermediates for synthesized resolve operation.[/yellow]&quot;</span>
            <span class="p">)</span>

        <span class="n">dedup</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">explanation</span> <span class="o">=</span> <span class="s2">&quot;There is a reduce operation that does not follow a resolve operation. Consider adding a resolve operation to deduplicate the data.&quot;</span>

        <span class="k">if</span> <span class="n">map_prompt</span><span class="p">:</span>
            <span class="c1"># Analyze the map prompt</span>
            <span class="n">analysis</span><span class="p">,</span> <span class="n">explanation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_map_prompt_categorization</span><span class="p">(</span>
                <span class="n">map_prompt</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">analysis</span><span class="p">:</span>
                <span class="n">dedup</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="s2">&quot;[yellow]No map prompt found in intermediates for analysis.[/yellow]&quot;</span>
            <span class="p">)</span>

        <span class="c1"># TODO: figure out why this would ever be the case</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">map_prompt</span><span class="p">:</span>
            <span class="n">map_prompt</span> <span class="o">=</span> <span class="s2">&quot;N/A&quot;</span>

        <span class="k">if</span> <span class="n">dedup</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">dedup</span><span class="p">,</span> <span class="n">explanation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_duplicate_keys</span><span class="p">(</span>
                <span class="n">input_data</span><span class="p">,</span> <span class="n">reduce_key</span><span class="p">,</span> <span class="n">map_prompt</span>
            <span class="p">)</span>

        <span class="c1"># Now do the last attempt of pairwise comparisons</span>
        <span class="k">if</span> <span class="n">dedup</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># Sample up to 20 random pairs of keys for duplicate analysis</span>
            <span class="n">sampled_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_random_pairs</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

            <span class="c1"># Use LLM to check for duplicates</span>
            <span class="n">duplicates_found</span><span class="p">,</span> <span class="n">explanation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_duplicates_with_llm</span><span class="p">(</span>
                <span class="n">input_data</span><span class="p">,</span> <span class="n">sampled_pairs</span><span class="p">,</span> <span class="n">reduce_key</span><span class="p">,</span> <span class="n">map_prompt</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">duplicates_found</span><span class="p">:</span>
                <span class="n">dedup</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">dedup</span><span class="p">,</span> <span class="n">explanation</span>

    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../operations/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Operations">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Operations
              </div>
            </div>
          </a>
        
        
          
          <a href="../python/" class="md-footer__link md-footer__link--next" aria-label="Next: Python API">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Python API
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.instant.prefetch", "navigation.tracking", "navigation.expand", "navigation.path", "navigation.prune", "navigation.indexes", "navigation.top", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "toc.follow", "navigation.footer", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>