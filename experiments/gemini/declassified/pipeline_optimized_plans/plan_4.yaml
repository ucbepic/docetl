datasets:
  articles:
    path: experiments/gemini/declassified/blackvault_articles_pdfs.json
    type: file
default_model: gemini/gemini-2.0-flash
operations:
- associative: true
  fold_batch_size: 324
  fold_prompt: 'For extraterrestrial/paranormal events of type "{{ reduce_key }}",
    continue analyzing these incident reports:


    {% for report in inputs %}

    Report {{ loop.index }}:

    {{ report.content }}

    {% if report.pdf_content %}

    Additional PDF content:

    {{ report.pdf_content | truncate(10000) }}

    {% endif %}

    {% endfor %}


    Update the list of unique locations of observation mentioned across these reports.
    They should be real locations on Earth. Combine these with the current list of
    locations in {{ output.locations }} to ensure all locations are included without
    duplicates.'
  gleaning:
    num_rounds: 1
    validation_prompt: '1. Does the output list all unique locations of observation
      mentioned in the reports, ensuring they are real locations on Earth as specified
      in the task?

      2. Are there any locations that appear to be missing or incorrectly identified
      as not being on Earth?

      3. Does the output maintain the integrity of the input data by accurately reflecting
      the locations mentioned without introducing errors or omissions?'
  model: gemini/gemini-2.0-flash
  name: gleaning_1_rounds_aggregate_locations_bs_324_fp_0
  optimize: true
  output:
    schema:
      locations: list[str]
  prompt: 'For extraterrestrial/paranormal events of type "{{ reduce_key }}", analyze
    these incident reports:


    {% for report in inputs %}

    Report {{ loop.index }}:

    {{ report.content }}

    {% if report.pdf_content %}

    Additional PDF content:

    {{ report.pdf_content | truncate(10000) }}

    {% endif %}

    {% endfor %}


    Extract and list all unique locations of observation mentioned across these reports.
    They should be real locations on Earth.

    '
  reduce_key:
  - event_type
  type: reduce
- blocking_keys:
  - event_type
  blocking_threshold: 0.6869
  comparison_prompt: 'Compare these two event types from extraterrestrial/paranormal
    incident reports:


    Type 1: {{ input1.event_type }}

    Type 2: {{ input2.event_type }}


    Are these describing similar categories of event? Consider if they are synonyms
    or closely related subcategories.

    '
  embedding_model: text-embedding-3-small
  model: azure/gpt-4o-mini
  name: resolve_event_types
  optimize: true
  output:
    schema:
      event_type: str
  resolution_prompt: 'Given these similar event type categorizations:

    {% for entry in inputs %}

    - {{ entry.event_type }}

    {% endfor %}


    Provide a single standardized category name that best represents all of these
    related event types. It should not be long. A few words at most.

    '
  type: resolve
  verbose: true
- associative: true
  input: &id001
    schema:
      event_type: str
  model: gemini/gemini-2.0-flash
  name: subreduce_extract_event_type
  output: *id001
  pass_through: true
  prompt: 'You are tasked with consolidating the types of extraterrestrial or paranormal
    events extracted from different chunks of text.


    Here are the event types extracted from each chunk:

    {% for item in inputs %}

    Event type for chunk {{ loop.index }}:

    {{ item.event_type }}

    {% endfor %}


    Analyze all the event types above and create a single, specific event type category
    that:

    1. Combines similar or related event types into a unified category

    2. Preserves unique event types that appear in only one chunk if they are distinct

    3. Prioritizes event types that appear multiple times across chunks

    4. Maintains the original wording where possible


    Provide the final consolidated event type category, ensuring it is distinct and
    accurately represents the content of the document.'
  reduce_key:
  - split_extract_event_type_id
  synthesize_resolve: false
  type: reduce
- model: gemini/gemini-2.0-flash
  name: submap_extract_event_type
  output:
    schema:
      event_type: str
  prompt: 'Given the following metadata about the document:

    {{ input.metadata }}


    Given the following chunk of document content from the black vault, identify and
    extract the type of extraterrestrial or paranormal event being described:


    {{ input.content_chunk_rendered }}


    Provide a single, specific event type category. Only process the main chunk in
    --- Begin Main Chunk --- and --- End Main Chunk --- delimiters if they are present.'
  type: map
- content_key: content_chunk
  doc_header_key: headers
  doc_id_key: split_extract_event_type_id
  name: gather_content_extract_event_type
  order_key: split_extract_event_type_chunk_num
  peripheral_chunks:
    previous:
      middle:
        content_key: content_summary
      tail:
        count: 1
  type: gather
- name: parallel_map_content_extract_event_type
  output:
    schema:
      content_summary: string
      headers: 'list[{header: string, level: integer}]'
  prompts:
  - model: gemini/gemini-2.0-flash
    name: header_extraction_content_extract_event_type
    output_keys:
    - headers
    prompt: "Analyze the following chunk of a document and extract any headers you\
      \ see.\n\n        {{ input.content_chunk }}\n\n        Examples of headers and\
      \ their levels based on the document structure:\n        - \"Background\" (level\
      \ 1)\n- \"Conclusions\" (level 1)\n- \"1.)\" (level 2)\n- \"2.)\" (level 2)\n\
      - \"3.)\" (level 2)\n\n        Overall structure: The document is structured\
      \ with main sections indicated by bold headers such as 'Background' and 'Conclusions'.\
      \ Within the 'Conclusions' section, there are numbered points that serve as\
      \ subheaders, indicating a hierarchical structure. The main sections provide\
      \ a broad overview, while the numbered subheaders break down specific points\
      \ or findings within those sections. This structure allows for easy navigation\
      \ and understanding of the document's content.\n\n        Provide your analysis\
      \ as a list of dictionaries, where each dictionary contains a 'header' (string)\
      \ and 'level' (integer). For example:\n\n        [\n            {\"header\"\
      : \"Background\", \"level\": 1},\n            {\"header\": \"1.)\", \"level\"\
      : 2}\n        ]\n\n        Only include headers you find in the text, do not\
      \ add any that are not present. Use the patterns described for each level to\
      \ identify headers:\n        Level 1: Level 1 headers are bold and possibly\
      \ larger font size, serving as main section titles.\nLevel 2: Level 2 headers\
      \ are numbered with parentheses, indicating subsections or points within a main\
      \ section.\n        "
  - model: gemini/gemini-2.0-flash
    name: summary_content_extract_event_type
    output_keys:
    - content_summary
    prompt: 'Summarize the following chunk: {{ input.content_chunk }}


      Focus on identifying any specific extraterrestrial or paranormal event types
      mentioned in the chunk.'
  type: parallel_map
- method: token_count
  method_kwargs:
    num_tokens: 762
  name: split_extract_event_type
  split_key: content
  type: split
- model: gemini/gemini-2.0-flash
  name: extract_metadata_extract_event_type
  output:
    schema:
      metadata: str
  prompt: 'Given the following document content, identify and extract the type of
    extraterrestrial or paranormal event being described:


    {{ input.content }}


    Provide a single, specific event type category. Only process the main chunk in
    --- Begin Main Chunk --- and --- End Main Chunk --- delimiters if they are present.'
  type: map
- type: sample
  method: uniform
  random_state: 42
  samples: 500
  name: sample_articles
optimizer_config:
  judge_agent_model: azure/gpt-4o-mini
  model_choices:
  - gemini/gemini-2.0-flash
  - gemini/gemini-2.0-flash-lite-preview-02-05
  rewrite_agent_model: azure/gpt-4o
  sample_sizes:
    resolve: 50
  save_all_plans: true
pipeline:
  output:
    intermediate_dir: experiments/gemini/declassified/plans/intermediate_4
    path: experiments/gemini/declassified/plans/event_locations_4.json
    type: file
  steps:
  - name: analyze_events
    input: articles
    operations:
    - sample_articles
    - extract_metadata_extract_event_type
    - split_extract_event_type
    - parallel_map_content_extract_event_type
    - gather_content_extract_event_type
    - submap_extract_event_type
    - subreduce_extract_event_type
    - resolve_event_types
    - gleaning_1_rounds_aggregate_locations_bs_324_fp_0
