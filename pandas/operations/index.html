
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../examples/">
      
      
      <link rel="icon" href="../../assets/docetl-favicon-color.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Operations - docetl docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CSource+Code+Pro:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"Source Code Pro"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="#FDB515">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#semantic-operations" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="docetl docs" class="md-header__button md-logo" aria-label="docetl docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M0 112c0-41.5 31.6-75.6 72-79.6V32h280c53 0 96 43 96 96v176H272c-39.8 0-72 32.2-72 72v60c0 24.3-19.7 44-44 44s-44-19.7-44-44V208H48c-26.5 0-48-21.5-48-48zm236.8 368c7.1-13.1 11.2-28.1 11.2-44v-60c0-13.3 10.7-24 24-24h248c13.3 0 24 10.7 24 24v24c0 44.2-35.8 80-80 80zM80 80c-17.7 0-32 14.3-32 32v48h64v-48c0-17.7-14.3-32-32-32"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            docetl docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Operations
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="#FDB515"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="#FDB515"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="#FDB515"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/ucbepic/docetl" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    ucbepic/docetl
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  
    
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../concepts/operators/" class="md-tabs__link">
          
  
  
    
  
  User Guide

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../optimization/overview/" class="md-tabs__link">
          
  
  
    
  
  Optimization

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../examples/presidential-debate-themes/" class="md-tabs__link">
          
  
  
    
  
  Tutorials & Examples

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../examples/custom-parsing/" class="md-tabs__link">
          
  
  
    
  
  Developer Reference

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../playground/" class="md-tabs__link">
          
  
  
    
  
  Tools & Resources

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="docetl docs" class="md-nav__button md-logo" aria-label="docetl docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M0 112c0-41.5 31.6-75.6 72-79.6V32h280c53 0 96 43 96 96v176H272c-39.8 0-72 32.2-72 72v60c0 24.3-19.7 44-44 44s-44-19.7-44-44V208H48c-26.5 0-48-21.5-48-48zm236.8 368c7.1-13.1 11.2-28.1 11.2-44v-60c0-13.3 10.7-24 24-24h248c13.3 0 24 10.7 24 24v24c0 44.2-35.8 80-80 80zM80 80c-17.7 0-32 14.3-32 32v48h64v-48c0-17.7-14.3-32-32-32"/></svg>

    </a>
    docetl docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ucbepic/docetl" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    ucbepic/docetl
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../.." class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    User Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Core Concepts
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Core Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/operators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Operators & Validation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/schemas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Output Schemas
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/pipelines/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pipelines
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/optimization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Optimization
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Retrieval
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Retrieval
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../retrievers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Retrievers
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    LLM-Powered Operators
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            LLM-Powered Operators
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operators/map/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Map
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operators/resolve/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Resolve
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operators/reduce/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Reduce
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operators/parallel-map/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Parallel Map
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operators/filter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Filter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operators/equijoin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Equijoin
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operators/rank/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rank
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operators/extract/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Extract
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operators/cluster/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cluster
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Auxiliary Operators
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            Auxiliary Operators
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operators/split/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Split
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operators/gather/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Gather
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operators/unnest/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Unnest
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operators/sample/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sample
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operators/topk/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TopK
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operators/code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Code
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" checked>
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    APIs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            APIs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../python/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Python API Guide
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5_2" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Pandas Integration
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_5_2" id="__nav_2_5_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_5_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_5_2">
            <span class="md-nav__icon md-icon"></span>
            Pandas Integration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Operations
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Operations
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#map-operation" class="md-nav__link">
    <span class="md-ellipsis">
      Map Operation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Map Operation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.apis.pd_accessors.SemanticAccessor.map" class="md-nav__link">
    <span class="md-ellipsis">
      map
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filter-operation" class="md-nav__link">
    <span class="md-ellipsis">
      Filter Operation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Filter Operation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.apis.pd_accessors.SemanticAccessor.filter" class="md-nav__link">
    <span class="md-ellipsis">
      filter
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#merge-operation-experimental" class="md-nav__link">
    <span class="md-ellipsis">
      Merge Operation (Experimental)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Merge Operation (Experimental)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.apis.pd_accessors.SemanticAccessor.merge" class="md-nav__link">
    <span class="md-ellipsis">
      merge
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregate-operation" class="md-nav__link">
    <span class="md-ellipsis">
      Aggregate Operation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Aggregate Operation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.apis.pd_accessors.SemanticAccessor.agg" class="md-nav__link">
    <span class="md-ellipsis">
      agg
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#split-operation" class="md-nav__link">
    <span class="md-ellipsis">
      Split Operation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Split Operation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.apis.pd_accessors.SemanticAccessor.split" class="md-nav__link">
    <span class="md-ellipsis">
      split
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gather-operation" class="md-nav__link">
    <span class="md-ellipsis">
      Gather Operation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Gather Operation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.apis.pd_accessors.SemanticAccessor.gather" class="md-nav__link">
    <span class="md-ellipsis">
      gather
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unnest-operation" class="md-nav__link">
    <span class="md-ellipsis">
      Unnest Operation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Unnest Operation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.apis.pd_accessors.SemanticAccessor.unnest" class="md-nav__link">
    <span class="md-ellipsis">
      unnest
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-features" class="md-nav__link">
    <span class="md-ellipsis">
      Common Features
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../optimization/overview/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Optimization
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../examples/presidential-debate-themes/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Tutorials & Examples
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../examples/custom-parsing/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Developer Reference
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../playground/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Tools & Resources
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#map-operation" class="md-nav__link">
    <span class="md-ellipsis">
      Map Operation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Map Operation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.apis.pd_accessors.SemanticAccessor.map" class="md-nav__link">
    <span class="md-ellipsis">
      map
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filter-operation" class="md-nav__link">
    <span class="md-ellipsis">
      Filter Operation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Filter Operation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.apis.pd_accessors.SemanticAccessor.filter" class="md-nav__link">
    <span class="md-ellipsis">
      filter
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#merge-operation-experimental" class="md-nav__link">
    <span class="md-ellipsis">
      Merge Operation (Experimental)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Merge Operation (Experimental)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.apis.pd_accessors.SemanticAccessor.merge" class="md-nav__link">
    <span class="md-ellipsis">
      merge
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregate-operation" class="md-nav__link">
    <span class="md-ellipsis">
      Aggregate Operation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Aggregate Operation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.apis.pd_accessors.SemanticAccessor.agg" class="md-nav__link">
    <span class="md-ellipsis">
      agg
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#split-operation" class="md-nav__link">
    <span class="md-ellipsis">
      Split Operation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Split Operation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.apis.pd_accessors.SemanticAccessor.split" class="md-nav__link">
    <span class="md-ellipsis">
      split
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gather-operation" class="md-nav__link">
    <span class="md-ellipsis">
      Gather Operation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Gather Operation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.apis.pd_accessors.SemanticAccessor.gather" class="md-nav__link">
    <span class="md-ellipsis">
      gather
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unnest-operation" class="md-nav__link">
    <span class="md-ellipsis">
      Unnest Operation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Unnest Operation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.apis.pd_accessors.SemanticAccessor.unnest" class="md-nav__link">
    <span class="md-ellipsis">
      unnest
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-features" class="md-nav__link">
    <span class="md-ellipsis">
      Common Features
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="semantic-operations">Semantic Operations</h1>
<p>The pandas integration provides several semantic operations through the <code>.semantic</code> accessor. Each operation is designed to handle specific types of transformations and analyses using LLMs.</p>
<p>All semantic operations return a new DataFrame that preserves the original columns and adds new columns based on the output schema. For example, if your original DataFrame has a column <code>text</code> and you use <code>map</code> with an <code>output={"schema": {"sentiment": "str", "keywords": "list[str]"}}</code>, the resulting DataFrame will have three columns: <code>text</code>, <code>sentiment</code>, and <code>keywords</code>. This makes it easy to chain operations and maintain data lineage.</p>
<h2 id="map-operation">Map Operation</h2>


<div class="doc doc-object doc-function">



<a id="docetl.apis.pd_accessors.SemanticAccessor.map"></a>
    <div class="doc doc-contents first">

        <p>Apply semantic mapping to each row using a language model.</p>
<p>Documentation: https://ucbepic.github.io/docetl/operators/map/</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prompt</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Jinja template string for generating prompts. Use {{input.column_name}}
   to reference input columns.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing output configuration with keys:
   - "schema": Dictionary defining the expected output structure and types.
              Example: {"entities": "list[str]", "sentiment": "str"}
   - "mode": Optional output mode. Either "tools" (default) or "structured_output".
            "structured_output" uses native JSON schema mode for supported models.
   - "n": Optional number of outputs to generate for each input (synthetic data generation)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_schema</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DEPRECATED. Use 'output' parameter instead.
          Dictionary defining the expected output structure for backward compatibility.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional configuration options:
- model: LLM model to use (default: from config)
- batch_prompt: Template for processing multiple documents in a single prompt
- max_batch_size: Maximum number of documents to process in a single batch
- optimize: Flag to enable operation optimization (default: True)
- recursively_optimize: Flag to enable recursive optimization (default: False)
- sample: Number of samples to use for the operation
- tools: List of tool definitions for LLM use
- validate: List of Python expressions to validate output
- num_retries_on_validate_failure: Number of retry attempts (default: 0)
- gleaning: Configuration for LLM-based refinement
- drop_keys: List of keys to drop from input
- timeout: Timeout for each LLM call in seconds (default: 120)
- max_retries_per_timeout: Maximum retries per timeout (default: 2)
- litellm_completion_kwargs: Additional parameters for LiteLLM
- skip_on_error: Skip operation if LLM returns error (default: False)
- bypass_cache: Bypass cache for this operation (default: False)
- n: Number of outputs to generate for each input (synthetic data generation)</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: A new DataFrame containing the transformed data with columns
         matching the output schema.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Extract entities and sentiment</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Analyze this text: {{input.text}}&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">output</span><span class="o">=</span><span class="p">{</span>
<span class="gp">... </span>        <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="gp">... </span>            <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="s2">&quot;list[str]&quot;</span><span class="p">,</span>
<span class="gp">... </span>            <span class="s2">&quot;sentiment&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span>
<span class="gp">... </span>        <span class="p">}</span>
<span class="gp">... </span>    <span class="p">},</span>
<span class="gp">... </span>    <span class="n">validate</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;len(output[&#39;entities&#39;]) &lt;= 5&quot;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">num_retries_on_validate_failure</span><span class="o">=</span><span class="mi">2</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Generate synthetic data with multiple variations per input</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Create a headline for: {{input.topic}}&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">output</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;headline&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span><span class="p">},</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Use structured output mode for better JSON schema support</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Extract structured data: {{input.text}}&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">output</span><span class="o">=</span><span class="p">{</span>
<span class="gp">... </span>        <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="s2">&quot;list[str]&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;structured_output&quot;</span>
<span class="gp">... </span>    <span class="p">}</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>docetl/apis/pd_accessors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">output_schema</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply semantic mapping to each row using a language model.</span>

<span class="sd">    Documentation: https://ucbepic.github.io/docetl/operators/map/</span>

<span class="sd">    Args:</span>
<span class="sd">        prompt: Jinja template string for generating prompts. Use {{input.column_name}}</span>
<span class="sd">               to reference input columns.</span>
<span class="sd">        output: Dictionary containing output configuration with keys:</span>
<span class="sd">               - &quot;schema&quot;: Dictionary defining the expected output structure and types.</span>
<span class="sd">                          Example: {&quot;entities&quot;: &quot;list[str]&quot;, &quot;sentiment&quot;: &quot;str&quot;}</span>
<span class="sd">               - &quot;mode&quot;: Optional output mode. Either &quot;tools&quot; (default) or &quot;structured_output&quot;.</span>
<span class="sd">                        &quot;structured_output&quot; uses native JSON schema mode for supported models.</span>
<span class="sd">               - &quot;n&quot;: Optional number of outputs to generate for each input (synthetic data generation)</span>
<span class="sd">        output_schema: DEPRECATED. Use &#39;output&#39; parameter instead.</span>
<span class="sd">                      Dictionary defining the expected output structure for backward compatibility.</span>
<span class="sd">        **kwargs: Additional configuration options:</span>
<span class="sd">            - model: LLM model to use (default: from config)</span>
<span class="sd">            - batch_prompt: Template for processing multiple documents in a single prompt</span>
<span class="sd">            - max_batch_size: Maximum number of documents to process in a single batch</span>
<span class="sd">            - optimize: Flag to enable operation optimization (default: True)</span>
<span class="sd">            - recursively_optimize: Flag to enable recursive optimization (default: False)</span>
<span class="sd">            - sample: Number of samples to use for the operation</span>
<span class="sd">            - tools: List of tool definitions for LLM use</span>
<span class="sd">            - validate: List of Python expressions to validate output</span>
<span class="sd">            - num_retries_on_validate_failure: Number of retry attempts (default: 0)</span>
<span class="sd">            - gleaning: Configuration for LLM-based refinement</span>
<span class="sd">            - drop_keys: List of keys to drop from input</span>
<span class="sd">            - timeout: Timeout for each LLM call in seconds (default: 120)</span>
<span class="sd">            - max_retries_per_timeout: Maximum retries per timeout (default: 2)</span>
<span class="sd">            - litellm_completion_kwargs: Additional parameters for LiteLLM</span>
<span class="sd">            - skip_on_error: Skip operation if LLM returns error (default: False)</span>
<span class="sd">            - bypass_cache: Bypass cache for this operation (default: False)</span>
<span class="sd">            - n: Number of outputs to generate for each input (synthetic data generation)</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: A new DataFrame containing the transformed data with columns</span>
<span class="sd">                     matching the output schema.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Extract entities and sentiment</span>
<span class="sd">        &gt;&gt;&gt; df.semantic.map(</span>
<span class="sd">        ...     prompt=&quot;Analyze this text: {{input.text}}&quot;,</span>
<span class="sd">        ...     output={</span>
<span class="sd">        ...         &quot;schema&quot;: {</span>
<span class="sd">        ...             &quot;entities&quot;: &quot;list[str]&quot;,</span>
<span class="sd">        ...             &quot;sentiment&quot;: &quot;str&quot;</span>
<span class="sd">        ...         }</span>
<span class="sd">        ...     },</span>
<span class="sd">        ...     validate=[&quot;len(output[&#39;entities&#39;]) &lt;= 5&quot;],</span>
<span class="sd">        ...     num_retries_on_validate_failure=2</span>
<span class="sd">        ... )</span>

<span class="sd">        &gt;&gt;&gt; # Generate synthetic data with multiple variations per input</span>
<span class="sd">        &gt;&gt;&gt; df.semantic.map(</span>
<span class="sd">        ...     prompt=&quot;Create a headline for: {{input.topic}}&quot;,</span>
<span class="sd">        ...     output={&quot;schema&quot;: {&quot;headline&quot;: &quot;str&quot;}, &quot;n&quot;: 5}</span>
<span class="sd">        ... )</span>

<span class="sd">        &gt;&gt;&gt; # Use structured output mode for better JSON schema support</span>
<span class="sd">        &gt;&gt;&gt; df.semantic.map(</span>
<span class="sd">        ...     prompt=&quot;Extract structured data: {{input.text}}&quot;,</span>
<span class="sd">        ...     output={</span>
<span class="sd">        ...         &quot;schema&quot;: {&quot;name&quot;: &quot;str&quot;, &quot;age&quot;: &quot;int&quot;, &quot;tags&quot;: &quot;list[str]&quot;},</span>
<span class="sd">        ...         &quot;mode&quot;: &quot;structured_output&quot;</span>
<span class="sd">        ...     }</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert DataFrame to list of dicts for DocETL</span>
    <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>

    <span class="c1"># Handle backward compatibility: if output_schema is provided, convert it to output format</span>
    <span class="k">if</span> <span class="n">output_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">output_schema</span><span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;n&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">output</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output_schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either &#39;output&#39; or &#39;output_schema&#39; must be provided&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Cannot provide both &#39;output&#39; and &#39;output_schema&#39; parameters&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Validate output parameter</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;output must be a dictionary&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;schema&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;output must contain a &#39;schema&#39; key&quot;</span><span class="p">)</span>

    <span class="c1"># Validate output mode if provided</span>
    <span class="n">output_mode</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="s2">&quot;tools&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="s2">&quot;structured_output&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;output mode must be &#39;tools&#39; or &#39;structured_output&#39;, got &#39;</span><span class="si">{</span><span class="n">output_mode</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Create map operation config</span>
    <span class="n">map_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;map&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;semantic_map_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
        <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">output</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Create and execute map operation</span>
    <span class="n">map_op</span> <span class="o">=</span> <span class="n">MapOperation</span><span class="p">(</span>
        <span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="n">map_config</span><span class="p">,</span>
        <span class="n">default_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;default_model&quot;</span><span class="p">],</span>
        <span class="n">max_threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
        <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">results</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">map_op</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_operation</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s2">&quot;map&quot;</span><span class="p">,</span> <span class="n">map_config</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><p>Example usage:
<div class="highlight"><pre><span></span><code><span class="c1"># Basic map operation</span>
<span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
    <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Extract sentiment and key points from: {{input.text}}&quot;</span><span class="p">,</span>
    <span class="n">output</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;sentiment&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span><span class="p">,</span>
            <span class="s2">&quot;key_points&quot;</span><span class="p">:</span> <span class="s2">&quot;list[str]&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="n">validate</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;len(output[&#39;key_points&#39;]) &lt;= 5&quot;</span><span class="p">],</span>
    <span class="n">num_retries_on_validate_failure</span><span class="o">=</span><span class="mi">2</span>
<span class="p">)</span>

<span class="c1"># Using structured output mode for better JSON schema support</span>
<span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
    <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Extract detailed information from: {{input.text}}&quot;</span><span class="p">,</span>
    <span class="n">output</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;company&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span><span class="p">,</span>
            <span class="s2">&quot;product&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span><span class="p">,</span>
            <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="s2">&quot;list[str]&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;structured_output&quot;</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Backward compatible syntax (still supported)</span>
<span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
    <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Extract sentiment from: {{input.text}}&quot;</span><span class="p">,</span>
    <span class="n">output_schema</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sentiment&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span><span class="p">}</span>
<span class="p">)</span>
</code></pre></div></p>
<h2 id="filter-operation">Filter Operation</h2>


<div class="doc doc-object doc-function">



<a id="docetl.apis.pd_accessors.SemanticAccessor.filter"></a>
    <div class="doc doc-contents first">

        <p>Filter DataFrame rows based on semantic conditions.</p>
<p>Documentation: https://ucbepic.github.io/docetl/operators/filter/</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prompt</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Jinja template string for generating prompts</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output configuration with keys:
- "schema": Dictionary defining the expected output structure and types
  For filtering, this must be a single boolean field (e.g., {"keep": "bool"})
- "mode": Optional output mode. Either "tools" (default) or "structured_output"</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_schema</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DEPRECATED. Use 'output' parameter instead. Backward-compatible schema dict.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional configuration options:
- model: LLM model to use
- validate: List of validation expressions
- num_retries_on_validate_failure: Number of retries
- timeout: Timeout in seconds (default: 120)
- max_retries_per_timeout: Max retries per timeout (default: 2)
- skip_on_error: Skip rows on LLM error (default: False)
- bypass_cache: Bypass cache for this operation (default: False)</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: Filtered DataFrame containing only rows where the model
         returned True</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Simple filtering</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Is this about technology? {{input.text}}&quot;</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Custom output schema</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Analyze if this is relevant: {{input.text}}&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">output</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;keep&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span><span class="p">}}</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>docetl/apis/pd_accessors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_schema</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter DataFrame rows based on semantic conditions.</span>

<span class="sd">    Documentation: https://ucbepic.github.io/docetl/operators/filter/</span>

<span class="sd">    Args:</span>
<span class="sd">        prompt: Jinja template string for generating prompts</span>
<span class="sd">        output: Output configuration with keys:</span>
<span class="sd">            - &quot;schema&quot;: Dictionary defining the expected output structure and types</span>
<span class="sd">              For filtering, this must be a single boolean field (e.g., {&quot;keep&quot;: &quot;bool&quot;})</span>
<span class="sd">            - &quot;mode&quot;: Optional output mode. Either &quot;tools&quot; (default) or &quot;structured_output&quot;</span>
<span class="sd">        output_schema: DEPRECATED. Use &#39;output&#39; parameter instead. Backward-compatible schema dict.</span>
<span class="sd">        **kwargs: Additional configuration options:</span>
<span class="sd">            - model: LLM model to use</span>
<span class="sd">            - validate: List of validation expressions</span>
<span class="sd">            - num_retries_on_validate_failure: Number of retries</span>
<span class="sd">            - timeout: Timeout in seconds (default: 120)</span>
<span class="sd">            - max_retries_per_timeout: Max retries per timeout (default: 2)</span>
<span class="sd">            - skip_on_error: Skip rows on LLM error (default: False)</span>
<span class="sd">            - bypass_cache: Bypass cache for this operation (default: False)</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Filtered DataFrame containing only rows where the model</span>
<span class="sd">                     returned True</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Simple filtering</span>
<span class="sd">        &gt;&gt;&gt; df.semantic.filter(</span>
<span class="sd">        ...     prompt=&quot;Is this about technology? {{input.text}}&quot;</span>
<span class="sd">        ... )</span>

<span class="sd">        &gt;&gt;&gt; # Custom output schema</span>
<span class="sd">        &gt;&gt;&gt; df.semantic.filter(</span>
<span class="sd">        ...     prompt=&quot;Analyze if this is relevant: {{input.text}}&quot;,</span>
<span class="sd">        ...     output={&quot;schema&quot;: {&quot;keep&quot;: &quot;bool&quot;, &quot;reason&quot;: &quot;str&quot;}}</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert DataFrame to list of dicts</span>
    <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>

    <span class="c1"># Backward compatibility and defaults</span>
    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">output_schema</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output_schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;keep&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">}}</span>

    <span class="c1"># Validate output</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;output must be a dictionary&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;schema&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;output must contain a &#39;schema&#39; key&quot;</span><span class="p">)</span>
    <span class="n">output_mode</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="s2">&quot;tools&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="s2">&quot;structured_output&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;output mode must be &#39;tools&#39; or &#39;structured_output&#39;, got &#39;</span><span class="si">{</span><span class="n">output_mode</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Create map operation config for filtering</span>
    <span class="n">filter_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;map&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;semantic_filter_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
        <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">output</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Create and execute filter operation</span>
    <span class="n">filter_op</span> <span class="o">=</span> <span class="n">FilterOperation</span><span class="p">(</span>
        <span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="n">filter_config</span><span class="p">,</span>
        <span class="n">default_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;default_model&quot;</span><span class="p">],</span>
        <span class="n">max_threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
        <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">results</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">filter_op</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_operation</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s2">&quot;filter&quot;</span><span class="p">,</span> <span class="n">filter_config</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><p>Example usage:
<div class="highlight"><pre><span></span><code><span class="c1"># Simple filtering</span>
<span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Is this text about technology? {{input.text}}&quot;</span>
<span class="p">)</span>

<span class="c1"># Custom output with reasons</span>
<span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Analyze if this is relevant: {{input.text}}&quot;</span><span class="p">,</span>
    <span class="n">output</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;keep&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">,</span>
            <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div></p>
<h2 id="merge-operation-experimental">Merge Operation (Experimental)</h2>
<blockquote>
<p><strong>Note</strong>: The merge operation is an experimental feature based on our equijoin operator. It provides a pandas-like interface for semantic record matching and deduplication. When <code>fuzzy=True</code>, it automatically invokes optimization to improve performance while maintaining accuracy.</p>
</blockquote>


<div class="doc doc-object doc-function">



<a id="docetl.apis.pd_accessors.SemanticAccessor.merge"></a>
    <div class="doc doc-contents first">

        <p>Semantically merge two DataFrames based on flexible matching criteria.</p>
<p>Documentation: https://ucbepic.github.io/docetl/operators/equijoin/</p>
<p>When fuzzy=True and no blocking parameters are provided, this method automatically
invokes the JoinOptimizer to generate efficient blocking conditions. The optimizer
will suggest blocking thresholds and conditions to improve performance while
maintaining the target recall. The optimized configuration will be displayed
for future reuse.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>right</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Right DataFrame to merge with</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>comparison_prompt</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prompt template for comparing records</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fuzzy</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use fuzzy matching with optimization (default: False)</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional configuration options:
- model: LLM model to use
- blocking_threshold: Threshold for blocking optimization
- blocking_conditions: Custom blocking conditions
- target_recall: Target recall for optimization (default: 0.95)
- estimated_selectivity: Estimated match rate
- validate: List of validation expressions
- num_retries_on_validate_failure: Number of retries
- timeout: Timeout in seconds (default: 120)
- max_retries_per_timeout: Max retries per timeout (default: 2)</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: Merged DataFrame containing matched records</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Simple merge</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">merged_df</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">df2</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">comparison_prompt</span><span class="o">=</span><span class="s2">&quot;Are these records about the same entity? {{input1}} vs {{input2}}&quot;</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Fuzzy merge with automatic optimization</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">merged_df</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">df2</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">comparison_prompt</span><span class="o">=</span><span class="s2">&quot;Compare: {{input1}} vs {{input2}}&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">fuzzy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">target_recall</span><span class="o">=</span><span class="mf">0.9</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Fuzzy merge with manual blocking parameters</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">merged_df</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">df2</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">comparison_prompt</span><span class="o">=</span><span class="s2">&quot;Compare: {{input1}} vs {{input2}}&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">fuzzy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">blocking_threshold</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">blocking_conditions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;input1.category == input2.category&quot;</span><span class="p">]</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>docetl/apis/pd_accessors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">right</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">comparison_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">fuzzy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Semantically merge two DataFrames based on flexible matching criteria.</span>

<span class="sd">    Documentation: https://ucbepic.github.io/docetl/operators/equijoin/</span>

<span class="sd">    When fuzzy=True and no blocking parameters are provided, this method automatically</span>
<span class="sd">    invokes the JoinOptimizer to generate efficient blocking conditions. The optimizer</span>
<span class="sd">    will suggest blocking thresholds and conditions to improve performance while</span>
<span class="sd">    maintaining the target recall. The optimized configuration will be displayed</span>
<span class="sd">    for future reuse.</span>

<span class="sd">    Args:</span>
<span class="sd">        right: Right DataFrame to merge with</span>
<span class="sd">        comparison_prompt: Prompt template for comparing records</span>
<span class="sd">        fuzzy: Whether to use fuzzy matching with optimization (default: False)</span>
<span class="sd">        **kwargs: Additional configuration options:</span>
<span class="sd">            - model: LLM model to use</span>
<span class="sd">            - blocking_threshold: Threshold for blocking optimization</span>
<span class="sd">            - blocking_conditions: Custom blocking conditions</span>
<span class="sd">            - target_recall: Target recall for optimization (default: 0.95)</span>
<span class="sd">            - estimated_selectivity: Estimated match rate</span>
<span class="sd">            - validate: List of validation expressions</span>
<span class="sd">            - num_retries_on_validate_failure: Number of retries</span>
<span class="sd">            - timeout: Timeout in seconds (default: 120)</span>
<span class="sd">            - max_retries_per_timeout: Max retries per timeout (default: 2)</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Merged DataFrame containing matched records</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Simple merge</span>
<span class="sd">        &gt;&gt;&gt; merged_df = df1.semantic.merge(</span>
<span class="sd">        ...     df2,</span>
<span class="sd">        ...     comparison_prompt=&quot;Are these records about the same entity? {{input1}} vs {{input2}}&quot;</span>
<span class="sd">        ... )</span>

<span class="sd">        &gt;&gt;&gt; # Fuzzy merge with automatic optimization</span>
<span class="sd">        &gt;&gt;&gt; merged_df = df1.semantic.merge(</span>
<span class="sd">        ...     df2,</span>
<span class="sd">        ...     comparison_prompt=&quot;Compare: {{input1}} vs {{input2}}&quot;,</span>
<span class="sd">        ...     fuzzy=True,</span>
<span class="sd">        ...     target_recall=0.9</span>
<span class="sd">        ... )</span>

<span class="sd">        &gt;&gt;&gt; # Fuzzy merge with manual blocking parameters</span>
<span class="sd">        &gt;&gt;&gt; merged_df = df1.semantic.merge(</span>
<span class="sd">        ...     df2,</span>
<span class="sd">        ...     comparison_prompt=&quot;Compare: {{input1}} vs {{input2}}&quot;,</span>
<span class="sd">        ...     fuzzy=False,</span>
<span class="sd">        ...     blocking_threshold=0.8,</span>
<span class="sd">        ...     blocking_conditions=[&quot;input1.category == input2.category&quot;]</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert DataFrames to lists of dicts</span>
    <span class="n">left_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
    <span class="n">right_data</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>

    <span class="c1"># Create equijoin operation config</span>
    <span class="n">join_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;equijoin&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;semantic_merge_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;comparison_prompt&quot;</span><span class="p">:</span> <span class="n">comparison_prompt</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># If fuzzy matching and no blocking params provided, use JoinOptimizer</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">fuzzy</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_threshold&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_conditions&quot;</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="n">join_optimizer</span> <span class="o">=</span> <span class="n">JoinOptimizer</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
            <span class="n">join_config</span><span class="p">,</span>
            <span class="n">target_recall</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_recall&quot;</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
            <span class="n">estimated_selectivity</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;estimated_selectivity&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">optimized_config</span><span class="p">,</span> <span class="n">optimizer_cost</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">join_optimizer</span><span class="o">.</span><span class="n">optimize_equijoin</span><span class="p">(</span>
            <span class="n">left_data</span><span class="p">,</span> <span class="n">right_data</span><span class="p">,</span> <span class="n">skip_map_gen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skip_containment_gen</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># Print optimized config for reuse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="n">Panel</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="s2">&quot;[bold cyan]Optimized Configuration for Merge[/bold cyan]</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;[yellow]Consider adding these parameters to avoid re-running optimization:[/yellow]</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;blocking_threshold: </span><span class="si">{</span><span class="n">optimized_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;blocking_threshold&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;blocking_keys: </span><span class="si">{</span><span class="n">optimized_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;blocking_keys&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;blocking_conditions: </span><span class="si">{</span><span class="n">optimized_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;blocking_conditions&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Optimization Results&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">join_config</span> <span class="o">=</span> <span class="n">optimized_config</span>
        <span class="n">optimizer_cost_value</span> <span class="o">=</span> <span class="n">optimizer_cost</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">optimizer_cost_value</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Create and execute equijoin operation</span>
    <span class="n">join_op</span> <span class="o">=</span> <span class="n">EquijoinOperation</span><span class="p">(</span>
        <span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="n">join_config</span><span class="p">,</span>
        <span class="n">default_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;default_model&quot;</span><span class="p">],</span>
        <span class="n">max_threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
        <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">results</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">join_op</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">left_data</span><span class="p">,</span> <span class="n">right_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_operation</span><span class="p">(</span>
        <span class="n">results</span><span class="p">,</span> <span class="s2">&quot;equijoin&quot;</span><span class="p">,</span> <span class="n">join_config</span><span class="p">,</span> <span class="n">cost</span> <span class="o">+</span> <span class="n">optimizer_cost_value</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><p>Example usage:
<div class="highlight"><pre><span></span><code><span class="c1"># Simple merge</span>
<span class="n">merged_df</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">df2</span><span class="p">,</span>
    <span class="n">comparison_prompt</span><span class="o">=</span><span class="s2">&quot;Are these records about the same entity? {{input1}} vs {{input2}}&quot;</span>
<span class="p">)</span>

<span class="c1"># Fuzzy merge with optimization</span>
<span class="n">merged_df</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">df2</span><span class="p">,</span>
    <span class="n">comparison_prompt</span><span class="o">=</span><span class="s2">&quot;Compare: {{input1}} vs {{input2}}&quot;</span><span class="p">,</span>
    <span class="n">fuzzy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">target_recall</span><span class="o">=</span><span class="mf">0.9</span>
<span class="p">)</span>
</code></pre></div></p>
<h2 id="aggregate-operation">Aggregate Operation</h2>


<div class="doc doc-object doc-function">



<a id="docetl.apis.pd_accessors.SemanticAccessor.agg"></a>
    <div class="doc doc-contents first">

        <p>Semantically aggregate data with optional fuzzy matching.</p>
<p>Documentation:
- Resolve Operation: https://ucbepic.github.io/docetl/operators/resolve/
- Reduce Operation: https://ucbepic.github.io/docetl/operators/reduce/</p>
<p>When fuzzy=True and no blocking parameters are provided in resolve_kwargs,
this method automatically invokes the JoinOptimizer to generate efficient
blocking conditions for the resolve phase. The optimizer will suggest
blocking thresholds and conditions to improve performance while maintaining
the target recall. The optimized configuration will be displayed for future reuse.</p>
<p>The resolve phase is skipped if:
- fuzzy=False
- reduce_keys=["_all"]
- input data has 5 or fewer rows</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>reduce_prompt</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prompt template for the reduction phase</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output configuration with keys:
- "schema": Dictionary defining the expected output structure and types
- "mode": Optional output mode. Either "tools" (default) or "structured_output"</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_schema</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DEPRECATED. Use 'output' parameter instead. Backward-compatible schema dict</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fuzzy</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use fuzzy matching for resolution (default: False)</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>comparison_prompt</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prompt template for comparing records during resolution</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resolution_prompt</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prompt template for resolving conflicts</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resolution_output</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output configuration for resolution (new API with schema key)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resolution_output_schema</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Schema for resolution output (deprecated, use resolution_output)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reduce_keys</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Keys to group by for reduction (default: ["_all"])</p>
              </div>
            </td>
            <td>
                  <code>[&#39;_all&#39;]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resolve_kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional kwargs for resolve operation:
- model: LLM model to use
- blocking_threshold: Threshold for blocking optimization
- blocking_conditions: Custom blocking conditions
- target_recall: Target recall for optimization (default: 0.95)
- estimated_selectivity: Estimated match rate
- validate: List of validation expressions
- num_retries_on_validate_failure: Number of retries
- timeout: Timeout in seconds (default: 120)
- max_retries_per_timeout: Max retries per timeout (default: 2)</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reduce_kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional kwargs for reduce operation:
- model: LLM model to use
- validate: List of validation expressions
- num_retries_on_validate_failure: Number of retries
- timeout: Timeout in seconds (default: 120)
- max_retries_per_timeout: Max retries per timeout (default: 2)</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: Aggregated DataFrame with columns matching output['schema']</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Simple aggregation</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">reduce_prompt</span><span class="o">=</span><span class="s2">&quot;Summarize these items: {{input.text}}&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">output</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span><span class="p">}}</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Fuzzy matching with automatic optimization</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">reduce_prompt</span><span class="o">=</span><span class="s2">&quot;Combine these items: {{input.text}}&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">output</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;combined&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span><span class="p">}},</span>
<span class="gp">... </span>    <span class="n">fuzzy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">comparison_prompt</span><span class="o">=</span><span class="s2">&quot;Are these items similar: {{input1.text}} vs {{input2.text}}&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">resolution_prompt</span><span class="o">=</span><span class="s2">&quot;Resolve conflicts between: {{items}}&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">resolution_output</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;resolved&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span><span class="p">}}</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Fuzzy matching with manual blocking parameters</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">reduce_prompt</span><span class="o">=</span><span class="s2">&quot;Combine these items: {{input.text}}&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">output</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;combined&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span><span class="p">}},</span>
<span class="gp">... </span>    <span class="n">fuzzy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">comparison_prompt</span><span class="o">=</span><span class="s2">&quot;Compare items: {{input1.text}} vs {{input2.text}}&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">resolve_kwargs</span><span class="o">=</span><span class="p">{</span>
<span class="gp">... </span>        <span class="s2">&quot;blocking_threshold&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
<span class="gp">... </span>        <span class="s2">&quot;blocking_conditions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;input1.category == input2.category&quot;</span><span class="p">]</span>
<span class="gp">... </span>    <span class="p">}</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>docetl/apis/pd_accessors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span></pre></div></td><td class="code"><div><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">agg</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="c1"># Reduction phase params (required)</span>
        <span class="n">reduce_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_schema</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="c1"># Resolution and reduce phase params (optional)</span>
        <span class="n">fuzzy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">comparison_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resolution_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resolution_output</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resolution_output_schema</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reduce_keys</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_all&quot;</span><span class="p">],</span>
        <span class="n">resolve_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">reduce_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Semantically aggregate data with optional fuzzy matching.</span>

<span class="sd">        Documentation:</span>
<span class="sd">        - Resolve Operation: https://ucbepic.github.io/docetl/operators/resolve/</span>
<span class="sd">        - Reduce Operation: https://ucbepic.github.io/docetl/operators/reduce/</span>

<span class="sd">        When fuzzy=True and no blocking parameters are provided in resolve_kwargs,</span>
<span class="sd">        this method automatically invokes the JoinOptimizer to generate efficient</span>
<span class="sd">        blocking conditions for the resolve phase. The optimizer will suggest</span>
<span class="sd">        blocking thresholds and conditions to improve performance while maintaining</span>
<span class="sd">        the target recall. The optimized configuration will be displayed for future reuse.</span>

<span class="sd">        The resolve phase is skipped if:</span>
<span class="sd">        - fuzzy=False</span>
<span class="sd">        - reduce_keys=[&quot;_all&quot;]</span>
<span class="sd">        - input data has 5 or fewer rows</span>

<span class="sd">        Args:</span>
<span class="sd">            reduce_prompt: Prompt template for the reduction phase</span>
<span class="sd">            output: Output configuration with keys:</span>
<span class="sd">                - &quot;schema&quot;: Dictionary defining the expected output structure and types</span>
<span class="sd">                - &quot;mode&quot;: Optional output mode. Either &quot;tools&quot; (default) or &quot;structured_output&quot;</span>
<span class="sd">            output_schema: DEPRECATED. Use &#39;output&#39; parameter instead. Backward-compatible schema dict</span>
<span class="sd">            fuzzy: Whether to use fuzzy matching for resolution (default: False)</span>
<span class="sd">            comparison_prompt: Prompt template for comparing records during resolution</span>
<span class="sd">            resolution_prompt: Prompt template for resolving conflicts</span>
<span class="sd">            resolution_output: Output configuration for resolution (new API with schema key)</span>
<span class="sd">            resolution_output_schema: Schema for resolution output (deprecated, use resolution_output)</span>
<span class="sd">            reduce_keys: Keys to group by for reduction (default: [&quot;_all&quot;])</span>
<span class="sd">            resolve_kwargs: Additional kwargs for resolve operation:</span>
<span class="sd">                - model: LLM model to use</span>
<span class="sd">                - blocking_threshold: Threshold for blocking optimization</span>
<span class="sd">                - blocking_conditions: Custom blocking conditions</span>
<span class="sd">                - target_recall: Target recall for optimization (default: 0.95)</span>
<span class="sd">                - estimated_selectivity: Estimated match rate</span>
<span class="sd">                - validate: List of validation expressions</span>
<span class="sd">                - num_retries_on_validate_failure: Number of retries</span>
<span class="sd">                - timeout: Timeout in seconds (default: 120)</span>
<span class="sd">                - max_retries_per_timeout: Max retries per timeout (default: 2)</span>
<span class="sd">            reduce_kwargs: Additional kwargs for reduce operation:</span>
<span class="sd">                - model: LLM model to use</span>
<span class="sd">                - validate: List of validation expressions</span>
<span class="sd">                - num_retries_on_validate_failure: Number of retries</span>
<span class="sd">                - timeout: Timeout in seconds (default: 120)</span>
<span class="sd">                - max_retries_per_timeout: Max retries per timeout (default: 2)</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: Aggregated DataFrame with columns matching output[&#39;schema&#39;]</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; # Simple aggregation</span>
<span class="sd">            &gt;&gt;&gt; df.semantic.agg(</span>
<span class="sd">            ...     reduce_prompt=&quot;Summarize these items: {{input.text}}&quot;,</span>
<span class="sd">            ...     output={&quot;schema&quot;: {&quot;summary&quot;: &quot;str&quot;}}</span>
<span class="sd">            ... )</span>

<span class="sd">            &gt;&gt;&gt; # Fuzzy matching with automatic optimization</span>
<span class="sd">            &gt;&gt;&gt; df.semantic.agg(</span>
<span class="sd">            ...     reduce_prompt=&quot;Combine these items: {{input.text}}&quot;,</span>
<span class="sd">            ...     output={&quot;schema&quot;: {&quot;combined&quot;: &quot;str&quot;}},</span>
<span class="sd">            ...     fuzzy=True,</span>
<span class="sd">            ...     comparison_prompt=&quot;Are these items similar: {{input1.text}} vs {{input2.text}}&quot;,</span>
<span class="sd">            ...     resolution_prompt=&quot;Resolve conflicts between: {{items}}&quot;,</span>
<span class="sd">            ...     resolution_output={&quot;schema&quot;: {&quot;resolved&quot;: &quot;str&quot;}}</span>
<span class="sd">            ... )</span>

<span class="sd">            &gt;&gt;&gt; # Fuzzy matching with manual blocking parameters</span>
<span class="sd">            &gt;&gt;&gt; df.semantic.agg(</span>
<span class="sd">            ...     reduce_prompt=&quot;Combine these items: {{input.text}}&quot;,</span>
<span class="sd">            ...     output={&quot;schema&quot;: {&quot;combined&quot;: &quot;str&quot;}},</span>
<span class="sd">            ...     fuzzy=False,</span>
<span class="sd">            ...     comparison_prompt=&quot;Compare items: {{input1.text}} vs {{input2.text}}&quot;,</span>
<span class="sd">            ...     resolve_kwargs={</span>
<span class="sd">            ...         &quot;blocking_threshold&quot;: 0.8,</span>
<span class="sd">            ...         &quot;blocking_conditions&quot;: [&quot;input1.category == input2.category&quot;]</span>
<span class="sd">            ...     }</span>
<span class="sd">            ... )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert DataFrame to list of dicts</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>

        <span class="c1"># Handle backward compatibility: if output_schema is provided, convert it to output format</span>
        <span class="k">if</span> <span class="n">output_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">output_schema</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output_schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either &#39;output&#39; or &#39;output_schema&#39; must be provided&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot provide both &#39;output&#39; and &#39;output_schema&#39; parameters&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Validate output parameter</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;output must be a dictionary&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;schema&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;output must contain a &#39;schema&#39; key&quot;</span><span class="p">)</span>

        <span class="c1"># Handle backward compatibility for resolution_output_schema</span>
        <span class="k">if</span> <span class="n">resolution_output_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">resolution_output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resolution_output</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">resolution_output_schema</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">resolution_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">resolution_output_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot provide both &#39;resolution_output&#39; and &#39;resolution_output_schema&#39; parameters&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Validate output mode if provided</span>
        <span class="n">output_mode</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="s2">&quot;tools&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="s2">&quot;structured_output&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;output mode must be &#39;tools&#39; or &#39;structured_output&#39;, got &#39;</span><span class="si">{</span><span class="n">output_mode</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Change keys to list</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reduce_keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">reduce_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">reduce_keys</span><span class="p">]</span>

        <span class="c1"># Skip resolution if using _all or fuzzy is False</span>
        <span class="k">if</span> <span class="n">reduce_keys</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;_all&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">fuzzy</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">resolved_data</span> <span class="o">=</span> <span class="n">input_data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Synthesize comparison prompt if not provided</span>
            <span class="k">if</span> <span class="n">comparison_prompt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Build record template from reduce_keys</span>
                <span class="n">record_template</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="se">{{{{</span><span class="s2"> input</span><span class="si">{</span><span class="mi">0</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> </span><span class="se">}}}}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">reduce_keys</span>
                <span class="p">)</span>

                <span class="c1"># Add context about how fields were created</span>
                <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synthesize_comparison_context</span><span class="p">(</span><span class="n">reduce_keys</span><span class="p">)</span>

                <span class="n">comparison_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Do the following two records represent the same concept? Your answer should be true or false.</span><span class="si">{</span><span class="n">context</span><span class="si">}</span>

<span class="s2">Record 1: </span><span class="si">{</span><span class="n">record_template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;input0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;input1&#39;</span><span class="p">)</span><span class="si">}</span>
<span class="s2">Record 2: </span><span class="si">{</span><span class="n">record_template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;input0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;input2&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>

            <span class="c1"># Configure resolution</span>
            <span class="n">resolve_config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;resolve&quot;</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;semantic_resolve_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;comparison_prompt&quot;</span><span class="p">:</span> <span class="n">comparison_prompt</span><span class="p">,</span>
                <span class="o">**</span><span class="n">resolve_kwargs</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># Add resolution prompt and schema if provided</span>
            <span class="k">if</span> <span class="n">resolution_prompt</span><span class="p">:</span>
                <span class="n">resolve_config</span><span class="p">[</span><span class="s2">&quot;resolution_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolution_prompt</span>
                <span class="k">if</span> <span class="n">resolution_output</span><span class="p">:</span>
                    <span class="c1"># Use the new resolution_output format</span>
                    <span class="n">resolve_config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolution_output</span>
                    <span class="k">if</span> <span class="s2">&quot;keys&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resolve_config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]:</span>
                        <span class="c1"># Add keys from schema if not explicitly provided</span>
                        <span class="n">resolve_config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;keys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                            <span class="n">resolution_output</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># No resolution output provided, use reduce_keys</span>
                    <span class="n">resolve_config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;keys&quot;</span><span class="p">:</span> <span class="n">reduce_keys</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resolve_config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;keys&quot;</span><span class="p">:</span> <span class="n">reduce_keys</span><span class="p">}</span>

            <span class="c1"># If blocking params not provided, use JoinOptimizer to synthesize them</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resolve_kwargs</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="s2">&quot;blocking_threshold&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resolve_kwargs</span>
                <span class="ow">and</span> <span class="s2">&quot;blocking_conditions&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resolve_kwargs</span>
            <span class="p">):</span>
                <span class="n">join_optimizer</span> <span class="o">=</span> <span class="n">JoinOptimizer</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
                    <span class="n">resolve_config</span><span class="p">,</span>
                    <span class="n">target_recall</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">resolve_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_recall&quot;</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">resolve_kwargs</span>
                        <span class="k">else</span> <span class="mf">0.95</span>
                    <span class="p">),</span>
                    <span class="n">estimated_selectivity</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">resolve_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;estimated_selectivity&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">resolve_kwargs</span>
                        <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="n">optimized_config</span><span class="p">,</span> <span class="n">optimizer_cost</span> <span class="o">=</span> <span class="n">join_optimizer</span><span class="o">.</span><span class="n">optimize_resolve</span><span class="p">(</span>
                    <span class="n">input_data</span>
                <span class="p">)</span>

                <span class="c1"># Print optimized config for reuse</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="n">Panel</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                        <span class="s2">&quot;[bold cyan]Optimized Configuration for Resolve[/bold cyan]</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;[yellow]Consider adding these parameters to avoid re-running optimization:[/yellow]</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;blocking_threshold: </span><span class="si">{</span><span class="n">optimized_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;blocking_threshold&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;blocking_keys: </span><span class="si">{</span><span class="n">optimized_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;blocking_keys&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;blocking_conditions: </span><span class="si">{</span><span class="n">optimized_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;blocking_conditions&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Optimization Results&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Use provided blocking params</span>
                <span class="n">optimized_config</span> <span class="o">=</span> <span class="n">resolve_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">optimizer_cost</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="c1"># Execute resolution with optimized config</span>
            <span class="n">resolve_op</span> <span class="o">=</span> <span class="n">ResolveOperation</span><span class="p">(</span>
                <span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">optimized_config</span><span class="p">,</span>
                <span class="n">default_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;default_model&quot;</span><span class="p">],</span>
                <span class="n">max_threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
                <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">resolved_data</span><span class="p">,</span> <span class="n">resolve_cost</span> <span class="o">=</span> <span class="n">resolve_op</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_operation</span><span class="p">(</span>
                <span class="n">resolved_data</span><span class="p">,</span>
                <span class="s2">&quot;resolve&quot;</span><span class="p">,</span>
                <span class="n">optimized_config</span><span class="p">,</span>
                <span class="n">resolve_cost</span> <span class="o">+</span> <span class="n">optimizer_cost</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Configure reduction</span>
        <span class="n">reduce_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;reduce&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;semantic_reduce_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;reduce_key&quot;</span><span class="p">:</span> <span class="n">reduce_keys</span><span class="p">,</span>
            <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">reduce_prompt</span><span class="p">,</span>
            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">output</span><span class="p">,</span>
            <span class="o">**</span><span class="n">reduce_kwargs</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Execute reduction</span>
        <span class="n">reduce_op</span> <span class="o">=</span> <span class="n">ReduceOperation</span><span class="p">(</span>
            <span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">reduce_config</span><span class="p">,</span>
            <span class="n">default_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;default_model&quot;</span><span class="p">],</span>
            <span class="n">max_threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
            <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">results</span><span class="p">,</span> <span class="n">reduce_cost</span> <span class="o">=</span> <span class="n">reduce_op</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">resolved_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_operation</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s2">&quot;reduce&quot;</span><span class="p">,</span> <span class="n">reduce_config</span><span class="p">,</span> <span class="n">reduce_cost</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><p>Example usage:
<div class="highlight"><pre><span></span><code><span class="c1"># Simple aggregation</span>
<span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
    <span class="n">reduce_prompt</span><span class="o">=</span><span class="s2">&quot;Summarize these items: {{input.text}}&quot;</span><span class="p">,</span>
    <span class="n">output</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span><span class="p">}}</span>
<span class="p">)</span>

<span class="c1"># Fuzzy matching with custom resolution</span>
<span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
    <span class="n">reduce_prompt</span><span class="o">=</span><span class="s2">&quot;Combine these items: {{input.text}}&quot;</span><span class="p">,</span>
    <span class="n">output</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;combined&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span><span class="p">}},</span>
    <span class="n">fuzzy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">comparison_prompt</span><span class="o">=</span><span class="s2">&quot;Are these items similar: {{input1.text}} vs {{input2.text}}&quot;</span><span class="p">,</span>
    <span class="n">resolution_prompt</span><span class="o">=</span><span class="s2">&quot;Resolve conflicts between: {{items}}&quot;</span><span class="p">,</span>
    <span class="n">resolution_output</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;resolved&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span><span class="p">}}</span>
<span class="p">)</span>
</code></pre></div></p>
<h2 id="split-operation">Split Operation</h2>


<div class="doc doc-object doc-function">



<a id="docetl.apis.pd_accessors.SemanticAccessor.split"></a>
    <div class="doc doc-contents first">

        <pre><code>    Split DataFrame rows into multiple chunks based on content.

    Documentation: https://ucbepic.github.io/docetl/operators/split/

    Args:
        split_key: The column containing content to split
        method: Splitting method, either "token_count" or "delimiter"
        method_kwargs: Dictionary containing method-specific parameters:
            - For "token_count": {"num_tokens": int, "model": str (optional)}
            - For "delimiter": {"delimiter": str, "num_splits_to_group": int (optional)}
        **kwargs: Additional configuration options:
            - model: LLM model to use for tokenization (default: from config)

    Returns:
        pd.DataFrame: DataFrame with split content, including:
            - {split_key}_chunk: The content of each chunk
            - {operation_name}_id: Unique identifier for the original document
            - {operation_name}_chunk_num: Sequential chunk number within the document

    Examples:
        &gt;&gt;&gt; # Split by token count
        &gt;&gt;&gt; df.semantic.split(
        ...     split_key="content",
        ...     method="token_count",
        ...     method_kwargs={"num_tokens": 100}
        ... )

        &gt;&gt;&gt; # Split by delimiter
        &gt;&gt;&gt; df.semantic.split(
        ...     split_key="text",
        ...     method="delimiter",
        ...     method_kwargs={"delimiter": "
</code></pre>
<p>", "num_splits_to_group": 2}
            ... )</p>


            <details class="quote">
              <summary>Source code in <code>docetl/apis/pd_accessors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">split_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">method_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split DataFrame rows into multiple chunks based on content.</span>

<span class="sd">    Documentation: https://ucbepic.github.io/docetl/operators/split/</span>

<span class="sd">    Args:</span>
<span class="sd">        split_key: The column containing content to split</span>
<span class="sd">        method: Splitting method, either &quot;token_count&quot; or &quot;delimiter&quot;</span>
<span class="sd">        method_kwargs: Dictionary containing method-specific parameters:</span>
<span class="sd">            - For &quot;token_count&quot;: {&quot;num_tokens&quot;: int, &quot;model&quot;: str (optional)}</span>
<span class="sd">            - For &quot;delimiter&quot;: {&quot;delimiter&quot;: str, &quot;num_splits_to_group&quot;: int (optional)}</span>
<span class="sd">        **kwargs: Additional configuration options:</span>
<span class="sd">            - model: LLM model to use for tokenization (default: from config)</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: DataFrame with split content, including:</span>
<span class="sd">            - {split_key}_chunk: The content of each chunk</span>
<span class="sd">            - {operation_name}_id: Unique identifier for the original document</span>
<span class="sd">            - {operation_name}_chunk_num: Sequential chunk number within the document</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Split by token count</span>
<span class="sd">        &gt;&gt;&gt; df.semantic.split(</span>
<span class="sd">        ...     split_key=&quot;content&quot;,</span>
<span class="sd">        ...     method=&quot;token_count&quot;,</span>
<span class="sd">        ...     method_kwargs={&quot;num_tokens&quot;: 100}</span>
<span class="sd">        ... )</span>

<span class="sd">        &gt;&gt;&gt; # Split by delimiter</span>
<span class="sd">        &gt;&gt;&gt; df.semantic.split(</span>
<span class="sd">        ...     split_key=&quot;text&quot;,</span>
<span class="sd">        ...     method=&quot;delimiter&quot;,</span>
<span class="sd">        ...     method_kwargs={&quot;delimiter&quot;: &quot;\n\n&quot;, &quot;num_splits_to_group&quot;: 2}</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert DataFrame to list of dicts</span>
    <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>

    <span class="c1"># Create split operation config</span>
    <span class="n">split_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;split&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;semantic_split_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;split_key&quot;</span><span class="p">:</span> <span class="n">split_key</span><span class="p">,</span>
        <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span>
        <span class="s2">&quot;method_kwargs&quot;</span><span class="p">:</span> <span class="n">method_kwargs</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Create and execute split operation</span>
    <span class="n">split_op</span> <span class="o">=</span> <span class="n">SplitOperation</span><span class="p">(</span>
        <span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="n">split_config</span><span class="p">,</span>
        <span class="n">default_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;default_model&quot;</span><span class="p">],</span>
        <span class="n">max_threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
        <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">results</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">split_op</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_operation</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s2">&quot;split&quot;</span><span class="p">,</span> <span class="n">split_config</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><p>Example usage:
<div class="highlight"><pre><span></span><code><span class="c1"># Split by token count</span>
<span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
    <span class="n">split_key</span><span class="o">=</span><span class="s2">&quot;content&quot;</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;token_count&quot;</span><span class="p">,</span>
    <span class="n">method_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;num_tokens&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Split by delimiter</span>
<span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
    <span class="n">split_key</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;delimiter&quot;</span><span class="p">,</span>
    <span class="n">method_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;delimiter&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;num_splits_to_group&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="p">)</span>
</code></pre></div></p>
<h2 id="gather-operation">Gather Operation</h2>


<div class="doc doc-object doc-function">



<a id="docetl.apis.pd_accessors.SemanticAccessor.gather"></a>
    <div class="doc doc-contents first">

        <p>Gather contextual information from surrounding chunks to enhance each chunk.</p>
<p>Documentation: https://ucbepic.github.io/docetl/operators/gather/</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>content_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The column containing the main content to be enhanced</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>doc_id_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The column containing document identifiers to group chunks</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>order_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The column containing chunk order numbers within documents</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>peripheral_chunks</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration for surrounding context:
- previous: {"head": {"count": int}, "tail": {"count": int}, "middle": {}}
- next: {"head": {"count": int}, "tail": {"count": int}, "middle": {}}</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional configuration options:
- main_chunk_start: Start marker for main chunk (default: "--- Begin Main Chunk ---")
- main_chunk_end: End marker for main chunk (default: "--- End Main Chunk ---")
- doc_header_key: Column containing document headers (optional)</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: DataFrame with enhanced content including:
- {content_key}_rendered: The main content with surrounding context</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Basic gathering with surrounding context</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">content_key</span><span class="o">=</span><span class="s2">&quot;chunk_content&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">doc_id_key</span><span class="o">=</span><span class="s2">&quot;document_id&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">order_key</span><span class="o">=</span><span class="s2">&quot;chunk_number&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">peripheral_chunks</span><span class="o">=</span><span class="p">{</span>
<span class="gp">... </span>        <span class="s2">&quot;previous&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;head&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="s2">&quot;tail&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}},</span>
<span class="gp">... </span>        <span class="s2">&quot;next&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;head&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="s2">&quot;tail&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}}</span>
<span class="gp">... </span>    <span class="p">}</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Simple gathering without peripheral chunks</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">content_key</span><span class="o">=</span><span class="s2">&quot;content&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">doc_id_key</span><span class="o">=</span><span class="s2">&quot;doc_id&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">order_key</span><span class="o">=</span><span class="s2">&quot;order&quot;</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>docetl/apis/pd_accessors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">gather</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">content_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">doc_id_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">order_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">peripheral_chunks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gather contextual information from surrounding chunks to enhance each chunk.</span>

<span class="sd">    Documentation: https://ucbepic.github.io/docetl/operators/gather/</span>

<span class="sd">    Args:</span>
<span class="sd">        content_key: The column containing the main content to be enhanced</span>
<span class="sd">        doc_id_key: The column containing document identifiers to group chunks</span>
<span class="sd">        order_key: The column containing chunk order numbers within documents</span>
<span class="sd">        peripheral_chunks: Configuration for surrounding context:</span>
<span class="sd">            - previous: {&quot;head&quot;: {&quot;count&quot;: int}, &quot;tail&quot;: {&quot;count&quot;: int}, &quot;middle&quot;: {}}</span>
<span class="sd">            - next: {&quot;head&quot;: {&quot;count&quot;: int}, &quot;tail&quot;: {&quot;count&quot;: int}, &quot;middle&quot;: {}}</span>
<span class="sd">        **kwargs: Additional configuration options:</span>
<span class="sd">            - main_chunk_start: Start marker for main chunk (default: &quot;--- Begin Main Chunk ---&quot;)</span>
<span class="sd">            - main_chunk_end: End marker for main chunk (default: &quot;--- End Main Chunk ---&quot;)</span>
<span class="sd">            - doc_header_key: Column containing document headers (optional)</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: DataFrame with enhanced content including:</span>
<span class="sd">            - {content_key}_rendered: The main content with surrounding context</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Basic gathering with surrounding context</span>
<span class="sd">        &gt;&gt;&gt; df.semantic.gather(</span>
<span class="sd">        ...     content_key=&quot;chunk_content&quot;,</span>
<span class="sd">        ...     doc_id_key=&quot;document_id&quot;,</span>
<span class="sd">        ...     order_key=&quot;chunk_number&quot;,</span>
<span class="sd">        ...     peripheral_chunks={</span>
<span class="sd">        ...         &quot;previous&quot;: {&quot;head&quot;: {&quot;count&quot;: 2}, &quot;tail&quot;: {&quot;count&quot;: 1}},</span>
<span class="sd">        ...         &quot;next&quot;: {&quot;head&quot;: {&quot;count&quot;: 1}, &quot;tail&quot;: {&quot;count&quot;: 2}}</span>
<span class="sd">        ...     }</span>
<span class="sd">        ... )</span>

<span class="sd">        &gt;&gt;&gt; # Simple gathering without peripheral chunks</span>
<span class="sd">        &gt;&gt;&gt; df.semantic.gather(</span>
<span class="sd">        ...     content_key=&quot;content&quot;,</span>
<span class="sd">        ...     doc_id_key=&quot;doc_id&quot;,</span>
<span class="sd">        ...     order_key=&quot;order&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert DataFrame to list of dicts</span>
    <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>

    <span class="c1"># Create gather operation config</span>
    <span class="n">gather_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;gather&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;semantic_gather_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;content_key&quot;</span><span class="p">:</span> <span class="n">content_key</span><span class="p">,</span>
        <span class="s2">&quot;doc_id_key&quot;</span><span class="p">:</span> <span class="n">doc_id_key</span><span class="p">,</span>
        <span class="s2">&quot;order_key&quot;</span><span class="p">:</span> <span class="n">order_key</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Add peripheral_chunks config if provided</span>
    <span class="k">if</span> <span class="n">peripheral_chunks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gather_config</span><span class="p">[</span><span class="s2">&quot;peripheral_chunks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peripheral_chunks</span>

    <span class="c1"># Create and execute gather operation</span>
    <span class="n">gather_op</span> <span class="o">=</span> <span class="n">GatherOperation</span><span class="p">(</span>
        <span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="n">gather_config</span><span class="p">,</span>
        <span class="n">default_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;default_model&quot;</span><span class="p">],</span>
        <span class="n">max_threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
        <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">results</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">gather_op</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_operation</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s2">&quot;gather&quot;</span><span class="p">,</span> <span class="n">gather_config</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><p>Example usage:
<div class="highlight"><pre><span></span><code><span class="c1"># Basic gathering with surrounding context</span>
<span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
    <span class="n">content_key</span><span class="o">=</span><span class="s2">&quot;chunk_content&quot;</span><span class="p">,</span>
    <span class="n">doc_id_key</span><span class="o">=</span><span class="s2">&quot;document_id&quot;</span><span class="p">,</span>
    <span class="n">order_key</span><span class="o">=</span><span class="s2">&quot;chunk_number&quot;</span><span class="p">,</span>
    <span class="n">peripheral_chunks</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;previous&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;head&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="s2">&quot;tail&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}},</span>
        <span class="s2">&quot;next&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;head&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="s2">&quot;tail&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}}</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Simple gathering without peripheral chunks</span>
<span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
    <span class="n">content_key</span><span class="o">=</span><span class="s2">&quot;content&quot;</span><span class="p">,</span>
    <span class="n">doc_id_key</span><span class="o">=</span><span class="s2">&quot;doc_id&quot;</span><span class="p">,</span>
    <span class="n">order_key</span><span class="o">=</span><span class="s2">&quot;order&quot;</span>
<span class="p">)</span>
</code></pre></div></p>
<h2 id="unnest-operation">Unnest Operation</h2>


<div class="doc doc-object doc-function">



<a id="docetl.apis.pd_accessors.SemanticAccessor.unnest"></a>
    <div class="doc doc-contents first">

        <p>Unnest list-like or dictionary values into multiple rows.</p>
<p>Documentation: https://ucbepic.github.io/docetl/operators/unnest/</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>unnest_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The column containing list-like or dictionary values to unnest</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>keep_empty</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to keep rows with empty/null values (default: False)</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>expand_fields</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For dictionary values, which fields to expand (default: all)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>recursive</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to recursively unnest nested structures (default: False)</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>depth</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum depth for recursive unnesting (default: 1, or unlimited if recursive=True)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional configuration options</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: DataFrame with unnested values, where:
- For lists: Each list element becomes a separate row
- For dicts: Specified fields are expanded into the parent row</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Unnest a list column</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">unnest</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">unnest_key</span><span class="o">=</span><span class="s2">&quot;tags&quot;</span>
<span class="gp">... </span><span class="p">)</span>
<span class="go"># Input:  [{&quot;id&quot;: 1, &quot;tags&quot;: [&quot;a&quot;, &quot;b&quot;]}]</span>
<span class="go"># Output: [{&quot;id&quot;: 1, &quot;tags&quot;: &quot;a&quot;}, {&quot;id&quot;: 1, &quot;tags&quot;: &quot;b&quot;}]</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Unnest a dictionary column with specific fields</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">unnest</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">unnest_key</span><span class="o">=</span><span class="s2">&quot;user_info&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">expand_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">]</span>
<span class="gp">... </span><span class="p">)</span>
<span class="go"># Input:  [{&quot;id&quot;: 1, &quot;user_info&quot;: {&quot;name&quot;: &quot;Alice&quot;, &quot;age&quot;: 30, &quot;email&quot;: &quot;alice@example.com&quot;}}]</span>
<span class="go"># Output: [{&quot;id&quot;: 1, &quot;user_info&quot;: {...}, &quot;name&quot;: &quot;Alice&quot;, &quot;age&quot;: 30}]</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Recursive unnesting</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">unnest</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">unnest_key</span><span class="o">=</span><span class="s2">&quot;nested_lists&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">depth</span><span class="o">=</span><span class="mi">2</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>docetl/apis/pd_accessors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">unnest</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">unnest_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">keep_empty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">expand_fields</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unnest list-like or dictionary values into multiple rows.</span>

<span class="sd">    Documentation: https://ucbepic.github.io/docetl/operators/unnest/</span>

<span class="sd">    Args:</span>
<span class="sd">        unnest_key: The column containing list-like or dictionary values to unnest</span>
<span class="sd">        keep_empty: Whether to keep rows with empty/null values (default: False)</span>
<span class="sd">        expand_fields: For dictionary values, which fields to expand (default: all)</span>
<span class="sd">        recursive: Whether to recursively unnest nested structures (default: False)</span>
<span class="sd">        depth: Maximum depth for recursive unnesting (default: 1, or unlimited if recursive=True)</span>
<span class="sd">        **kwargs: Additional configuration options</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: DataFrame with unnested values, where:</span>
<span class="sd">            - For lists: Each list element becomes a separate row</span>
<span class="sd">            - For dicts: Specified fields are expanded into the parent row</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Unnest a list column</span>
<span class="sd">        &gt;&gt;&gt; df.semantic.unnest(</span>
<span class="sd">        ...     unnest_key=&quot;tags&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">        # Input:  [{&quot;id&quot;: 1, &quot;tags&quot;: [&quot;a&quot;, &quot;b&quot;]}]</span>
<span class="sd">        # Output: [{&quot;id&quot;: 1, &quot;tags&quot;: &quot;a&quot;}, {&quot;id&quot;: 1, &quot;tags&quot;: &quot;b&quot;}]</span>

<span class="sd">        &gt;&gt;&gt; # Unnest a dictionary column with specific fields</span>
<span class="sd">        &gt;&gt;&gt; df.semantic.unnest(</span>
<span class="sd">        ...     unnest_key=&quot;user_info&quot;,</span>
<span class="sd">        ...     expand_fields=[&quot;name&quot;, &quot;age&quot;]</span>
<span class="sd">        ... )</span>
<span class="sd">        # Input:  [{&quot;id&quot;: 1, &quot;user_info&quot;: {&quot;name&quot;: &quot;Alice&quot;, &quot;age&quot;: 30, &quot;email&quot;: &quot;alice@example.com&quot;}}]</span>
<span class="sd">        # Output: [{&quot;id&quot;: 1, &quot;user_info&quot;: {...}, &quot;name&quot;: &quot;Alice&quot;, &quot;age&quot;: 30}]</span>

<span class="sd">        &gt;&gt;&gt; # Recursive unnesting</span>
<span class="sd">        &gt;&gt;&gt; df.semantic.unnest(</span>
<span class="sd">        ...     unnest_key=&quot;nested_lists&quot;,</span>
<span class="sd">        ...     recursive=True,</span>
<span class="sd">        ...     depth=2</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert DataFrame to list of dicts</span>
    <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>

    <span class="c1"># Create unnest operation config</span>
    <span class="n">unnest_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;unnest&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;semantic_unnest_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;unnest_key&quot;</span><span class="p">:</span> <span class="n">unnest_key</span><span class="p">,</span>
        <span class="s2">&quot;keep_empty&quot;</span><span class="p">:</span> <span class="n">keep_empty</span><span class="p">,</span>
        <span class="s2">&quot;recursive&quot;</span><span class="p">:</span> <span class="n">recursive</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Add optional parameters if provided</span>
    <span class="k">if</span> <span class="n">expand_fields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">unnest_config</span><span class="p">[</span><span class="s2">&quot;expand_fields&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expand_fields</span>
    <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">unnest_config</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">depth</span>

    <span class="c1"># Create and execute unnest operation</span>
    <span class="n">unnest_op</span> <span class="o">=</span> <span class="n">UnnestOperation</span><span class="p">(</span>
        <span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="n">unnest_config</span><span class="p">,</span>
        <span class="n">default_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;default_model&quot;</span><span class="p">],</span>
        <span class="n">max_threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
        <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">results</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">unnest_op</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_operation</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s2">&quot;unnest&quot;</span><span class="p">,</span> <span class="n">unnest_config</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><p>Example usage:
<div class="highlight"><pre><span></span><code><span class="c1"># Unnest a list column</span>
<span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">unnest</span><span class="p">(</span><span class="n">unnest_key</span><span class="o">=</span><span class="s2">&quot;tags&quot;</span><span class="p">)</span>

<span class="c1"># Unnest a dictionary column with specific fields</span>
<span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">unnest</span><span class="p">(</span>
    <span class="n">unnest_key</span><span class="o">=</span><span class="s2">&quot;user_info&quot;</span><span class="p">,</span>
    <span class="n">expand_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Recursive unnesting with depth control</span>
<span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">unnest</span><span class="p">(</span>
    <span class="n">unnest_key</span><span class="o">=</span><span class="s2">&quot;nested_lists&quot;</span><span class="p">,</span>
    <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">depth</span><span class="o">=</span><span class="mi">2</span>
<span class="p">)</span>
</code></pre></div></p>
<h2 id="common-features">Common Features</h2>
<p>All operations support:</p>
<ol>
<li>
<p><strong>Cost Tracking</strong>
<div class="highlight"><pre><span></span><code><span class="c1"># After any operation</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Operation cost: $</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">total_cost</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Operation History</strong>
<div class="highlight"><pre><span></span><code><span class="c1"># View operation history</span>
<span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">semantic</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">op</span><span class="o">.</span><span class="n">op_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">op</span><span class="o">.</span><span class="n">output_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Validation Rules</strong>
<div class="highlight"><pre><span></span><code><span class="c1"># Add validation rules to any  map or filter operation</span>
<span class="n">validate</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;len(output[&#39;tags&#39;]) &lt;= 5&quot;</span><span class="p">,</span> <span class="s2">&quot;output[&#39;score&#39;] &gt;= 0&quot;</span><span class="p">]</span>
</code></pre></div></p>
</li>
</ol>
<p>For more details on configuration options and best practices, refer to:
- <a href="../../best-practices/">DocETL Best Practices</a>
- <a href="../../concepts/pipelines/">Pipeline Configuration</a>
- <a href="../../concepts/schemas/">Output Schemas</a> </p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../" class="md-footer__link md-footer__link--prev" aria-label="Previous: Overview">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Overview
              </div>
            </div>
          </a>
        
        
          
          <a href="../examples/" class="md-footer__link md-footer__link--next" aria-label="Next: Examples">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Examples
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.instant.prefetch", "navigation.tracking", "navigation.expand", "navigation.path", "navigation.prune", "navigation.indexes", "navigation.top", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "toc.follow", "navigation.footer", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>